<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>FastApi项目部署之应用生产环境gunicorn + uvicorn + nginx部署</title>
    <url>/2022/06/07/FastApi%E9%A1%B9%E7%9B%AE%E9%83%A8%E7%BD%B2%E4%B9%8B%E5%BA%94%E7%94%A8%E7%94%9F%E4%BA%A7%E7%8E%AF%E5%A2%83%E9%83%A8%E7%BD%B2/</url>
    <content><![CDATA[<p>hello 大家好我是Monday，今天给大家带来一篇fastApi项目部署的相关文章。</p>
<a id="more"></a>
<p>在上篇介绍了使用Uvicorn部署启动程序</p>
<p>一般情况下，我们在开发、调试过程中采用命令行启动用的是 uvicorn（当然小型服务也有例外），但是并没有提供进程的监控。</p>
<p>所以我在生产环境下，一般会使用进程管理器 gunicorn + uvicorn + nginx 来部署项目</p>
<p><strong>1、Gunicorn：</strong></p>
<p>Gunicorn 是成熟的，功能齐全的服务器，Uvicorn 内部包含有 Guicorn 的 workers 类，允许你运行 ASGI 应用程序，这些 workers 继承了所有 Uvicorn 高性能的特点，并且给你使用 Guicorn 来进行进程管理。</p>
<p>这样的话，你可能动态增加或减少进程数量，平滑地重启工作进程，或者升级服务器而无需停机。</p>
<p>在生产环境中，Guicorn 大概是最简单的方式来管理 Uvicorn 了，生产环境部署我们推荐使用 Guicorn 和 Uvicorn 的 worker 类：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">gunicorn example:app -w 4 -k uvicorn.workers.UvicornWorker</span><br></pre></td></tr></table></figure>
<p><strong>2、安装gunicorn</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">pip install gunicorn</span><br></pre></td></tr></table></figure>
<p><strong>3.以配置文件方式启动应用</strong></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> multiprocessing</span><br><span class="line"><span class="comment"># 绑定ip和端口号</span></span><br><span class="line">bind = <span class="string">'0.0.0.0:9088'</span></span><br><span class="line"><span class="comment"># 并行工作进程数</span></span><br><span class="line">workers = multiprocessing.cpu_count() * <span class="number">2</span> + <span class="number">1</span></span><br><span class="line"><span class="comment"># workers = 2</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 还可以使用 gevent 模式，还可以使用sync模式，默认sync模式</span></span><br><span class="line">worker_class = <span class="string">'uvicron.workers.UvicornWorker'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 指定每个工作者的线程数</span></span><br><span class="line">threads = <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 监听队列</span></span><br><span class="line">backlog = <span class="number">2048</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 超过多少秒后工作将被杀掉，并重新启动。一般设置为30秒或更多</span></span><br><span class="line">timeout = <span class="number">30</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置最大并发量</span></span><br><span class="line">worker_connections = <span class="number">1000</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 默认False，设置守护进程，将进程交给supervisor管理</span></span><br><span class="line">daemon = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">debug = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">loglevel = <span class="string">'debug'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 默认None，这会影响ps和top。如果要运行多个Gunicorn实例，</span></span><br><span class="line"><span class="comment"># 需要设置一个名称来区分，这就要安装setproctitle模块。如果未安装</span></span><br><span class="line">proc_name = <span class="string">'main'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置进程文件目录</span></span><br><span class="line">pidfile = <span class="string">'./pid/gunicron.pid'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 访问日志文件</span></span><br><span class="line">accesslog = <span class="string">'./logs/access.log'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 错误日志文件</span></span><br><span class="line">errorlog = <span class="string">'./logs/error.log'</span></span><br><span class="line"><span class="comment"># logger_class = 'gunicron.gologging.Logger'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 预加载资源</span></span><br><span class="line">preload_app = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">autorestart = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置gunicron访问日志格式，错误日志无法设置</span></span><br><span class="line">access_log_format = <span class="string">'%(t)s %(p)s %(h)s "%(r)s" %(s)s %(L)s %(b)s %(f)s" " "%(a)s"'</span></span><br></pre></td></tr></table></figure>
<p><strong>4、启动程序</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">nohup gunicorn -c gunicorn.conf.py main:app -k uvicorn.workers.UvicornWorker</span><br></pre></td></tr></table></figure>
<p><strong>注意</strong>：main.py的端口要和gunicorn绑定的端口一样。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">uvicorn.run(app&#x3D;&#39;main:app&#39;, host&#x3D;&quot;127.0.0.1&quot;, port&#x3D;9088, reload&#x3D;True, debug&#x3D;True)</span><br></pre></td></tr></table></figure>
<p><strong>查看gunicorn进程树：</strong></p>
<figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">pstree -ap|<span class="keyword">grep</span> gunicorn</span><br></pre></td></tr></table></figure>
<p><strong>杀掉进程：</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">kill -9 gunicorn的pid</span><br></pre></td></tr></table></figure>
<p><strong>5、配置nginx,</strong> </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">vim &#x2F;etc&#x2F;nginx&#x2F;conf.d&#x2F;fastapi_9008.conf</span><br></pre></td></tr></table></figure>
<p><strong>配置文件如下:</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">        listen 9008;</span><br><span class="line">        root &#x2F;python&#x2F;fastapi;</span><br><span class="line">        server_name xxx.xxx.xxx.xxx;</span><br><span class="line">        location &#x2F; &#123;</span><br><span class="line">            proxy_set_header x-Real-IP $remote_addr;</span><br><span class="line">            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</span><br><span class="line">            proxy_set_header Host $http_host;</span><br><span class="line">            proxy_pass http:&#x2F;&#x2F;localhost:9088&#x2F;; # gunicorn绑定的端口号</span><br><span class="line">        &#125;</span><br><span class="line">        # 配置static的静态文件：</span><br><span class="line">        location ~ ^\&#x2F;static\&#x2F;.*$ &#123;</span><br><span class="line">            root &#x2F;python&#x2F;fastapi&#x2F;static;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>配置文件意思是</strong>：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">listen监听9008端口，</span><br><span class="line"></span><br><span class="line">root指向项目目录，</span><br><span class="line"></span><br><span class="line">server_name设定服务器IP或者域名，</span><br><span class="line"></span><br><span class="line">location的proxy_set_header设定IP以及相关，</span><br><span class="line"></span><br><span class="line">proxy_pass转发给gunicorn绑定的fastapi使用的端口，</span><br><span class="line"></span><br><span class="line">注意：监听端口和转发绑定端口不能一样，</span><br></pre></td></tr></table></figure>
<p><strong>然后保存，重启nginx</strong>。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">systemctl restart nginx</span><br></pre></td></tr></table></figure>
<p><strong>nginx配置大文件上传</strong></p>
<p>正常web程序post是对请求的body或者文件上传没有大小限制</p>
<p>这个发布部署是通过nginx反向代理，转发fastapi端口，来实现的，</p>
<p>因为nginx默认最大上传文件是1M，所以需要修改，否则大文件会报错Request too large  413 代码，</p>
<p>把上面的nginx的配置文件，修改成如下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">        listen 9518;</span><br><span class="line">        root &#x2F;www&#x2F;python;</span><br><span class="line">        server_name xxx.xxx.xxx.xxx;</span><br><span class="line">        location &#x2F; &#123;</span><br><span class="line">            proxy_set_header x-Real-IP $remote_addr;</span><br><span class="line">            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</span><br><span class="line">            proxy_set_header Host $http_host;</span><br><span class="line">            proxy_set_header Range $http_range;</span><br><span class="line">            proxy_set_header If-Range $http_if_range;</span><br><span class="line">            proxy_pass http:&#x2F;&#x2F;127.0.0.1:9088&#x2F;; # gunicorn绑定的端口号</span><br><span class="line">            client_max_body_size   2048m;#最大上传文件改成2G</span><br><span class="line">            proxy_connect_timeout  3600s;#最大等待上传时间，改成1个小时</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>参考学习链接：</strong></p>
<p>nginx 更改配置client_max_body_size nginx.conf 修改默认限制上传附件大小</p>
<p><a href="https://blog.csdn.net/z69183787/article/details/83070275" target="_blank" rel="noopener">https://blog.csdn.net/z69183787/article/details/83070275</a></p>
<p>http请求的url或body或header有长度或大小的限制吗？</p>
<p><a href="https://blog.csdn.net/kris_lh123/article/details/101062026" target="_blank" rel="noopener">https://blog.csdn.net/kris_lh123/article/details/101062026</a></p>
<p>fastapi学习记录【十二】发布部署gunicorn+nginx</p>
<p><a href="https://blog.csdn.net/wangluonanhai/article/details/124011178" target="_blank" rel="noopener">https://blog.csdn.net/wangluonanhai/article/details/124011178</a></p>
<p>FastAPI部署，docker 部署</p>
<p><a href="https://blog.csdn.net/RoninYang/article/details/121128106" target="_blank" rel="noopener">https://blog.csdn.net/RoninYang/article/details/121128106</a></p>
<p>setproctitle：设置Python进程名称</p>
<p><a href="https://www.missshi.cn/api/view/blog/5df835053b4ab21ff6000000" target="_blank" rel="noopener">https://www.missshi.cn/api/view/blog/5df835053b4ab21ff6000000</a></p>
<p><strong>结束语</strong>：</p>
<p>​    今天的分享就到这里了，欢迎大家关注微信公众号”<strong>菜鸟童靴</strong>“</p>
<p><img src="/2022/06/07/FastApi%E9%A1%B9%E7%9B%AE%E9%83%A8%E7%BD%B2%E4%B9%8B%E5%BA%94%E7%94%A8%E7%94%9F%E4%BA%A7%E7%8E%AF%E5%A2%83%E9%83%A8%E7%BD%B2/微信.png" style="zoom: 50%;"></p>
]]></content>
      <categories>
        <category>后端</category>
      </categories>
      <tags>
        <tag>后端</tag>
        <tag>fastapi</tag>
      </tags>
  </entry>
  <entry>
    <title>fastApi项目部署之uvicorn参数解析</title>
    <url>/2022/06/07/fastApi%E9%A1%B9%E7%9B%AE%E9%83%A8%E7%BD%B2%E4%B9%8Buvicorn%E5%8F%82%E6%95%B0%E8%A7%A3%E6%9E%90/</url>
    <content><![CDATA[<p>hello 大家好我是Monday，今天给大家带来一篇fastApi项目部署的相关文章。</p>
<a id="more"></a>
<h2 id="Uvicorn"><a href="#Uvicorn" class="headerlink" title="Uvicorn"></a>Uvicorn</h2><p>uvicorn官方文档：<a href="https://www.uvicorn.org/" target="_blank" rel="noopener">https://www.uvicorn.org/</a></p>
<ul>
<li><code>Uvicorn</code> 是基于 <code>uvloop</code> 和 <code>httptools</code> 构建的非常快速的 <code>ASGI</code> 服务器。</li>
<li><code>Uvicorn</code> 提供一个轻量级的方法来运行多个工作进程，比如 <code>-workers 4</code> ，但是并没有提供进程的监控。</li>
</ul>
<p><strong>1、uvicorn支持的参数非常多 uvicorn —help  查看下：</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">uvicorn --help</span><br><span class="line">Usage: uvicorn [OPTIONS] APP</span><br><span class="line"></span><br><span class="line">Options:</span><br><span class="line">  --host TEXT                     Bind socket to this host.  [default:</span><br><span class="line">                                  127.0.0.1]</span><br><span class="line"></span><br><span class="line">  --port INTEGER                  Bind socket to this port.  [default: 8000]</span><br><span class="line">  --uds TEXT                      Bind to a UNIX domain socket.</span><br><span class="line">  --fd INTEGER                    Bind to socket from this file descriptor.</span><br><span class="line">  --reload                        Enable auto-reload.</span><br><span class="line">  --reload-dir TEXT               Set reload directories explicitly, instead</span><br><span class="line">                                  of using the current working directory.</span><br><span class="line"></span><br><span class="line">  --reload-delay FLOAT            Delay between previous and next check if</span><br><span class="line">                                  application needs to be. Defaults to 0.25s.</span><br><span class="line">                                  [default: 0.25]</span><br><span class="line"></span><br><span class="line">  --workers INTEGER               Number of worker processes. Defaults to the</span><br><span class="line">                                  $WEB_CONCURRENCY environment variable if</span><br><span class="line">                                  available. Not valid with --reload.</span><br><span class="line"></span><br><span class="line">  --loop [auto|asyncio|uvloop]    Event loop implementation.  [default: auto]</span><br><span class="line">  --http [auto|h11|httptools]     HTTP protocol implementation.  [default:</span><br><span class="line">                                  auto]</span><br><span class="line"></span><br><span class="line">  --ws [auto|none|websockets|wsproto]</span><br><span class="line">                                  WebSocket protocol implementation.</span><br><span class="line">                                  [default: auto]</span><br><span class="line"></span><br><span class="line">  --lifespan [auto|on|off]        Lifespan implementation.  [default: auto]</span><br><span class="line">  --interface [auto|asgi3|asgi2|wsgi]</span><br><span class="line">                                  Select ASGI3, ASGI2, or WSGI as the</span><br><span class="line">                                  application interface.  [default: auto]</span><br><span class="line"></span><br><span class="line">  --env-file PATH                 Environment configuration file.</span><br><span class="line">  --log-config PATH               Logging configuration file.</span><br><span class="line">  --log-level [critical|error|warning|info|debug|trace]</span><br><span class="line">                                  Log level. [default: info]</span><br><span class="line">  --access-log &#x2F; --no-access-log  Enable&#x2F;Disable access log.</span><br><span class="line">  --use-colors &#x2F; --no-use-colors  Enable&#x2F;Disable colorized logging.</span><br><span class="line">  --proxy-headers &#x2F; --no-proxy-headers</span><br><span class="line">                                  Enable&#x2F;Disable X-Forwarded-Proto,</span><br><span class="line">                                  X-Forwarded-For, X-Forwarded-Port to</span><br><span class="line">                                  populate remote address info.</span><br><span class="line"></span><br><span class="line">  --forwarded-allow-ips TEXT      Comma seperated list of IPs to trust with</span><br><span class="line">                                  proxy headers. Defaults to the</span><br><span class="line">                                  $FORWARDED_ALLOW_IPS environment variable if</span><br><span class="line">                                  available, or &#39;127.0.0.1&#39;.</span><br><span class="line"></span><br><span class="line">  --root-path TEXT                Set the ASGI &#39;root_path&#39; for applications</span><br><span class="line">                                  submounted below a given URL path.</span><br><span class="line"></span><br><span class="line">  --limit-concurrency INTEGER     Maximum number of concurrent connections or</span><br><span class="line">                                  tasks to allow, before issuing HTTP 503</span><br><span class="line">                                  responses.</span><br><span class="line"></span><br><span class="line">  --backlog INTEGER               Maximum number of connections to hold in</span><br><span class="line">                                  backlog</span><br><span class="line"></span><br><span class="line">  --limit-max-requests INTEGER    Maximum number of requests to service before</span><br><span class="line">                                  terminating the process.</span><br><span class="line"></span><br><span class="line">  --timeout-keep-alive INTEGER    Close Keep-Alive connections if no new data</span><br><span class="line">                                  is received within this timeout.  [default:</span><br><span class="line">                                  5]</span><br><span class="line"></span><br><span class="line">  --ssl-keyfile TEXT              SSL key file</span><br><span class="line">  --ssl-certfile TEXT             SSL certificate file</span><br><span class="line">  --ssl-keyfile-password TEXT     SSL keyfile password</span><br><span class="line">  --ssl-version INTEGER           SSL version to use (see stdlib ssl module&#39;s)</span><br><span class="line">                                  [default: 2]</span><br><span class="line"></span><br><span class="line">  --ssl-cert-reqs INTEGER         Whether client certificate is required (see</span><br><span class="line">                                  stdlib ssl module&#39;s)  [default: 0]</span><br><span class="line"></span><br><span class="line">  --ssl-ca-certs TEXT             CA certificates file</span><br><span class="line">  --ssl-ciphers TEXT              Ciphers to use (see stdlib ssl module&#39;s)</span><br><span class="line">                                  [default: TLSv1]</span><br><span class="line"></span><br><span class="line">  --header TEXT                   Specify custom default HTTP response headers</span><br><span class="line">                                  as a Name:Value pair</span><br><span class="line"></span><br><span class="line">  --version                       Display the uvicorn version and exit.</span><br><span class="line">  --app-dir TEXT                  Look for APP in the specified directory, by</span><br><span class="line">                                  adding this to the PYTHONPATH. Defaults to</span><br><span class="line">                                  the current working directory.  [default: .]</span><br><span class="line"></span><br><span class="line">  --help                          Show this message and exit.</span><br></pre></td></tr></table></figure>
<p><strong>2、我们进入到 uvicorn.run 查看下参数配置，及默认值</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">class Config:</span><br><span class="line">    def __init__(</span><br><span class="line">        self,</span><br><span class="line">        app,</span><br><span class="line">        host&#x3D;&quot;127.0.0.1&quot;,</span><br><span class="line">        port&#x3D;8000,</span><br><span class="line">        uds&#x3D;None,</span><br><span class="line">        fd&#x3D;None,</span><br><span class="line">        loop&#x3D;&quot;auto&quot;,</span><br><span class="line">        http&#x3D;&quot;auto&quot;,</span><br><span class="line">        ws&#x3D;&quot;auto&quot;,</span><br><span class="line">        lifespan&#x3D;&quot;auto&quot;,</span><br><span class="line">        env_file&#x3D;None,</span><br><span class="line">        log_config&#x3D;LOGGING_CONFIG,</span><br><span class="line">        log_level&#x3D;None,</span><br><span class="line">        access_log&#x3D;True,</span><br><span class="line">        use_colors&#x3D;None,</span><br><span class="line">        interface&#x3D;&quot;auto&quot;,</span><br><span class="line">        debug&#x3D;False,</span><br><span class="line">        reload&#x3D;False,</span><br><span class="line">        reload_dirs&#x3D;None,</span><br><span class="line">        reload_delay&#x3D;None,</span><br><span class="line">        workers&#x3D;None,</span><br><span class="line">        proxy_headers&#x3D;True,</span><br><span class="line">        forwarded_allow_ips&#x3D;None,</span><br><span class="line">        root_path&#x3D;&quot;&quot;,</span><br><span class="line">        limit_concurrency&#x3D;None,</span><br><span class="line">        limit_max_requests&#x3D;None,</span><br><span class="line">        backlog&#x3D;2048,</span><br><span class="line">        timeout_keep_alive&#x3D;5,</span><br><span class="line">        timeout_notify&#x3D;30,</span><br><span class="line">        callback_notify&#x3D;None,</span><br><span class="line">        ssl_keyfile&#x3D;None,</span><br><span class="line">        ssl_certfile&#x3D;None,</span><br><span class="line">        ssl_keyfile_password&#x3D;None,</span><br><span class="line">        ssl_version&#x3D;SSL_PROTOCOL_VERSION,</span><br><span class="line">        ssl_cert_reqs&#x3D;ssl.CERT_NONE,</span><br><span class="line">        ssl_ca_certs&#x3D;None,</span><br><span class="line">        ssl_ciphers&#x3D;&quot;TLSv1&quot;,</span><br><span class="line">        headers&#x3D;None,</span><br><span class="line">    ):</span><br></pre></td></tr></table></figure>
<p><strong>3、 解析每一个参数的含义</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">app：指定应用app，&#39;脚本名:FastAPI实例对象&#39;、FastAPI实例对象</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">host: 字符串，允许被访问的形式 locahost、127.0.0.1、当前IP、0.0.0.0，默认为127.0.0.1,</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">port：数字，应用的端口，默认为8000,</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">uds：字符串，socket服务绑定到UNIX的域名</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">fd：数字，从此文件描述符绑定到socket</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">loop：[auto|asyncio|uvloop]，事件循环模式，默认为auto</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">http：[auto|h11|httptools]，HTTP协议实现，默认为auto</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ws：[auto|none|websockets|wsproto]，WebSocket协议实现，默认为auto</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ws-max-size：数字，WebSocket最大消息大小（字节），默认值为16777216</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">lifespan：[auto|on|off]，生命周期实施，默认为auto</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">env-file：PATH，环境配置文件</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">log-config：PATH，日志配置文件。支持的格式：.ini、.json、.yaml，默认为fastapi默认的log配置</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">log-level：[critical|error|warning|info|debug|trace]，日志级别，默认info</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">access-log：boolean，access log日志的开关，默认为True</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">use-colors：boolean，彩色日志的开关，（前提需指定log-config），默认为None</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">interface：[auto|asgi3|asgi2|wsgi]，选择ASGI3、ASGI2或WSGI作为应用程序接口，默认为auto</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">debug：是否使用debug模式，默认False,</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">reload：boolean，当代码发生更时，是否自动重启，默认False,</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">reload_dirs：字符串，设置重新加载目录，由源码可见，当没有传这个参数的实时，将取当前工作目录</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">reload-delay：float，每隔多久检测代码是否有变动，默认0.25秒</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">workers：数字，工作进程数。默认为$WEB\U CONCURRENCY环境变量（如果可用），或1。对于--reload无效。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">proxy-headers：boolean，启用&#x2F;禁用X-Forwarded-Proto、X-Forwarded-For、X-Forwarded-Port以填充远程地址信息，默认为True</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">forwarded-allow-ips：字符串，用逗号分隔的IP列表以信任代理标头。默认为$FORWARDED\u ALLOW\u IPS环境变量（如果可用），或 None，为None时，代码里面则取127.0.0.1</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">root-path：字符串，为安装在给定URL路径下的应用程序设置ASGI“根路径”。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">limit-concurrency：数字，在发出HTTP503响应之前，允许的最大并发连接数或任务数。默认为None</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">limit-max-requests：数字，达到多少请求数则终止进程，默认为None</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">backlog：数字，等待处理的最大连接数，默认为2048</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">timeout-keep-alive：数字，如果在此超时时间内未收到新数据，则关闭保持活动状态的连接，默认为5</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ssl-keyfile：字符串，SSL密钥文件，默认为None</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ssl-certfile：字符串，SSL证书文件，默认为None</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ssl-keyfile-password：字符串，SSL密钥文件密码，默认为None</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ssl-version：数字，要使用的SSL版本（详见stdlib SSL模块），默认为2</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ssl-cert-reqs：数字，是否需要客户端证书（详见stdlib SSL模块），默认为0</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ssl-ca-certs：字符串，CA证书文件</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ssl-ciphers：字符串，要使用的CA证书文件密码（详见stdlib SSL模块），默认为TLSv1</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">header：字典，自定义响应头信息，键值对的形式，默认为None</span><br></pre></td></tr></table></figure>
<p><strong>4、利用uvicorn 部署启动FastApi应用程序</strong></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> uvicorn</span><br><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI</span><br><span class="line"><span class="keyword">from</span> pydantic <span class="keyword">import</span> BaseModel</span><br><span class="line"></span><br><span class="line">app = FastAPI()  <span class="comment"># 必须实例化该类，启动的时候调用</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">People</span><span class="params">(BaseModel)</span>:</span>  <span class="comment"># 必须继承</span></span><br><span class="line">    name: str</span><br><span class="line">    age: int</span><br><span class="line">    address: str</span><br><span class="line">    salary: float</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 请求根目录</span></span><br><span class="line"><span class="meta">@app.get('/')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">'message'</span>: <span class="string">'欢迎来到FastApi 服务！'</span>&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># get请求带参数数据</span></span><br><span class="line"><span class="meta">@app.get('/items/&#123;item_id&#125;')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">items</span><span class="params">(item_id: int)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">'message'</span>: <span class="string">'欢迎'</span> + item_id + <span class="string">'来到接口页面'</span>&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># post请求带参数数据</span></span><br><span class="line"><span class="meta">@app.post('/people')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">insert</span><span class="params">(people: People)</span>:</span></span><br><span class="line">    age = people.age</span><br><span class="line">    msg = <span class="string">f'名字：<span class="subst">&#123;people.name&#125;</span>，年龄：<span class="subst">&#123;age&#125;</span>'</span></span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">'success'</span>: <span class="literal">True</span>, <span class="string">'msg'</span>: msg&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    uvicorn.run(app=<span class="string">"ceshi:app"</span>, host=<span class="string">"127.0.0.1"</span>, port=<span class="number">8080</span>, workers=<span class="number">10</span>, </span><br><span class="line">                debug=<span class="literal">True</span>, reload=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>
<p><strong>5、启动：</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">1、python ceshi.py</span><br><span class="line"></span><br><span class="line">2、uvicorn main:app --reload</span><br></pre></td></tr></table></figure>
<p><strong>结束语</strong>：</p>
<p>​    今天的分享就到这里了，欢迎大家关注微信公众号”<strong>菜鸟童靴</strong>“</p>
<p><img src="/2022/06/07/fastApi%E9%A1%B9%E7%9B%AE%E9%83%A8%E7%BD%B2%E4%B9%8Buvicorn%E5%8F%82%E6%95%B0%E8%A7%A3%E6%9E%90/微信.png" style="zoom: 50%;"></p>
]]></content>
      <categories>
        <category>后端</category>
      </categories>
      <tags>
        <tag>后端</tag>
        <tag>fastapi</tag>
      </tags>
  </entry>
  <entry>
    <title>web服务器和web应用框架关系以及介绍</title>
    <url>/2022/06/06/web%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%92%8Cweb%E5%BA%94%E7%94%A8%E6%A1%86%E6%9E%B6%E5%85%B3%E7%B3%BB%E4%BB%A5%E5%8F%8A%E4%BB%8B%E7%BB%8D/</url>
    <content><![CDATA[<p>hello 大家好我是Monday，今天给大家带来一篇后端开发，关于web服务器和web应用框架关系以及介绍。</p>
<a id="more"></a>
<h1 id="一、CGI-FastCGI-WSGI-uWSGI-uwsgi-ASGI介绍"><a href="#一、CGI-FastCGI-WSGI-uWSGI-uwsgi-ASGI介绍" class="headerlink" title="一、CGI, FastCGI, WSGI, uWSGI, uwsgi, ASGI介绍"></a>一、<strong>CGI, FastCGI, WSGI, uWSGI, uwsgi, ASGI介绍</strong></h1><h2 id="CGI"><a href="#CGI" class="headerlink" title="CGI"></a><strong>CGI</strong></h2><p><a href="https://baike.baidu.com/item/CGI/607810" target="_blank" rel="noopener">CGI（通用网关接口）_百度百科 (baidu.com)</a></p>
<p><a href="https://baike.baidu.com/item/公共网关接口/10911997" target="_blank" rel="noopener">公共网关接口</a>（Common Gateway Interface，CGI）是Web 服务器运行时外部程序的规范，按CGI 编写的程序可以扩展服务器功能。CGI 应用程序能与<a href="https://baike.baidu.com/item/浏览器/213911" target="_blank" rel="noopener">浏览器</a>进行交互，还可通过数据API与<a href="https://baike.baidu.com/item/数据库服务器/613818" target="_blank" rel="noopener">数据库服务器</a>等外部数据源进行<a href="https://baike.baidu.com/item/通信/300982" target="_blank" rel="noopener">通信</a>，从数据库服务器中获取数据。格式化为HTML文档后，发送给浏览器，也可以将从浏览器获得的数据放到数据库中。几乎所有<a href="https://baike.baidu.com/item/服务器/100571" target="_blank" rel="noopener">服务器</a>都支持CGI，可用任何语言编写CGI，包括流行的C、C ++、Java、VB 和Delphi 等。CGI分为标准CGI和间接CGI两种。标准CGI使用<a href="https://baike.baidu.com/item/命令行/196110" target="_blank" rel="noopener">命令行</a>参数或环境变量表示服务器的详细请求，服务器与浏览器通信采用标准输入输出方式。间接CGI又称缓冲CGI，在CGI程序和CGI接口之间插入一个缓冲程序，缓冲程序与CGI接口间用标准输入输出进行通信 [1] 。（百度百科）</p>
<h3 id="CGI总结"><a href="#CGI总结" class="headerlink" title="CGI总结"></a><strong>CGI总结</strong></h3><p>1、通用网关接口（Common Gateway Interface/CGI）是一种重要的互联网技术，可以让一个客户端，从网页浏览器向执行在网络服务器上的程序请求数据。CGI描述了服务器和请求处理程序之间传输数据的一种标准。</p>
<p>2、CGI程序可以用任何脚本语言或者是完全独立编程语言实现，只要这个语言可以在这个系统上运行。</p>
<p>3、用来规范web服务器传输的数据类型以及数据格式，包括URL、查询字符串、POST数据、HTTP header等，也就是为了保证web server传递过来的数据是标准格式的</p>
<p>4、一句话总结： 一个标准，定义了客户端服务器之间如何传数据</p>
<h2 id="FastCGI"><a href="#FastCGI" class="headerlink" title="FastCGI"></a><strong>FastCGI</strong></h2><p>FastCGI是一个可伸缩地、高速地在HTTP服务器和动态脚本语言间通信的接口（FastCGI接口在Linux下是socket（可以是文件socket，也可以是ip socket）），主要优点是把动态语言和HTTP服务器分离开来。多数流行的HTTP服务器都支持FastCGI，包括Apache、Nginx和lightpd。</p>
<p>同时，FastCGI也被许多脚本语言所支持，比较流行的脚本语言之一为PHP。FastCGI接口方式采用C/S架构，可以将HTTP服务器和脚本解析服务器分开，同时在脚本解析服务器上启动一个或多个脚本解析守护进程。当HTTP服务器每次遇到动态程序时，可以将其直接交付给FastCGI进程执行，然后将得到的结构返回给浏览器。这种方式可以让HTTP服务器专一地处理静态请求或者将动态脚本服务器的结果返回给客户端，这在很大程度上提高了整个应用系统的性能。</p>
<h3 id="FastCGI的重要特点："><a href="#FastCGI的重要特点：" class="headerlink" title="FastCGI的重要特点："></a><strong>FastCGI的重要特点：</strong></h3><p>1、FastCGI是HTTP服务器和动态脚本语言间通信的接口或者工具。</p>
<p>2、FastCGI优点是把动态语言解析和HTTP服务器分离开来。</p>
<p>3、Nginx、Apache、Lighttpd以及多数动态语言都支持FastCGI。</p>
<p>4、FastCGI接口方式采用C/S架构，分为客户端（HTTP服务器）和服务端（动态语言解析服务器）。</p>
<p>5、PHP动态语言服务端可以启动多个FastCGI的守护进程。</p>
<p>6、HTTP服务器通过FastCGI客户端和动态语言FastCGI服务端通信。</p>
<h3 id="FastCGI总结："><a href="#FastCGI总结：" class="headerlink" title="FastCGI总结："></a><strong>FastCGI总结：</strong></h3><p>1、快速通用网关接口（Fast Common Gateway Interface／FastCGI）是一种让交互程序与Web服务器通信的协议。FastCGI是早期通用网关接口（CGI）的增强版本。</p>
<p>2、FastCGI致力于减少网页服务器与CGI程序之间互动的开销，从而使服务器可以同时处理更多的网页请求。</p>
<p>3、使用FastCGI的服务器：</p>
<p>​    Apache HTTP Server (部分)、Cherokee HTTP Server、Hiawatha Webserver、Lighttpd、Nginx、LiteSpeed Web Server</p>
<p>​    Microsoft IIS</p>
<p><img src="/2022/06/06/web%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%92%8Cweb%E5%BA%94%E7%94%A8%E6%A1%86%E6%9E%B6%E5%85%B3%E7%B3%BB%E4%BB%A5%E5%8F%8A%E4%BB%8B%E7%BB%8D/4.jpg" style="zoom: 150%;"></p>
<h2 id="WSGI"><a href="#WSGI" class="headerlink" title="WSGI"></a><strong>WSGI</strong></h2><p>1、wsgi server (比如uWSGI） 要和 wsgi application（比如django ）交互，uwsgi需要将过来的请求转给django 处理，那么uWSGI 和 django的交互和调用就需要一个统一的规范，这个规范就是WSGI WSGI（Web Server Gateway Interface）</p>
<p>2、WSGI，全称 Web Server Gateway Interface，或者 Python Web Server Gateway Interface ，是为 Python 语言定义的 Web 服务器和 Web 应用程序或框架之间的一种简单而通用的接口。自从 WSGI 被开发出来以后，许多其它语言中也出现了类似接口。</p>
<p>3、WSGI 的官方定义是，the Python Web Server Gateway Interface。从名字就可以看出来，这东西是一个Gateway，也就是网关。网关的作用就是在协议之间进行转换。</p>
<p>4、WSGI 是作为 Web 服务器与 Web 应用程序或应用框架之间的一种低级别的接口，以提升可移植 Web 应用开发的共同点。WSGI 是基于现存的 CGI 标准而设计的</p>
<p> 5、一句话总结： 为Python定义的web服务器和web框架之间的接口标准</p>
<h2 id="ASGI"><a href="#ASGI" class="headerlink" title="ASGI"></a><strong>ASGI</strong></h2><p>异步网关接口（Asynchronous Server Gateway Interface），是WSGI的扩展版本，旨在为Python Web服务、框架和应用之间提供一个标准的异步接口。其本身可以提供同步和异步应用，并且可以并行处理。还能处理多种通用协议，包括HTTP，HTTP2和WebSocket。同WSGI一样，需要有独立的服务器实现这种异步的网关接口，比如Daphne、Uvicorn、Hypercorn等，</p>
<p><strong>通用型网关接口：CGI、FastCGI</strong></p>
<p>网关接口是一种协议，为了实现加载动态脚本。CGI程序则是实现了CGI协议的一种程序</p>
<p><strong>Web服务器网关接口协议：WSGI、ASGI、uwsgi</strong></p>
<p>网关接口是用于Web应用与Web服务器进行通讯。其中WSGI、ASGI是专为python设计的网关接口。uwsgi是uWSGI服务器自有的传输协议</p>
<p><strong>实现了Web服务器网关接口的软件有</strong>：</p>
<p>uWSGI（注意大小写）、uvicorn、gunicorn</p>
<p><strong>要注意 WSGI / uwsgi / uWSGI 这三个概念的区分。</strong></p>
<ul>
<li>WSGI看过前面的同学很清楚了，是一种通信协议。</li>
<li>uwsgi同WSGI一样是一种通信协议。</li>
<li>而uWSGI是实现了uwsgi和WSGI两种协议的Web服务器。</li>
</ul>
<p><strong>同步异步</strong>：同步是指执行是串行的，需要处理完当前任务在处理一下；异步指并行的，现有的任务不影响下一个任务的执行。类比到请求上面就是假如同时有两个请求进来，在同步处理的框架下第二个请求需要等第一个结束之后才能响应，而异步就可以并行处理</p>
<div class="table-container">
<table>
<thead>
<tr>
<th>协议，规范</th>
<th>支持的请求协议（常见，未列全）</th>
<th>同步/异步</th>
<th>支持的框架</th>
</tr>
</thead>
<tbody>
<tr>
<td>CGI</td>
<td>HTTP</td>
<td></td>
<td>CGI程序</td>
</tr>
<tr>
<td>WSGI</td>
<td>HTTP</td>
<td>同步</td>
<td>Flup，Flask</td>
</tr>
<tr>
<td>ASGI</td>
<td>HTTP，HTTP2，WebSocket等</td>
<td>同步/异步</td>
<td>FastAPI，Quart，Sanic，Vibora，Tornado</td>
</tr>
</tbody>
</table>
</div>
<h1 id="二、-web服务器和web应用框架关系总结"><a href="#二、-web服务器和web应用框架关系总结" class="headerlink" title="二、 web服务器和web应用框架关系总结"></a>二、 web服务器和web应用框架关系总结</h1><p>web 服务器 和 web 应用[框架]，分工不同，职责不同（web 服务器专注于接收并解析请求以调用的方式将请求的内容传web框架），缺一不可，可以说它们是两个组件，共同协作才能实现web网页的访问。</p>
<p>web服务器端程序有Nginx+uWSGI的组合使用，如访问量少可单独使用uWSGI。</p>
<p>web应用（框架）有python开发的应用，或者使用python框架django、flask、Tornado等开发的应用。</p>
<p>用户浏览器，通过访问web服务器获取web应用（框架）提供的后台服务。下面用三个图反复描述他们之间的关系。</p>
<p><img src="/2022/06/06/web%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%92%8Cweb%E5%BA%94%E7%94%A8%E6%A1%86%E6%9E%B6%E5%85%B3%E7%B3%BB%E4%BB%A5%E5%8F%8A%E4%BB%8B%E7%BB%8D/2.jpg" style="zoom: 150%;"></p>
<p><strong>对这张图有一段话解释这里借鉴一下</strong></p>
<p>首先nginx 是对外的服务接口，外部浏览器通过url访问nginx,</p>
<p>nginx 接收到浏览器发送过来的http请求，将包进行解析，分析url，如果是静态文件请求就直接访问用户给nginx配置的静态文件目录，直接返回用户请求的静态文件， 如果不是静态文件，而是一个动态的请求，那么nginx就将请求转发给uwsgi,uwsgi 接收到请求之后将包进行处理，处理成wsgi可以接受的格式，并发给wsgi,wsgi 根据请求调用应用程序的某个文件，某个文件的某个函数，最后处理完将返回值再次交给wsgi,wsgi将返回值进行打包，打包成uwsgi能够接收的格式，uwsgi接收wsgi 发送的请求，并转发给nginx,nginx最终将返回值返回给浏览器。</p>
<p>要知道第一级的nginx并不是必须的，uwsgi完全可以完成整个的和浏览器交互的流程，但是要考虑到某些情况</p>
<p> <strong>a. 安全问题，</strong>程序不能直接被浏览器访问到，而是通过nginx,nginx只开放某个接口，uwsgi本身是内网接口，这样运维人员在nginx上加上安全性的限制，可以达到保护程序的作用。</p>
<p> <strong>b. 负载均衡问题</strong>，一个uwsgi很可能不够用，即使开了多个work也是不行，毕竟一台机器的cpu和内存都是有限的，有了nginx做代理，一个nginx可以代理多台uwsgi完成uwsgi的负载均衡。</p>
<p> <strong>c. 静态文件问题</strong>，用django或是uwsgi这种东西来负责静态文件的处理是很浪费的行为，而且他们本身对文件的处理也不如nginx好，所以整个静态文件的处理都直接由nginx完成，静态文件的访问完全不去经过uwsgi以及其后面的东西。</p>
<p>图二</p>
<p><img src="/2022/06/06/web%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%92%8Cweb%E5%BA%94%E7%94%A8%E6%A1%86%E6%9E%B6%E5%85%B3%E7%B3%BB%E4%BB%A5%E5%8F%8A%E4%BB%8B%E7%BB%8D/1.jpg" style="zoom: 150%;"></p>
<p>图三、</p>
<p><img src="/2022/06/06/web%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%92%8Cweb%E5%BA%94%E7%94%A8%E6%A1%86%E6%9E%B6%E5%85%B3%E7%B3%BB%E4%BB%A5%E5%8F%8A%E4%BB%8B%E7%BB%8D/3.jpg" style="zoom: 150%;"></p>
<p><strong>参考链接：</strong></p>
<p>1、一文读懂WSGI和ASGI</p>
<p><a href="https://blog.csdn.net/p515659704/article/details/110411508" target="_blank" rel="noopener">https://blog.csdn.net/p515659704/article/details/110411508</a></p>
<p>2、web服务器和web应用(框架)的关系梳理，兼谈nginx、wsgi、uWSGI、uwsgi、django</p>
<p><a href="https://www.cnblogs.com/yanjidong/articles/13198697.html" target="_blank" rel="noopener">https://www.cnblogs.com/yanjidong/articles/13198697.html</a></p>
<p>3、uWSGI详解</p>
<p><a href="https://zhuanlan.zhihu.com/p/36448645" target="_blank" rel="noopener">https://zhuanlan.zhihu.com/p/36448645</a></p>
<p>4、FastCGI</p>
<p><a href="https://www.jianshu.com/p/565217337247" target="_blank" rel="noopener">https://www.jianshu.com/p/565217337247</a></p>
<p><strong>结束语</strong>：</p>
<p>​    今天的分享就到这里了，欢迎大家关注微信公众号”<strong>菜鸟童靴</strong>“</p>
<p><img src="/2022/06/06/web%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%92%8Cweb%E5%BA%94%E7%94%A8%E6%A1%86%E6%9E%B6%E5%85%B3%E7%B3%BB%E4%BB%A5%E5%8F%8A%E4%BB%8B%E7%BB%8D/微信.png" style="zoom: 50%;"></p>
]]></content>
      <categories>
        <category>后端</category>
      </categories>
      <tags>
        <tag>后端</tag>
        <tag>web服务器</tag>
      </tags>
  </entry>
  <entry>
    <title>SpringBoot集成Druid数据库连接池</title>
    <url>/2022/05/24/SpringBoot%E9%9B%86%E6%88%90Druid%E6%95%B0%E6%8D%AE%E5%BA%93%E8%BF%9E%E6%8E%A5%E6%B1%A0/</url>
    <content><![CDATA[<p>hello 大家好我是Monday，今天我们开启SpringBoot的学习的系列文章之SpringBoot集成Druid数据库连接池。</p>
<a id="more"></a>
<p><strong>什么是Druid</strong><br>Java程序很大一部分要操作数据库，为了提高性能操作数据库的时候，又不得不使用数据库连接池。</p>
<p>Druid 是阿里巴巴开源平台上一个数据库连接池实现，但它不仅仅是一个数据库连接池，它还包含一个ProxyDriver（代理驱动程序），一系列内置的JDBC组件库，一个SQL Parser(SQL解析器)。</p>
<p>Druid结合了 C3P0、DBCP 等 DB 池的优点，同时加入了日志监控，可以很好的监控 DB 池连接和 SQL 的执行情况，天生就是针对监控而生的 DB 连接池。（来源网络）</p>
<p><strong>导入maven依赖：</strong></p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!--MySQL连接--&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">version</span>&gt;</span>5.1.39<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">		<span class="comment">&lt;!-- 连接池 --&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>druid<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0.31<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">		<span class="comment">&lt;!--dao层:mybatis--&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.mybatis.spring.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">version</span>&gt;</span>1.2.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p><strong>设置Druid的配置</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">############################################################</span><br><span class="line">#</span><br><span class="line"># mysql数据库配置</span><br><span class="line">#</span><br><span class="line">############################################################</span><br><span class="line"></span><br><span class="line">spring.datasource.url &#x3D; jdbc:mysql:&#x2F;&#x2F;localhost:3306&#x2F;wechat  &#x2F;&#x2F;数据库URL</span><br><span class="line">spring.datasource.username &#x3D; root   &#x2F;&#x2F;账号</span><br><span class="line">spring.datasource.password &#x3D; 123456  &#x2F;&#x2F;密码</span><br><span class="line">spring.datasource.driverClassName &#x3D; com.mysql.jdbc.Driver    &#x2F;&#x2F; 驱动</span><br><span class="line">## 指定使用druid 表明不使用默认的Hikari</span><br><span class="line">spring.datasource.type&#x3D; com.alibaba.druid.pool.DruidDataSource</span><br><span class="line"></span><br><span class="line">## #############配置druid参数######################</span><br><span class="line">#druid_config</span><br><span class="line">#用户名</span><br><span class="line">druid.login.username&#x3D;root</span><br><span class="line">#密码</span><br><span class="line">druid.login.password&#x3D;root</span><br><span class="line"></span><br><span class="line"># 配置一个连接在池中最小生存的时间，单位是毫秒，下面是：5分钟</span><br><span class="line">spring.datasource.druid.min-evictable-idle-time-millis&#x3D; 300000</span><br><span class="line"># 打开PSCache，并且指定每个连接上PSCache的大小</span><br><span class="line">spring.datasource.druid.pool-prepared-statements&#x3D; true</span><br><span class="line">spring.datasource.druid.max-pool-prepared-statement-per-connection-size&#x3D;20</span><br><span class="line"># 初始化大小，最小，最大</span><br><span class="line">spring.datasource.druid.initial-size&#x3D;5</span><br><span class="line">spring.datasource.druid.min-idle&#x3D; 3</span><br><span class="line"># 最大连接池数量</span><br><span class="line">spring.datasource.druid.max-active&#x3D; 20</span><br><span class="line"># 配置获取连接等待超时的时间</span><br><span class="line">spring.datasource.druid.max-wait&#x3D; 60000</span><br><span class="line"># 配置间隔多久才进行一次检测，检测需要关闭的空闲连接，单位是毫秒，下面是：1分钟</span><br><span class="line">spring.datasource.druid.time-between-eviction-runs-millis&#x3D; 60000</span><br><span class="line"></span><br><span class="line"># asyncInit是1.1.4中新增加的配置，如果有initialSize数量较多时，打开会加快应用启动时间</span><br><span class="line">spring.datasource.druid.asyncInit&#x3D;true</span><br><span class="line"></span><br><span class="line"># 配置监控统计拦截的filters，去掉后监控界面sql无法统计，&#39;wall&#39;用于防火墙</span><br><span class="line">spring.datasource.druid.filters&#x3D;stat,wall,log4j,config</span><br><span class="line"></span><br><span class="line">spring.datasource.druid.validation-query: select &#39;x&#39;</span><br></pre></td></tr></table></figure>
<p><strong>配置Druid数据源监控</strong></p>
<p><strong>Druid 数据源具有监控的功能，并提供了一个 web 界面方便用户查看</strong></p>
<p><strong>1、配置 Druid 监控管理后台的Servlet</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.demo.config;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.druid.pool.DruidDataSource;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.druid.support.http.StatViewServlet;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.druid.support.http.WebStatFilter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Value;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.context.properties.ConfigurationProperties;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.web.servlet.FilterRegistrationBean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.web.servlet.ServletRegistrationBean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.sql.DataSource;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DruidConfig</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;druid.login.username&#125;"</span>)</span><br><span class="line">    <span class="keyword">private</span> String userName;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;druid.login.password&#125;"</span>)</span><br><span class="line">    <span class="keyword">private</span> String password;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@ConfigurationProperties</span>(prefix =<span class="string">"spring.datasource"</span>)<span class="comment">//和配置文件绑定</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> DataSource <span class="title">druidDataSource</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> DruidDataSource();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//获取后台监控</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="comment">//由于 SpringBoot 默认是以 jar 包的方式启动嵌入式的 Servlet 容器来启动 SpringBoot 的 web 应用，没有 web.xml 文件。</span></span><br><span class="line">    <span class="comment">// 所以想用使用 Servlet 功能，就必须要借用 Spring Boot 提供的 ServletRegistrationBean 接口。</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ServletRegistrationBean <span class="title">servletRegistration</span><span class="params">()</span></span>&#123;</span><br><span class="line">        ServletRegistrationBean&lt;StatViewServlet&gt; bean = <span class="keyword">new</span> ServletRegistrationBean&lt;&gt;(<span class="keyword">new</span> StatViewServlet(),<span class="string">"/druid/*"</span>);   <span class="comment">//StatViewServlet用于展示Druid的统计信息</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//设置后台登录的账户和密码</span></span><br><span class="line">        HashMap&lt;String, String&gt; initParameters = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//增加配置 登录的key是固定的</span></span><br><span class="line"><span class="comment">//        initParameters.put("loginUsername","admin");</span></span><br><span class="line"><span class="comment">//        initParameters.put("loginPassword","123456");</span></span><br><span class="line">        initParameters.put(<span class="string">"loginUsername"</span>,userName);</span><br><span class="line">        initParameters.put(<span class="string">"loginPassword"</span>,password);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//设置谁可以访问</span></span><br><span class="line">        initParameters.put(<span class="string">"allow"</span>,<span class="string">""</span>);<span class="comment">//任何人都可以访问</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//设置初始化参数</span></span><br><span class="line">        bean.setInitParameters(initParameters);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> bean;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//配置filter 过滤器</span></span><br><span class="line">    <span class="comment">//WebStatFilter：用于配置Web和Druid数据源之间的管理关联监控统计</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> FilterRegistrationBean <span class="title">filterRegistrationBean</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        FilterRegistrationBean filterRegistrationBean = <span class="keyword">new</span> FilterRegistrationBean();</span><br><span class="line">        filterRegistrationBean.setFilter(<span class="keyword">new</span> WebStatFilter());</span><br><span class="line">        filterRegistrationBean.addUrlPatterns(<span class="string">"/*"</span>);</span><br><span class="line">        filterRegistrationBean.addInitParameter(<span class="string">"exclusions"</span>, <span class="string">"*.js,*.gif,*.jpg,*.png,*.css,*.ico,/druid/*"</span>);</span><br><span class="line">        <span class="keyword">return</span> filterRegistrationBean;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>2、启动SpringBoot测试，访问<code>http://localhost:8080/druid</code></strong></p>
<p>网页登录用户名和密码就OK了</p>
<p><strong>参考链接：</strong></p>
<p>Spring Boot——集成Druid数据库连接池</p>
<p><a href="https://blog.csdn.net/wpc2018/article/details/116948255" target="_blank" rel="noopener">https://blog.csdn.net/wpc2018/article/details/116948255</a></p>
<p>Druid使用手册</p>
<p><a href="https://www.bookstack.cn/read/Druid/06014f428e7b0263.md" target="_blank" rel="noopener">https://www.bookstack.cn/read/Druid/06014f428e7b0263.md</a></p>
<p>SpringBoot配置 Druid 连接池(application.properties参数配置详解</p>
<p><a href="https://blog.csdn.net/yuekangwei/article/details/121369124" target="_blank" rel="noopener">https://blog.csdn.net/yuekangwei/article/details/121369124</a></p>
<p><strong>结束语</strong>：</p>
<p>​    今天的分享就到这里了，欢迎大家关注微信公众号”<strong>菜鸟童靴</strong>“</p>
<p><img src="/2022/05/24/SpringBoot%E9%9B%86%E6%88%90Druid%E6%95%B0%E6%8D%AE%E5%BA%93%E8%BF%9E%E6%8E%A5%E6%B1%A0/微信.png" style="zoom: 50%;"></p>
]]></content>
      <categories>
        <category>SpringBoot</category>
      </categories>
      <tags>
        <tag>java</tag>
        <tag>SpringBoot</tag>
      </tags>
  </entry>
  <entry>
    <title>SpringBoot日志处理</title>
    <url>/2022/05/23/SpringBoot%E6%97%A5%E5%BF%97%E5%A4%84%E7%90%86/</url>
    <content><![CDATA[<p>hello 大家好我是Monday，今天我们开启SpringBoot的学习的系列文章之SpringBoot日志处理。</p>
<a id="more"></a>
<p>Springboot的日志的框架比较丰富，而且Springboot本身就内置了日志功能，不过实际项目中会出现：只记录想要的日志，日志输出到磁盘，按天归档，日志信息同步到其他系统等功能。这些是Springboot本身就内置了日志功能不具备的。</p>
<p>logback日志SpringBoot自带的，所以依赖什么的就不用引了！首先我们在resources下面创建一个官方推荐：logback-spring.xml大家按照这个名字创建，不要其他名字。因为带spring后缀的可以使用《springProfile》这个标签而且SpringBoot会自动查找。</p>
<p>下面我们就以logback讲讲Spring Boot中的日志收集。</p>
<h2 id="为什么要统一日志"><a href="#为什么要统一日志" class="headerlink" title="为什么要统一日志"></a><strong>为什么要统一日志</strong></h2><p>前面我们说了Springboot 本身就可以日志功能，为什么还需要统一规范日志？</p>
<p>1、日志统一，方便查阅管理。 </p>
<p>2、日志分割归档功能。</p>
<p>3、日志持久化功能。</p>
<p> 4、方便日志系统（ELK）收集。</p>
<p>我们在resources 文件夹下创建logback-spring.xml文件，文件内容如下（来源于网络）：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- 日志级别从低到高分为TRACE &lt; DEBUG &lt; INFO &lt; WARN &lt; ERROR &lt; FATAL，如果设置为WARN，则低于WARN的信息都不会输出 --&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- scan:当此属性设置为true时，配置文档如果发生改变，将会被重新加载，默认值为true --&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- scanPeriod:设置监测配置文档是否有修改的时间间隔，如果没有给出时间单位，默认单位是毫秒。</span></span><br><span class="line"><span class="comment">                 当scan为true时，此属性生效。默认的时间间隔为1分钟。 --&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- de<span class="doctag">bug:</span>当此属性设置为true时，将打印出logback内部日志信息，实时查看logback运行状态。默认值为false。 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">configuration</span>  <span class="attr">scan</span>=<span class="string">"true"</span> <span class="attr">scanPeriod</span>=<span class="string">"10 seconds"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">contextName</span>&gt;</span>logback<span class="tag">&lt;/<span class="name">contextName</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- name的值是变量的名称，value的值时变量定义的值。通过定义的值会被插入到logger上下文中。</span></span><br><span class="line"><span class="comment">    定义后，可以使“$&#123;&#125;”来使用变量。 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"log.path"</span> <span class="attr">value</span>=<span class="string">"log"</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--0. 日志格式和颜色渲染 --&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 彩色日志依赖的渲染类 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">conversionRule</span> <span class="attr">conversionWord</span>=<span class="string">"clr"</span> <span class="attr">converterClass</span>=<span class="string">"org.springframework.boot.logging.logback.ColorConverter"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">conversionRule</span> <span class="attr">conversionWord</span>=<span class="string">"wex"</span> <span class="attr">converterClass</span>=<span class="string">"org.springframework.boot.logging.logback.WhitespaceThrowableProxyConverter"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">conversionRule</span> <span class="attr">conversionWord</span>=<span class="string">"wEx"</span> <span class="attr">converterClass</span>=<span class="string">"org.springframework.boot.logging.logback.ExtendedWhitespaceThrowableProxyConverter"</span> /&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 彩色日志格式 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"CONSOLE_LOG_PATTERN"</span> <span class="attr">value</span>=<span class="string">"$&#123;CONSOLE_LOG_PATTERN:-%clr(%d&#123;yyyy-MM-dd HH:mm:ss.SSS&#125;)&#123;faint&#125; %clr($&#123;LOG_LEVEL_PATTERN:-%5p&#125;) %clr($&#123;PID:- &#125;)&#123;magenta&#125; %clr(---)&#123;faint&#125; %clr([%15.15t])&#123;faint&#125; %clr(%-40.40logger&#123;39&#125;)&#123;cyan&#125; %clr(:)&#123;faint&#125; %m%n$&#123;LOG_EXCEPTION_CONVERSION_WORD:-%wEx&#125;&#125;"</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--1. 输出到控制台--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">appender</span> <span class="attr">name</span>=<span class="string">"CONSOLE"</span> <span class="attr">class</span>=<span class="string">"ch.qos.logback.core.ConsoleAppender"</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--此日志appender是为开发使用，只配置最底级别，控制台输出的日志级别是大于或等于此级别的日志信息--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">filter</span> <span class="attr">class</span>=<span class="string">"ch.qos.logback.classic.filter.ThresholdFilter"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">level</span>&gt;</span>debug<span class="tag">&lt;/<span class="name">level</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">filter</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">encoder</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">Pattern</span>&gt;</span>$&#123;CONSOLE_LOG_PATTERN&#125;<span class="tag">&lt;/<span class="name">Pattern</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!-- 设置字符集 --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">charset</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">charset</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">encoder</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">appender</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--2. 输出到文档--&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 2.1 level为 DEBUG 日志，时间滚动输出  --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">appender</span> <span class="attr">name</span>=<span class="string">"DEBUG_FILE"</span> <span class="attr">class</span>=<span class="string">"ch.qos.logback.core.rolling.RollingFileAppender"</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 正在记录的日志文档的路径及文档名 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">file</span>&gt;</span>$&#123;log.path&#125;/edu_debug.log<span class="tag">&lt;/<span class="name">file</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--日志文档输出格式--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">encoder</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">pattern</span>&gt;</span>%d&#123;yyyy-MM-dd HH:mm:ss.SSS&#125; [%thread] %-5level %logger&#123;50&#125; - %msg%n<span class="tag">&lt;/<span class="name">pattern</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">charset</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">charset</span>&gt;</span> <span class="comment">&lt;!-- 设置字符集 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">encoder</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 日志记录器的滚动策略，按日期，按大小记录 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">rollingPolicy</span> <span class="attr">class</span>=<span class="string">"ch.qos.logback.core.rolling.TimeBasedRollingPolicy"</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!-- 日志归档 --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">fileNamePattern</span>&gt;</span>$&#123;log.path&#125;/web-debug-%d&#123;yyyy-MM-dd&#125;.%i.log<span class="tag">&lt;/<span class="name">fileNamePattern</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">timeBasedFileNamingAndTriggeringPolicy</span> <span class="attr">class</span>=<span class="string">"ch.qos.logback.core.rolling.SizeAndTimeBasedFNATP"</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">maxFileSize</span>&gt;</span>100MB<span class="tag">&lt;/<span class="name">maxFileSize</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">timeBasedFileNamingAndTriggeringPolicy</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!--日志文档保留天数--&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">maxHistory</span>&gt;</span>15<span class="tag">&lt;/<span class="name">maxHistory</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">rollingPolicy</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 此日志文档只记录debug级别的 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">filter</span> <span class="attr">class</span>=<span class="string">"ch.qos.logback.classic.filter.LevelFilter"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">level</span>&gt;</span>debug<span class="tag">&lt;/<span class="name">level</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">onMatch</span>&gt;</span>ACCEPT<span class="tag">&lt;/<span class="name">onMatch</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">onMismatch</span>&gt;</span>DENY<span class="tag">&lt;/<span class="name">onMismatch</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">filter</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">appender</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 2.2 level为 INFO 日志，时间滚动输出  --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">appender</span> <span class="attr">name</span>=<span class="string">"INFO_FILE"</span> <span class="attr">class</span>=<span class="string">"ch.qos.logback.core.rolling.RollingFileAppender"</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 正在记录的日志文档的路径及文档名 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">file</span>&gt;</span>$&#123;log.path&#125;/edu_info.log<span class="tag">&lt;/<span class="name">file</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--日志文档输出格式--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">encoder</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">pattern</span>&gt;</span>%d&#123;yyyy-MM-dd HH:mm:ss.SSS&#125; [%thread] %-5level %logger&#123;50&#125; - %msg%n<span class="tag">&lt;/<span class="name">pattern</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">charset</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">charset</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">encoder</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 日志记录器的滚动策略，按日期，按大小记录 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">rollingPolicy</span> <span class="attr">class</span>=<span class="string">"ch.qos.logback.core.rolling.TimeBasedRollingPolicy"</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!-- 每天日志归档路径以及格式 --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">fileNamePattern</span>&gt;</span>$&#123;log.path&#125;/web-info-%d&#123;yyyy-MM-dd&#125;.%i.log<span class="tag">&lt;/<span class="name">fileNamePattern</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">timeBasedFileNamingAndTriggeringPolicy</span> <span class="attr">class</span>=<span class="string">"ch.qos.logback.core.rolling.SizeAndTimeBasedFNATP"</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">maxFileSize</span>&gt;</span>100MB<span class="tag">&lt;/<span class="name">maxFileSize</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">timeBasedFileNamingAndTriggeringPolicy</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!--日志文档保留天数--&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">maxHistory</span>&gt;</span>15<span class="tag">&lt;/<span class="name">maxHistory</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">rollingPolicy</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 此日志文档只记录info级别的 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">filter</span> <span class="attr">class</span>=<span class="string">"ch.qos.logback.classic.filter.LevelFilter"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">level</span>&gt;</span>info<span class="tag">&lt;/<span class="name">level</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">onMatch</span>&gt;</span>ACCEPT<span class="tag">&lt;/<span class="name">onMatch</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">onMismatch</span>&gt;</span>DENY<span class="tag">&lt;/<span class="name">onMismatch</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">filter</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">appender</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 2.3 level为 WARN 日志，时间滚动输出  --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">appender</span> <span class="attr">name</span>=<span class="string">"WARN_FILE"</span> <span class="attr">class</span>=<span class="string">"ch.qos.logback.core.rolling.RollingFileAppender"</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 正在记录的日志文档的路径及文档名 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">file</span>&gt;</span>$&#123;log.path&#125;/edu_warn.log<span class="tag">&lt;/<span class="name">file</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--日志文档输出格式--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">encoder</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">pattern</span>&gt;</span>%d&#123;yyyy-MM-dd HH:mm:ss.SSS&#125; [%thread] %-5level %logger&#123;50&#125; - %msg%n<span class="tag">&lt;/<span class="name">pattern</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">charset</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">charset</span>&gt;</span> <span class="comment">&lt;!-- 此处设置字符集 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">encoder</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 日志记录器的滚动策略，按日期，按大小记录 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">rollingPolicy</span> <span class="attr">class</span>=<span class="string">"ch.qos.logback.core.rolling.TimeBasedRollingPolicy"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">fileNamePattern</span>&gt;</span>$&#123;log.path&#125;/web-warn-%d&#123;yyyy-MM-dd&#125;.%i.log<span class="tag">&lt;/<span class="name">fileNamePattern</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">timeBasedFileNamingAndTriggeringPolicy</span> <span class="attr">class</span>=<span class="string">"ch.qos.logback.core.rolling.SizeAndTimeBasedFNATP"</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">maxFileSize</span>&gt;</span>100MB<span class="tag">&lt;/<span class="name">maxFileSize</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">timeBasedFileNamingAndTriggeringPolicy</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!--日志文档保留天数--&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">maxHistory</span>&gt;</span>15<span class="tag">&lt;/<span class="name">maxHistory</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">rollingPolicy</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 此日志文档只记录warn级别的 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">filter</span> <span class="attr">class</span>=<span class="string">"ch.qos.logback.classic.filter.LevelFilter"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">level</span>&gt;</span>warn<span class="tag">&lt;/<span class="name">level</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">onMatch</span>&gt;</span>ACCEPT<span class="tag">&lt;/<span class="name">onMatch</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">onMismatch</span>&gt;</span>DENY<span class="tag">&lt;/<span class="name">onMismatch</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">filter</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">appender</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 2.4 level为 ERROR 日志，时间滚动输出  --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">appender</span> <span class="attr">name</span>=<span class="string">"ERROR_FILE"</span> <span class="attr">class</span>=<span class="string">"ch.qos.logback.core.rolling.RollingFileAppender"</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 正在记录的日志文档的路径及文档名 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">file</span>&gt;</span>$&#123;log.path&#125;/edu_error.log<span class="tag">&lt;/<span class="name">file</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--日志文档输出格式--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">encoder</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">pattern</span>&gt;</span>%d&#123;yyyy-MM-dd HH:mm:ss.SSS&#125; [%thread] %-5level %logger&#123;50&#125; - %msg%n<span class="tag">&lt;/<span class="name">pattern</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">charset</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">charset</span>&gt;</span> <span class="comment">&lt;!-- 此处设置字符集 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">encoder</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 日志记录器的滚动策略，按日期，按大小记录 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">rollingPolicy</span> <span class="attr">class</span>=<span class="string">"ch.qos.logback.core.rolling.TimeBasedRollingPolicy"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">fileNamePattern</span>&gt;</span>$&#123;log.path&#125;/web-error-%d&#123;yyyy-MM-dd&#125;.%i.log<span class="tag">&lt;/<span class="name">fileNamePattern</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">timeBasedFileNamingAndTriggeringPolicy</span> <span class="attr">class</span>=<span class="string">"ch.qos.logback.core.rolling.SizeAndTimeBasedFNATP"</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">maxFileSize</span>&gt;</span>100MB<span class="tag">&lt;/<span class="name">maxFileSize</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">timeBasedFileNamingAndTriggeringPolicy</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!--日志文档保留天数--&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">maxHistory</span>&gt;</span>15<span class="tag">&lt;/<span class="name">maxHistory</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">rollingPolicy</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 此日志文档只记录ERROR级别的 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">filter</span> <span class="attr">class</span>=<span class="string">"ch.qos.logback.classic.filter.LevelFilter"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">level</span>&gt;</span>ERROR<span class="tag">&lt;/<span class="name">level</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">onMatch</span>&gt;</span>ACCEPT<span class="tag">&lt;/<span class="name">onMatch</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">onMismatch</span>&gt;</span>DENY<span class="tag">&lt;/<span class="name">onMismatch</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">filter</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">appender</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--</span></span><br><span class="line"><span class="comment">        &lt;logger&gt;用来设置某一个包或者具体的某一个类的日志打印级别、</span></span><br><span class="line"><span class="comment">        以及指定&lt;appender&gt;。&lt;logger&gt;仅有一个name属性，</span></span><br><span class="line"><span class="comment">        一个可选的level和一个可选的addtivity属性。</span></span><br><span class="line"><span class="comment">        name:用来指定受此logger约束的某一个包或者具体的某一个类。</span></span><br><span class="line"><span class="comment">        level:用来设置打印级别，大小写无关：TRACE, DEBUG, INFO, WARN, ERROR, ALL 和 OFF，</span></span><br><span class="line"><span class="comment">              还有一个特俗值INHERITED或者同义词NULL，代表强制执行上级的级别。</span></span><br><span class="line"><span class="comment">              如果未设置此属性，那么当前logger将会继承上级的级别。</span></span><br><span class="line"><span class="comment">        addtivity:是否向上级logger传递打印信息。默认是true。</span></span><br><span class="line"><span class="comment">        &lt;logger name="org.springframework.web" level="info"/&gt;</span></span><br><span class="line"><span class="comment">        &lt;logger name="org.springframework.scheduling.annotation.ScheduledAnnotationBeanPostProcessor" level="INFO"/&gt;</span></span><br><span class="line"><span class="comment">    --&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--</span></span><br><span class="line"><span class="comment">        使用mybatis的时候，sql语句是debug下才会打印，而这里我们只配置了info，所以想要查看sql语句的话，有以下两种操作：</span></span><br><span class="line"><span class="comment">        第一种把&lt;root level="info"&gt;改成&lt;root level="DEBUG"&gt;这样就会打印sql，不过这样日志那边会出现很多其他消息</span></span><br><span class="line"><span class="comment">        第二种就是单独给dao下目录配置debug模式，代码如下，这样配置sql语句会打印，其他还是正常info级别：</span></span><br><span class="line"><span class="comment">        【logging.level.org.mybatis=debug logging.level.dao=debug】</span></span><br><span class="line"><span class="comment">     --&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--</span></span><br><span class="line"><span class="comment">        root节点是必选节点，用来指定最基础的日志输出级别，只有一个level属性</span></span><br><span class="line"><span class="comment">        level:用来设置打印级别，大小写无关：TRACE, DEBUG, INFO, WARN, ERROR, ALL 和 OFF，</span></span><br><span class="line"><span class="comment">        不能设置为INHERITED或者同义词NULL。默认是DEBUG</span></span><br><span class="line"><span class="comment">        可以包含零个或多个元素，标识这个appender将会添加到这个logger。</span></span><br><span class="line"><span class="comment">    --&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 4. 最终的策略 --&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 4.1 开发环境:打印控制台--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">springProfile</span> <span class="attr">name</span>=<span class="string">"dev"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">logger</span> <span class="attr">name</span>=<span class="string">"com.cms"</span> <span class="attr">level</span>=<span class="string">"info"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">root</span> <span class="attr">level</span>=<span class="string">"info"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">appender-ref</span> <span class="attr">ref</span>=<span class="string">"CONSOLE"</span> /&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">appender-ref</span> <span class="attr">ref</span>=<span class="string">"DEBUG_FILE"</span> /&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">appender-ref</span> <span class="attr">ref</span>=<span class="string">"INFO_FILE"</span> /&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">appender-ref</span> <span class="attr">ref</span>=<span class="string">"WARN_FILE"</span> /&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">appender-ref</span> <span class="attr">ref</span>=<span class="string">"ERROR_FILE"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">root</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">springProfile</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 4.2 生产环境:输出到文档--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">springProfile</span> <span class="attr">name</span>=<span class="string">"pro"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">logger</span> <span class="attr">name</span>=<span class="string">"com.cms"</span> <span class="attr">level</span>=<span class="string">"warn"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">root</span> <span class="attr">level</span>=<span class="string">"info"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">appender-ref</span> <span class="attr">ref</span>=<span class="string">"ERROR_FILE"</span> /&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">appender-ref</span> <span class="attr">ref</span>=<span class="string">"WARN_FILE"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">root</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">springProfile</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!--    &amp;lt;!&amp;ndash; 默认日志输出级别 &amp;ndash;&amp;gt;--&gt;</span></span><br><span class="line"><span class="comment">&lt;!--    &lt;root level="DEBUG"&gt;--&gt;</span></span><br><span class="line"><span class="comment">&lt;!--        &lt;appender-ref ref="CONSOLE" /&gt;--&gt;</span></span><br><span class="line"><span class="comment">&lt;!--        &lt;appender-ref ref="DEBUG_FILE" /&gt;--&gt;</span></span><br><span class="line"><span class="comment">&lt;!--        &lt;appender-ref ref="INFO_FILE" /&gt;--&gt;</span></span><br><span class="line"><span class="comment">&lt;!--        &lt;appender-ref ref="WARN_FILE" /&gt;--&gt;</span></span><br><span class="line"><span class="comment">&lt;!--        &lt;appender-ref ref="ERROR_FILE" /&gt;--&gt;</span></span><br><span class="line"><span class="comment">&lt;!--    &lt;/root&gt;--&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>配置日志目录</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;property name&#x3D;&quot;log.path&quot; value&#x3D;&quot;log&quot; &#x2F;&gt;</span><br></pre></td></tr></table></figure>
<p>以下内容，就是我们开头所说的，带spring后缀的可以使用《springProfile》这个标签，</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 4. 最终的策略 --&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- 4.1 开发环境:打印控制台--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">springProfile</span> <span class="attr">name</span>=<span class="string">"dev"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">logger</span> <span class="attr">name</span>=<span class="string">"com.cms"</span> <span class="attr">level</span>=<span class="string">"info"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">root</span> <span class="attr">level</span>=<span class="string">"info"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">appender-ref</span> <span class="attr">ref</span>=<span class="string">"CONSOLE"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">appender-ref</span> <span class="attr">ref</span>=<span class="string">"DEBUG_FILE"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">appender-ref</span> <span class="attr">ref</span>=<span class="string">"INFO_FILE"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">appender-ref</span> <span class="attr">ref</span>=<span class="string">"WARN_FILE"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">appender-ref</span> <span class="attr">ref</span>=<span class="string">"ERROR_FILE"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">root</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">springProfile</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 4.2 生产环境:输出到文档--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">springProfile</span> <span class="attr">name</span>=<span class="string">"pro"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">logger</span> <span class="attr">name</span>=<span class="string">"com.cms"</span> <span class="attr">level</span>=<span class="string">"warn"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">root</span> <span class="attr">level</span>=<span class="string">"info"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">appender-ref</span> <span class="attr">ref</span>=<span class="string">"ERROR_FILE"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">appender-ref</span> <span class="attr">ref</span>=<span class="string">"WARN_FILE"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">root</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">springProfile</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>他可以区分你的不同生产环境的配置需求</p>
<p><img src="/2022/05/23/SpringBoot%E6%97%A5%E5%BF%97%E5%A4%84%E7%90%86/1.jpg" style="zoom: 150%;"></p>
<h2 id="配置application-properties"><a href="#配置application-properties" class="headerlink" title="配置application.properties"></a><strong>配置application.properties</strong></h2><p>在application.properties或者其他使用的自定义配置文件中配置logback</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"># # logback 配置,日志管理</span><br><span class="line">#日志配置,输出到文本，</span><br><span class="line">logging.config=classpath:logback-spring.xml</span><br><span class="line">#控制台默认日志级别修改</span><br><span class="line">logging.level.root=info</span><br><span class="line"># 指定输出日志的文件名，默认输出至当前项目目录下</span><br><span class="line">logging.file.path=springboot.log</span><br></pre></td></tr></table></figure>
<h2 id="程序中记录日志"><a href="#程序中记录日志" class="headerlink" title="程序中记录日志"></a><strong>程序中记录日志</strong></h2><p>在项目中创建LoggingController 控制器</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.demo.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.example.demo.bases.Result;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/log"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LoggingController</span> </span>&#123;</span><br><span class="line">    Logger logger = LoggerFactory.getLogger(getClass());</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping</span>(<span class="string">"/write"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Result <span class="title">writeLog</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="comment">// 级别由低到高 trace&lt;debug&lt;info&lt;warn&lt;error</span></span><br><span class="line">        logger.trace(<span class="string">"这是一个trace日志"</span>);</span><br><span class="line">        logger.debug(<span class="string">"这是一个debug日志"</span>);</span><br><span class="line">        logger.info(<span class="string">"这是一个info日志"</span>);</span><br><span class="line">        logger.warn(<span class="string">"这是一个warn日志"</span>);</span><br><span class="line">        logger.error(<span class="string">"这是一个error日志"</span>);</span><br><span class="line">        <span class="keyword">return</span> Result.success(<span class="string">"write log success"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="测试"><a href="#测试" class="headerlink" title="测试"></a><strong>测试</strong></h2><p>启动项目，</p>
<p>在浏览器输入：<a href="http://localhost:8081/log/write" target="_blank" rel="noopener">http://localhost:8081/log/write</a> ，(我的项目端口已经更改)</p>
<p>去相关目录下查看日志文件</p>
<p><img src="/2022/05/23/SpringBoot%E6%97%A5%E5%BF%97%E5%A4%84%E7%90%86/2.jpg" style="zoom: 150%;"></p>
<h2 id="进一步基于slf4j封装日志类输出日志"><a href="#进一步基于slf4j封装日志类输出日志" class="headerlink" title="进一步基于slf4j封装日志类输出日志"></a>进一步基于slf4j封装日志类输出日志</h2><p>新建package包utils，创建Log类，代码如下</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.demo.utils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.slf4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Log</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> String logPrefix = <span class="string">"demo log -&gt; "</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Log instance;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Logger logger = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Map&lt;Class, Logger&gt; loggerList = <span class="keyword">new</span> HashMap&lt;Class, Logger&gt;(); <span class="comment">//用于缓存logger对象</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">Log</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 定义私有构造方法实现单例</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">static</span> Log <span class="title">getInst</span><span class="params">(Object obj)</span> </span>&#123;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 功能说明：获取服务实例的静态方法</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> obj 传入调用此方法的对象</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">if</span> (instance == <span class="keyword">null</span>) &#123;</span><br><span class="line">            instance = <span class="keyword">new</span> Log();</span><br><span class="line">        &#125;</span><br><span class="line">        Log.logger = loggerList.get(obj.getClass());</span><br><span class="line">        <span class="keyword">if</span> (Log.logger == <span class="keyword">null</span>) &#123;</span><br><span class="line">            Log.logger = LoggerFactory.getLogger(obj.getClass());</span><br><span class="line">            <span class="comment">//Log.logger = Logger.getLogger(obj.getClass());</span></span><br><span class="line">            loggerList.put(obj.getClass(), Log.logger);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> instance;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">static</span> Log <span class="title">getInst</span><span class="params">(Class clazz)</span> </span>&#123;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 功能说明：获取服务实例的静态方法</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">if</span> (instance == <span class="keyword">null</span>) &#123;</span><br><span class="line">            instance = <span class="keyword">new</span> Log();</span><br><span class="line">        &#125;</span><br><span class="line">        Log.logger = loggerList.get(clazz);</span><br><span class="line">        <span class="keyword">if</span> (Log.logger == <span class="keyword">null</span>) &#123;</span><br><span class="line">            Log.logger = LoggerFactory.getLogger(clazz);</span><br><span class="line">            loggerList.put(clazz, Log.logger);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> instance;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">static</span> Log <span class="title">getInst</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 功能说明：获取服务实例的静态方法</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">if</span> (instance == <span class="keyword">null</span>) &#123;</span><br><span class="line">            instance = <span class="keyword">new</span> Log();</span><br><span class="line">        &#125;</span><br><span class="line">        Log.logger = loggerList.get(Log<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">        <span class="keyword">if</span> (Log.logger == <span class="keyword">null</span>) &#123;</span><br><span class="line">            Log.logger = LoggerFactory.getLogger(Log<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">            loggerList.put(Log<span class="class">.<span class="keyword">class</span>, <span class="title">Log</span>.<span class="title">logger</span>)</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> instance;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">trace</span><span class="params">(String message)</span> </span>&#123;</span><br><span class="line">        Log.logger.trace(logPrefix + message);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">trace</span><span class="params">(String message, Throwable t)</span> </span>&#123;</span><br><span class="line">        Log.logger.trace(logPrefix + message, t);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">debug</span><span class="params">(String message)</span> </span>&#123;</span><br><span class="line">        Log.logger.debug(logPrefix + message);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">debug</span><span class="params">(String message, Throwable t)</span> </span>&#123;</span><br><span class="line">        Log.logger.debug(logPrefix + message, t);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">info</span><span class="params">(String message)</span> </span>&#123;</span><br><span class="line">        Log.logger.info(logPrefix + message);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">info</span><span class="params">(String message, Throwable t)</span> </span>&#123;</span><br><span class="line">        Log.logger.info(logPrefix + message, t);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">warn</span><span class="params">(String message)</span> </span>&#123;</span><br><span class="line">        Log.logger.warn(logPrefix + message);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">warn</span><span class="params">(String message, Throwable t)</span> </span>&#123;</span><br><span class="line">        Log.logger.warn(logPrefix + message, t);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">error</span><span class="params">(String message,Object... arguments)</span> </span>&#123;</span><br><span class="line">        Log.logger.error(logPrefix + message,arguments);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">error</span><span class="params">(String message, Throwable t, Object... arguments)</span> </span>&#123;</span><br><span class="line">        Log.logger.error(logPrefix + message,t,arguments);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在刚才的测试接口导入包</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">import com.example.demo.utils.Log;</span><br></pre></td></tr></table></figure>
<p>增加使用代码：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Log.getInst(this).info(&quot;测试成功&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;！&quot;);</span><br></pre></td></tr></table></figure>
<p>调用接口，会发现日志写入了info文件下，封装成功</p>
<p>其他测试代码：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.demo;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"><span class="keyword">import</span> com.example.demo.utils.Log;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSONObject;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestDemo</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//把参数传进Map中</span></span><br><span class="line">        HashMap&lt;String,String&gt; paramsMap=<span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        paramsMap.put(<span class="string">"name"</span>,<span class="string">"哈哈"</span>);</span><br><span class="line">        paramsMap.put(<span class="string">"client"</span>,<span class="string">"Android"</span>);</span><br><span class="line">        paramsMap.put(<span class="string">"id"</span>,<span class="string">"3243598"</span>);</span><br><span class="line">        String jsonStr = JSONObject.toJSONString(paramsMap);</span><br><span class="line">        System.out.println(jsonStr);</span><br><span class="line">        <span class="comment">//测试读取SpringBoot中配置文件信息</span></span><br><span class="line"><span class="comment">//        Logger logger = LoggerFactory.getLogger(TestDemo.class);</span></span><br><span class="line"></span><br><span class="line">        Log.getInst(TestDemo.class).info("测试成功！");</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>参考文献：</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">https:&#x2F;&#x2F;cloud.tencent.com&#x2F;developer&#x2F;article&#x2F;1646435</span><br><span class="line">https:&#x2F;&#x2F;www.w3cschool.cn&#x2F;article&#x2F;2632622.html</span><br><span class="line">https:&#x2F;&#x2F;www.w3cschool.cn&#x2F;article&#x2F;2632622.html</span><br></pre></td></tr></table></figure>
<p><strong>结束语</strong>：</p>
<p>​    今天的分享就到这里了，欢迎大家关注微信公众号”<strong>菜鸟童靴</strong>“</p>
<p><img src="/2022/05/23/SpringBoot%E6%97%A5%E5%BF%97%E5%A4%84%E7%90%86/微信.png" style="zoom: 50%;"></p>
]]></content>
      <categories>
        <category>SpringBoot</category>
      </categories>
      <tags>
        <tag>java</tag>
        <tag>SpringBoot</tag>
      </tags>
  </entry>
  <entry>
    <title>SpringBoot访问数据库操作</title>
    <url>/2022/05/20/SpringBoot%E8%AE%BF%E9%97%AE%E6%95%B0%E6%8D%AE%E5%BA%93%E6%93%8D%E4%BD%9C/</url>
    <content><![CDATA[<p>hello 大家好我是Monday，继上篇介绍SpringBoot集成Druid数据库连接池后，今天我们开启SpringBoot的学习的系列文章之SpringBoot访问数据库操作</p>
<a id="more"></a>
<h3 id="1、什么是DAO？"><a href="#1、什么是DAO？" class="headerlink" title="1、什么是DAO？"></a>1、什么是DAO？</h3><p>DAO(Data Access Object)是一个数据访问接口，数据访问：顾名思义就是与数据库打交道。夹在<a href="https://baike.baidu.com/item/业务逻辑" target="_blank" rel="noopener">业务逻辑</a>与数据库资源中间。</p>
<h3 id="2、Spring-Data-Jpa-简介"><a href="#2、Spring-Data-Jpa-简介" class="headerlink" title="2、Spring Data Jpa 简介"></a>2、Spring Data Jpa 简介</h3><p><code>JPA</code>(<code>Java Persistence API</code>)意即Java持久化API，是Sun官方在JDK5.0后提出的Java持久化规范（JSR 338，这些接口所在包为<code>javax.persistence</code>，详细内容可参考<a href="https://github.com/javaee/jpa-spec）" target="_blank" rel="noopener">https://github.com/javaee/jpa-spec）</a><br> JPA的出现主要是为了简化持久层开发以及整合ORM技术，结束Hibernate、TopLink、JDO等ORM框架各自为营的局面。JPA是在吸收现有ORM框架的基础上发展而来，易于使用，伸缩性强。总的来说，JPA包括以下3方面的技术：</p>
<ul>
<li><strong>ORM映射元数据</strong>： 支持XML和注解两种元数据的形式，元数据描述对象和表之间的映射关系</li>
<li><strong>API</strong>： 操作实体对象来执行CRUD操作</li>
<li><strong>查询语言</strong>： 通过面向对象而非面向数据库的查询语言（<code>JPQL</code>）查询数据，避免程序的SQL语句紧密耦合</li>
</ul>
<p>来看一下Spring官方的解释<a href="https://spring.io/projects/spring-data-jpa#overview" target="_blank" rel="noopener">https://spring.io/projects/spring-data-jpa#overview</a></p>
<p><strong>开搞</strong></p>
<h3 id="3、在pom-xml文件中添加以下依赖："><a href="#3、在pom-xml文件中添加以下依赖：" class="headerlink" title="3、在pom.xml文件中添加以下依赖："></a>3、在pom.xml文件中添加以下依赖：</h3><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-jpa<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--MySQL连接--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">version</span>&gt;</span>5.1.39<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- 连接池 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>druid<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0.31<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="4、在resources写好配置文件"><a href="#4、在resources写好配置文件" class="headerlink" title="4、在resources写好配置文件"></a>4、在resources写好配置文件</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">## 设置server参数</span><br><span class="line">## 端口</span><br><span class="line">server.port&#x3D;8081</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">############################################################</span><br><span class="line">#</span><br><span class="line">#   其他自定义变量</span><br><span class="line">#</span><br><span class="line">############################################################</span><br><span class="line"></span><br><span class="line">application-dev.username&#x3D;root</span><br><span class="line">application-dev.password&#x3D;root</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">############################################################</span><br><span class="line">#</span><br><span class="line"># logback 配置,日志管理</span><br><span class="line">#</span><br><span class="line">############################################################</span><br><span class="line">#日志配置,输出到文本，</span><br><span class="line">logging.config&#x3D;classpath:logback-spring.xml</span><br><span class="line">#控制台默认日志级别修改</span><br><span class="line">#logging.level.root&#x3D;warn</span><br><span class="line"># 指定输出日志的文件名，默认输出至当前项目目录下</span><br><span class="line">#logging.file.path&#x3D;springboot.log</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">############################################################</span><br><span class="line">#</span><br><span class="line"># mysql数据库配置</span><br><span class="line">#</span><br><span class="line">############################################################</span><br><span class="line"></span><br><span class="line">spring.datasource.url &#x3D; jdbc:mysql:&#x2F;&#x2F;localhost:3306&#x2F;wechat  &#x2F;&#x2F;数据库URL</span><br><span class="line">spring.datasource.username &#x3D; root   &#x2F;&#x2F;账号</span><br><span class="line">spring.datasource.password &#x3D; 123456  &#x2F;&#x2F;密码</span><br><span class="line">spring.datasource.driverClassName &#x3D; com.mysql.jdbc.Driver    &#x2F;&#x2F; 驱动</span><br><span class="line">## 指定使用druid 表明不使用默认的Hikari</span><br><span class="line">spring.datasource.type&#x3D; com.alibaba.druid.pool.DruidDataSource</span><br><span class="line"></span><br><span class="line">## #############配置druid参数######################</span><br><span class="line">#druid_config</span><br><span class="line">#用户名</span><br><span class="line">druid.login.username&#x3D;root</span><br><span class="line">#密码</span><br><span class="line">druid.login.password&#x3D;root</span><br><span class="line"></span><br><span class="line"># 配置一个连接在池中最小生存的时间，单位是毫秒，下面是：5分钟</span><br><span class="line">spring.datasource.druid.min-evictable-idle-time-millis&#x3D; 300000</span><br><span class="line"># 打开PSCache，并且指定每个连接上PSCache的大小</span><br><span class="line">spring.datasource.druid.pool-prepared-statements&#x3D; true</span><br><span class="line">spring.datasource.druid.max-pool-prepared-statement-per-connection-size&#x3D;20</span><br><span class="line"># 初始化大小，最小，最大</span><br><span class="line">spring.datasource.druid.initial-size&#x3D;5</span><br><span class="line">spring.datasource.druid.min-idle&#x3D; 3</span><br><span class="line"># 最大连接池数量</span><br><span class="line">spring.datasource.druid.max-active&#x3D; 20</span><br><span class="line"># 配置获取连接等待超时的时间</span><br><span class="line">spring.datasource.druid.max-wait&#x3D; 60000</span><br><span class="line"># 配置间隔多久才进行一次检测，检测需要关闭的空闲连接，单位是毫秒，下面是：1分钟</span><br><span class="line">spring.datasource.druid.time-between-eviction-runs-millis&#x3D; 60000</span><br><span class="line"></span><br><span class="line"># asyncInit是1.1.4中新增加的配置，如果有initialSize数量较多时，打开会加快应用启动时间</span><br><span class="line">spring.datasource.druid.asyncInit&#x3D;true</span><br><span class="line"></span><br><span class="line"># 配置监控统计拦截的filters，去掉后监控界面sql无法统计，&#39;wall&#39;用于防火墙</span><br><span class="line">spring.datasource.druid.filters&#x3D;stat,wall,log4j,config</span><br><span class="line"></span><br><span class="line">spring.datasource.druid.validation-query: select &#39;x&#39;</span><br><span class="line"></span><br><span class="line">spring.jpa.show-sql&#x3D;true</span><br><span class="line">spring.jpa.database-platform&#x3D;org.hibernate.dialect.MySQL5InnoDBDialect</span><br></pre></td></tr></table></figure>
<h3 id="5、新建user文件"><a href="#5、新建user文件" class="headerlink" title="5、新建user文件"></a><strong>5、新建user文件</strong></h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.demo.models;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.annotation.JsonIgnoreProperties;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.persistence.*;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="meta">@Table</span>(name=<span class="string">"user"</span>)</span><br><span class="line"><span class="comment">//@JsonIgnoreProperties(&#123;"hibernateLazyInitializer", "handler"&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    @GeneratedValue(strategy = GenerationType.IDENTITY)</span></span><br><span class="line"><span class="comment">    TABLE：使用一个特定的数据库表格来保存主键。</span></span><br><span class="line"><span class="comment">    SEQUENCE：根据底层数据库的序列来生成主键，条件是数据库支持序列。</span></span><br><span class="line"><span class="comment">    IDENTITY：主键由数据库自动生成（主要是自动增长型）</span></span><br><span class="line"><span class="comment">    AUTO：主键由程序控制。</span></span><br><span class="line"><span class="comment">    * */</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Id</span></span><br><span class="line">    <span class="meta">@GeneratedValue</span>(strategy = GenerationType.IDENTITY)</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> id;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Column</span>(name=<span class="string">"userName"</span>)</span><br><span class="line">    <span class="keyword">private</span> String userName;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Column</span>(name=<span class="string">"passWord"</span>)</span><br><span class="line">    <span class="keyword">private</span> String passWord;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">User</span><span class="params">()</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">User</span><span class="params">(String userName)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// TODO Auto-generated constructor stub</span></span><br><span class="line">        <span class="keyword">this</span>.userName = userName;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> userName;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setName</span><span class="params">(String userName)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.userName = userName;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getPassword</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> passWord;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setPassWord</span><span class="params">(String passWord)</span></span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.passWord =passWord;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="6、新建UserDao，继承JpaRepository。"><a href="#6、新建UserDao，继承JpaRepository。" class="headerlink" title="6、新建UserDao，继承JpaRepository。"></a>6、新建UserDao，继承JpaRepository。</h3><p>Dao层主要用来实现对数据库的增、删、查、改。 dao只要继承JpaRepository类就可以，几乎可以不用写方法，可以根据方法名来自动的生产SQL，比如findByUserName 会自动生产一个以 userName 为参数的查询方法。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">* 新建UserDao，继承JpaRepository</span></span><br><span class="line"><span class="comment">* */</span></span><br><span class="line"><span class="keyword">package</span> com.example.demo.dao;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.jpa.repository.JpaRepository;</span><br><span class="line"><span class="keyword">import</span> com.example.demo.models.User;</span><br><span class="line"><span class="keyword">import</span> org.springframework.jdbc.core.JdbcTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Repository;</span><br><span class="line"></span><br><span class="line"><span class="comment">//dao层，写对数据库的操作</span></span><br><span class="line"><span class="comment">//交给springboot管理的注解</span></span><br><span class="line"><span class="meta">@Repository</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserDao</span> <span class="keyword">extends</span> <span class="title">JpaRepository</span>&lt;<span class="title">User</span>, <span class="title">Long</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function">User <span class="title">findByUserName</span><span class="params">(String userName)</span></span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="创建Userservice接口"><a href="#创建Userservice接口" class="headerlink" title="创建Userservice接口"></a>创建Userservice接口</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 创建Userservice接口</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">package</span> com.example.demo.service;</span><br><span class="line"><span class="keyword">import</span> com.example.demo.models.User;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserService</span> </span>&#123;</span><br><span class="line">    <span class="function">User <span class="title">save</span><span class="params">(User user)</span></span>;</span><br><span class="line">    <span class="function">User <span class="title">getOne</span><span class="params">(<span class="keyword">long</span> id)</span></span>;</span><br><span class="line">    <span class="function">List&lt;User&gt; <span class="title">findAll</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="创建service以及实现类-创建接口的实现"><a href="#创建service以及实现类-创建接口的实现" class="headerlink" title="创建service以及实现类,创建接口的实现"></a>创建service以及实现类,创建接口的实现</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">* service以及实现类,创建接口的实现</span></span><br><span class="line"><span class="comment">* */</span></span><br><span class="line"><span class="keyword">package</span> com.example.demo.service;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"><span class="keyword">import</span> com.example.demo.models.User;</span><br><span class="line"><span class="keyword">import</span> com.example.demo.dao.UserDao;</span><br><span class="line"><span class="keyword">import</span> com.example.demo.service.UserService;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserServiceImpl</span> <span class="keyword">implements</span> <span class="title">UserService</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserDao userDao;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> User <span class="title">getOne</span><span class="params">(<span class="keyword">long</span> id)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> userDao.getOne(id);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;User&gt; <span class="title">findAll</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> userDao.findAll();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> User <span class="title">create</span><span class="params">(User user)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> userDao.save(user);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="7、新建UserController文件"><a href="#7、新建UserController文件" class="headerlink" title="7、新建UserController文件"></a><strong>7、新建UserController文件</strong></h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.demo.controller;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.example.demo.dao.UserDao;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.ResponseBody;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.example.demo.models.User;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"user"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserDao userDao;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping</span>(<span class="string">"/getAllUser"</span>)</span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;User&gt; <span class="title">findAll</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        List&lt;User&gt; list = <span class="keyword">new</span> ArrayList&lt;User&gt;();</span><br><span class="line">        list = userDao.findAll();</span><br><span class="line">        <span class="keyword">return</span> list;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping</span>(<span class="string">"/getByUserName"</span>)</span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> User <span class="title">getByUserName</span><span class="params">(String userName)</span> </span>&#123;</span><br><span class="line">        User user = userDao.findByUserName(userName);</span><br><span class="line">        <span class="keyword">return</span> user;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@RequestMapping</span>(<span class="string">"/createtUser"</span>)</span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> User <span class="title">createtUser</span><span class="params">(String userName,String passWord)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        User user = <span class="keyword">new</span> User(userName,passWord);</span><br><span class="line">        user.setName(userName);</span><br><span class="line">        user.setPassWord(passWord);</span><br><span class="line">        userDao.save(user);</span><br><span class="line">        <span class="keyword">return</span> user;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="8、启动程序注意："><a href="#8、启动程序注意：" class="headerlink" title="8、启动程序注意："></a>8、启动程序注意：</h3><p>在本地跑项目的时候，本地数据库的版本是5.1.37的版本。<br>而服务器的数据库版本是8.0.20。<br>这就是主要原因造成的，先改本地pom文件里的jar包改成和数据库版本一致。<br>jdbc.driver = com.mysql.cj.jdbc.Driver<br>jdbc.url=jdbc:mysql://49.27.62.218:3306/zjcq?useUnicode=true&amp;characterEncoding=utf8&amp;useSSL=true&amp;serverTimezone=UTC<br>在数据库版本为8.0的时候要加serverTimezone=UTC地区</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">&lt;groupId&gt;mysql&lt;&#x2F;groupId&gt;</span><br><span class="line">&lt;artifactId&gt;mysql-connector-java&lt;&#x2F;artifactId&gt;</span><br><span class="line">&lt;version&gt;8.0.20&lt;&#x2F;version&gt;</span><br><span class="line">&lt;&#x2F;dependency&gt;</span><br></pre></td></tr></table></figure>
<h3 id="10、建表方式"><a href="#10、建表方式" class="headerlink" title="10、建表方式"></a>10、建表方式</h3><p>关键的地方在建表方式设置上，配置文件，只有写了这句才会自动建表：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">spring.jpa.properties.hibernate.hbm2ddl.auto&#x3D;update</span><br></pre></td></tr></table></figure>
<p><strong>spring.jpa.properties.hibernate.hbm2ddl.auto有几种配置：</strong></p>
<p>create：每次加载Hibernate时都会删除上一次生成的表，然后重新生成新表，即使两次没有任何修改也会这样执行，这就导致每次启动都是一个新的数据库，也是导致数据丢失的重要原因。</p>
<p>create-drop：每次加载Hibernate时都会生成表，但当SessionFactory关闭时，所生成的表将自动删除。</p>
<p>update：最常用的属性值，第一次加载Hibernate时创建数据表（前提是需要先有数据库），以后加载HIbernate时只会根据model更新，即使model已经删除了某些属性，数据表也不会随之删除字段。</p>
<p>validate：每次加载Hibernate时都会验证数据表结构，只会和已经存在的数据表进行比较，根据model修改表结构，但不会创建新表。</p>
<h3 id="9、-测试"><a href="#9、-测试" class="headerlink" title="9、 测试"></a>9、 测试</h3><p>启动项目。用Postman发送请求进行测试：</p>
<p><a href="http://localhost:8081/user/getAllUser" target="_blank" rel="noopener">http://localhost:8081/user/getAllUser</a> </p>
<p><a href="http://localhost:8081/user/getByUserName?userName=ceshi" target="_blank" rel="noopener">localhost:8081/user/getByUserName?userName=ceshi</a></p>
<p><img src="/2022/05/20/SpringBoot%E8%AE%BF%E9%97%AE%E6%95%B0%E6%8D%AE%E5%BA%93%E6%93%8D%E4%BD%9C/3.jpg" style="zoom: 50%;"></p>
<p><strong>参考链接：</strong></p>
<p>Spring Boot——集成Druid数据库连接池</p>
<p><a href="https://blog.csdn.net/wpc2018/article/details/116948255" target="_blank" rel="noopener">https://blog.csdn.net/wpc2018/article/details/116948255</a></p>
<p>Druid使用手册</p>
<p><a href="https://www.bookstack.cn/read/Druid/06014f428e7b0263.md" target="_blank" rel="noopener">https://www.bookstack.cn/read/Druid/06014f428e7b0263.md</a></p>
<p>SpringBoot配置 Druid 连接池(application.properties参数配置详解</p>
<p><a href="https://blog.csdn.net/yuekangwei/article/details/121369124" target="_blank" rel="noopener">https://blog.csdn.net/yuekangwei/article/details/121369124</a></p>
<p>spring boot连接数据库并插入数据</p>
<p><a href="https://blog.csdn.net/qq_38320255/article/details/81327440" target="_blank" rel="noopener">https://blog.csdn.net/qq_38320255/article/details/81327440</a></p>
<p>spring boot操作mysql数据库：自动建表，数据添加、查询和修改</p>
<p><a href="https://blog.csdn.net/liuzhijun301/article/details/82461851" target="_blank" rel="noopener">https://blog.csdn.net/liuzhijun301/article/details/82461851</a></p>
<p>spring boot实战系列（11）：结合使用druid连接池链接mysql数据库</p>
<p><a href="https://mp.weixin.qq.com/s/mLb2zZ7GqgmbRUy8OUwx1A" target="_blank" rel="noopener">https://mp.weixin.qq.com/s/mLb2zZ7GqgmbRUy8OUwx1A</a></p>
<p>Spring Boot连接MySQL数据库</p>
<p><a href="https://www.cnblogs.com/sgh1023/p/10044722.html#_lab3" target="_blank" rel="noopener">https://www.cnblogs.com/sgh1023/p/10044722.html#_lab3</a></p>
<p><strong>结束语</strong>：</p>
<p>​    今天的分享就到这里了，欢迎大家关注微信公众号”<strong>菜鸟童靴</strong>“</p>
<p><img src="/2022/05/20/SpringBoot%E8%AE%BF%E9%97%AE%E6%95%B0%E6%8D%AE%E5%BA%93%E6%93%8D%E4%BD%9C/微信.png" style="zoom: 50%;"></p>
]]></content>
      <categories>
        <category>SpringBoot</category>
      </categories>
      <tags>
        <tag>java</tag>
        <tag>SpringBoot</tag>
      </tags>
  </entry>
  <entry>
    <title>SpringBoot如何自定义配置文件</title>
    <url>/2022/05/13/SpringBoot%E5%A6%82%E4%BD%95%E8%87%AA%E5%AE%9A%E4%B9%89%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6/</url>
    <content><![CDATA[<p>hello 大家好我是Monday，今天我们开启SpringBoot的学习的系列文章之SpringBoot如何自定义配置文件。</p>
<a id="more"></a>
<h3 id="1-前言"><a href="#1-前言" class="headerlink" title="1. 前言"></a><strong>1. 前言</strong></h3><p>SpringBoot最核心的就是自动配置类，而自动配置类需要读取配置文件的信息，来自动创建实例，因此配置文件就显得非常重要了。因此本文主要介绍SpringBoot的配置文件、以及自动配置类和配置文件之间的关系，即SpringBoot的运行原理。</p>
<h3 id="2-SpringBoot-配置文件"><a href="#2-SpringBoot-配置文件" class="headerlink" title="2. SpringBoot 配置文件"></a><strong>2. SpringBoot 配置文件</strong></h3><p>SpringBoot<strong>默认加载</strong>的配置文件是在classpath根目录的<strong>application.properties</strong>或者</p>
<p><strong>application.yml</strong>配置文件。</p>
<p><strong>—注意：</strong></p>
<blockquote>
<p>[1] 文件名不能写错，因为默认的文件名写死在SpringBoot配置代码中。<br>[2] SpringBoot支持properties和yml两个格式的配置文件。</p>
</blockquote>
<h3 id="3、-多个环境配置文件"><a href="#3、-多个环境配置文件" class="headerlink" title="3、- 多个环境配置文件"></a><strong>3、- 多个环境配置文件</strong></h3><p><strong>(1)、在现实的开发环境中我们可能需要多个不同环境(开发,调试,生产)的配置文件可以使用 application-{profile}.properties进行配置如</strong></p>
<ul>
<li>application-dev.properties : 开发环境</li>
<li>application-test.properties : 测试环境</li>
<li>application-prod.properties : 生产环境</li>
</ul>
<p><strong>(2)、使用 : 在application.properties中配置</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">spring.profiles.active&#x3D;dev 表示启动 开发环境</span><br></pre></td></tr></table></figure>
<p>我们在application-dev.properties，填写上如下信息</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">## 设置server参数</span><br><span class="line">## 端口</span><br><span class="line">server.port&#x3D;8081</span><br></pre></td></tr></table></figure>
<p><strong>(3)、启动程序发现端口变成了 dev 下配置的</strong></p>
<p><img src="/2022/05/13/SpringBoot%E5%A6%82%E4%BD%95%E8%87%AA%E5%AE%9A%E4%B9%89%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6/1.jpg" style="zoom: 50%;"></p>
<h3 id="4、程序如何读取配置文件"><a href="#4、程序如何读取配置文件" class="headerlink" title="4、程序如何读取配置文件"></a>4、程序如何读取配置文件</h3><p><strong>（1）我们在application-dev.properties，填写上如下信息</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">application-dev.username&#x3D;root</span><br><span class="line">application-dev.password&#x3D;root</span><br></pre></td></tr></table></figure>
<p><strong>（2）新建config文件并创建DevProperties.java文件</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.demo.config;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.context.properties.ConfigurationProperties;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@ConfigurationProperties</span>(value = <span class="string">"application-dev"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DevProperties</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String username;</span><br><span class="line">    <span class="keyword">private</span> String password;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getUsername</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> username;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getPassword</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> password;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>注意：</strong></p>
<p>@ConfigurationProperties(value = “application-dev”)表示的配置文件里属性的前缀都是application-dev开头<br>配置类上记得加上@Data和@Component注解（或者在启动类上加上@EnableConfigurationProperties(value =DevProperties.class)）</p>
<p>如果有内部类对象，记得加上@Data，不然无法映射数据<br>.properties类型文件映射规则，短横线(-)后面的首个字母会变成大写，同时注意有内部类时的写法</p>
<p><strong>（3）如何读取配置文件，LoadPropertiesService.java文件创建,具体代码</strong></p>
<p>使用方法也很简单，直接使用spring的注解@Autowired引入即可</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.demo.controller;</span><br><span class="line"><span class="keyword">import</span> com.example.demo.config.DevProperties;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.context.properties.EnableConfigurationProperties;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="meta">@EnableConfigurationProperties</span>(DevProperties<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">@<span class="title">RestController</span></span></span><br><span class="line"><span class="class"><span class="title">public</span> <span class="title">class</span> <span class="title">LoadPropertiesService</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    DevProperties devProperties;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping</span>(<span class="string">"/testProperties"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">testProperties</span><span class="params">()</span></span>&#123;</span><br><span class="line">        String str = devProperties.getUsername();</span><br><span class="line">        String str2 = devProperties.getPassword();</span><br><span class="line">        System.out.println(str);</span><br><span class="line">        System.out.println(str2);</span><br><span class="line">        <span class="keyword">return</span> str+str2;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>测试：</strong></p>
<p><img src="/2022/05/13/SpringBoot%E5%A6%82%E4%BD%95%E8%87%AA%E5%AE%9A%E4%B9%89%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6/2.jpg" style="zoom: 150%;"></p>
<p><strong>注意：</strong></p>
<p>类型转换少，配置类可以直接定义常规类型<br>配置分类方便，一个地方维护，不用一个key到处写<br>更符合面向对象的写法<br>Spring Boot注解读取application.properties或者application-{profile}.properties文件时默认编码是ISO_8859_1，读取yaml配置文件时使用的是UTF-8的编码方式，如果有中文配置请使用.yml格式，或者使用我接下来的读取方式。</p>
<p><strong>参考文献：</strong></p>
<p>SpringBoot【配置文件&amp;运行原理篇】 :  <a href="https://zhuanlan.zhihu.com/p/102942848" target="_blank" rel="noopener">https://zhuanlan.zhihu.com/p/102942848</a></p>
<p>Spring Boot读取配置文件常用方式 ： <a href="https://blog.csdn.net/Alian_1223/article/details/118891954" target="_blank" rel="noopener">https://blog.csdn.net/Alian_1223/article/details/118891954</a></p>
<p><strong>结束语</strong>：</p>
<p>​    今天的分享就到这里了，欢迎大家关注微信公众号”<strong>菜鸟童靴</strong>“</p>
<p><img src="/2022/05/13/SpringBoot%E5%A6%82%E4%BD%95%E8%87%AA%E5%AE%9A%E4%B9%89%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6/微信.png" style="zoom: 50%;"></p>
]]></content>
      <categories>
        <category>SpringBoot</category>
      </categories>
      <tags>
        <tag>java</tag>
        <tag>SpringBoot</tag>
      </tags>
  </entry>
  <entry>
    <title>Java学习笔记之重写Override与重载Overload介绍</title>
    <url>/2022/05/13/Java%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E4%B9%8B%E9%87%8D%E5%86%99Override%E4%B8%8E%E9%87%8D%E8%BD%BDOverload%E4%BB%8B%E7%BB%8D/</url>
    <content><![CDATA[<p>hello 大家好我是Monday，今天我们开启回补java的学习的系列文章之重写Override与重载Overload介绍</p>
<a id="more"></a>
<p><strong>重写(Override)</strong></p>
<p>重写是子类对父类的允许访问的方法的实现过程进行重新编写, 返回值和形参都不能改变。即外壳不变，核心重写！</p>
<p>重写的好处在于子类可以根据需要，定义特定于自己的行为。 也就是说子类能够根据需要实现父类的方法。</p>
<p>重写方法不能抛出新的检查异常或者比被重写方法申明更加宽泛的异常。例如： 父类的一个方法申明了一个检查异常 IOException，但是在重写这个方法的时候不能抛出 Exception 异常，因为 Exception 是 IOException 的父类，只能抛出 IOException 的子类异常。</p>
<p>在面向对象原则里，重写意味着可以重写任何现有方法。实例如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Animal</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">move</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"动物可以移动"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Dog</span> <span class="keyword">extends</span> <span class="title">Animal</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">move</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"狗可以跑和走"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestDog</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String args[])</span> </span>&#123;</span><br><span class="line">        Animal a = <span class="keyword">new</span> Animal(); <span class="comment">// Animal 对象</span></span><br><span class="line">        Animal b = <span class="keyword">new</span> Dog(); <span class="comment">// Dog 对象</span></span><br><span class="line">        a.move(); <span class="comment">// 执行 Animal 类的方法</span></span><br><span class="line">        b.move(); <span class="comment">//执行 Dog 类的方法</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">运行结果</span></span><br><span class="line"><span class="comment">动物可以移动</span></span><br><span class="line"><span class="comment">狗可以跑和走</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>
<p>在上面的例子中可以看到，尽管b属于Animal类型，但是它运行的是Dog类的move方法。</p>
<p>这是由于在编译阶段，只是检查参数的引用类型。</p>
<p>然而在运行时，Java虚拟机(JVM)指定对象的类型并且运行该对象的方法。</p>
<p>因此在上面的例子中，之所以能编译成功，是因为Animal类中存在move方法，然而运行时，运行的是特定对象的方法。</p>
<p>思考以下例子：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Animal</span></span>&#123;</span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">move</span><span class="params">()</span></span>&#123;</span><br><span class="line">      System.out.println(<span class="string">"动物可以移动"</span>);</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Dog</span> <span class="keyword">extends</span> <span class="title">Animal</span></span>&#123;</span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">move</span><span class="params">()</span></span>&#123;</span><br><span class="line">      System.out.println(<span class="string">"狗可以跑和走"</span>);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">bark</span><span class="params">()</span></span>&#123;</span><br><span class="line">      System.out.println(<span class="string">"狗可以吠叫"</span>);</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestDog</span></span>&#123;</span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String args[])</span></span>&#123;</span><br><span class="line">      Animal a = <span class="keyword">new</span> Animal(); <span class="comment">// Animal 对象</span></span><br><span class="line">      Animal b = <span class="keyword">new</span> Dog(); <span class="comment">// Dog 对象</span></span><br><span class="line"></span><br><span class="line">      a.move();<span class="comment">// 执行 Animal 类的方法</span></span><br><span class="line">      b.move();<span class="comment">//执行 Dog 类的方法</span></span><br><span class="line">      b.bark();</span><br><span class="line"></span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">运行结果：</span></span><br><span class="line"><span class="comment">TestDog.java:30: cannot find symbol</span></span><br><span class="line"><span class="comment">symbol  : method bark()</span></span><br><span class="line"><span class="comment">location: class Animal</span></span><br><span class="line"><span class="comment">                b.bark();</span></span><br><span class="line"><span class="comment">                 ^</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>
<p>该程序将抛出一个编译错误，因为b的引用类型Animal没有bark方法。</p>
<p><strong>方法的重写规则</strong></p>
<p>1、参数列表必须完全与被重写方法的相同。</p>
<p>2、返回类型与被重写方法的返回类型可以不相同，但是必须是父类返回值的派生类（java5 及更早版本返回类型要一样，java7 及更高版本可以不同）。</p>
<p>3、访问权限不能比父类中被重写的方法的访问权限更低。例如：如果父类的一个方法被声明为 public，那么在子类中重写该方法就不能声明为 protected。</p>
<p>4、父类的成员方法只能被它的子类重写。</p>
<p>5、声明为 final 的方法不能被重写。</p>
<p>6、声明为 static 的方法不能被重写，但是能够被再次声明。</p>
<p>7、子类和父类在同一个包中，那么子类可以重写父类所有方法，除了声明为 private 和 final 的方法。</p>
<p>8、子类和父类不在同一个包中，那么子类只能够重写父类的声明为 public 和 protected 的非 final 方法。</p>
<p>9、重写的方法能够抛出任何非强制异常，无论被重写的方法是否抛出异常。但是，重写的方法不能抛出新的强制性异常，或者比被重写方法声明的更广泛的强制性异常，反之则可以。</p>
<p>10、构造方法不能被重写。</p>
<p>11、如果不能继承一个方法，则不能重写这个方法。</p>
<p><strong>Super 关键字的使用</strong></p>
<p>当需要在子类中调用父类的被重写方法时，要使用 super 关键字。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Animal</span></span>&#123;</span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">move</span><span class="params">()</span></span>&#123;</span><br><span class="line">      System.out.println(<span class="string">"动物可以移动"</span>);</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Dog</span> <span class="keyword">extends</span> <span class="title">Animal</span></span>&#123;</span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">move</span><span class="params">()</span></span>&#123;</span><br><span class="line">      <span class="keyword">super</span>.move(); <span class="comment">// 应用super类的方法</span></span><br><span class="line">      System.out.println(<span class="string">"狗可以跑和走"</span>);</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestDog</span></span>&#123;</span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String args[])</span></span>&#123;</span><br><span class="line"></span><br><span class="line">      Animal b = <span class="keyword">new</span> Dog(); <span class="comment">// Dog 对象</span></span><br><span class="line">      b.move(); <span class="comment">//执行 Dog类的方法</span></span><br><span class="line"></span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">动物可以移动</span></span><br><span class="line"><span class="comment">狗可以跑和走</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>
<p><strong>重载(Overload)</strong><br>1、重载(overloading) 是在一个类里面，方法名字相同，而参数不同。返回类型可以相同也可以不同。</p>
<p>2、每个重载的方法（或者构造函数）都必须有一个独一无二的参数类型列表。</p>
<p>3、最常用的地方就是构造器的重载。</p>
<p><strong>重载规则:</strong></p>
<p>1、被重载的方法必须改变参数列表(参数个数或类型不一样)；</p>
<p>2、被重载的方法可以改变返回类型；</p>
<p>3、被重载的方法可以改变访问修饰符；</p>
<p>4、被重载的方法可以声明新的或更广的检查异常；</p>
<p>5、方法能够在同一个类中或者在一个子类中被重载。</p>
<p>6、无法以返回值类型作为重载函数的区分标准。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Overloading</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">test</span><span class="params">()</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"test1"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test</span><span class="params">(<span class="keyword">int</span> a)</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"test2"</span>);</span><br><span class="line">    &#125;   </span><br><span class="line">     </span><br><span class="line">    <span class="comment">//以下两个参数类型顺序不同</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">test</span><span class="params">(<span class="keyword">int</span> a,String s)</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"test3"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"returntest3"</span>;</span><br><span class="line">    &#125;   </span><br><span class="line">     </span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">test</span><span class="params">(String s,<span class="keyword">int</span> a)</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"test4"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"returntest4"</span>;</span><br><span class="line">    &#125;   </span><br><span class="line">     </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span>&#123;</span><br><span class="line">        Overloading o = <span class="keyword">new</span> Overloading();</span><br><span class="line">        System.out.println(o.test());</span><br><span class="line">        o.test(<span class="number">1</span>);</span><br><span class="line">        System.out.println(o.test(<span class="number">1</span>,<span class="string">"test3"</span>));</span><br><span class="line">        System.out.println(o.test(<span class="string">"test4"</span>,<span class="number">1</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>重写与重载之间的区别</strong></p>
<div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:left">区别点</th>
<th style="text-align:left">重载方法</th>
<th style="text-align:left">重写方法</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">参数列表</td>
<td style="text-align:left">必须修改</td>
<td style="text-align:left">一定不能修改</td>
</tr>
<tr>
<td style="text-align:left">返回类型</td>
<td style="text-align:left">可以修改</td>
<td style="text-align:left">一定不能修改</td>
</tr>
<tr>
<td style="text-align:left">异常</td>
<td style="text-align:left">可以修改</td>
<td style="text-align:left">可以减少或删除，一定不能抛出新的或者更广的异常</td>
</tr>
<tr>
<td style="text-align:left">访问</td>
<td style="text-align:left">可以修改</td>
<td style="text-align:left">一定不能做更严格的限制（可以降低限制）</td>
</tr>
</tbody>
</table>
</div>
<p><strong>总结</strong><br>方法的重写(Overriding)和重载(Overloading)是java多态性的不同表现，重写是父类与子类之间多态性的一种表现，重载可以理解成多态的具体表现形式。</p>
<p>(1)方法重载是一个类中定义了多个方法名相同,而他们的参数的数量不同或数量相同而类型和次序不同,则称为方法的重载(Overloading)。</p>
<p>(2)方法重写是在子类存在方法与父类的方法的名字相同,而且参数的个数与类型一样,返回值也一样的方法,就称为重写(Overriding)。</p>
<p>(3)方法重载是一个类的多态性表现,而方法重写是子类与父类的一种多态性表现。</p>
<p>原文链接：<a href="https://blog.csdn.net/BigBoy_Coder/article/details/102951430" target="_blank" rel="noopener">https://blog.csdn.net/BigBoy_Coder/article/details/102951430</a></p>
<p><strong>结束语</strong>：</p>
<p>​    今天的分享就到这里了，欢迎大家关注微信公众号”<strong>菜鸟童靴</strong>“</p>
<p><img src="/2022/05/13/Java%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E4%B9%8B%E9%87%8D%E5%86%99Override%E4%B8%8E%E9%87%8D%E8%BD%BDOverload%E4%BB%8B%E7%BB%8D/微信.png" style="zoom: 50%;"></p>
]]></content>
      <categories>
        <category>JAVA</category>
      </categories>
      <tags>
        <tag>java</tag>
      </tags>
  </entry>
  <entry>
    <title>Java学习笔记之构造函数介绍</title>
    <url>/2022/05/13/Java%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E4%B9%8B%E6%9E%84%E9%80%A0%E5%87%BD%E6%95%B0%E4%BB%8B%E7%BB%8D/</url>
    <content><![CDATA[<p>hello 大家好我是Monday，今天我们开启回补java的学习的系列文章之构造函数介绍。</p>
<a id="more"></a>
<p>我们人出生的时候，有些人一出生之后再起名字的，但是有些人一旦出生就已经起好名字的。那么我们在 java 里面怎么在对象一旦创建就赋值呢？</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Person</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">String name; <span class="comment">//    姓名</span></span><br><span class="line"><span class="keyword">int</span> age; <span class="comment">//    年龄</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">    Person p = <span class="keyword">new</span> Person(); <span class="comment">//    创建了Person类型的p对象</span></span><br><span class="line">    System.out.println(<span class="string">"姓名: "</span> + p.name + <span class="string">" 年龄: "</span> + p.age); <span class="comment">//    name = null, age = 0;</span></span><br><span class="line">    <span class="comment">//这个小孩刚出生的时候没有姓名和年龄</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>那我们怎么在出生后给小孩起名字呢：</p>
<p>看看我们如何构造的：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Person</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">String name; <span class="comment">//    姓名</span></span><br><span class="line"><span class="keyword">int</span> age; <span class="comment">//    年龄</span></span><br><span class="line"><span class="comment">//    构造方法</span></span><br><span class="line">Person(String name,<span class="keyword">int</span> age)&#123;</span><br><span class="line">    <span class="keyword">this</span>.name = name; <span class="comment">//     给对象赋予name值</span></span><br><span class="line">    <span class="keyword">this</span>.age = age; <span class="comment">//    给对象赋予age值</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">    Person p = <span class="keyword">new</span> Person(<span class="string">"张三"</span>,<span class="number">1</span>); <span class="comment">//    创建了Person类型的p对象,并且调用构造方法赋予该对象属性值</span></span><br><span class="line">    System.out.println(<span class="string">"姓名: "</span> + p.name + <span class="string">" 年龄: "</span> + p.age); <span class="comment">//    name = 张三, age = 1;</span></span><br><span class="line">    <span class="comment">//这个小孩刚出生的时候已经有了姓名和年龄</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>到这里我们引出构造方法的作用：</strong></p>
<p>1).创建对象,凡是必须和new一起使用.</p>
<p>2).对对象进行初始化.</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Person</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">String name; <span class="comment">//    姓名</span></span><br><span class="line"><span class="keyword">int</span> age; <span class="comment">//    年龄</span></span><br><span class="line"><span class="comment">//    全参构造方法</span></span><br><span class="line">Person(String name,<span class="keyword">int</span> age)&#123;</span><br><span class="line">    <span class="keyword">this</span>.name = name; <span class="comment">//     给对象赋予name值</span></span><br><span class="line">    <span class="keyword">this</span>.age = age; <span class="comment">//    给对象赋予age值</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//    无参构造方法</span></span><br><span class="line">Person()&#123;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">    Person p = <span class="keyword">new</span> Person(<span class="string">"张三"</span>,<span class="number">1</span>); </span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">         根据创建对象的实参个数,jvm回去寻找合适的构造方法,</span></span><br><span class="line"><span class="comment">         两个实参所有会调用含有两个参数的构造方法.Person(String name,int age)</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    System.out.println(<span class="string">"姓名: "</span> + p.name + <span class="string">" 年龄: "</span> + p.age); <span class="comment">//    name = 张三, age = 1;</span></span><br><span class="line">    <span class="comment">//这个对象创建出来的时候已经有了自己的姓名和年龄</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>构造函数与普通函数的区别：</strong></p>
<p>（1）. 一般函数是用于定义对象应该具备的功能。而构造函数定义的是，对象在调用功能之前，在建立时，应该具备的一些内容。也就是对象的初始化内容。</p>
<p>（2）. 构造函数是在对象建立时由 jvm 调用, 给对象初始化。一般函数是对象建立后，当对象调用该功能时才会执行。</p>
<p>（3）. 普通函数可以使用对象多次调用，构造函数就在创建对象时调用。</p>
<p>（4）. 构造函数的函数名要与类名一样，而普通的函数只要符合标识符的命名规则即可。</p>
<p>（5）. 构造函数没有返回值类型。</p>
<p><strong>构造函数要注意的细节：</strong></p>
<p>（1）. 当类中没有定义构造函数时，系统会指定给该类加上一个空参数的构造函数。这个是类中默认的构造函数。当类中如果自定义了构造函数，这时默认的构造函数就没有了。</p>
<p>备注：可以通过 javap 命令验证。</p>
<p>（2）. 在一个类中可以定义多个构造函数，以进行不同的初始化。多个构造函数存在于类中，是以重载的形式体现的。因为构造函数的名称都相同。</p>
<p><strong>一段整合练习的代码：综合运用的以上所涉及的知识点，还有一点点的知识扩展：</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">package com;</span><br><span class="line">import java.util.Random;</span><br><span class="line">public class Construction_demo1 &#123;</span><br><span class="line">    public String name; &#x2F;&#x2F;    姓名</span><br><span class="line">    public int age; &#x2F;&#x2F;    年龄</span><br><span class="line">    Construction_demo1() &#123;</span><br><span class="line">        System.out.println(&quot;无参构造方法&quot;);</span><br><span class="line">    &#125;;</span><br><span class="line">    Construction_demo1(String name, int age) &#123;</span><br><span class="line">        this.age &#x3D; age;</span><br><span class="line">        this.name &#x3D; name;</span><br><span class="line">    &#125;;</span><br><span class="line">    &#123;</span><br><span class="line">        cry();</span><br><span class="line">    &#125;</span><br><span class="line">    &#x2F;&#x2F;构造代码块，构造代码块和构造函数的区别，构造代码块是给所有对象进行统一初始化， 构造函数给对应的对象初始化。</span><br><span class="line">    &#x2F;&#x2F;构造代码块的作用：它的作用就是将所有构造方法中公共的信息进行抽取。</span><br><span class="line">    public void cry() &#123;</span><br><span class="line">        System.out.println(&quot;----------cry------------------&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        Construction_demo1 p &#x3D; new Construction_demo1(); &#x2F;&#x2F;    创建了Person类型的p对象</span><br><span class="line">        System.out.println(&quot;姓名: &quot; + p.name + &quot; 年龄: &quot; + p.age); &#x2F;&#x2F;    name &#x3D; null, age &#x3D; 0;</span><br><span class="line">        &#x2F;&#x2F;这个小孩刚出生的时候没有姓名和年龄</span><br><span class="line">        Construction_demo1 p2 &#x3D; new Construction_demo1(&quot;xiaoli&quot;, 48);</span><br><span class="line">        System.out.println(&quot;姓名 ：&quot; + p2.name + &quot;年龄： &quot; + p2.age);</span><br><span class="line">        int result &#x3D; get_nonce(0, 100); &#x2F;&#x2F;如何调用静态方法</span><br><span class="line">        System.out.println(result);</span><br><span class="line">        p2.cry(); &#x2F;&#x2F;如何调用类里面的方法</span><br><span class="line">    &#125;</span><br><span class="line">    public static int get_nonce(int i, int i2) &#123;</span><br><span class="line">        if (i &gt; i2) &#123;</span><br><span class="line">            return 0;</span><br><span class="line">        &#125;</span><br><span class="line">        return i !&#x3D; i2 ? i + new Random().nextInt(i2 - i) : i;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>到这里java 的构造函数我们就告一段落了，</p>
<p>原文链接：<a href="https://blog.csdn.net/BigBoy_Coder/article/details/102939143" target="_blank" rel="noopener">https://blog.csdn.net/BigBoy_Coder/article/details/102939143</a></p>
<p><strong>结束语</strong>：</p>
<p>​    今天的分享就到这里了，欢迎大家关注微信公众号”<strong>菜鸟童靴</strong>“</p>
<p><img src="/2022/05/13/Java%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E4%B9%8B%E6%9E%84%E9%80%A0%E5%87%BD%E6%95%B0%E4%BB%8B%E7%BB%8D/微信.png" style="zoom: 50%;"></p>
]]></content>
      <categories>
        <category>JAVA</category>
      </categories>
      <tags>
        <tag>java</tag>
      </tags>
  </entry>
  <entry>
    <title>Java学习笔记之泛型介绍</title>
    <url>/2022/05/12/Java%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E4%B9%8B%E6%B3%9B%E5%9E%8B%E4%BB%8B%E7%BB%8D/</url>
    <content><![CDATA[<p>hello 大家好我是Monday，今天我们开启SpringBoot的学习的系列文章之SpringBoot项目引入本地Jar包。</p>
<a id="more"></a>
<p><strong>java 中泛型标记符：</strong></p>
<ul>
<li><p><strong>E</strong> - Element (在集合中使用，因为集合中存放的是元素)</p>
</li>
<li><p><strong>T</strong> - Type（Java 类）</p>
</li>
<li><p><strong>K</strong> - Key（键）</p>
</li>
<li><p><strong>V</strong> - Value（值）</p>
</li>
<li><p><strong>N</strong> - Number（数值类型）</p>
</li>
<li><p><strong>？</strong> - 表示不确定的 java 类型</p>
</li>
</ul>
<h3 id="实例"><a href="#实例" class="headerlink" title="实例"></a>实例</h3><p>下面的例子演示了如何使用泛型方法打印不同类型的数组元素：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> fanxing;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">* java 泛型</span></span><br><span class="line"><span class="comment">* */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GenericMethodTest</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="comment">// 泛型方法 printArray</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt; E &gt; <span class="function"><span class="keyword">void</span> <span class="title">printArray</span><span class="params">( E[] inputArray )</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">// 输出数组元素</span></span><br><span class="line">        <span class="keyword">for</span> ( E element : inputArray )&#123;</span><br><span class="line">            System.out.printf( <span class="string">"%s "</span>, element );</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">( String args[] )</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">// 创建不同类型数组： Integer, Double 和 Character</span></span><br><span class="line">        Integer[] intArray = &#123; <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span> &#125;;</span><br><span class="line">        Double[] doubleArray = &#123; <span class="number">1.1</span>, <span class="number">2.2</span>, <span class="number">3.3</span>, <span class="number">4.4</span> &#125;;</span><br><span class="line">        Character[] charArray = &#123; <span class="string">'H'</span>, <span class="string">'E'</span>, <span class="string">'L'</span>, <span class="string">'L'</span>, <span class="string">'O'</span> &#125;;</span><br><span class="line"></span><br><span class="line">        System.out.println( <span class="string">"整型数组元素为:"</span> );</span><br><span class="line">        printArray( intArray  ); <span class="comment">// 传递一个整型数组</span></span><br><span class="line"></span><br><span class="line">        System.out.println( <span class="string">"\n双精度型数组元素为:"</span> );</span><br><span class="line">        printArray( doubleArray ); <span class="comment">// 传递一个双精度型数组</span></span><br><span class="line"></span><br><span class="line">        System.out.println( <span class="string">"\n字符型数组元素为:"</span> );</span><br><span class="line">        printArray( charArray ); <span class="comment">// 传递一个字符型数组</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>运行结果如下所示：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">整型数组元素为:</span><br><span class="line">1 2 3 4 5 </span><br><span class="line"></span><br><span class="line">双精度型数组元素为:</span><br><span class="line">1.1 2.2 3.3 4.4 </span><br><span class="line"></span><br><span class="line">字符型数组元素为:</span><br><span class="line">H E L L O</span><br></pre></td></tr></table></figure>
<p><strong>参考文献：</strong></p>
<p>​    <a href="https://www.runoob.com/java/java-generics.html" target="_blank" rel="noopener">https://www.runoob.com/java/java-generics.html</a></p>
<p>​    <a href="https://www.cnblogs.com/coprince/p/8603492.html" target="_blank" rel="noopener">https://www.cnblogs.com/coprince/p/8603492.html</a></p>
<p><strong>结束语</strong>：</p>
<p>​    今天的分享就到这里了，欢迎大家关注微信公众号”<strong>菜鸟童靴</strong>“</p>
<p><img src="/2022/05/12/Java%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E4%B9%8B%E6%B3%9B%E5%9E%8B%E4%BB%8B%E7%BB%8D/微信.png" style="zoom: 50%;"></p>
]]></content>
      <categories>
        <category>java</category>
      </categories>
      <tags>
        <tag>java</tag>
      </tags>
  </entry>
  <entry>
    <title>SpringBoot项目引入本地Jar包</title>
    <url>/2022/05/12/SpringBoot%E9%A1%B9%E7%9B%AE%E5%BC%95%E5%85%A5%E6%9C%AC%E5%9C%B0Jar%E5%8C%85/</url>
    <content><![CDATA[<p>hello 大家好我是Monday，今天我们开启SpringBoot的学习的系列文章之SpringBoot项目引入本地Jar包。</p>
<a id="more"></a>
<p>在开发过程中有时会用到maven仓库里没有的jar包或者本地的jar包，这时没办法通过pom直接引入，那么该怎么解决呢</p>
<ul>
<li>这个jar包不在maven仓库里面，如果我们要引入这个下载的jar包。有两种方法可以试试：<ol>
<li>本地直接引入，打包到依赖文件中。</li>
<li>打包上传到maven本地仓库中，然后pom文件正常引入。</li>
</ol>
</li>
</ul>
<p>首先我们将下载好的jar包放到指定目录下</p>
<p><img src="/2022/05/12/SpringBoot%E9%A1%B9%E7%9B%AE%E5%BC%95%E5%85%A5%E6%9C%AC%E5%9C%B0Jar%E5%8C%85/1.jpg" style="zoom: 150%;"></p>
<p><strong>1、在根目录文件夹下面新建lib文件夹，需要的数据库jar包放到这里</strong></p>
<p><strong>2、在pom文件中引入刚刚添加的文件。</strong></p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!--引入本地资源--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>fastjson<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.2.27<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">scope</span>&gt;</span>system<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">systemPath</span>&gt;</span>$&#123;project.basedir&#125;/lib/fastjson-1.2.27.jar<span class="tag">&lt;/<span class="name">systemPath</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p><code>groupId</code>和<code>artifactId</code>可以自定义，建议和所要引入的jar包不要有太大的出入,</p>
<p><code>version</code>填写引入jar包的版本号即可。</p>
<p><code>systemPath</code>这个路径填写jar包的所在路径。</p>
<p><code>scope</code>需要填写system，这个不可省略，否则可能会报错。</p>
<p><code>${project.basedir}</code>是一个系统常量，代表当前项目的根目录。</p>
<p><strong>3、项目打包时引入本地jar包,需要在打包插件中引入<code>&lt;includeSystemScope&gt;</code>，具体的如下所示。</strong></p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">includeSystemScope</span>&gt;</span>true<span class="tag">&lt;/<span class="name">includeSystemScope</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p><strong>4、Maven 更新下配置：</strong></p>
<p><img src="/2022/05/12/SpringBoot%E9%A1%B9%E7%9B%AE%E5%BC%95%E5%85%A5%E6%9C%AC%E5%9C%B0Jar%E5%8C%85/2.jpg" style="zoom: 150%;"></p>
<p><strong>5、成功使用</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.demo;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSONObject;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestDemo</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"><span class="comment">//            //把参数传进Map中</span></span><br><span class="line">        HashMap&lt;String,String&gt; paramsMap=<span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        paramsMap.put(<span class="string">"name"</span>,<span class="string">"哈哈"</span>);</span><br><span class="line">        paramsMap.put(<span class="string">"client"</span>,<span class="string">"Android"</span>);</span><br><span class="line">        paramsMap.put(<span class="string">"id"</span>,<span class="string">"3243598"</span>);</span><br><span class="line">        String jsonStr = JSONObject.toJSONString(paramsMap);</span><br><span class="line">        System.out.println(jsonStr);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>注意</strong>：</p>
<p>下载的jar一定要版本相对应，避免版本过高，不支持，一直显示无法导入，小编深陷此坑</p>
<h3 id="上传jar包到maven仓库"><a href="#上传jar包到maven仓库" class="headerlink" title="上传jar包到maven仓库"></a>上传jar包到maven仓库</h3><p>我们还可以使用相关的maven命令，把相关的jar包上传到maven仓库，然后就可以在项目中直接引用了。</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">mvn install:install-file </span><br><span class="line">-Dfile=D:/Workspace/fastjson-1.2.27.jar</span><br><span class="line">-DgroupId=com.alibaba </span><br><span class="line">-DartifactId=fastjson</span><br><span class="line">-Dversion=1.2.27</span><br><span class="line">-Dpackaging=jar</span><br></pre></td></tr></table></figure>
<p><code>-Dfile</code>：jar包文件的地址</p>
<p><code>-DgroupId</code>：引入依赖时填写的groupId</p>
<p><code>-DartifactId</code>：引入依赖时填写的artifactId</p>
<p><code>-Dversion</code>：版本号</p>
<p><code>-Dpackaging</code>：打包方式</p>
<hr>
<p>如此一来基本上可以满足我们的需求了。</p>
<p><strong>参考文献：</strong></p>
<p><a href="https://blog.csdn.net/yanmouren110/article/details/106922452" target="_blank" rel="noopener">https://blog.csdn.net/yanmouren110/article/details/106922452</a></p>
<p><a href="https://www.jianshu.com/p/a8d6d76c5566" target="_blank" rel="noopener">https://www.jianshu.com/p/a8d6d76c5566</a></p>
<p><a href="https://www.cnblogs.com/tudou1179006580/p/14875366.html" target="_blank" rel="noopener">https://www.cnblogs.com/tudou1179006580/p/14875366.html</a></p>
<p><strong>结束语</strong>：</p>
<p>​    今天的分享就到这里了，欢迎大家关注微信公众号”<strong>菜鸟童靴</strong>“</p>
<p><img src="/2022/05/12/SpringBoot%E9%A1%B9%E7%9B%AE%E5%BC%95%E5%85%A5%E6%9C%AC%E5%9C%B0Jar%E5%8C%85/微信.png" style="zoom: 50%;"></p>
]]></content>
      <categories>
        <category>SpringBoot</category>
      </categories>
      <tags>
        <tag>java</tag>
        <tag>SpringBoot</tag>
      </tags>
  </entry>
  <entry>
    <title>使用setuptools打包盘python项目</title>
    <url>/2022/05/10/%E4%BD%BF%E7%94%A8setuptools%E6%89%93%E5%8C%85%E7%9B%98python%E9%A1%B9%E7%9B%AE/</url>
    <content><![CDATA[<p>hello 大家好我是Monday，今天给大家带来一篇关于简单介绍使用setuptools打包盘python项目</p>
<p>的文章。</p>
<a id="more"></a>
<p>当我们写一个完整的项目，需要该项目文件中打包成分发包共享给他人或者上传到pypi社区以供他人下载。这就需要对该项目进行打包分发。</p>
<h3 id="项目文件"><a href="#项目文件" class="headerlink" title="项目文件"></a>项目文件</h3><p>这是一个已写好的项目文件包，叫做<code>wxtool</code>，它的目录结构如下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">├─wxtools</span><br><span class="line">│  __init__.py</span><br><span class="line">├─wxtool</span><br><span class="line">│  │  .gitignore</span><br><span class="line">│  │  callback_server.py</span><br><span class="line">│  │  config.py</span><br><span class="line">│  │  readme.txt</span><br><span class="line">│  │  requirements.txt</span><br><span class="line">│  │  scheduled_server.py</span><br><span class="line">│  │  worker.py</span><br><span class="line">│  ├─chain</span><br><span class="line">│  │  │  scheduled_task.py</span><br><span class="line">│  │  │  __init__.py</span><br><span class="line">│  ├─common</span><br><span class="line">│  │  │  MysqlSaveMethod.py</span><br><span class="line">│  │  │  __init__.py</span><br><span class="line">│  ├─create_table</span><br><span class="line">│  │  │  create_table.py</span><br><span class="line">│  │  │  create_table_ceshi.py</span><br><span class="line">│  │  │  __init__.py</span><br><span class="line">│  ├─datas</span><br><span class="line">│  ├─db</span><br><span class="line">│  │  │  mysqldb.py</span><br><span class="line">│  │  │  redis_db.py</span><br><span class="line">│  │  │  __init__.py</span><br><span class="line">│  ├─extract_data</span><br><span class="line">│  │  │  login.py</span><br><span class="line">│  │  │  __init__.py</span><br><span class="line">│  ├─logs</span><br><span class="line">│  ├─middleware</span><br><span class="line">│  │  │  extract_data.py</span><br><span class="line">│  │  │  __init__.py</span><br><span class="line">│  │  │</span><br><span class="line">│  │  └─__pycache__</span><br><span class="line">│  ├─routers</span><br><span class="line">│  │  │  pull_task.py</span><br><span class="line">│  │  │  upload_file.py</span><br><span class="line">│  │  │  __init__.py</span><br><span class="line">│  │  │</span><br><span class="line">│  │  └─__pycache__</span><br><span class="line">│  └─utils</span><br><span class="line">│      │  bas64_tools.py</span><br><span class="line">│      │  __init__.py</span><br></pre></td></tr></table></figure>
<p>现在我们需要对这个wxtool进行打包。</p>
<h3 id="创建包文件和setup-py文件"><a href="#创建包文件和setup-py文件" class="headerlink" title="创建包文件和setup.py文件"></a>创建包文件和setup.py文件</h3><p><code>wxtool</code>是将打包的Python包文件，在<code>wxtool</code>的同级目录下分别创建以下文件：</p>
<ul>
<li>setup.py —— 打包脚本文件，执行该脚本将自动完成打包</li>
<li>LICENCE —— 许可证文件</li>
<li>README —— 包的介绍和说明</li>
</ul>
<p>创建后文件目录结构部分如下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">├─wxtools</span><br><span class="line">│  setup.py</span><br><span class="line">│  LICENCE</span><br><span class="line">│  README</span><br><span class="line">│  __init__.py</span><br><span class="line">├─wxtool</span><br></pre></td></tr></table></figure>
<h3 id="setup-py配置"><a href="#setup-py配置" class="headerlink" title="setup.py配置"></a>setup.py配置</h3><p>打开setup.py文件，写入以下内容</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># -*- coding: utf-8 -*-</span><br><span class="line">&quot;&quot;&quot;</span><br><span class="line">Created on 2021-12-13 16:29:25</span><br><span class="line">---------</span><br><span class="line">@summary:</span><br><span class="line">---------</span><br><span class="line">@author: Monday</span><br><span class="line">&quot;&quot;&quot;</span><br><span class="line">import setuptools  # 导入setuptools, 基于setuptools模块进行打包分发</span><br><span class="line">import os, shutil</span><br><span class="line"></span><br><span class="line"># 移除构建的build文件夹</span><br><span class="line">CUR_PATH &#x3D; os.path.dirname(os.path.abspath(__file__))</span><br><span class="line">path &#x3D; os.path.join(CUR_PATH, &#39;build&#39;)</span><br><span class="line">if os.path.isdir(path):</span><br><span class="line">    print(&#39;INFO del dir &#39;, path)</span><br><span class="line">    shutil.rmtree(path)</span><br><span class="line"></span><br><span class="line"># 将readme文件中内容加载进来，作为对包的详细说明（可以不需要）</span><br><span class="line"># with open(&quot;README.md&quot;, &quot;r&quot;,encoding&#x3D;&quot;utf-8&quot;) as fh:</span><br><span class="line">#     long_description &#x3D; fh.read()</span><br><span class="line"></span><br><span class="line"># 调用setuptools的setup进行打包，通过参数配置指定包的信息，这是打包的关键设置</span><br><span class="line">setuptools.setup(</span><br><span class="line">    name&#x3D;&quot;wxtool&quot;,  # 这是该包的名字，将来可能使用pip install 该包名直接下载</span><br><span class="line">    version&#x3D;&quot;1.0.1&quot;,  # 版本号，</span><br><span class="line">    author&#x3D;&quot;Monday&quot;,  # 作者</span><br><span class="line">    author_email&#x3D;&quot;author@example.com&quot;,  # 作者邮箱</span><br><span class="line">    description&#x3D;&quot;wxtool拦截消息入库功能&quot;,  # 包简短的描述</span><br><span class="line">    # long_description&#x3D;long_description,  # 详细的描述，这里使用从readme中读取的内容</span><br><span class="line">    # long_description_content_type&#x3D;&quot;text&#x2F;markdown&quot;,  # 详细描述来源文件的文件类型，这里使用markdomn</span><br><span class="line">    # url&#x3D;&quot;https:&#x2F;&#x2F;github.com&#x2F;pypa&#x2F;my_pkg&quot;,  # 可以将项目上传到github,gitlab等，在此指定链接地址以供下载。</span><br><span class="line"></span><br><span class="line">    # 指定需要打包的内容，输入需要打包包名字符串列表，打包时不会自动获取子包，需要手动指定，例如：[&quot;my_pkg&quot;, &quot;mypkg.utils&quot;]</span><br><span class="line">    packages&#x3D;setuptools.find_packages(),  # 使用该函数可以自动打包该同级目录下所有包</span><br><span class="line">    include_package_data&#x3D;True,  # 启用清单文件MANIFEST.in,包含数据文件</span><br><span class="line">    exclude_package_data&#x3D;&#123;&#39;wxtools&#39;: [&#39;readme.txt&#39;]&#125;,  # 排除文件</span><br><span class="line">    # 自动安装依赖</span><br><span class="line">    install_requires&#x3D;[&quot;amqp&#x3D;&#x3D;2.5.2&quot;,</span><br><span class="line">                      &quot;attrs&#x3D;&#x3D;19.3.0&quot;,</span><br><span class="line">                      &quot;demjson&quot;,</span><br><span class="line">                      &quot;fastapi&quot;,</span><br><span class="line">                      &quot;uvicorn&quot;,</span><br><span class="line">                      &quot;cachelib&quot;,</span><br><span class="line">                      &quot;WMI&quot;,</span><br><span class="line">                      &quot;psutil&quot;,</span><br><span class="line">                      &quot;apscheduler&quot;,</span><br><span class="line">                      &quot;better-exceptions&gt;&#x3D;0.2.2&quot;,</span><br><span class="line">                      &quot;redis-py-cluster&gt;&#x3D;2.1.0&quot;,</span><br><span class="line">                      &quot;boto3&quot;,</span><br><span class="line">                      &quot;schedule&quot;,</span><br><span class="line">                      &quot;python-jose&#x3D;&#x3D;3.2.0&quot;,</span><br><span class="line">                      &quot;passlib[Bcrypt]&#x3D;&#x3D;1.7.4&quot;,</span><br><span class="line">                      &quot;python-multipart&quot;,</span><br><span class="line">                      &quot;pyjwt&quot;,</span><br><span class="line">                      &quot;aiofiles&quot;,</span><br><span class="line">                      &quot;slowapi&quot;, ],</span><br><span class="line"></span><br><span class="line">    classifiers&#x3D;[  # 指定一些包的元数据信息，例如使用的协议，操作系统要求</span><br><span class="line">        &quot;Programming Language :: Python :: 3&quot;,</span><br><span class="line">        &quot;License :: OSI Approved :: MIT License&quot;,</span><br><span class="line">        &quot;Operating System :: OS Independent&quot;,</span><br><span class="line">    ],</span><br><span class="line">    python_requires&#x3D;&#39;&gt;&#x3D;3.9&#39;,  # 该包的Python版本要求</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>setup.py中除了上述内容，还可以添加包括以下的信息</p>
<p>创建setup.py文件后，可通过执行“python setup.py —help”命令获得帮助信息</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">setup函数各参数详解：</span><br><span class="line">&gt;&gt;python setup.py --help</span><br><span class="line">  --name              包名称</span><br><span class="line">  --version (-V)      包版本</span><br><span class="line">  --author            程序的作者</span><br><span class="line">  --author_email      程序的作者的邮箱地址</span><br><span class="line">  --maintainer        维护者</span><br><span class="line">  --maintainer_email  维护者的邮箱地址</span><br><span class="line">  --url               程序的官网地址</span><br><span class="line">  --license           程序的授权信息</span><br><span class="line">  --description       程序的简单描述</span><br><span class="line">  --long_description  程序的详细描述</span><br><span class="line">  --platforms         程序适用的软件平台列表</span><br><span class="line">  --classifiers       程序的所属分类列表</span><br><span class="line">  --keywords          程序的关键字列表</span><br><span class="line">  --packages  需要打包的目录列表</span><br><span class="line">  --py_modules  需要打包的python文件列表</span><br><span class="line">  --download_url  程序的下载地址</span><br><span class="line">  --cmdclass  </span><br><span class="line">  --data_files  打包时需要打包的数据文件，如图片，配置文件等</span><br><span class="line">  --scripts  安装时需要执行的脚步列表</span><br></pre></td></tr></table></figure>
<p>setup.py配置完成后，就可以执行这个文件进行打包了（在命令行使用Python解释器指定参数执行，不能直接执行），在此之前还有<code>LICENCE</code>和<code>README</code>两个文件需要完善（也可以不做处理，不影响打包执行）。</p>
<h4 id="README"><a href="#README" class="headerlink" title="README"></a>README</h4><p>这个文件是该包的详细说明文件，包括各种信息，例如该包如何安装，需要的环境，如何使用等详细内容。</p>
<h4 id="LICENCE"><a href="#LICENCE" class="headerlink" title="LICENCE"></a>LICENCE</h4><p>指定许可证信息，开源软件都遵循了不同的开源协议，这些协议规定了使用者使用该包后必须遵守的原则，可以查看不同开源协议内容 <a href="https://choosealicense.com/" target="_blank" rel="noopener">https://choosealicense.com/</a> ，选则一个协议，复制对应的协议内容到该文件中即可：</p>
<p>示例选择MIT协议</p>
<p><img src="/2022/05/10/%E4%BD%BF%E7%94%A8setuptools%E6%89%93%E5%8C%85%E7%9B%98python%E9%A1%B9%E7%9B%AE/1.jpg" style="zoom: 50%;"></p>
<p>由于只是内部使用，所以就没有填写LICENCE</p>
<h4 id="打包成wheel二进制包"><a href="#打包成wheel二进制包" class="headerlink" title="打包成wheel二进制包"></a>打包成wheel二进制包</h4><p>安装wheel</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">pip install wheel</span><br></pre></td></tr></table></figure>
<p>这需要最新的setuptools 和 wheel包。执行以下命令更新</p>
<figure class="highlight css"><table><tr><td class="code"><pre><span class="line"><span class="selector-tag">python</span> <span class="selector-tag">-m</span> <span class="selector-tag">pip</span> <span class="selector-tag">install</span> <span class="selector-tag">--user</span> <span class="selector-tag">--upgrade</span> <span class="selector-tag">setuptools</span> <span class="selector-tag">wheel</span></span><br></pre></td></tr></table></figure>
<p>执行该setup.py文件并指定参数，指定打包为wheel二进制文件。</p>
<figure class="highlight mipsasm"><table><tr><td class="code"><pre><span class="line">python setup.py sdist <span class="keyword">bdist_wheel</span></span><br></pre></td></tr></table></figure>
<p>执行该命令后，该目录下会多出build、dist、三个目录。</p>
<p><img src="/2022/05/10/%E4%BD%BF%E7%94%A8setuptools%E6%89%93%E5%8C%85%E7%9B%98python%E9%A1%B9%E7%9B%AE/3.jpg" style="zoom: 50%;"></p>
<p>在dist目录下就是我们打包好的源代码文件（tar.gz）和wheel二进制文件(.whl)。</p>
<p><img src="/2022/05/10/%E4%BD%BF%E7%94%A8setuptools%E6%89%93%E5%8C%85%E7%9B%98python%E9%A1%B9%E7%9B%AE/2.jpg" style="zoom: 50%;"></p>
<p>直接安装使用：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">pip <span class="keyword">install</span> wxtool<span class="number">-0.0</span><span class="number">.1</span>-py3-<span class="keyword">none</span>-<span class="keyword">any</span>-whl</span><br></pre></td></tr></table></figure>
<p>该命令会将这个包安装到python安装目录下/Lib/site-packages目录下，使用<code>pip list</code>命令可以看到在列表中出现了名为wxtool的包名，安装成功。该包可以使用了。</p>
<p><img src="/2022/05/10/%E4%BD%BF%E7%94%A8setuptools%E6%89%93%E5%8C%85%E7%9B%98python%E9%A1%B9%E7%9B%AE/4.jpg" style="zoom: 50%;"></p>
<p><img src="/2022/05/10/%E4%BD%BF%E7%94%A8setuptools%E6%89%93%E5%8C%85%E7%9B%98python%E9%A1%B9%E7%9B%AE/5.jpg" style="zoom: 50%;"></p>
<p>安装成功可以使用了</p>
<p>如果将该包上传到pypi社区供他人下载，需要注意自己包名不要和其他贡献者的包名相同，如何判断是否重复，尝试在未上传前使用<code>pip isntall 包名</code>进行安装，若没有找到找到该package表示该名可用，也可以上pypi官网搜索。上传成功后，直接使用<code>pip install 包名</code>进行安装。上传pypi过程见官网</p>
<p>示例</p>
<p><a href="https://packaging.python.org/tutorials/packaging-projects/#uploading-the-distribution-archives" target="_blank" rel="noopener">https://packaging.python.org/tutorials/packaging-projects/#uploading-the-distribution-archives</a></p>
<h4 id="其他选项-来源于网络-："><a href="#其他选项-来源于网络-：" class="headerlink" title="其他选项(来源于网络)："></a>其他选项(来源于网络)：</h4><h4 id="二进制安装程序-bdist"><a href="#二进制安装程序-bdist" class="headerlink" title="二进制安装程序-bdist"></a>二进制安装程序-bdist</h4><p>打包为二进制安装包，生成目标操作系统的安装程序。</p>
<p><strong>生成windows 安装程序</strong></p>
<p>针对windows环境下，以下三条命令均可</p>
<figure class="highlight mipsasm"><table><tr><td class="code"><pre><span class="line">python setup.py <span class="keyword">bdist_wininst</span></span><br><span class="line"><span class="keyword">Python </span>setup.py <span class="keyword">bdist_msi</span></span><br><span class="line"><span class="keyword">python </span>setup.py <span class="keyword">bdist </span>--format=msi</span><br></pre></td></tr></table></figure>
<p>创建一个dist目录，生成一个安装程序，在Windows上直接双击即可安装该包。</p>
<p><strong>生成rpm包</strong></p>
<figure class="highlight mipsasm"><table><tr><td class="code"><pre><span class="line">python setup.py <span class="keyword">bdist_rpm</span></span><br><span class="line"><span class="keyword">python </span>setup.py <span class="keyword">bdist </span>-- format=rpm</span><br></pre></td></tr></table></figure>
<p>在Linux系统中使用rpm命令进行安装。</p>
<p><strong>生成压缩文件</strong></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">python setup.py bdist --format=zip</span><br><span class="line">python setup.py bdist --format=gztar</span><br></pre></td></tr></table></figure>
<p><strong>参考链接：</strong></p>
<p><a href="https://zhuanlan.zhihu.com/p/162842824" target="_blank" rel="noopener">https://zhuanlan.zhihu.com/p/162842824</a></p>
<p><a href="https://www.cnblogs.com/anliven/p/9840583.html" target="_blank" rel="noopener">https://www.cnblogs.com/anliven/p/9840583.html</a></p>
<p><a href="https://www.cnblogs.com/k5210202/p/13819403.html" target="_blank" rel="noopener">https://www.cnblogs.com/k5210202/p/13819403.html</a></p>
<p><strong>结束语</strong>：</p>
<p>​    今天的分享就到这里了，欢迎大家关注微信公众号”<strong>菜鸟童靴</strong>“</p>
<p><img src="/2022/05/10/%E4%BD%BF%E7%94%A8setuptools%E6%89%93%E5%8C%85%E7%9B%98python%E9%A1%B9%E7%9B%AE/微信.png" style="zoom: 50%;"></p>
]]></content>
      <categories>
        <category>技术杂谈</category>
      </categories>
      <tags>
        <tag>setuptools打包</tag>
      </tags>
  </entry>
  <entry>
    <title>初识Protobuf（一）</title>
    <url>/2022/05/09/%E5%88%9D%E8%AF%86Protobuf%EF%BC%88%E4%B8%80%EF%BC%89/</url>
    <content><![CDATA[<p>hello 大家好我是Monday，今天给大家带来一篇关于简单介绍Protobuf协议以及如何使用Protobuf来实现序列化与反序列化</p>
<p>的文章。</p>
<a id="more"></a>
<h3 id="前言："><a href="#前言：" class="headerlink" title="前言："></a>前言：</h3><p>Protobuf即Protocol Buffers，是Google公司开发的一种跨语言和平台的序列化数据结构的方式，是一个灵活的、高效的用于序列化数据的协议。</p>
<p>  与XML和JSON格式相比，Protobuf更小、更快、更便捷。Protobuf是跨语言的，并且自带一个编译器(protoc)，只需要用protoc进行编译，就可以编译成Java、Python、C++、C#、Go等多种语言代码，然后可以直接使用，不需要再写其它代码，自带有解析的代码。</p>
<p>  只需要将要被序列化的结构化数据定义一次(在.proto文件定义)，便可以使用特别生成的源代码(使用Protobuf提供的生成工具)轻松的使用不同的数据流完成对结构数据的读写操作。甚至可以更新.proto文件中对数据结构的定义而不会破坏依赖旧格式编译出来的程序。</p>
<p>  <strong>Protobuf的优点如下：</strong></p>
<ul>
<li>性能号，效率高。序列化后字节占用空间比XML少3-10倍，序列化的时间效率比XML快20-100倍。</li>
<li>有代码生成机制。将对结构化数据的操作封装成一个类，便于使用。</li>
<li>支持向后和向前兼容。当客户端和服务器同时使用一块协议的时候， 当客户端在协议中增加一个字节，并不会影响客户端的使用。</li>
<li>支持多种编程语言。Protobuf目前已经支持Java，C++，Python、Go、Ruby等多种语言。</li>
</ul>
<p>  <strong>Protobuf的缺点如下：</strong></p>
<ul>
<li>二进制格式导致可读性差</li>
<li>缺乏自描述</li>
<li>应用不是很广泛</li>
</ul>
<p>（以上文字来源于网络）</p>
<h3 id="Protobuf安装："><a href="#Protobuf安装：" class="headerlink" title="Protobuf安装："></a>Protobuf安装：</h3><p>（1）安装第三方库</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">pip install protobuf&#x3D;&#x3D;3.20.1</span><br></pre></td></tr></table></figure>
<p>（2）下载proto编译器</p>
<p><a href="https://github.com/protocolbuffers/protobuf/releases/" target="_blank" rel="noopener">https://github.com/protocolbuffers/protobuf/releases/</a></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">一个exe程序，把 proto.exe 加入到环境变量里</span><br></pre></td></tr></table></figure>
<p><img src="/2022/05/09/%E5%88%9D%E8%AF%86Protobuf%EF%BC%88%E4%B8%80%EF%BC%89/1.jpg" style="zoom: 50%;"></p>
<p>下载对应的版本，小编使用的是windows+python语言，所以下载protoc-3.20.1-win64</p>
<p>注意：</p>
<p>电脑安装的编译器版本和 python包版本一定要相对应</p>
<h3 id="Protobuf-正向流程："><a href="#Protobuf-正向流程：" class="headerlink" title="Protobuf 正向流程："></a>Protobuf 正向流程：</h3><p><img src="/2022/05/09/%E5%88%9D%E8%AF%86Protobuf%EF%BC%88%E4%B8%80%EF%BC%89/2.jpg" style="zoom: 150%;"></p>
<h3 id="proto文件格式说明："><a href="#proto文件格式说明：" class="headerlink" title=".proto文件格式说明："></a>.proto文件格式说明：</h3><p>  在前面的简介部分已经说过，Protobuf在使用时定义序列化结构的文件为后缀是.proto的文件。</p>
<p>  .proto文件有专门的语法结构，ProtoBuf有两个语法版本：v2与v3。message 用来定义一个数据结构。</p>
<p>  我们先来看一个简单的.proto文件的例子：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">syntax = <span class="string">"proto3"</span>;</span><br><span class="line"></span><br><span class="line">message Person &#123;</span><br><span class="line">    int64 id = <span class="number">1</span>;</span><br><span class="line">    string name = <span class="number">2</span>;</span><br><span class="line">    repeated string skills = <span class="number">3</span>;  // 这里表示skills可以接受多个string类型的值</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>文件的首行生命该语法使用Protobuf3语法，同时在文件后面定义了Person消息，该消息有三个字段：id, name, skill。</p>
<p>  每个字段的定义格式为 <code>指定字段规则 数据类型 变量名称=数字标识符</code>。</p>
<p>  <code>指定字段规则</code>在Protobuf3语法中只有repeated、singular两种类型，</p>
<p>其中singular类型（默认类型，不需要声明）表示有0个或者1个这种字段（但是不能超过1个）；</p>
<p>repeated类型表示该字段可以重复任意多次(包括0次)，重复值的顺序会被保留。</p>
<p>  <code>数据类型</code>常见的有double、float、int32、string、bytes、bool等，也可以是枚举、嵌套消息类型、Any、oneof等。</p>
<p>正如你所见，在消息定义中，每个字段都有唯一的一个数字标识符。这些标识符是用来在消息的二进制格式中识别各个字段的，一旦开始使用就不能够再改变。注：[1,15]之内的标识号在编码的时候会占用一个字节。[16,2047]之内的标识号则占用2个字节。所以应该为那些频繁出现的消息元素保留 [1,15]之内的标识号。切记：要为将来有可能添加的、频繁出现的标识号预留一些标识号。</p>
<p>最小的标识号可以从1开始，最大到2^29 - 1, or 536,870,911。不可以使用其中的[19000－19999]（ (从FieldDescriptor::kFirstReservedNumber 到 FieldDescriptor::kLastReservedNumber)）的标识号， Protobuf协议实现中对这些进行了预留。如果非要在.proto文件中使用这些预留标识号，编译时就会报警。同样你也不能使用早期保留的标识号。</p>
<h3 id="从-proto文件生成了什么？"><a href="#从-proto文件生成了什么？" class="headerlink" title="从.proto文件生成了什么？"></a>从.proto文件生成了什么？</h3><p>当用protocol buffer编译器来运行.proto文件时，编译器将生成所选择语言的代码，这些代码可以操作在.proto文件中定义的消息类型，包括获取、设置字段值，将消息序列化到一个输出流中，以及从一个输入流中解析消息。</p>
<ul>
<li>对C++来说，编译器会为每个.proto文件生成一个.h文件和一个.cc文件，.proto文件中的每一个消息有一个对应的类。</li>
<li>对Java来说，编译器为每一个消息类型生成了一个.java文件，以及一个特殊的Builder类（该类是用来创建消息类接口的）。</li>
<li>对Python来说，有点不太一样——Python编译器为.proto文件中的每个消息类型生成一个含有静态描述符的模块，，该模块与一个元类（metaclass）在运行时（runtime）被用来创建所需的Python数据访问类。</li>
<li>对go来说，编译器会位每个消息类型生成了一个.pd.go文件。</li>
<li>对于Ruby来说，编译器会为每个消息类型生成了一个.rb文件。</li>
<li>javaNano来说，编译器输出类似域java但是没有Builder类</li>
<li>对于Objective-C来说，编译器会为每个消息类型生成了一个pbobjc.h文件和pbobjcm文件，.proto文件中的每一个消息有一个对应的类。</li>
<li>对于C#来说，编译器会为每个消息类型生成了一个.cs文件，.proto文件中的每一个消息有一个对应的类。<br>你可以从如下的文档链接中获取每种语言更多API(proto3版本的内容很快就公布)。<a href="https://developers.google.com/protocol-buffers/docs/reference/overview" target="_blank" rel="noopener">API Reference</a></li>
</ul>
<h3 id="下面我们开始实际操作起来："><a href="#下面我们开始实际操作起来：" class="headerlink" title="下面我们开始实际操作起来："></a>下面我们开始实际操作起来：</h3><h3 id="序列化与反序列化"><a href="#序列化与反序列化" class="headerlink" title="序列化与反序列化"></a>序列化与反序列化</h3><p>下面将通过一个简单的里来介绍如何使用Protobuf来实现序列化与反序列化。</p>
<p>  定义数据结构文件（<code>person_and_book.proto</code>）如下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">syntax &#x3D; &quot;proto3&quot;;</span><br><span class="line"></span><br><span class="line">message Book &#123;  &#x2F;&#x2F; 书籍信息</span><br><span class="line">  string name &#x3D; 1;</span><br><span class="line">  float price &#x3D; 2;</span><br><span class="line">  string press &#x3D; 3;</span><br><span class="line">  repeated Person people &#x3D; 4;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">message Person &#123;  &#x2F;&#x2F; 人物信息</span><br><span class="line">  int32 id &#x3D; 1;</span><br><span class="line">  string name &#x3D; 2;</span><br><span class="line">  int32 age &#x3D; 3;</span><br><span class="line">  string email &#x3D; 4;</span><br><span class="line">  string job &#x3D; 5;</span><br><span class="line">  bool work_status &#x3D; 6;</span><br><span class="line">  string city &#x3D; 7;</span><br><span class="line"></span><br><span class="line">  MyAddress maps &#x3D; 8;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">message MyAddress &#123; &#x2F;&#x2F; 地址信息,字段类型为map</span><br><span class="line">  map&lt;string, string&gt; tell_address &#x3D; 1;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>使用protoc编译person_and_book.proto文件, 命令行如下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">protoc.exe .&#x2F;person_and_book.proto  --python_out&#x3D;.&#x2F;</span><br></pre></td></tr></table></figure>
<p>编译完毕，会自动生成person_and_book_pb2.py文件。在命令行中，./person_and_book.proto为需要编译的.proto文件所在路径，python_out为输出python脚本路径，./表示为当前路径。</p>
<p>  接着我们使用一个新的脚本（add_person.py）针对该数据结构进行序列化与反序列化。完整代码如下：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">import</span> person_and_book_pb2</span><br><span class="line"></span><br><span class="line"><span class="comment"># 书籍信息</span></span><br><span class="line">book = person_and_book_pb2.Book()</span><br><span class="line">book.name = <span class="string">"菜鸟童靴"</span></span><br><span class="line">book.price = <span class="number">8.5</span></span><br><span class="line">book.press = <span class="string">"NY Press"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 添加人物信息</span></span><br><span class="line">person = book.people.add()</span><br><span class="line">person.id = <span class="number">1</span></span><br><span class="line">person.name = <span class="string">"Monday"</span></span><br><span class="line">person.age = <span class="number">25</span></span><br><span class="line">person.email = <span class="string">"Monday@163.com"</span></span><br><span class="line">person.job = <span class="string">"college professor"</span></span><br><span class="line">person.work_status = <span class="literal">True</span></span><br><span class="line">person.city = <span class="string">"北京"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 添加人物的地址信息</span></span><br><span class="line">address_maps = person.maps</span><br><span class="line">address_maps.tell_address[<span class="string">"born place"</span>] = <span class="string">"内蒙古"</span></span><br><span class="line">address_maps.tell_address[<span class="string">"living place"</span>] = <span class="string">"北京"</span></span><br><span class="line">address_maps.tell_address[<span class="string">"visited place"</span>] = <span class="string">"内蒙古, 北京, 长春"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 序列化</span></span><br><span class="line">print(<span class="string">"===================序列化======================================"</span>)</span><br><span class="line">serializeToString = book.SerializeToString()</span><br><span class="line">print(type(serializeToString), serializeToString)</span><br><span class="line">print(<span class="string">"===================反序列化======================================"</span>)</span><br><span class="line"><span class="comment"># 反序列化</span></span><br><span class="line">parsed_book = person_and_book_pb2.Book()</span><br><span class="line">parsed_book.ParseFromString(serializeToString)</span><br><span class="line">print(type(parsed_book),parsed_book)</span><br><span class="line">print(<span class="string">"=======================输出书籍信息=================================="</span>)</span><br><span class="line"><span class="comment"># 输出书籍信息</span></span><br><span class="line">print(<span class="string">"book_name: %s, book_price: %s, book_press: %s"</span> % (parsed_book.name, parsed_book.price, parsed_book.press))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">print(<span class="string">"======================输出人物信息==================================="</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 输出人物信息</span></span><br><span class="line"><span class="keyword">for</span> person <span class="keyword">in</span> parsed_book.people:</span><br><span class="line">    print(<span class="string">"p_id: %s, p_name: %s, p_age: %s, p_email: %s, p_job: %s, p_work_status: %s, p_city: %s"</span></span><br><span class="line">          % (person.id, person.name, person.age, person.email, person.job, person.work_status, person.city))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> key <span class="keyword">in</span> person.maps.tell_address:</span><br><span class="line">        print(key, person.maps.tell_address[key])</span><br></pre></td></tr></table></figure>
<p><strong>输出结果如下：</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;序列化&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line">&lt;class &#39;bytes&#39;&gt; b&#39;\n\x0c\xe8\x8f\x9c\xe9\xb8\x9f\xe7\xab\xa5\xe9\x9d\xb4\x15\x00\x00\x08A\x1a\x08NY Press&quot;\x98\x01\x08\x01\x12\x06Monday\x18\x19&quot;\x0eMonday@163.com*\x11college professor0\x01:\x06\xe5\x8c\x97\xe4\xba\xacB]\n\x16\n\x0cliving place\x12\x06\xe5\x8c\x97\xe4\xba\xac\n*\n\rvisited place\x12\x19\xe5\x86\x85\xe8\x92\x99\xe5\x8f\xa4, \xe5\x8c\x97\xe4\xba\xac, \xe9\x95\xbf\xe6\x98\xa5\n\x17\n\nborn place\x12\t\xe5\x86\x85\xe8\x92\x99\xe5\x8f\xa4&#39;</span><br><span class="line">&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;反序列化&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line">&lt;class &#39;person_and_book_pb2.Book&#39;&gt; name: &quot;\350\217\234\351\270\237\347\253\245\351\235\264&quot;</span><br><span class="line">price: 8.5</span><br><span class="line">press: &quot;NY Press&quot;</span><br><span class="line">people &#123;</span><br><span class="line">  id: 1</span><br><span class="line">  name: &quot;Monday&quot;</span><br><span class="line">  age: 25</span><br><span class="line">  email: &quot;Monday@163.com&quot;</span><br><span class="line">  job: &quot;college professor&quot;</span><br><span class="line">  work_status: true</span><br><span class="line">  city: &quot;\345\214\227\344\272\254&quot;</span><br><span class="line">  maps &#123;</span><br><span class="line">    tell_address &#123;</span><br><span class="line">      key: &quot;born place&quot;</span><br><span class="line">      value: &quot;\345\206\205\350\222\231\345\217\244&quot;</span><br><span class="line">    &#125;</span><br><span class="line">    tell_address &#123;</span><br><span class="line">      key: &quot;living place&quot;</span><br><span class="line">      value: &quot;\345\214\227\344\272\254&quot;</span><br><span class="line">    &#125;</span><br><span class="line">    tell_address &#123;</span><br><span class="line">      key: &quot;visited place&quot;</span><br><span class="line">      value: &quot;\345\206\205\350\222\231\345\217\244, \345\214\227\344\272\254, \351\225\277\346\230\245&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;输出书籍信息&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line">book_name: 菜鸟童靴, book_price: 8.5, book_press: NY Press</span><br><span class="line">&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;输出人物信息&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line">p_id: 1, p_name: Monday, p_age: 25, p_email: Monday@163.com, p_job: college professor, p_work_status: True, p_city: 北京</span><br><span class="line">living place 北京</span><br><span class="line">born place 内蒙古</span><br><span class="line">visited place 内蒙古, 北京, 长春</span><br></pre></td></tr></table></figure>
<p><strong>参考网址：</strong></p>
<p>Protobuf3 语法指南 ： <a href="https://colobu.com/2017/03/16/Protobuf3-language-guide/" target="_blank" rel="noopener">https://colobu.com/2017/03/16/Protobuf3-language-guide/</a></p>
<p>Protobuf协议逆向和仿真&amp;举个栗子 ： <a href="https://mp.weixin.qq.com/s/_Na2hjLKvcgVzRx5u_zbLg" target="_blank" rel="noopener">https://mp.weixin.qq.com/s/_Na2hjLKvcgVzRx5u_zbLg</a></p>
<p><a href="https://mp.weixin.qq.com/s/QbLq5gVKjaHyoaY2Vv5MRQ" target="_blank" rel="noopener">https://mp.weixin.qq.com/s/QbLq5gVKjaHyoaY2Vv5MRQ</a></p>
<p><a href="https://zhuanlan.zhihu.com/p/38601419" target="_blank" rel="noopener">https://zhuanlan.zhihu.com/p/38601419</a></p>
<p><strong>结束语</strong>：</p>
<p>​    今天的分享就到这里了，欢迎大家关注微信公众号”<strong>菜鸟童靴</strong>“</p>
<p><img src="/2022/05/09/%E5%88%9D%E8%AF%86Protobuf%EF%BC%88%E4%B8%80%EF%BC%89/微信.png" style="zoom: 50%;"></p>
]]></content>
      <categories>
        <category>技术杂谈</category>
      </categories>
      <tags>
        <tag>Protobuf</tag>
        <tag>序列化</tag>
      </tags>
  </entry>
  <entry>
    <title>安卓逆向objection的基本安装和使用</title>
    <url>/2022/04/29/%E5%AE%89%E5%8D%93%E9%80%86%E5%90%91objection%E7%9A%84%E5%9F%BA%E6%9C%AC%E5%AE%89%E8%A3%85%E5%92%8C%E4%BD%BF%E7%94%A8/</url>
    <content><![CDATA[<p><strong>objection启动并注入内存</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">objection -d -g package_name explore</span><br></pre></td></tr></table></figure>]]></content>
  </entry>
  <entry>
    <title>手把手教你开发一个apk查壳软件</title>
    <url>/2022/04/28/%E6%89%8B%E6%8A%8A%E6%89%8B%E6%95%99%E4%BD%A0%E5%BC%80%E5%8F%91%E4%B8%80%E4%B8%AAapk%E6%9F%A5%E5%A3%B3%E8%BD%AF%E4%BB%B6/</url>
    <content><![CDATA[<p>hello 大家好我是Monday，今天给大家带来一篇开发Android查壳工具的文章。</p>
<a id="more"></a>
<p><strong>1、背景：</strong></p>
<p>当我拿到一个APK准备逆向分析之前，首先要知道的是，这个apk是否加壳，以及是通过什么方式加的壳，以便于我们下一步的脱壳操作。</p>
<p><strong>2、安卓应用壳是什么</strong></p>
<p>安卓应用的安装文件格式为 .apk 格式，该格式其实为一个压缩包格式，包含安卓应用的源码、配置文件、资源文件等。因为简单的apk是使用了归档压缩包格式保存所有源码，可以用简单的解压后，得到apk的指令集dex文件，在反编译几乎可以拿到源码级别的java代码。这个对于编写软件的工程师来说是一个灾难。那么应该如何防护呢？</p>
<p>最常见的防护方式“壳”运营而生。从字面可以看到，“壳”是用来保护重要内容的。安卓应用的壳也是一样，用来保护应用源码不被非法修改或反编译。通常壳是一段程序，一般优先于真正程序运行，获得系统控制权，然后保护真正需要运行的软件。（来源于网络）</p>
<p><strong>3、查壳：</strong></p>
<p>一般网络上流行着各种查壳小工具，比如说 PKID的</p>
<p>PKID有两个版本，最开始是只有Windows版本的，后来有位大佬用Mac，觉得每次用的时候都要开虚拟机太麻烦了于是写了个Java版的，读者请根据自己的情况下载不同的版本。</p>
<p><a href="https://www.secpulse.com/archives/68886.html" target="_blank" rel="noopener">https://www.secpulse.com/archives/68886.html</a></p>
<p>Windows版下载地址：<a href="https://www.jb51.net/softs/603472.html#downintro2" target="_blank" rel="noopener">https://www.jb51.net/softs/603472.html#downintro2</a></p>
<p>Java版的看雪论坛下载地址：<a href="https://bbs.pediy.com/thread-225120.htm" target="_blank" rel="noopener">https://bbs.pediy.com/thread-225120.htm</a></p>
<p>具体使用也很简单，直接下载启动，拖入apk即可</p>
<p><strong>4、 识别原理简介</strong></p>
<p>对于加了壳的apk，包里面会有一些符合特定特征的文件，比较简单的方式就是通过检测apk是否符合这些特征，当然随着各大加固平台不断的迭代，其特征也可能会不断的迭代。</p>
<p>我们只需要知道大概原理就可以了，常见的特征判断是判断lib下是否存在特定的so文件，比如看雪上有人总结过的：</p>
<p><a href="https://bbs.pediy.com/thread-223248.htm" target="_blank" rel="noopener">https://bbs.pediy.com/thread-223248.htm</a></p>
<p><strong>5、开发查壳工具</strong></p>
<p>接下来我们根据我们了解到知识，也开发一个类似的查壳工具</p>
<p><strong>思想</strong>：首先，我们把apk后缀改为.zip并对它进行解压，一般来说，我们可以在assets目录或者lib中找到痕迹</p>
<p><img src="/2022/04/28/%E6%89%8B%E6%8A%8A%E6%89%8B%E6%95%99%E4%BD%A0%E5%BC%80%E5%8F%91%E4%B8%80%E4%B8%AAapk%E6%9F%A5%E5%A3%B3%E8%BD%AF%E4%BB%B6/1.jpg" style="zoom: 50%;"></p>
<p>进行文件名对比即可；</p>
<p><strong>优点：</strong></p>
<p>写个属于自己的查壳脚本，它的优点在于，以后有新的加固方式，只需要更新自己加固库就可以了。</p>
<p><strong>6、开始开发：</strong></p>
<p><strong>1、确认壳特征：</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">self.features &#x3D; &#123;</span><br><span class="line">            &quot;libchaosvmp.so&quot;: &quot;娜迦&quot;,</span><br><span class="line">            &quot;libddog.so&quot;: &quot;娜迦&quot;,</span><br><span class="line">            &quot;libfdog.so&quot;: &quot;娜迦&quot;,</span><br><span class="line">            &quot;libedog.so&quot;: &quot;娜迦企业版&quot;,</span><br><span class="line">            &quot;libexecmain.so&quot;: &quot;爱加密&quot;,</span><br><span class="line">            &quot;ijiami.dat&quot;: &quot;爱加密&quot;,</span><br><span class="line">            &quot;ijiami.ajm&quot;: &quot;爱加密企业版&quot;,</span><br><span class="line">            &quot;libsecexe.so&quot;: &quot;梆梆免费版&quot;,</span><br><span class="line">            &quot;libsecmain.so&quot;: &quot;梆梆免费版&quot;,</span><br><span class="line">            &quot;libSecShell.so&quot;: &quot;梆梆免费版&quot;,</span><br><span class="line">            &quot;libDexHelper.so&quot;: &quot;梆梆企业版&quot;,</span><br><span class="line">            &quot;libDexHelper-x86.so&quot;: &quot;梆梆企业版&quot;,</span><br><span class="line">            &quot;libprotectClass.so&quot;: &quot;360&quot;,</span><br><span class="line">            &quot;libjiagu.so&quot;: &quot;360&quot;,</span><br><span class="line">            &quot;libjiagu_art.so&quot;: &quot;360&quot;,</span><br><span class="line">            &quot;libjiagu_x86.so&quot;: &quot;360&quot;,</span><br><span class="line">            &quot;libegis.so&quot;: &quot;通付盾&quot;,</span><br><span class="line">            &quot;libNSaferOnly.so&quot;: &quot;通付盾&quot;,</span><br><span class="line">            &quot;libnqshield.so&quot;: &quot;网秦&quot;,</span><br><span class="line">            &quot;libbaiduprotect.so&quot;: &quot;百度&quot;,</span><br><span class="line">            &quot;aliprotect.dat&quot;: &quot;阿里聚安全&quot;,</span><br><span class="line">            &quot;libsgmain.so&quot;: &quot;阿里聚安全&quot;,</span><br><span class="line">            &quot;libsgsecuritybody.so&quot;: &quot;阿里聚安全&quot;,</span><br><span class="line">            &quot;libmobisec.so&quot;: &quot;阿里聚安全&quot;,</span><br><span class="line">            &quot;libtup.so&quot;: &quot;腾讯&quot;,</span><br><span class="line">            &quot;libexec.so&quot;: &quot;腾讯&quot;,</span><br><span class="line">            &quot;libshell.so&quot;: &quot;腾讯&quot;,</span><br><span class="line">            &quot;mix.dex&quot;: &quot;腾讯&quot;,</span><br><span class="line">            &quot;lib&#x2F;armeabi&#x2F;mix.dex&quot;: &quot;腾讯&quot;,</span><br><span class="line">            &quot;lib&#x2F;armeabi&#x2F;mixz.dex&quot;: &quot;腾讯&quot;,</span><br><span class="line">            &quot;libtosprotection.armeabi.so&quot;: &quot;腾讯御安全&quot;,</span><br><span class="line">            &quot;libtosprotection.armeabi-v7a.so&quot;: &quot;腾讯御安全&quot;,</span><br><span class="line">            &quot;libtosprotection.x86.so&quot;: &quot;腾讯御安全&quot;,</span><br><span class="line">            &quot;libnesec.so&quot;: &quot;网易易盾&quot;,</span><br><span class="line">            &quot;libAPKProtect.so&quot;: &quot;APKProtect&quot;,</span><br><span class="line">            &quot;libkwscmm.so&quot;: &quot;几维安全&quot;,</span><br><span class="line">            &quot;libkwscr.so&quot;: &quot;几维安全&quot;,</span><br><span class="line">            &quot;libkwslinker.so&quot;: &quot;几维安全&quot;,</span><br><span class="line">            &quot;libx3g.so&quot;: &quot;顶像科技&quot;,</span><br><span class="line">            &quot;libapssec.so&quot;: &quot;盛大&quot;,</span><br><span class="line">            &quot;librsprotect.so&quot;: &quot;瑞星&quot;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>
<p><strong>2、编写，解压文件和判断特征文件是否在目录里</strong></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">chake</span><span class="params">(self, apk_path)</span>:</span></span><br><span class="line">    zipfiles = zipfile.ZipFile(apk_path)</span><br><span class="line">    name_list = zipfiles.namelist()</span><br><span class="line">    <span class="keyword">for</span> filename <span class="keyword">in</span> name_list:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">for</span> shell <span class="keyword">in</span> self.features.keys():</span><br><span class="line">                <span class="keyword">if</span> shell <span class="keyword">in</span> filename:</span><br><span class="line">                    shell_type = self.features[shell]</span><br><span class="line">                    result = <span class="string">f"该apk使用了《 <span class="subst">&#123;shell_type&#125;</span> 》加固"</span></span><br><span class="line">                    <span class="keyword">return</span> result</span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"unknown"</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">"该APK未加固或采用未知加固厂商\n"</span></span><br></pre></td></tr></table></figure>
<p><strong>3、最后tkinter 编写GUI界面</strong></p>
<p><strong>4、最结果展示：</strong></p>
<p><img src="/2022/04/28/%E6%89%8B%E6%8A%8A%E6%89%8B%E6%95%99%E4%BD%A0%E5%BC%80%E5%8F%91%E4%B8%80%E4%B8%AAapk%E6%9F%A5%E5%A3%B3%E8%BD%AF%E4%BB%B6/2.jpg" style="zoom: 100%;"></p>
<p><strong>结束语</strong>：</p>
<p>​    今天的分享就到这里了，欢迎大家关注微信公众号”<strong>菜鸟童靴</strong>“</p>
<p><img src="/2022/04/28/%E6%89%8B%E6%8A%8A%E6%89%8B%E6%95%99%E4%BD%A0%E5%BC%80%E5%8F%91%E4%B8%80%E4%B8%AAapk%E6%9F%A5%E5%A3%B3%E8%BD%AF%E4%BB%B6/微信.png" style="zoom: 50%;"></p>
]]></content>
      <categories>
        <category>逆向</category>
      </categories>
      <tags>
        <tag>逆向</tag>
        <tag>查壳</tag>
      </tags>
  </entry>
  <entry>
    <title>Android脱壳工具整理第二篇</title>
    <url>/2022/04/25/Android%E8%84%B1%E5%A3%B3%E5%B7%A5%E5%85%B7%E6%95%B4%E7%90%86%E7%AC%AC%E4%BA%8C%E7%AF%87/</url>
    <content><![CDATA[<p>hello 大家好我是Monday，今天给大家带来一篇Android脱壳工具的文章的第二篇。</p>
<a id="more"></a>
<p><strong>背景：</strong></p>
<p>现在混淆的代码，也很容易被破解，所以就出现了加固工具，让反编译的难度更大。但是有了加固技术，就会有反加固技术，正所谓道高一尺魔高一丈。</p>
<p><a href="https://github.com/CodingGay/BlackDex" target="_blank" rel="noopener">https://github.com/CodingGay/BlackDex</a></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;storage&#x2F;emulated&#x2F;0&#x2F;Android&#x2F;data&#x2F;top.niunaijun.blackdexa32&#x2F;dump</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">tar -zcvf cn.com.spdb.mobilebank.per.tar.gz  .&#x2F;cn.com.spdb.mobilebank.per&#x2F;</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>逆向</category>
      </categories>
      <tags>
        <tag>逆向</tag>
        <tag>脱壳</tag>
      </tags>
  </entry>
  <entry>
    <title>Android脱壳工具整理第一篇</title>
    <url>/2022/04/25/Android%E8%84%B1%E5%A3%B3%E5%B7%A5%E5%85%B7%E6%95%B4%E7%90%86%E7%AC%AC%E4%B8%80%E7%AF%87/</url>
    <content><![CDATA[<p>hello 大家好我是Monday，今天给大家带来一篇Android脱壳工具的文章。</p>
<a id="more"></a>
<p><strong>背景：</strong></p>
<p>现在混淆的代码，也很容易被破解，所以就出现了加固工具，让反编译的难度更大。但是有了加固技术，就会有反加固技术，正所谓道高一尺魔高一丈。</p>
<p>下面开始介绍几个开源的脱壳工具：</p>
<p><strong>（1）FART</strong></p>
<p>这款脱壳工具是寒冰大佬写的，是通过刷入大佬定制的系统，进而在程序运行中动态脱壳。</p>
<p>具体介绍可见大佬的github：<a href="https://github.com/hanbinglengyue/FART" target="_blank" rel="noopener">https://github.com/hanbinglengyue/FART</a><br>原理介绍：<a href="https://bbs.pediy.com/thread-252630.htm" target="_blank" rel="noopener">https://bbs.pediy.com/thread-252630.htm</a></p>
<p>有些人可能觉得刷机麻烦，同时大佬也提供了Frida版的，可以直接使用frida hook脚本动态脱壳。</p>
<p>我们解压该文件后，将lib文件夹中的<code>fart.so</code>和<code>fart64.so</code>拷贝到<code>/data/app</code>目录下，并使用 <code>chmod 777</code> 提权，接下来就可以正常使用frida hook脚本脱壳了</p>
<p><img src="/2022/04/25/Android%E8%84%B1%E5%A3%B3%E5%B7%A5%E5%85%B7%E6%95%B4%E7%90%86%E7%AC%AC%E4%B8%80%E7%AF%87/1.jpg" style="zoom: 50%;"></p>
<p>使用方式：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">frida -U -f [包名] -l .&#x2F;frida_fart_hook.js --no-pause</span><br></pre></td></tr></table></figure>
<p><strong>（2）FRIDA-DEXDump</strong></p>
<p>这款基于frida的脱壳工具是葫芦娃大佬写的</p>
<p>github地址：<a href="https://github.com/hluwa/FRIDA-DEXDump" target="_blank" rel="noopener">https://github.com/hluwa/FRIDA-DEXDump</a></p>
<p>原理介绍：<a href="https://mp.weixin.qq.com/s/n2XHGhshTmvt2FhxyFfoMA[深入" target="_blank" rel="noopener">https://mp.weixin.qq.com/s/n2XHGhshTmvt2FhxyFfoMA[深入</a> FRIDA-DEXDump 中的矛与盾 (qq.com)](<a href="https://mp.weixin.qq.com/s/n2XHGhshTmvt2FhxyFfoMA" target="_blank" rel="noopener">https://mp.weixin.qq.com/s/n2XHGhshTmvt2FhxyFfoMA</a>)</p>
<p>我们可以直接用pip命令安装：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">pip3 install frida-dexdump</span><br></pre></td></tr></table></figure>
<p>CLI arguments base on <a href="https://github.com/frida/frida-tools" target="_blank" rel="noopener">frida-tools</a>, you can quickly dump the foreground application like this:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">frida-dexdump -FU</span><br></pre></td></tr></table></figure>
<p>Or specify and spawn app like this:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">frida-dexdump -U -f com.app.pkgname</span><br><span class="line">frida-dexdump -FU -f com.app.pkgname -d --sleep 5 -o .&#x2F;</span><br></pre></td></tr></table></figure>
<p>Additionally, you can see in <code>-h</code> that the new options provided by frida-dexdump are:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">-o OUTPUT, --output OUTPUT  Output folder path, default is &#39;.&#x2F;&lt;appname&gt;&#x2F;&#39;.</span><br><span class="line">-d, --deep-search           Enable deep search mode.</span><br><span class="line">--sleep SLEEP               Waiting times for start, spawn mode default is 5s.</span><br></pre></td></tr></table></figure>
<p>When using, I suggest using the <code>-d, --deep-search</code> option, which may take more time, but the results will be more complete.</p>
<p>使用截图：</p>
<p><img src="/2022/04/25/Android%E8%84%B1%E5%A3%B3%E5%B7%A5%E5%85%B7%E6%95%B4%E7%90%86%E7%AC%AC%E4%B8%80%E7%AF%87/2.jpg" style="zoom: 50%;"></p>
<p><strong>（3）总结</strong></p>
<p>当然还有一些其他的脱壳工具，Ratel（平头哥），FDex2 等，相比较来说，Ratel（平头哥）和FRIDA-DEXDump 这个两个工具我使用的较多，目前更新的频率也新一些。</p>
<p><strong>结束语</strong>：</p>
<p>​    今天的分享就到这里了，欢迎大家关注微信公众号”<strong>菜鸟童靴</strong>“</p>
<p><img src="/2022/04/25/Android%E8%84%B1%E5%A3%B3%E5%B7%A5%E5%85%B7%E6%95%B4%E7%90%86%E7%AC%AC%E4%B8%80%E7%AF%87/微信.png" style="zoom: 50%;"></p>
]]></content>
      <categories>
        <category>逆向</category>
      </categories>
      <tags>
        <tag>逆向</tag>
        <tag>脱壳</tag>
      </tags>
  </entry>
  <entry>
    <title>大数据ETL工具Kettle入门实践二csv转换mysql</title>
    <url>/2022/04/08/%E5%A4%A7%E6%95%B0%E6%8D%AEETL%E5%B7%A5%E5%85%B7Kettle%E5%85%A5%E9%97%A8%E5%AE%9E%E8%B7%B5%E4%BA%8Ccsv%E8%BD%AC%E6%8D%A2mysql/</url>
    <content><![CDATA[<p>hello 大家好我是Monday，今天我们开启大数据ETL工具的学习的系列文章第二篇csv转换mysql。</p>
<a id="more"></a>
<h3 id="1、首先下载Mysql数据库的JDBC驱动jar包"><a href="#1、首先下载Mysql数据库的JDBC驱动jar包" class="headerlink" title="1、首先下载Mysql数据库的JDBC驱动jar包"></a><strong>1、首先下载Mysql数据库的JDBC驱动jar包</strong></h3><p>（1）进入此链接：</p>
<p><a href="https://dev.mysql.com/downloads/" target="_blank" rel="noopener">https://dev.mysql.com/downloads/</a></p>
<p>该jar包的作用：连接数据库！</p>
<p><img src="/2022/04/08/%E5%A4%A7%E6%95%B0%E6%8D%AEETL%E5%B7%A5%E5%85%B7Kettle%E5%85%A5%E9%97%A8%E5%AE%9E%E8%B7%B5%E4%BA%8Ccsv%E8%BD%AC%E6%8D%A2mysql/11.jpg" style="zoom: 50%;"></p>
<p><img src="/2022/04/08/%E5%A4%A7%E6%95%B0%E6%8D%AEETL%E5%B7%A5%E5%85%B7Kettle%E5%85%A5%E9%97%A8%E5%AE%9E%E8%B7%B5%E4%BA%8Ccsv%E8%BD%AC%E6%8D%A2mysql/22.jpg" style="zoom: 50%;"></p>
<p><img src="/2022/04/08/%E5%A4%A7%E6%95%B0%E6%8D%AEETL%E5%B7%A5%E5%85%B7Kettle%E5%85%A5%E9%97%A8%E5%AE%9E%E8%B7%B5%E4%BA%8Ccsv%E8%BD%AC%E6%8D%A2mysql/33.jpg" style="zoom: 50%;"></p>
<p>（2）需准备的其他东西：<br>数据库驱动，需将mysql的驱动放在kettle根目录的\data-integration\lib下面，然后到服务中启动mysql，重启kettle。</p>
<h3 id="2、打开kettle"><a href="#2、打开kettle" class="headerlink" title="2、打开kettle"></a><strong>2、打开kettle</strong></h3><p>注意：kettle存放路径中不要包含中文，如果红圈处没有connect按钮，原因为资源库配置文件乱码造成<br>解决方法：</p>
<p>​        1.找到.kettle目录</p>
<p>​         2.然后把这个目录下的repositories.<a href="https://so.csdn.net/so/search?q=xml&amp;spm=1001.2101.3001.7020" target="_blank" rel="noopener">xml</a>，.spoonrc文件和db.cache文件都删掉，</p>
<p>​         3.重启就OK。</p>
<h3 id="3、开始实战操作"><a href="#3、开始实战操作" class="headerlink" title="3、开始实战操作"></a><strong>3、开始实战操作</strong></h3><p>csv输入已经在上篇文章讲述了，</p>
<p>我们先创建匹配csv的mysql数据表</p>
<p>我们这次直接从输出插入更新开始：</p>
<p><img src="/2022/04/08/%E5%A4%A7%E6%95%B0%E6%8D%AEETL%E5%B7%A5%E5%85%B7Kettle%E5%85%A5%E9%97%A8%E5%AE%9E%E8%B7%B5%E4%BA%8Ccsv%E8%BD%AC%E6%8D%A2mysql/1.jpg" style="zoom: 50%;"></p>
<p><strong>选择新建数据库连接：</strong></p>
<p><img src="/2022/04/08/%E5%A4%A7%E6%95%B0%E6%8D%AEETL%E5%B7%A5%E5%85%B7Kettle%E5%85%A5%E9%97%A8%E5%AE%9E%E8%B7%B5%E4%BA%8Ccsv%E8%BD%AC%E6%8D%A2mysql/2.jpg" style="zoom: 50%;"></p>
<p><strong>确认过后，浏览会出现如下bug：</strong></p>
<p><img src="/2022/04/08/%E5%A4%A7%E6%95%B0%E6%8D%AEETL%E5%B7%A5%E5%85%B7Kettle%E5%85%A5%E9%97%A8%E5%AE%9E%E8%B7%B5%E4%BA%8Ccsv%E8%BD%AC%E6%8D%A2mysql/3.jpg" style="zoom: 50%;"></p>
<p><strong>根据提示我们发现缺少jtds.jar包</strong></p>
<p>百度云下载地址：<a href="https://links.jianshu.com/go?to=https%3A%2F%2Fpan.baidu.com%2Fs%2F1eRwzxnaOOeq7gERwFMFYdQ" target="_blank" rel="noopener">https://pan.baidu.com/s/1eRwzxnaOOeq7gERwFMFYdQ</a><br>提取码：2ri4</p>
<p>（来自网络）</p>
<p>下载完jar包，放入lib文件下，重启kettle</p>
<p><strong>再次重复操作会发现</strong>：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Connection failed. Verify all connection parameters and confirm that the appropriate driver is installed.</span><br><span class="line">I&#x2F;O Error: Unknown packet type 0x4a</span><br></pre></td></tr></table></figure>
<p>错误信息显示是jar包未安装，查阅资料了解到，一定要和自己使用的数据库版本一样的连接驱动，我的是mysql版本是8.0.26</p>
<p><strong>下载匹配自己mysql 的数据库驱动后：</strong></p>
<p><img src="/2022/04/08/%E5%A4%A7%E6%95%B0%E6%8D%AEETL%E5%B7%A5%E5%85%B7Kettle%E5%85%A5%E9%97%A8%E5%AE%9E%E8%B7%B5%E4%BA%8Ccsv%E8%BD%AC%E6%8D%A2mysql/4.jpg" style="zoom: 50%;"></p>
<p>结果显示OK</p>
<p>选择数据表</p>
<p><img src="/2022/04/08/%E5%A4%A7%E6%95%B0%E6%8D%AEETL%E5%B7%A5%E5%85%B7Kettle%E5%85%A5%E9%97%A8%E5%AE%9E%E8%B7%B5%E4%BA%8Ccsv%E8%BD%AC%E6%8D%A2mysql/5.jpg" style="zoom: 50%;"></p>
<p>分别点击获取字段、获取和更新字段，还可以点击编辑映射查看</p>
<p><img src="/2022/04/08/%E5%A4%A7%E6%95%B0%E6%8D%AEETL%E5%B7%A5%E5%85%B7Kettle%E5%85%A5%E9%97%A8%E5%AE%9E%E8%B7%B5%E4%BA%8Ccsv%E8%BD%AC%E6%8D%A2mysql/6.jpg" style="zoom: 50%;"></p>
<p>查看sql语句：</p>
<p><img src="/2022/04/08/%E5%A4%A7%E6%95%B0%E6%8D%AEETL%E5%B7%A5%E5%85%B7Kettle%E5%85%A5%E9%97%A8%E5%AE%9E%E8%B7%B5%E4%BA%8Ccsv%E8%BD%AC%E6%8D%A2mysql/7.jpg" style="zoom: 50%;"></p>
<p>启动转换，查看mysql数据表结果</p>
<p><img src="/2022/04/08/%E5%A4%A7%E6%95%B0%E6%8D%AEETL%E5%B7%A5%E5%85%B7Kettle%E5%85%A5%E9%97%A8%E5%AE%9E%E8%B7%B5%E4%BA%8Ccsv%E8%BD%AC%E6%8D%A2mysql/8.jpg" style="zoom: 50%;"></p>
<p>数据有了，转换结束</p>
<p><strong>参考文献：</strong></p>
<p>Kettle下载和安装：<a href="https://www.jianshu.com/p/c76bac247cce" target="_blank" rel="noopener">https://www.jianshu.com/p/c76bac247cce</a></p>
<p>大数据ETL工具 Kettle 入门实践 <a href="https://mp.weixin.qq.com/s/ltMTBHwJ10Xbj0g7QiXvEA" target="_blank" rel="noopener">https://mp.weixin.qq.com/s/ltMTBHwJ10Xbj0g7QiXvEA</a></p>
<p>window下怎么重启MySQl服务？<a href="https://www.php.cn/mysql-tutorials-419563.html" target="_blank" rel="noopener">https://www.php.cn/mysql-tutorials-419563.html</a></p>
<p>【Kettle】2、文件夹与界面介绍 <a href="https://www.cnblogs.com/Zeros/p/7551714.html" target="_blank" rel="noopener">https://www.cnblogs.com/Zeros/p/7551714.html</a></p>
<p>通过kettle读取csv文件到mysql表中 <a href="https://www.likecs.com/show-203707054.html" target="_blank" rel="noopener">https://www.likecs.com/show-203707054.html</a></p>
<p><strong>结束语</strong>：</p>
<p>​    今天的分享就到这里了，欢迎大家关注微信公众号”<strong>菜鸟童靴</strong>“</p>
<p><img src="/2022/04/08/%E5%A4%A7%E6%95%B0%E6%8D%AEETL%E5%B7%A5%E5%85%B7Kettle%E5%85%A5%E9%97%A8%E5%AE%9E%E8%B7%B5%E4%BA%8Ccsv%E8%BD%AC%E6%8D%A2mysql/微信.png" style="zoom: 50%;"></p>
]]></content>
      <categories>
        <category>大数据</category>
      </categories>
      <tags>
        <tag>大数据</tag>
        <tag>ETL</tag>
        <tag>Kettle</tag>
      </tags>
  </entry>
  <entry>
    <title>Linux如何使用手机共享网络</title>
    <url>/2022/04/07/Linux%E5%A6%82%E4%BD%95%E4%BD%BF%E7%94%A8%E6%89%8B%E6%9C%BA%E5%85%B1%E4%BA%AB%E7%BD%91%E7%BB%9C/</url>
    <content><![CDATA[<p>hello 大家好我是Monday，今天和大家聊聊关于Linux如何使用手机共享网络；</p>
<a id="more"></a>
<p><strong>(1)Linux通过手机USB网络共享上网</strong></p>
<p><strong>设置方法如下：</strong></p>
<p>　　<strong>1.连接好数据线并在手机设置中打开“USB网络共享”。</strong></p>
<p>　　<strong>2. 终端中查看是否将USB接口识别为网络接口。</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">　 ip addr 或者 ifconfig</span><br></pre></td></tr></table></figure>
<p>　　输出结果中会显示网络接口的名字，但是没有IP地址。（“usb0”，或者其他名字）</p>
<p>　　<strong>3. 为网络接口分配IP地址。</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">　dhclient usb0</span><br></pre></td></tr></table></figure>
<p>　　<strong>4.确认网络接口情况。</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">　 ip addr 或者 ifconfig</span><br></pre></td></tr></table></figure>
<p>　　此时，usb0应该已被分配IP地址。</p>
<p>　　<strong>5.确认已接入互联网。</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">　 ping www.baidu.com</span><br></pre></td></tr></table></figure>
<p><strong>(2)Linux直接连接手机便携式热点</strong></p>
<p>注意事项，手机设置wifi热点时。选择AP频段的时候，选择2.4GHZ频段方可使用（eg:ubuntu 只能搜索2.4GHZ的手机热点WiFi）</p>
<p><strong>补充说明</strong>：</p>
<p>　频段2.4GHz穿透性好，但传输距离近；5GHz穿透性差，传输距离远；</p>
<p>根据您所在环境进行选择，如果障碍物较多环境，建议选择2.4GHz频段。</p>
<p>以下是详细介绍：</p>
<p>　　1、频段2.4GHz穿透性好，但传输距离近；5GHz穿透性差，传输距离远；</p>
<p>　　2、由于目前大部分无线设备都采用2.4GHz的频段，因此在日常使用环境中经常会受到干扰，信号方面会不如5GHz，网速也会受到影响，目前绝大部分设备都已经支持5GHz，建议打开5GHz频段的WiFi，这样不容易受到干扰，但同时手机的耗电也会加快；</p>
<p>　　3、不过，如果您的设备与开热点的手机相距一段距离，环境比较复杂，建议选择2.4GHz，这样即便是隔着障碍物都能够接收到一个较好的信号；</p>
<p><strong>结束语</strong>：</p>
<p>​    今天的分享就到这里了，欢迎大家关注微信公众号”<strong>菜鸟童靴</strong>“</p>
<p><img src="/2022/04/07/Linux%E5%A6%82%E4%BD%95%E4%BD%BF%E7%94%A8%E6%89%8B%E6%9C%BA%E5%85%B1%E4%BA%AB%E7%BD%91%E7%BB%9C/微信.png" style="zoom: 50%;"></p>
]]></content>
      <categories>
        <category>技术杂谈</category>
      </categories>
      <tags>
        <tag>linux</tag>
      </tags>
  </entry>
  <entry>
    <title>linux安裝mitmproxy配置https证书</title>
    <url>/2022/04/07/linux%E5%AE%89%E8%A3%9Dmitmproxy%E9%85%8D%E7%BD%AEhttps%E8%AF%81%E4%B9%A6/</url>
    <content><![CDATA[<p>hello 大家好我是Monday，今天和大家聊聊关于linux安裝mitmproxy配置https证书；</p>
<a id="more"></a>
<h3 id="1-安装mitmproxy"><a href="#1-安装mitmproxy" class="headerlink" title="1.安装mitmproxy"></a><strong>1.安装mitmproxy</strong></h3><p>下载mitmproxy<a href="https://so.csdn.net/so/search?q=二进制&amp;spm=1001.2101.3001.7020" target="_blank" rel="noopener">二进制</a>安装包：</p>
<p><a href="https://github.com/mitmproxy/mitmproxy/releases/" target="_blank" rel="noopener">https://github.com/mitmproxy/mitmproxy/releases/</a></p>
<p>我下载的版本为mitmproxy-4.0.1-linux.tar.gz</p>
<p>下载之后需要解压然后将其配置到<a href="https://so.csdn.net/so/search?q=环境变量&amp;spm=1001.2101.3001.7020" target="_blank" rel="noopener">环境变量</a>。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">tar -zxvf mitmproxy-4.0.1-linux.tar.gz</span><br><span class="line">sudo mv mitmproxy mitmdump mitmweb /usr/bin</span><br></pre></td></tr></table></figure>
<p>也可以直接使用python pip 的方式安装</p>
<p>接下来需要安装证书</p>
<h3 id="2-证书配置"><a href="#2-证书配置" class="headerlink" title="2. 证书配置"></a><strong>2. 证书配置</strong></h3><p>对于 MitmProxy 来说，如果想要截获 HTTPS 请求，我们就需要设置证书，MitmProxy 在安装后会提供一套 CA 证书，只要客户端信任了 MitmProxy 提供的证书，我们就可以通过 MitmProxy 获取 HTTPS 请求的具体内容，否则 MitmProxy 是无法解析 HTTPS 请求的。</p>
<p>（1）首先运行一下命令产生 CA 证书，启动 MitmDump 即可：</p>
<p>mitmdump</p>
<p><strong>在root目录下生 成.mitmproxy</strong> 目录里面找到 CA 证书</p>
<p>（2）如果在<a href="https://so.csdn.net/so/search?q=Ubuntu&amp;spm=1001.2101.3001.7020" target="_blank" rel="noopener">Ubuntu</a> 上如果遇到的是.pem的文件，必须先将其转换为.crt文件：</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line">openssl x509 -<span class="keyword">in</span> mitmproxy-ca-cert.pem -inform PEM -<span class="keyword">out</span> mitmproxy-ca-cert.crt</span><br></pre></td></tr></table></figure>
<p>（3）在以下位置为额外的CA证书创建目录/usr/share/ca-certificates：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo mkdir /usr/share/ca-certificates/extra</span><br></pre></td></tr></table></figure>
<p>（4）将CA .crt文件复制到此目录：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo cp  mitmproxy-ca-cert.crt /usr/share/ca-certificates/extra/mitmproxy-ca-cert.crt</span><br></pre></td></tr></table></figure>
<p>（5）让Ubuntu添加.crt文件的路径相/usr/share/ca-certificates对于/etc/ca-certificates.conf：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">sudo dpkg-reconfigure ca-certificates</span><br></pre></td></tr></table></figure>
<p> （6）遇到一个安装界面，直接回车就可以了，安装完成</p>
<p><strong>结束语</strong>：</p>
<p>​    今天的分享就到这里了，欢迎大家关注微信公众号”<strong>菜鸟童靴</strong>“</p>
<p><img src="./linux安裝mitmproxy配置https证书/微信.png" style="zoom: 50%;"></p>
]]></content>
      <categories>
        <category>技术杂谈</category>
      </categories>
      <tags>
        <tag>科学上网</tag>
        <tag>mitmproxy</tag>
      </tags>
  </entry>
  <entry>
    <title>雪花算法介绍</title>
    <url>/2022/04/06/%E9%9B%AA%E8%8A%B1%E7%AE%97%E6%B3%95%E4%BB%8B%E7%BB%8D/</url>
    <content><![CDATA[<p>hello 大家好我是Monday，今天和大家聊聊关于雪花算法的原理和实现；</p>
<a id="more"></a>
<p><strong>一、雪花算法的起源</strong>：<br>snowflake中文的意思是 雪花，雪片，所以翻译成雪花算法。它最早是twitter内部使用的分布式环境下的唯一ID生成算法。在2014年开源。开源的版本由scala编写，大家可以再找个地址找到这版本。</p>
<p><a href="https://github.com/twitter-archive/snowflake/tags" target="_blank" rel="noopener">https://github.com/twitter-archive/snowflake/tags</a></p>
<p><a href="https://github.com/twitter-archive/snowflake/blob/snowflake-2010/src/main/scala/com/twitter/service/snowflake/IdWorker.scala" target="_blank" rel="noopener">snowflake/IdWorker.scala at snowflake-2010 · twitter-archive/snowflake (github.com)</a></p>
<p><strong>二、雪花算法产生的背景</strong>：</p>
<p>雪花算法产生的背景当然是twitter高并发环境下对唯一ID生成的需求，得益于twitter内部牛逼的技术，雪花算法流传至今并被广泛使用。<strong>它至少有如下几个特点：</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">1、能满足高并发分布式系统环境下ID不重复</span><br><span class="line">2、基于时间戳，可以保证基本有序递增（有些业务场景对这个又要求）</span><br><span class="line">3、不依赖第三方的库或者中间件</span><br><span class="line">4、生成效率极高</span><br></pre></td></tr></table></figure>
<p><strong>三、雪花算法原理</strong>：</p>
<p>雪花算法的原理就是生成一个的64位比特位的 long 类型的唯一 id。</p>
<p><img src="/2022/04/06/%E9%9B%AA%E8%8A%B1%E7%AE%97%E6%B3%95%E4%BB%8B%E7%BB%8D/2.png" style="zoom: 100%;"></p>
<ul>
<li>最高1位固定值0，因为生成的 id 是正整数，如果是1就是负数了(未使用)。</li>
<li>接下来41位存储毫秒级时间戳，2^41/(1000*60*60*24*365)=69，大概可以使用69年。</li>
<li>再接下10位存储机器码，包括5位 datacenterId 和5位 workerId。最多可以部署2^10=1024台机器。</li>
<li>最后12位存储序列号。同一毫秒时间戳时，通过这个递增的序列号来区分。即对于同一台机器而言，同一毫秒时间戳下，可以生成2^12=4096个不重复 id，所以最大可以支持单节点差不多四百万的并发量，这个妥妥的够用了。</li>
</ul>
<p>我们补充详解一下41位的毫秒单位的时间戳，我们可以计算下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">2^41&#x2F;1000（毫秒）*60（秒）*60（分钟）*24（小时）*365（天） &#x3D; 69</span><br></pre></td></tr></table></figure>
<p>也就是这个时间戳可以使用69年不重复，这个对于大部分系统够用了。</p>
<p>很多人这里会搞错概念，这个时间戳是相对于一个我们业务中指定的时间（一般是系统上线时间），而不是1970年。这里一定要注意。</p>
<p><strong>三、使用方式</strong>：</p>
<p>可以将雪花算法作为一个单独的服务进行部署，然后需要全局唯一 id 的系统，请求雪花算法服务获取 id 即可。</p>
<p><strong>（1）安装python第三方包：</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">pip install pysnowflake</span><br></pre></td></tr></table></figure>
<p><strong>（2）启动服务</strong></p>
<p>启动pysnowflake —pysnowflake基于Tornado开发，启动时相当于一个服务</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">snowflake_start_server --address&#x3D;127.0.0.1 --port&#x3D;8910 --dc&#x3D;1 --worker&#x3D;1 --log_file_prefix&#x3D;.&#x2F;pysnowflask.log</span><br></pre></td></tr></table></figure>
<p>参数说明：可以通过–help查看</p>
<blockquote>
<p>—address：本机的IP地址默认localhost<br>—dc：数据中心唯一标识符默认为0<br>—worker：工作者唯一标识符默认为0<br>—log_file_prefix：日志文件所在位置</p>
</blockquote>
<p><strong>（3）调用服务获取id</strong></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> snowflake.client</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_snowflake_uuid</span><span class="params">()</span>:</span></span><br><span class="line">    guid = snowflake.client.get_guid()</span><br><span class="line">    <span class="keyword">return</span> guid</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">res = get_snowflake_uuid()</span><br><span class="line">print(res)</span><br></pre></td></tr></table></figure>
<p><strong>四、雪花算法优点：</strong></p>
<ul>
<li>高并发分布式环境下生成不重复 id，每秒可生成百万个不重复 id。</li>
<li>基于时间戳，以及同一时间戳下序列号自增，基本保证 id 有序递增。</li>
<li>不依赖第三方库或者中间件。</li>
<li>算法简单，在内存中进行，效率高。</li>
</ul>
<p><strong>五、雪花算法有如下缺点：</strong></p>
<ul>
<li>依赖服务器时间，服务器时钟回拨时可能会生成重复 id。算法中可通过记录最后一个生成 id 时的时间戳来解决，每次生成 id 之前比较当前服务器时钟是否被回拨，避免生成重复 id。</li>
</ul>
<p><strong>六、自己实现雪花算法（python版）</strong>：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Twitter's Snowflake algorithm implementation which is used to generate distributed IDs.</span></span><br><span class="line"><span class="comment"># https://github.com/twitter-archive/snowflake/blob/snowflake-2010/src/main/scala/com/twitter/service/snowflake/IdWorker.scala</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">InvalidSystemClock</span><span class="params">(Exception)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    时钟回拨异常</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 64位ID的划分</span></span><br><span class="line">WORKER_ID_BITS = <span class="number">5</span></span><br><span class="line">DATACENTER_ID_BITS = <span class="number">5</span></span><br><span class="line">SEQUENCE_BITS = <span class="number">12</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 最大取值计算</span></span><br><span class="line">MAX_WORKER_ID = <span class="number">-1</span> ^ (<span class="number">-1</span> &lt;&lt; WORKER_ID_BITS)  <span class="comment"># 2**5-1 0b11111</span></span><br><span class="line">MAX_DATACENTER_ID = <span class="number">-1</span> ^ (<span class="number">-1</span> &lt;&lt; DATACENTER_ID_BITS)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 移位偏移计算</span></span><br><span class="line">WOKER_ID_SHIFT = SEQUENCE_BITS</span><br><span class="line">DATACENTER_ID_SHIFT = SEQUENCE_BITS + WORKER_ID_BITS</span><br><span class="line">TIMESTAMP_LEFT_SHIFT = SEQUENCE_BITS + WORKER_ID_BITS + DATACENTER_ID_BITS</span><br><span class="line"></span><br><span class="line"><span class="comment"># 序号循环掩码</span></span><br><span class="line">SEQUENCE_MASK = <span class="number">-1</span> ^ (<span class="number">-1</span> &lt;&lt; SEQUENCE_BITS)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Twitter元年时间戳</span></span><br><span class="line">TWEPOCH = <span class="number">1288834974657</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># logger = logging.getLogger('flask.app')</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">IdWorker</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    用于生成IDs</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, datacenter_id, worker_id, sequence=<span class="number">0</span>)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        初始化</span></span><br><span class="line"><span class="string">        :param datacenter_id: 数据中心（机器区域）ID</span></span><br><span class="line"><span class="string">        :param worker_id: 机器ID</span></span><br><span class="line"><span class="string">        :param sequence: 序号</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="comment"># sanity check</span></span><br><span class="line">        <span class="keyword">if</span> worker_id &gt; MAX_WORKER_ID <span class="keyword">or</span> worker_id &lt; <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">raise</span> ValueError(<span class="string">'worker_id值越界'</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> datacenter_id &gt; MAX_DATACENTER_ID <span class="keyword">or</span> datacenter_id &lt; <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">raise</span> ValueError(<span class="string">'datacenter_id值越界'</span>)</span><br><span class="line"></span><br><span class="line">        self.worker_id = worker_id</span><br><span class="line">        self.datacenter_id = datacenter_id</span><br><span class="line">        self.sequence = sequence</span><br><span class="line"></span><br><span class="line">        self.last_timestamp = <span class="number">-1</span>  <span class="comment"># 上次计算的时间戳</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_gen_timestamp</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        生成整数时间戳</span></span><br><span class="line"><span class="string">        :return:int timestamp</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="keyword">return</span> int(time.time() * <span class="number">1000</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_id</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        获取新ID</span></span><br><span class="line"><span class="string">        :return:</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        timestamp = self._gen_timestamp()</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 时钟回拨</span></span><br><span class="line">        <span class="keyword">if</span> timestamp &lt; self.last_timestamp:</span><br><span class="line">            logging.error(<span class="string">'clock is moving backwards. Rejecting requests until &#123;&#125;'</span>.format(self.last_timestamp))</span><br><span class="line">            <span class="keyword">raise</span> InvalidSystemClock</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> timestamp == self.last_timestamp:</span><br><span class="line">            self.sequence = (self.sequence + <span class="number">1</span>) &amp; SEQUENCE_MASK</span><br><span class="line">            <span class="keyword">if</span> self.sequence == <span class="number">0</span>:</span><br><span class="line">                timestamp = self._til_next_millis(self.last_timestamp)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            self.sequence = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">        self.last_timestamp = timestamp</span><br><span class="line"></span><br><span class="line">        new_id = ((timestamp - TWEPOCH) &lt;&lt; TIMESTAMP_LEFT_SHIFT) | (self.datacenter_id &lt;&lt; DATACENTER_ID_SHIFT) | \</span><br><span class="line">                 (self.worker_id &lt;&lt; WOKER_ID_SHIFT) | self.sequence</span><br><span class="line">        <span class="keyword">return</span> new_id</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_til_next_millis</span><span class="params">(self, last_timestamp)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        等到下一毫秒</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        timestamp = self._gen_timestamp()</span><br><span class="line">        <span class="keyword">while</span> timestamp &lt;= last_timestamp:</span><br><span class="line">            timestamp = self._gen_timestamp()</span><br><span class="line">        <span class="keyword">return</span> timestamp</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    worker = IdWorker(<span class="number">1</span>, <span class="number">2</span>, <span class="number">0</span>)</span><br><span class="line">    print(worker.get_id())</span><br><span class="line">    print(len(str(worker.get_id())))</span><br></pre></td></tr></table></figure>
<p><strong>参考链接：</strong></p>
<p><a href="https://blog.csdn.net/pony_maggie/article/details/103380116" target="_blank" rel="noopener">https://blog.csdn.net/pony_maggie/article/details/103380116</a></p>
<p><a href="https://bbs.huaweicloud.com/blogs/344958" target="_blank" rel="noopener">https://bbs.huaweicloud.com/blogs/344958</a></p>
<p><strong>结束语</strong>：</p>
<p>​    今天的分享就到这里了，欢迎大家关注微信公众号”<strong>菜鸟童靴</strong>“</p>
<p><img src="/2022/04/06/%E9%9B%AA%E8%8A%B1%E7%AE%97%E6%B3%95%E4%BB%8B%E7%BB%8D/微信.png" style="zoom: 100%;"></p>
]]></content>
      <categories>
        <category>算法</category>
      </categories>
      <tags>
        <tag>分布式ID</tag>
        <tag>算法</tag>
      </tags>
  </entry>
  <entry>
    <title>Frida如何使用外部库</title>
    <url>/2022/04/01/Frida%E5%A6%82%E4%BD%95%E4%BD%BF%E7%94%A8%E5%A4%96%E9%83%A8%E5%BA%93/</url>
    <content><![CDATA[<p>Frida  hook  时如何使用外部库介绍</p>
<a id="more"></a>
<p>我们以fastjson为例</p>
<p><strong>1、下载jar包</strong></p>
<p><a href="https://repo1.maven.org/maven2/com/alibaba/fastjson/1.2.76/" target="_blank" rel="noopener">https://repo1.maven.org/maven2/com/alibaba/fastjson/1.2.76/</a></p>
<p>下载 fastjson.jar</p>
<p><strong>2、重新打包为dex</strong><br>进入Android SDK的目录, 执行如下命令: dx —dex —output=fastjson.dex fastjson.jar</p>
<p><strong>3、将fastjson.dex 放到手机文件里</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">adb push &#x2F;xxx&#x2F;fastjson.dex &#x2F;data&#x2F;local&#x2F;tmp</span><br></pre></td></tr></table></figure>
<p>得到的 fastjson.dex通过adb push到手机 /data/local/tmp目录</p>
<p>chmod 777  /data/local/tmp/fastjson.dex</p>
<p>然后就可以使用fastjson了。</p>
<p><strong>4、关键相关代码：</strong></p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">Java.openClassFile(<span class="string">'/data/local/tmp/fastjson.dex'</span>).load();</span><br><span class="line"><span class="keyword">var</span> JSONObject = Java.use(<span class="string">'com.alibaba.fastjson.JSONObject'</span>);</span><br><span class="line">JSONObject.toJSONString(obj);</span><br></pre></td></tr></table></figure>
<p><strong>结束语</strong>：</p>
<p>​    今天的分享就到这里了，欢迎大家关注微信公众号”<strong>菜鸟童靴</strong>“</p>
<p><img src="/Frida如何使用外部库/微信.png" style="zoom: 50%;"></p>
]]></content>
      <categories>
        <category>逆向</category>
      </categories>
      <tags>
        <tag>逆向</tag>
        <tag>Hook</tag>
        <tag>frida</tag>
      </tags>
  </entry>
  <entry>
    <title>大数据ETL工具Kettle入门实践一</title>
    <url>/2022/04/01/%E5%A4%A7%E6%95%B0%E6%8D%AEETL%E5%B7%A5%E5%85%B7Kettle%E5%85%A5%E9%97%A8%E5%AE%9E%E8%B7%B5%E4%B8%80/</url>
    <content><![CDATA[<p>hello 大家好我是Monday，今天我们开启大数据ETL工具的学习的系列文章。</p>
<a id="more"></a>
<p>首先介绍一下今天主角Kettle</p>
<p><strong>1、Kettle 是什么</strong></p>
<p>Kettle 是一款国外开源的 ETL 工具，对商业用户也没有限制，纯 Java 编写，可以在 Window、Linux、Unix 上运行，绿色无需安装，数据抽取高效稳定。Kettle 是 PDI 以前的名称，PDI 的全称是Pentaho Data Integeration，Kettle 中文名称叫水壶，它允许管理来自不同数据库的数据，把各种<strong>数据</strong>放到一个壶里，然后以一种<strong>指定的格式</strong>流出。Kettle 中有两种脚本文件，<strong>Transformation</strong> 和 <strong>Job</strong>， Transformation 完成针对数据的基础转换，Job 则完成整个工作流的控制。通过图形界面设计实现做什么业务，并在 Job 下的 start 模块，有一个定时功能，可以每日，每周等方式进行定时。</p>
<p><strong>2、kettle下载安装</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">官网各个版本下载地址：https:&#x2F;&#x2F;sourceforge.net&#x2F;projects&#x2F;pentaho&#x2F;files&#x2F;Data%20Integration&#x2F;</span><br><span class="line">国内 Kettle 论坛网：https:&#x2F;&#x2F;www.kettle.net.cn&#x2F;</span><br></pre></td></tr></table></figure>
<p>Kettle 是纯 Java 编程的开源软件，需要安装 JDK，并配置环境变量，解压后直接使用无需安装。</p>
<p>需准备的其他东西：<strong>数据库驱动</strong>，如将驱动放在 Kettle 根目录的 bin 文件夹下面即可。</p>
<p>打开 Kettle 只需要运行 Spoon.bat (win)/ spoon.sh (Linux / macOS)，即可打开 Spoon 图形工具。</p>
<p><strong>3、kettle文件夹介绍</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Lib：存放Kettle的核心(core)jar包、工作引擎(engine)jar包、数据库(DB) jar包、图形界面(UI) jar包。</span><br><span class="line"></span><br><span class="line">Plugins：存放Kettle自定义插件时，需要把自定义好的插件打成jar放在此目录。</span><br><span class="line"></span><br><span class="line">Docs：存放Kettle各种语言版本的API文档。</span><br><span class="line"></span><br><span class="line">Pwd：存放Kettle配置集群时所需要的配置文件与加密文件。</span><br><span class="line"></span><br><span class="line">Libswt：存放Kettle对应不同平台的相关UI jar包。</span><br><span class="line"></span><br><span class="line">Samples：存放Kettle自带的一些Job与Trans实例(建议大家多去查看)。</span><br><span class="line"></span><br><span class="line">Launcher：存放Kettle Spoon加载的一些配置信息。</span><br><span class="line"></span><br><span class="line">Ui：存放Kettle初始化使用到的图片及配置信息。</span><br></pre></td></tr></table></figure>
<p><strong>4、如下图，执行  <code>./spoon.bat</code> 命令</strong></p>
<p><img src="/2022/04/01/%E5%A4%A7%E6%95%B0%E6%8D%AEETL%E5%B7%A5%E5%85%B7Kettle%E5%85%A5%E9%97%A8%E5%AE%9E%E8%B7%B5%E4%B8%80/0.0.jpg" style="zoom: 50%;"></p>
<p><strong>5、安装完我们就去实战操作一下：</strong></p>
<p><strong>需求：把数据从 CSV 文件复制到 Excel 文件</strong></p>
<p>（1）将 「CSV 文件输入」拖拽到右侧的工作区</p>
<p><img src="/2022/04/01/%E5%A4%A7%E6%95%B0%E6%8D%AEETL%E5%B7%A5%E5%85%B7Kettle%E5%85%A5%E9%97%A8%E5%AE%9E%E8%B7%B5%E4%B8%80/0.1.jpg" style="zoom: 50%;"></p>
<p>（2）双击进行编辑，浏览选择准备好的测试文件</p>
<p><img src="/2022/04/01/%E5%A4%A7%E6%95%B0%E6%8D%AEETL%E5%B7%A5%E5%85%B7Kettle%E5%85%A5%E9%97%A8%E5%AE%9E%E8%B7%B5%E4%B8%80/0.2.jpg" style="zoom: 50%;"></p>
<p>（3）点击「获取字段」自动获取 CSV 文件中表头信息</p>
<p><img src="/2022/04/01/%E5%A4%A7%E6%95%B0%E6%8D%AEETL%E5%B7%A5%E5%85%B7Kettle%E5%85%A5%E9%97%A8%E5%AE%9E%E8%B7%B5%E4%B8%80/0.3.jpg" style="zoom: 50%;"></p>
<p>（4）预览数据</p>
<p><img src="/2022/04/01/%E5%A4%A7%E6%95%B0%E6%8D%AEETL%E5%B7%A5%E5%85%B7Kettle%E5%85%A5%E9%97%A8%E5%AE%9E%E8%B7%B5%E4%B8%80/0.4.jpg" style="zoom: 50%;"></p>
<p>（5）输入配置完成，下一步进行输出配置。</p>
<p>将 「Excel 输出」拖拽到右侧的工作区，双击进行编辑，这步比较简单，浏览选择输出目录和设置文件名，完成配置。</p>
<p><img src="/2022/04/01/%E5%A4%A7%E6%95%B0%E6%8D%AEETL%E5%B7%A5%E5%85%B7Kettle%E5%85%A5%E9%97%A8%E5%AE%9E%E8%B7%B5%E4%B8%80/0.5.jpg" style="zoom: 50%;"></p>
<p><img src="/2022/04/01/%E5%A4%A7%E6%95%B0%E6%8D%AEETL%E5%B7%A5%E5%85%B7Kettle%E5%85%A5%E9%97%A8%E5%AE%9E%E8%B7%B5%E4%B8%80/0.6.jpg" style="zoom: 50%;"></p>
<p><img src="/2022/04/01/%E5%A4%A7%E6%95%B0%E6%8D%AEETL%E5%B7%A5%E5%85%B7Kettle%E5%85%A5%E9%97%A8%E5%AE%9E%E8%B7%B5%E4%B8%80/0.7.jpg" style="zoom: 50%;"></p>
<p>over文件生成已经在选择的目录下了。</p>
<p><strong>参考文献：</strong></p>
<p>Kettle下载和安装：<a href="https://www.jianshu.com/p/c76bac247cce" target="_blank" rel="noopener">https://www.jianshu.com/p/c76bac247cce</a></p>
<p>大数据ETL工具 Kettle 入门实践 <a href="https://mp.weixin.qq.com/s/ltMTBHwJ10Xbj0g7QiXvEA" target="_blank" rel="noopener">https://mp.weixin.qq.com/s/ltMTBHwJ10Xbj0g7QiXvEA</a></p>
<p>window下怎么重启MySQl服务？<a href="https://www.php.cn/mysql-tutorials-419563.html" target="_blank" rel="noopener">https://www.php.cn/mysql-tutorials-419563.html</a></p>
<p>【Kettle】2、文件夹与界面介绍 <a href="https://www.cnblogs.com/Zeros/p/7551714.html" target="_blank" rel="noopener">https://www.cnblogs.com/Zeros/p/7551714.html</a></p>
<p><strong>结束语</strong>：</p>
<p>​    今天的分享就到这里了，欢迎大家关注微信公众号”<strong>菜鸟童靴</strong>“</p>
<p><img src="/2022/04/01/%E5%A4%A7%E6%95%B0%E6%8D%AEETL%E5%B7%A5%E5%85%B7Kettle%E5%85%A5%E9%97%A8%E5%AE%9E%E8%B7%B5%E4%B8%80/微信.png" style="zoom: 50%;"></p>
]]></content>
      <categories>
        <category>大数据</category>
      </categories>
      <tags>
        <tag>大数据</tag>
        <tag>ETL</tag>
        <tag>Kettle</tag>
      </tags>
  </entry>
  <entry>
    <title>FastAPI开发Security系列之token认证</title>
    <url>/2022/03/31/FastAPI%E5%BC%80%E5%8F%91Security%E7%B3%BB%E5%88%97%E4%B9%8Btoken%E8%AE%A4%E8%AF%81/</url>
    <content><![CDATA[<p>hello 大家好我是Monday，今天给大家带来一篇FastAPI开发Security系列之token认证的知识分享。</p>
<a id="more"></a>
<p><strong>1、前言：</strong></p>
<p>在不久前我写了一篇关于fastapi数据库操作的文章，在里我我写了关于用户注册的数据库操作，今天我基于<a href="https://boyyongxin.github.io/2022/03/19/fastapi数据库操作/#more" target="_blank" rel="noopener">fastapi 数据库操作之数据库操作 | 菜鸟童靴 (boyyongxin.github.io)</a>，可在这篇文章在此基础上做token验证；</p>
<p><strong>2、知识点回顾：</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#39;&#39;&#39;</span><br><span class="line">为了数据安全，我们利用PassLib对入库的用户密码进行加密处理，推荐的加密算法是&quot;Bcrypt&quot;</span><br><span class="line">其中，我们主要使用下面方法：</span><br><span class="line">pwd_context.hash(password) # 对密码进行加密</span><br><span class="line">pwd_context.verify(plain_password, hashed_password) 对密码进行校验</span><br><span class="line">&#39;&#39;&#39;</span><br></pre></td></tr></table></figure>
<p><strong>3</strong>、<strong>安装依赖</strong></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">pip install pyjwt <span class="comment"># </span></span><br><span class="line">pip install python-multipart <span class="comment"># OAuth2需要通过表单数据来发送信息</span></span><br></pre></td></tr></table></figure>
<p>pyjwt生成Token细节可参考这篇文章：<a href="https://blog.csdn.net/Disany/article/details/109346079" target="_blank" rel="noopener">详解PyJWT生成Token</a></p>
<p><strong>4、本次测试用的账户密码：</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">账号：admin 密码：123456</span><br></pre></td></tr></table></figure>
<p> 用于我们稍后验证</p>
<p>我们先生成一下密码加密后的hash密码：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">from passlib.context import CryptContext  # passlib 处理哈希加密的包</span><br><span class="line"></span><br><span class="line">password &#x3D; &#39;123456&#39;</span><br><span class="line"># Context是上下文,CryptContext是密码上下文</span><br><span class="line">pwd_context &#x3D; CryptContext(schemes&#x3D;[&quot;bcrypt&quot;], deprecated&#x3D;&quot;auto&quot;)</span><br><span class="line">res &#x3D; pwd_context.hash(password)  # 对密码进行加密</span><br><span class="line">print(res)</span><br></pre></td></tr></table></figure>
<p>加密后的密码：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$2b$12$xwMRglIySSKjud.&#x2F;wzUmBeob62Vd6zR8mujSfXyTPn9KEXOnZHQ5O</span><br></pre></td></tr></table></figure>
<p><strong>5、模拟数据库和表信息</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">fake_users_db &#x3D; &#123;</span><br><span class="line">    &quot;admin&quot;: &#123;</span><br><span class="line">        &quot;username&quot;: &quot;admin&quot;,</span><br><span class="line">        &quot;full_name&quot;: &quot;admin&quot;,</span><br><span class="line">        &quot;email&quot;: &quot;admin@example.com&quot;,</span><br><span class="line">        &quot;hashed_password&quot;: &quot;$2b$12$xwMRglIySSKjud.&#x2F;wzUmBeob62Vd6zR8mujSfXyTPn9KEXOnZHQ5O&quot;,</span><br><span class="line">        &quot;disabled&quot;: False,</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p> 本次演示就不涉及到mysql数据库了，如有需要，可根据之前的进行替换</p>
<p><strong>6、登录验证，获取token的接口</strong></p>
<p>用户发送post请求获取token,后端验证该用户是否存在，密码是否正确。如果验证通过，会生成‘token’给到用户。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># -*- coding: UTF-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> datetime, timedelta</span><br><span class="line"><span class="keyword">import</span> jwt</span><br><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> Depends, FastAPI, HTTPException</span><br><span class="line"><span class="keyword">from</span> starlette <span class="keyword">import</span> status</span><br><span class="line"><span class="keyword">from</span> fastapi.security <span class="keyword">import</span> OAuth2PasswordBearer, OAuth2PasswordRequestForm</span><br><span class="line"><span class="keyword">from</span> jwt <span class="keyword">import</span> PyJWTError</span><br><span class="line"><span class="keyword">from</span> passlib.context <span class="keyword">import</span> CryptContext  <span class="comment"># passlib 处理哈希加密的包</span></span><br><span class="line"><span class="keyword">from</span> pydantic <span class="keyword">import</span> BaseModel</span><br><span class="line"><span class="keyword">import</span> uvicorn</span><br><span class="line"></span><br><span class="line">fake_users_db = &#123;</span><br><span class="line">    <span class="string">"admin"</span>: &#123;</span><br><span class="line">        <span class="string">"username"</span>: <span class="string">"admin"</span>,</span><br><span class="line">        <span class="string">"full_name"</span>: <span class="string">"admin"</span>,</span><br><span class="line">        <span class="string">"email"</span>: <span class="string">"admin@example.com"</span>,</span><br><span class="line">        <span class="string">"hashed_password"</span>: <span class="string">"$2b$12$xwMRglIySSKjud./wzUmBeob62Vd6zR8mujSfXyTPn9KEXOnZHQ5O"</span>,</span><br><span class="line">        <span class="string">"disabled"</span>: <span class="literal">False</span>,</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 这是我们的app应用</span></span><br><span class="line">app = FastAPI()</span><br><span class="line"><span class="comment"># to get a string like this run: openssl rand -hex 32</span></span><br><span class="line">SECRET_KEY = <span class="string">"09d25e094faa6ca2556c818166b7a9563b93f7099f6f0f4caa6cf63b88e8d3e7"</span>  <span class="comment"># 密钥</span></span><br><span class="line">ALGORITHM = <span class="string">"HS256"</span>  <span class="comment"># 算法</span></span><br><span class="line">ACCESS_TOKEN_EXPIRE_MINUTES = <span class="number">30</span>  <span class="comment"># 访问令牌过期分钟</span></span><br><span class="line"></span><br><span class="line"><span class="string">'''FastAPI参数类型验证模型'''</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># token url相应模型</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Token</span><span class="params">(BaseModel)</span>:</span></span><br><span class="line">    access_token: str</span><br><span class="line">    token_type: str</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 令牌数据模型</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TokenData</span><span class="params">(BaseModel)</span>:</span></span><br><span class="line">    username: str = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 用户基础模型</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span><span class="params">(BaseModel)</span>:</span></span><br><span class="line">    username: str</span><br><span class="line">    email: str = <span class="literal">None</span></span><br><span class="line">    full_name: str = <span class="literal">None</span></span><br><span class="line">    disabled: bool = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 用户输入数据模型</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserInDB</span><span class="params">(User)</span>:</span></span><br><span class="line">    hashed_password: str</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Context是上下文,CryptContext是密码上下文</span></span><br><span class="line">pwd_context = CryptContext(schemes=[<span class="string">"bcrypt"</span>], deprecated=<span class="string">"auto"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># oauth2_scheme是令牌对象，token: str = Depends(oauth2_scheme)后就是之前加密的令牌</span></span><br><span class="line">oauth2_scheme = OAuth2PasswordBearer(tokenUrl=<span class="string">"/token"</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">verify_password</span><span class="params">(plain_password, hashed_password)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    # plain_password普通密码, hashed_passwo# verify_password验证密码rd哈希密码</span></span><br><span class="line"><span class="string">    # 返回True和False</span></span><br><span class="line"><span class="string">    :param plain_password:</span></span><br><span class="line"><span class="string">    :param hashed_password:</span></span><br><span class="line"><span class="string">    :return:</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="keyword">return</span> pwd_context.verify(plain_password, hashed_password)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_password_hash</span><span class="params">(password)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    # 获取哈希密码;普通密码进去，对应的哈希密码出来。</span></span><br><span class="line"><span class="string">    :param password:</span></span><br><span class="line"><span class="string">    :return:</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="keyword">return</span> pwd_context.hash(password)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_user</span><span class="params">(db, username: str)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    # 模拟从数据库读取用户信息</span></span><br><span class="line"><span class="string">    :param db:</span></span><br><span class="line"><span class="string">    :param username:</span></span><br><span class="line"><span class="string">    :return:</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="keyword">if</span> username <span class="keyword">in</span> db:</span><br><span class="line">        user_dict = db[username]</span><br><span class="line">        <span class="keyword">return</span> UserInDB(**user_dict)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">authenticate_user</span><span class="params">(fake_db, username: str, password: str)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    # 验证用户</span></span><br><span class="line"><span class="string">    :param fake_db:</span></span><br><span class="line"><span class="string">    :param username:</span></span><br><span class="line"><span class="string">    :param password:</span></span><br><span class="line"><span class="string">    :return:</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    user = get_user(fake_db, username)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> user <span class="keyword">or</span> <span class="keyword">not</span> verify_password(password, user.hashed_password):</span><br><span class="line">        <span class="keyword">raise</span> HTTPException(</span><br><span class="line">            status_code=status.HTTP_401_UNAUTHORIZED,</span><br><span class="line">            detail=<span class="string">"Incorrect username or password"</span>,</span><br><span class="line">            headers=&#123;<span class="string">"WWW-Authenticate"</span>: <span class="string">"Bearer"</span>&#125;,</span><br><span class="line">        )</span><br><span class="line">    <span class="keyword">return</span> user</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建访问令牌（token）</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">create_access_token</span><span class="params">(*, data: dict, expires_delta: timedelta = None)</span>:</span></span><br><span class="line">    to_encode = data.copy()</span><br><span class="line">    expire = datetime.utcnow() + expires_delta  <span class="comment"># expire 令牌到期时间</span></span><br><span class="line">    to_encode.update(&#123;<span class="string">"exp"</span>: expire&#125;)</span><br><span class="line">    encoded_jwt = jwt.encode(to_encode, SECRET_KEY, algorithm=ALGORITHM)</span><br><span class="line">    <span class="keyword">return</span> encoded_jwt</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.post("/token", response_model=Token)</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">login_for_access_token</span><span class="params">(form_data: OAuth2PasswordRequestForm = Depends<span class="params">()</span>)</span>:</span></span><br><span class="line">    <span class="comment"># 1、验证用户</span></span><br><span class="line">    user = authenticate_user(fake_users_db, form_data.username, form_data.password)  <span class="comment"># 验证用户</span></span><br><span class="line">    <span class="comment"># 2、access_token_expires访问令牌过期</span></span><br><span class="line">    access_token_expires = timedelta(minutes=ACCESS_TOKEN_EXPIRE_MINUTES)  <span class="comment"># timedelta表示两个datetime对象之间的差异。（来自datetime包）</span></span><br><span class="line">    <span class="comment"># 3、create_access_token创建访问令牌</span></span><br><span class="line">    access_token = create_access_token(data=&#123;<span class="string">"sub"</span>: user.username&#125;, expires_delta=access_token_expires)</span><br><span class="line">    <span class="comment"># 返回</span></span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">"access_token"</span>: access_token, <span class="string">"token_type"</span>: <span class="string">"bearer"</span>&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    uvicorn.run(app=<span class="string">"gain_token:app"</span>, host=<span class="string">"0.0.0.0"</span>, port=<span class="number">8000</span>)</span><br></pre></td></tr></table></figure>
<p><strong>代码解析补充：</strong></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># oauth2_scheme是令牌对象，token: str = Depends(oauth2_scheme)后就是之前加密的令牌</span></span><br><span class="line">oauth2_scheme = OAuth2PasswordBearer(tokenUrl=<span class="string">"/token"</span>)</span><br></pre></td></tr></table></figure>
<p>OAuth2PasswordBearer是接收URL作为参数的一个类：客户端会向该URL发送username和password参数，然后得到一个token值。<br>OAuth2PasswordBearer并不会创建相应的URL路径操作，只是指明了客户端用来获取token的目标URL。<br>当请求到来的时候，FastAPI会检查请求的Authorization头信息，如果没有找到Authorization头信息，或者头信息的内容不是Bearer token，它会返回401状态码(UNAUTHORIZED)。</p>
<p><strong>我们测试一下结果：</strong></p>
<p><img src="/2022/03/31/FastAPI%E5%BC%80%E5%8F%91Security%E7%B3%BB%E5%88%97%E4%B9%8Btoken%E8%AE%A4%E8%AF%81/1.jpg" style="zoom: 50%;"></p>
<p><strong>7、数据请求验证</strong><br>用户拿到token信息后，必须在后续请求中，头信息的Authorization带有Bearer token，才能访问其他数据接口。<br>下面添加一个校验函数，对请求的合法性进行校验，读取token内容解析并进行验证，验证token通过后，获取接口响应数据</p>
<p><strong>具体代码如下</strong></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># -*- coding: UTF-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> datetime, timedelta</span><br><span class="line"><span class="keyword">import</span> jwt</span><br><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> Depends, FastAPI, HTTPException</span><br><span class="line"><span class="keyword">from</span> starlette <span class="keyword">import</span> status</span><br><span class="line"><span class="keyword">from</span> fastapi.security <span class="keyword">import</span> OAuth2PasswordBearer, OAuth2PasswordRequestForm</span><br><span class="line"><span class="keyword">from</span> jwt <span class="keyword">import</span> PyJWTError</span><br><span class="line"><span class="keyword">from</span> passlib.context <span class="keyword">import</span> CryptContext  <span class="comment"># passlib 处理哈希加密的包</span></span><br><span class="line"><span class="keyword">from</span> pydantic <span class="keyword">import</span> BaseModel</span><br><span class="line"><span class="keyword">import</span> uvicorn</span><br><span class="line"></span><br><span class="line">fake_users_db = &#123;</span><br><span class="line">    <span class="string">"admin"</span>: &#123;</span><br><span class="line">        <span class="string">"username"</span>: <span class="string">"admin"</span>,</span><br><span class="line">        <span class="string">"full_name"</span>: <span class="string">"admin"</span>,</span><br><span class="line">        <span class="string">"email"</span>: <span class="string">"admin@example.com"</span>,</span><br><span class="line">        <span class="string">"hashed_password"</span>: <span class="string">"$2b$12$xwMRglIySSKjud./wzUmBeob62Vd6zR8mujSfXyTPn9KEXOnZHQ5O"</span>,</span><br><span class="line">        <span class="string">"disabled"</span>: <span class="literal">False</span>,</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 这是我们的app应用</span></span><br><span class="line">app = FastAPI()</span><br><span class="line"><span class="comment"># to get a string like this run: openssl rand -hex 32</span></span><br><span class="line">SECRET_KEY = <span class="string">"09d25e094faa6ca2556c818166b7a9563b93f7099f6f0f4caa6cf63b88e8d3e7"</span>  <span class="comment"># 密钥</span></span><br><span class="line">ALGORITHM = <span class="string">"HS256"</span>  <span class="comment"># 算法</span></span><br><span class="line">ACCESS_TOKEN_EXPIRE_MINUTES = <span class="number">30</span>  <span class="comment"># 访问令牌过期分钟</span></span><br><span class="line"></span><br><span class="line"><span class="string">'''FastAPI参数类型验证模型'''</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># token url相应模型</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Token</span><span class="params">(BaseModel)</span>:</span></span><br><span class="line">    access_token: str</span><br><span class="line">    token_type: str</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 令牌数据模型</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TokenData</span><span class="params">(BaseModel)</span>:</span></span><br><span class="line">    username: str = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 用户基础模型</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span><span class="params">(BaseModel)</span>:</span></span><br><span class="line">    username: str</span><br><span class="line">    email: str = <span class="literal">None</span></span><br><span class="line">    full_name: str = <span class="literal">None</span></span><br><span class="line">    disabled: bool = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 用户输入数据模型</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserInDB</span><span class="params">(User)</span>:</span></span><br><span class="line">    hashed_password: str</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Context是上下文,CryptContext是密码上下文</span></span><br><span class="line">pwd_context = CryptContext(schemes=[<span class="string">"bcrypt"</span>], deprecated=<span class="string">"auto"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># oauth2_scheme是令牌对象，token: str = Depends(oauth2_scheme)后就是之前加密的令牌</span></span><br><span class="line">oauth2_scheme = OAuth2PasswordBearer(tokenUrl=<span class="string">"/token"</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">verify_password</span><span class="params">(plain_password, hashed_password)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    # plain_password普通密码, hashed_passwo# verify_password验证密码rd哈希密码</span></span><br><span class="line"><span class="string">    # 返回True和False</span></span><br><span class="line"><span class="string">    :param plain_password:</span></span><br><span class="line"><span class="string">    :param hashed_password:</span></span><br><span class="line"><span class="string">    :return:</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="keyword">return</span> pwd_context.verify(plain_password, hashed_password)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_password_hash</span><span class="params">(password)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    # 获取哈希密码;普通密码进去，对应的哈希密码出来。</span></span><br><span class="line"><span class="string">    :param password:</span></span><br><span class="line"><span class="string">    :return:</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="keyword">return</span> pwd_context.hash(password)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_user</span><span class="params">(db, username: str)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    # 模拟从数据库读取用户信息</span></span><br><span class="line"><span class="string">    :param db:</span></span><br><span class="line"><span class="string">    :param username:</span></span><br><span class="line"><span class="string">    :return:</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="keyword">if</span> username <span class="keyword">in</span> db:</span><br><span class="line">        user_dict = db[username]</span><br><span class="line">        <span class="keyword">return</span> UserInDB(**user_dict)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">authenticate_user</span><span class="params">(fake_db, username: str, password: str)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    # 验证用户</span></span><br><span class="line"><span class="string">    :param fake_db:</span></span><br><span class="line"><span class="string">    :param username:</span></span><br><span class="line"><span class="string">    :param password:</span></span><br><span class="line"><span class="string">    :return:</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    user = get_user(fake_db, username)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> user <span class="keyword">or</span> <span class="keyword">not</span> verify_password(password, user.hashed_password):</span><br><span class="line">        <span class="keyword">raise</span> HTTPException(</span><br><span class="line">            status_code=status.HTTP_401_UNAUTHORIZED,</span><br><span class="line">            detail=<span class="string">"Incorrect username or password"</span>,</span><br><span class="line">            headers=&#123;<span class="string">"WWW-Authenticate"</span>: <span class="string">"Bearer"</span>&#125;,</span><br><span class="line">        )</span><br><span class="line">    <span class="keyword">return</span> user</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建访问令牌（token）</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">create_access_token</span><span class="params">(*, data: dict, expires_delta: timedelta = None)</span>:</span></span><br><span class="line">    to_encode = data.copy()</span><br><span class="line">    expire = datetime.utcnow() + expires_delta  <span class="comment"># expire 令牌到期时间</span></span><br><span class="line">    to_encode.update(&#123;<span class="string">"exp"</span>: expire&#125;)</span><br><span class="line">    encoded_jwt = jwt.encode(to_encode, SECRET_KEY, algorithm=ALGORITHM)</span><br><span class="line">    <span class="keyword">return</span> encoded_jwt</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.post("/token", response_model=Token)</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">login_for_access_token</span><span class="params">(form_data: OAuth2PasswordRequestForm = Depends<span class="params">()</span>)</span>:</span></span><br><span class="line">    <span class="comment"># 1、验证用户</span></span><br><span class="line">    user = authenticate_user(fake_users_db, form_data.username, form_data.password)  <span class="comment"># 验证用户</span></span><br><span class="line">    <span class="comment"># 2、access_token_expires访问令牌过期</span></span><br><span class="line">    access_token_expires = timedelta(minutes=ACCESS_TOKEN_EXPIRE_MINUTES)  <span class="comment"># timedelta表示两个datetime对象之间的差异。（来自datetime包）</span></span><br><span class="line">    <span class="comment"># 3、create_access_token创建访问令牌</span></span><br><span class="line">    access_token = create_access_token(data=&#123;<span class="string">"sub"</span>: user.username&#125;, expires_delta=access_token_expires)</span><br><span class="line">    <span class="comment"># 返回</span></span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">"access_token"</span>: access_token, <span class="string">"token_type"</span>: <span class="string">"bearer"</span>&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">get_current_user</span><span class="params">(token: str = Depends<span class="params">(oauth2_scheme)</span>)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    # 获取当前用户</span></span><br><span class="line"><span class="string">    # 通过oauth2_scheme，拿到用户请求头文件里的token</span></span><br><span class="line"><span class="string">    :param token:</span></span><br><span class="line"><span class="string">    :return:</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    credentials_exception = HTTPException(</span><br><span class="line">        status_code=status.HTTP_401_UNAUTHORIZED,</span><br><span class="line">        detail=<span class="string">"Could not validate credentials"</span>,</span><br><span class="line">        headers=&#123;<span class="string">"WWW-Authenticate"</span>: <span class="string">"Bearer"</span>&#125;,</span><br><span class="line">    )</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># jwt 解码</span></span><br><span class="line">        payload = jwt.decode(token, SECRET_KEY, algorithms=[ALGORITHM])</span><br><span class="line">        <span class="comment"># 通常在jwt 解码会进行验证抛出各种异常PyJWTError，如令牌过期等；</span></span><br><span class="line">        <span class="comment"># 获取生成token时候，我们放进去的username信息</span></span><br><span class="line">        username: str = payload.get(<span class="string">"sub"</span>)</span><br><span class="line">        <span class="keyword">if</span> username <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="keyword">raise</span> credentials_exception</span><br><span class="line">        token_data = TokenData(username=username)</span><br><span class="line">    <span class="keyword">except</span> PyJWTError:</span><br><span class="line">        <span class="keyword">raise</span> credentials_exception</span><br><span class="line">    <span class="comment"># 获取该用户信息</span></span><br><span class="line">    user = get_user(fake_users_db, username=token_data.username)</span><br><span class="line">    <span class="keyword">if</span> user <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        <span class="keyword">raise</span> credentials_exception</span><br><span class="line">    <span class="keyword">return</span> user</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">get_current_active_user</span><span class="params">(current_user: User = Depends<span class="params">(get_current_user)</span>)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    # 获取当前激活用户，通过数据库信息及相关条件对用户有效性进行过滤；</span></span><br><span class="line"><span class="string">    如该用户存在，密码正确，token验证通过，但数据库字段显示该用户被封号或欠费了</span></span><br><span class="line"><span class="string">    （非激活用户），就这此处触发异常，结束访问。</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    :param current_user:</span></span><br><span class="line"><span class="string">    :return:</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="keyword">if</span> current_user.disabled:</span><br><span class="line">        <span class="keyword">raise</span> HTTPException(status_code=<span class="number">400</span>, detail=<span class="string">"Inactive user"</span>)</span><br><span class="line">    <span class="keyword">return</span> current_user</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get("/users/me/", response_model=User)</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">read_users_me</span><span class="params">(current_user: User = Depends<span class="params">(get_current_active_user)</span>)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    # 数据请求接口（获得自己的数据库信息），依赖上面的校验函数</span></span><br><span class="line"><span class="string">    :param current_user:</span></span><br><span class="line"><span class="string">    :return:</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="keyword">return</span> current_user</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    uvicorn.run(app=<span class="string">"main:app"</span>, host=<span class="string">"0.0.0.0"</span>, port=<span class="number">8000</span>)</span><br></pre></td></tr></table></figure>
<p><strong>不加token请求测试</strong>：</p>
<p><img src="/2022/03/31/FastAPI%E5%BC%80%E5%8F%91Security%E7%B3%BB%E5%88%97%E4%B9%8Btoken%E8%AE%A4%E8%AF%81/2.jpg" style="zoom: 50%;"></p>
<p><strong>加token请求测试</strong>：</p>
<p><img src="/2022/03/31/FastAPI%E5%BC%80%E5%8F%91Security%E7%B3%BB%E5%88%97%E4%B9%8Btoken%E8%AE%A4%E8%AF%81/3.jpg" style="zoom: 50%;"></p>
<p><strong>官网参考链接：</strong></p>
<p><a href="https://fastapi.tiangolo.com/tutorial/security/simple-oauth2/" target="_blank" rel="noopener">https://fastapi.tiangolo.com/tutorial/security/simple-oauth2/</a></p>
<p><a href="https://blog.csdn.net/Disany/article/details/109365066" target="_blank" rel="noopener">(65条消息) FastAPI Security系列之token认证（进阶篇）_搬砖的Fish的博客-CSDN博客_fastapi token</a></p>
<p><strong>项目完整代码：</strong></p>
<p><a href="https://github.com/BoyYongXin/wx_pub_artcole_code" target="_blank" rel="noopener">BoyYongXin/wx_pub_article_code: 博客发文使用的代码 (github.com)</a></p>
<p><strong>结束语</strong>：</p>
<p>​    今天的分享就到这里了，欢迎大家关注微信公众号”<strong>菜鸟童靴</strong>“</p>
<p><img src="/2022/03/31/FastAPI%E5%BC%80%E5%8F%91Security%E7%B3%BB%E5%88%97%E4%B9%8Btoken%E8%AE%A4%E8%AF%81/微信.png" style="zoom: 50%;"></p>
]]></content>
      <categories>
        <category>后端</category>
      </categories>
      <tags>
        <tag>后端</tag>
        <tag>fastapi</tag>
      </tags>
  </entry>
  <entry>
    <title>FastApi开发之项目文件结构</title>
    <url>/2022/03/31/FastApi%E5%BC%80%E5%8F%91%E4%B9%8B%E9%A1%B9%E7%9B%AE%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84/</url>
    <content><![CDATA[<p>hello 大家好我是Monday，前面我已写了多篇关于fastapi的文章，我们可以开发一些web应用了，今天给大家带来一篇FastApi开发之项目文件结构的文章。</p>
<a id="more"></a>
<p>根据自己的项目项目需求，组合了一套项目文件结构，今天的文章很短，主要是分享一下，每一个web应用的项目结构搭建</p>
<p><strong>1、项目结构如下：</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">├─ceshi_server</span><br><span class="line">│      active_send_request_ceshi.py</span><br><span class="line">├─chain</span><br><span class="line">│      scheduled_task.py</span><br><span class="line">│      __init__.py</span><br><span class="line">│</span><br><span class="line">├─common</span><br><span class="line">│  │  ceshi_db.py</span><br><span class="line">│  │  MysqlSaveMethod.py</span><br><span class="line">│  │  __init__.py</span><br><span class="line">├─create_table</span><br><span class="line">│      create_table.py</span><br><span class="line">│      __init__.py</span><br><span class="line">│</span><br><span class="line">├─datas</span><br><span class="line">│  ├─20220323</span><br><span class="line">│  │      0e25fc005f6de92cfc618e6ff3d6d615.jpg</span><br><span class="line">│  │      17416c4efa75596d835a39cced071b57.jpg</span><br><span class="line">├─db</span><br><span class="line">│  │  elastic_search_db.py</span><br><span class="line">│  │  mongo_db.py</span><br><span class="line">│  │  mysqldb.py</span><br><span class="line">│  │  redis_db.py</span><br><span class="line">│  │  __init__.py</span><br><span class="line">├─extract_data</span><br><span class="line">│  │  login.py</span><br><span class="line">│  │  report_contact.py</span><br><span class="line">│  │  report_new_msg.py</span><br><span class="line">│  │  report_new_room.py</span><br><span class="line">│  │  report_room_member_info.py</span><br><span class="line">│  │  report_room_member_update.py</span><br><span class="line">│  │  __init__.py</span><br><span class="line">├─logs</span><br><span class="line">│  └─loguru</span><br><span class="line">│          2022-03-22.log</span><br><span class="line">├─middleware</span><br><span class="line">│  │  extract_data.py</span><br><span class="line">│  │  limiter_tool.py</span><br><span class="line">│  │  __init__.py</span><br><span class="line">├─models</span><br><span class="line">│  │  user.py</span><br><span class="line">│  │  __init__.py</span><br><span class="line">├─routers</span><br><span class="line">│  │  index.py</span><br><span class="line">│  │  open_api.py</span><br><span class="line">│  │  pull_task.py</span><br><span class="line">│  │  push_task.py</span><br><span class="line">│  │  token_info.py</span><br><span class="line">│  │  upload_file.py</span><br><span class="line">│  │  __init__.py</span><br><span class="line">├─schemas</span><br><span class="line">│  │  user.py</span><br><span class="line">│  │  __init__.py</span><br><span class="line">│  </span><br><span class="line">├─utils</span><br><span class="line">│  │  loguru_handler.py</span><br><span class="line">│  │  __init__.py</span><br><span class="line">│  .gitignore</span><br><span class="line">│  base_task.py</span><br><span class="line">│  callback_server.py</span><br><span class="line">│  config.py</span><br><span class="line">│  crud.py</span><br><span class="line">│  database.py</span><br><span class="line">│  exceptions.py</span><br><span class="line">│  readme.md</span><br><span class="line">│  readme2.md</span><br><span class="line">│  requirements.txt</span><br><span class="line">│  start.sh</span><br><span class="line">│  worker.py</span><br><span class="line">│  __init__.py</span><br></pre></td></tr></table></figure>
<p><strong>2、项目文件逐一介绍：</strong></p>
<p>ceshi_server文件：存放对结构的一些代码测试实例</p>
<p>chain和worker文件：是项目集成了，celery 处理一些后台任务脚本</p>
<p>DB文件：封装了一些mysql 、MongoDB、等数据基础增删改差的基本功能封装</p>
<p>common文件：做了一些公用的对DB数据库的常用方法封装</p>
<p>utils文件：封装一些常用的工具类，日志等</p>
<p>middleware：中间件模块，封装一些自定义中间件模块</p>
<p>logs文件： 存放日志落地文件</p>
<p>datas文件:存放数据缓存文件等</p>
<p>routers文件： 文件里各个应用模块的内容（主要是根据不同功能分类的分组路由）</p>
<p>models文件：存放数据模型</p>
<p>extract_data文件：因为的我项目，有对不同数数据的解析提取分类，故有此类模块的存在</p>
<p>schemas文件：对数据模型的合法校验</p>
<p>start.sh：项目启动脚本</p>
<p>exceptions：自定义异常类</p>
<p> config文件：项目配置文件</p>
<p>callback_server:项目启动主文件</p>
<p>base_task.py： 里面主要封装了celery 的基类操作</p>
<p> requirements.txt和readme.md这两个文件顾名思义，这里就不做介绍了</p>
<p>今天的文章分享内容，就到这了</p>
<p><strong>3、总结:</strong></p>
<p>陆陆续续写了关于fastapi 的开发的一些文章，今天的文章也预示着，关于fastapi框架的技术分享暂告一段落了，但并不是落幕</p>
<p>后续我还会对一些知识进行总结分享，感谢大家的观看</p>
<p><strong>结束语</strong>：</p>
<p>​    今天的分享就到这里了，欢迎大家关注微信公众号”<strong>菜鸟童靴</strong>“</p>
<p><img src="/2022/03/31/FastApi%E5%BC%80%E5%8F%91%E4%B9%8B%E9%A1%B9%E7%9B%AE%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84/微信.png" style="zoom: 50%;"></p>
]]></content>
      <categories>
        <category>后端</category>
      </categories>
      <tags>
        <tag>后端</tag>
        <tag>fastapi</tag>
      </tags>
  </entry>
  <entry>
    <title>FastApi开发之自定义异常处理</title>
    <url>/2022/03/31/FastApi%E5%BC%80%E5%8F%91%E4%B9%8B%E8%87%AA%E5%AE%9A%E4%B9%89%E5%BC%82%E5%B8%B8/</url>
    <content><![CDATA[<p>hello 大家好我是Monday，今天给大家带来一篇FastApi开发之自定义异常处理的文章。</p>
<a id="more"></a>
<h2 id="一、使用-HTTPException"><a href="#一、使用-HTTPException" class="headerlink" title="一、使用 HTTPException"></a>一、使用 HTTPException</h2><p>向客户端返回 HTTP 错误响应，可以使用 <code>HTTPException</code>。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI, HTTPException</span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line">items = &#123;<span class="string">"foo"</span>: <span class="string">"The Foo Wrestlers"</span>&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get("/items/&#123;item_id&#125;")</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">read_item</span><span class="params">(item_id: str)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> item_id <span class="keyword">not</span> <span class="keyword">in</span> items:</span><br><span class="line">        <span class="keyword">raise</span> HTTPException(status_code=<span class="number">404</span>, detail=<span class="string">"Item not found"</span>)</span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">"item"</span>: items[item_id]&#125;</span><br></pre></td></tr></table></figure>
<h3 id="触发-HTTPException"><a href="#触发-HTTPException" class="headerlink" title="触发 HTTPException"></a>触发 HTTPException</h3><p><code>HTTPException</code> 是额外包含了和 API 有关数据的常规 Python 异常。</p>
<p>因为是 Python 异常，所以不能 <code>return</code>，只能 <code>raise</code>。</p>
<p>查看结果：</p>
<p><img src="/2022/03/31/FastApi%E5%BC%80%E5%8F%91%E4%B9%8B%E8%87%AA%E5%AE%9A%E4%B9%89%E5%BC%82%E5%B8%B8/1.jpg" style="zoom: 50%;"></p>
<h3 id="添加自定义响应头"><a href="#添加自定义响应头" class="headerlink" title="添加自定义响应头"></a>添加自定义响应头</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI, HTTPException</span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line">items = &#123;<span class="string">"foo"</span>: <span class="string">"The Foo Wrestlers"</span>&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get("/items-header/&#123;item_id&#125;")</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">read_item_header</span><span class="params">(item_id: str)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> item_id <span class="keyword">not</span> <span class="keyword">in</span> items:</span><br><span class="line">        <span class="keyword">raise</span> HTTPException(</span><br><span class="line">            status_code=<span class="number">404</span>,</span><br><span class="line">            detail=<span class="string">"Item not found"</span>,</span><br><span class="line">            headers=&#123;<span class="string">"X-Error"</span>: <span class="string">"There goes my error"</span>&#125;,</span><br><span class="line">        )</span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">"item"</span>: items[item_id]&#125;</span><br></pre></td></tr></table></figure>
<p>我们使用postman访问错误的url，看下测试结果：</p>
<p><img src="/2022/03/31/FastApi%E5%BC%80%E5%8F%91%E4%B9%8B%E8%87%AA%E5%AE%9A%E4%B9%89%E5%BC%82%E5%B8%B8/2.jpg" style="zoom: 50%;"></p>
<h2 id="二、自定义返回HTTPException"><a href="#二、自定义返回HTTPException" class="headerlink" title="二、自定义返回HTTPException"></a><strong>二、自定义返回HTTPException</strong></h2><p>官方示例如下：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> uvicorn</span><br><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI, Request</span><br><span class="line"><span class="keyword">from</span> fastapi.responses <span class="keyword">import</span> JSONResponse</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UnicornException</span><span class="params">(Exception)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, name: str)</span>:</span></span><br><span class="line">        self.name = name</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.exception_handler(UnicornException)</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">unicorn_exception_handler</span><span class="params">(request: Request, exc: UnicornException)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> JSONResponse(</span><br><span class="line">        status_code=<span class="number">418</span>,</span><br><span class="line">        content=&#123;<span class="string">"message"</span>: <span class="string">f"Oops! <span class="subst">&#123;exc.name&#125;</span> did something. There goes a rainbow..."</span>&#125;,</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get("/unicorns/&#123;name&#125;")</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">read_unicorn</span><span class="params">(name: str)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> name == <span class="string">"yolo"</span>:</span><br><span class="line">        <span class="keyword">raise</span> UnicornException(name=name)</span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">"unicorn_name"</span>: name&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    uvicorn.run(app=<span class="string">'eg2:app'</span>, host=<span class="string">"127.0.0.1"</span>, port=<span class="number">8000</span>, reload=<span class="literal">True</span>, debug=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>
<p>我观察下测试结果：</p>
<p><img src="/2022/03/31/FastApi%E5%BC%80%E5%8F%91%E4%B9%8B%E8%87%AA%E5%AE%9A%E4%B9%89%E5%BC%82%E5%B8%B8/3.jpg" style="zoom: 50%;"></p>
<p>当请求name == yolo的时候，我们主动抛出了UnicornException，而且我们，@app.exception_handler(UnicornException)也捕获到相关的异常信息，且返回了相关的信息。</p>
<h2 id="三、覆盖默认异常处理器"><a href="#三、覆盖默认异常处理器" class="headerlink" title="三、覆盖默认异常处理器"></a>三、覆盖默认异常处理器</h2><p><strong>FastAPI</strong> 自带了一些默认异常处理器。</p>
<p>触发 <code>HTTPException</code> 或请求无效数据时，这些处理器返回默认的 JSON 响应结果。</p>
<p>不过，也可以使用自定义处理器覆盖默认异常处理器。</p>
<h3 id="覆盖请求验证异常"><a href="#覆盖请求验证异常" class="headerlink" title="覆盖请求验证异常"></a>覆盖请求验证异常</h3><p>请求中包含无效数据时，<strong>FastAPI</strong> 内部会触发 <code>RequestValidationError</code>。</p>
<p>该异常也内置了默认异常处理器。</p>
<p>覆盖默认异常处理器时需要导入 <code>RequestValidationError</code>，并用 <code>@app.excption_handler(RequestValidationError)</code> 装饰异常处理器。</p>
<p><strong>如： 默认代码没有添加覆盖处理的话代码如下：</strong></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> uvicorn</span><br><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI, HTTPException</span><br><span class="line"><span class="keyword">from</span> fastapi.exceptions <span class="keyword">import</span> RequestValidationError</span><br><span class="line"><span class="keyword">from</span> fastapi.responses <span class="keyword">import</span> PlainTextResponse</span><br><span class="line"><span class="keyword">from</span> starlette.exceptions <span class="keyword">import</span> HTTPException <span class="keyword">as</span> StarletteHTTPException</span><br><span class="line"><span class="keyword">from</span> fastapi.responses <span class="keyword">import</span> JSONResponse</span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.exception_handler(StarletteHTTPException)</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">http_exception_handler</span><span class="params">(request, exc)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> PlainTextResponse(str(exc.detail), status_code=exc.status_code)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># @app.exception_handler(RequestValidationError)</span></span><br><span class="line"><span class="comment"># async def validation_exception_handler(request, exc):</span></span><br><span class="line"><span class="comment">#     return JSONResponse(&#123;'mes':'触发了RequestValidationError错误，，错误信息:%s 你妹的错了！'%(str(exc))&#125;)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get("/items/&#123;item_id&#125;")</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">read_item</span><span class="params">(item_id: int)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> item_id == <span class="number">3</span>:</span><br><span class="line">        <span class="keyword">raise</span> HTTPException(status_code=<span class="number">418</span>, detail=<span class="string">"Nope! I don't like 3."</span>)</span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">"item_id"</span>: item_id&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    uvicorn.run(app=<span class="string">'eg3:app'</span>, host=<span class="string">"127.0.0.1"</span>, port=<span class="number">8000</span>, reload=<span class="literal">True</span>, debug=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>
<p><strong>开启我们的测试</strong>：</p>
<p><img src="/2022/03/31/FastApi%E5%BC%80%E5%8F%91%E4%B9%8B%E8%87%AA%E5%AE%9A%E4%B9%89%E5%BC%82%E5%B8%B8/4.jpg" style="zoom: 50%;"></p>
<p>当我们类型输入错误时，会抛出如图的异常</p>
<p> <strong>恢复覆盖的时候：</strong></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> uvicorn</span><br><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI, HTTPException</span><br><span class="line"><span class="keyword">from</span> fastapi.exceptions <span class="keyword">import</span> RequestValidationError</span><br><span class="line"><span class="keyword">from</span> fastapi.responses <span class="keyword">import</span> PlainTextResponse</span><br><span class="line"><span class="keyword">from</span> starlette.exceptions <span class="keyword">import</span> HTTPException <span class="keyword">as</span> StarletteHTTPException</span><br><span class="line"><span class="keyword">from</span> fastapi.responses <span class="keyword">import</span> JSONResponse</span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.exception_handler(StarletteHTTPException)</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">http_exception_handler</span><span class="params">(request, exc)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> PlainTextResponse(str(exc.detail), status_code=exc.status_code)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.exception_handler(RequestValidationError)</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">validation_exception_handler</span><span class="params">(request, exc)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> JSONResponse(&#123;<span class="string">'mes'</span>:<span class="string">'触发了RequestValidationError错误，，错误信息:%s 你妹的错了！'</span>%(str(exc))&#125;)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get("/items/&#123;item_id&#125;")</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">read_item</span><span class="params">(item_id: int)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> item_id == <span class="number">3</span>:</span><br><span class="line">        <span class="keyword">raise</span> HTTPException(status_code=<span class="number">418</span>, detail=<span class="string">"Nope! I don't like 3."</span>)</span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">"item_id"</span>: item_id&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    uvicorn.run(app=<span class="string">'eg3:app'</span>, host=<span class="string">"127.0.0.1"</span>, port=<span class="number">8000</span>, reload=<span class="literal">True</span>, debug=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>
<p><strong>开启我们的测试</strong>：</p>
<p><img src="/2022/03/31/FastApi%E5%BC%80%E5%8F%91%E4%B9%8B%E8%87%AA%E5%AE%9A%E4%B9%89%E5%BC%82%E5%B8%B8/5.jpg" style="zoom: 50%;"></p>
<p>上面的返回其实我们还可以修改一下返回如下，指定响应码：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">@app.exception_handler(RequestValidationError)</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">validation_exception_handler</span><span class="params">(request: Request, exc: RequestValidationError)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> JSONResponse(</span><br><span class="line">        status_code=status.HTTP_422_UNPROCESSABLE_ENTITY,</span><br><span class="line">        content=jsonable_encoder(&#123;<span class="string">"detail"</span>: exc.errors(), <span class="string">"body"</span>: exc.body&#125;),</span><br><span class="line">    )</span><br></pre></td></tr></table></figure>
<p><strong>测试下结果</strong>：</p>
<p><img src="/2022/03/31/FastApi%E5%BC%80%E5%8F%91%E4%B9%8B%E8%87%AA%E5%AE%9A%E4%B9%89%E5%BC%82%E5%B8%B8/6.jpg" style="zoom: 50%;"></p>
<p>更多内容请移步官网：</p>
<p><a href="https://fastapi.tiangolo.com/zh/tutorial/handling-errors/" target="_blank" rel="noopener">处理错误 - FastAPI (tiangolo.com)</a></p>
<p><strong>项目完整代码：</strong></p>
<p><a href="https://github.com/BoyYongXin/wx_pub_artcole_code" target="_blank" rel="noopener">BoyYongXin/wx_pub_article_code: 博客发文使用的代码 (github.com)</a></p>
<p><strong>结束语</strong>：</p>
<p>​    今天的分享就到这里了，欢迎大家关注微信公众号”<strong>菜鸟童靴</strong>“</p>
<p><img src="/2022/03/31/FastApi%E5%BC%80%E5%8F%91%E4%B9%8B%E8%87%AA%E5%AE%9A%E4%B9%89%E5%BC%82%E5%B8%B8/微信.png" style="zoom: 50%;"></p>
]]></content>
      <categories>
        <category>后端</category>
      </categories>
      <tags>
        <tag>后端</tag>
        <tag>fastapi</tag>
      </tags>
  </entry>
  <entry>
    <title>FastApi开发之自定义中间件</title>
    <url>/2022/03/30/FastApi%E5%BC%80%E5%8F%91%E4%B9%8B%E8%87%AA%E5%AE%9A%E4%B9%89%E4%B8%AD%E9%97%B4%E4%BB%B6/</url>
    <content><![CDATA[<p>hello 大家好我是Monday，今天给大家带来一篇FastAPI中自定义中间件的文章。</p>
<a id="more"></a>
<h2 id="一、前言："><a href="#一、前言：" class="headerlink" title="一、前言："></a><strong>一、前言：</strong></h2><p><strong>1、什么中间件</strong>：</p>
<ul>
<li>就是一个函数，它在被任何特定路径操作处理之前处理每个请求，且在每个 response 返回之前被调用</li>
<li>类似钩子函数</li>
</ul>
<h4 id="2、执行顺序"><a href="#2、执行顺序" class="headerlink" title="2、执行顺序"></a>2、执行顺序</h4><ol>
<li><p>中间件会接收应用程序中的每个请求 Request</p>
</li>
<li><p>针对请求 Request 或其他功能，可以自定义代码块</p>
</li>
<li><p>再将请求 Request 传回路径操作函数，由应用程序的其余部分继续处理该请求</p>
</li>
<li><p>路径操作函数处理完后，中间件会获取到应用程序生成的响应 Response</p>
</li>
<li><p>中间件可以针对响应 Response 或其他功能，又可以自定义代码块</p>
</li>
<li><p>最后返回响应 Response 给客户端</p>
</li>
</ol>
<p><strong>3、中间件主要作用**</strong>：其实就是在请求前和请求后处理机制。通常我们的可以在中间件里处理的事情有：</p>
<ul>
<li>日志记录</li>
<li>鉴权</li>
<li>数据库的操作开关处理等</li>
</ul>
<h2 id="二、中间件操作示例："><a href="#二、中间件操作示例：" class="headerlink" title="二、中间件操作示例："></a>二、中间件操作示例：</h2><h3 id="1、如官网提供的最简自定义的中间件示例："><a href="#1、如官网提供的最简自定义的中间件示例：" class="headerlink" title="1、如官网提供的最简自定义的中间件示例："></a><strong>1、如官网提供的最简自定义的中间件示例：</strong></h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> uvicorn</span><br><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI, Request, Response</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.middleware("http")</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">log_request</span><span class="params">(request, call_next)</span>:</span></span><br><span class="line">    print(<span class="string">'请求开始前我可以处理事情1'</span>)</span><br><span class="line">    response = <span class="keyword">await</span> call_next(request)</span><br><span class="line"></span><br><span class="line">    print(<span class="string">'请求开始后我可以处理的事情3'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> response</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get("/")</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">not_timed</span><span class="params">()</span>:</span></span><br><span class="line">    print(<span class="string">'请求开始后我可以处理的事情2'</span>)</span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">"message"</span>: <span class="string">"你好"</span>&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    uvicorn.run(<span class="string">'eg1:app'</span>, host=<span class="string">"127.0.0.1"</span>, port=<span class="number">8000</span>, debug=<span class="literal">True</span>, reload=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>
<p>运行访问<a href="http://127.0.0.1:8000/" target="_blank" rel="noopener">127.0.0.1:8000</a>，看下控制台输出：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">INFO:     Application startup complete.</span><br><span class="line">请求开始前我可以处理事情1</span><br><span class="line">请求开始后我可以处理的事情2</span><br><span class="line">请求开始后我可以处理的事情3</span><br><span class="line">INFO:     127.0.0.1:64807 - &quot;GET &#x2F; HTTP&#x2F;1.1&quot; 200 OK</span><br></pre></td></tr></table></figure>
<p>我们还可以对返回的response进行处理，实例如下：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> uvicorn</span><br><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI, Request, Response</span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.middleware("http")</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">log_request</span><span class="params">(request, call_next)</span>:</span></span><br><span class="line">    print(<span class="string">'请求开始前我可以处理事情1'</span>)</span><br><span class="line">    start_time = time.time()</span><br><span class="line">    response = <span class="keyword">await</span> call_next(request)</span><br><span class="line"></span><br><span class="line">    print(<span class="string">'请求开始后我可以处理的事情3'</span>)</span><br><span class="line">    process_time = time.time() - start_time</span><br><span class="line">    response.headers[<span class="string">"X-Process-Time"</span>] = str(process_time)</span><br><span class="line">    <span class="keyword">return</span> response</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get("/")</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">not_timed</span><span class="params">(response: Response)</span>:</span></span><br><span class="line">    print(<span class="string">'请求开始后我可以处理的事情2'</span>)</span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">"message"</span>: <span class="string">"你好"</span>&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    uvicorn.run(<span class="string">'eg2:app'</span>, host=<span class="string">"127.0.0.1"</span>, port=<span class="number">8000</span>, debug=<span class="literal">True</span>, reload=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>
<p>我们可以看到，请求后的header 会出现X-Process-Time字段</p>
<p><img src="/2022/03/30/FastApi%E5%BC%80%E5%8F%91%E4%B9%8B%E8%87%AA%E5%AE%9A%E4%B9%89%E4%B8%AD%E9%97%B4%E4%BB%B6/1.jpg" style="zoom: 50%;"></p>
<h3 id="2：基于BaseHTTPMiddleware的实现的中间件"><a href="#2：基于BaseHTTPMiddleware的实现的中间件" class="headerlink" title="2：基于BaseHTTPMiddleware的实现的中间件"></a>2：基于BaseHTTPMiddleware的实现的中间件</h3><p>多自定义中间件示例：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> uvicorn</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI, Request, Response</span><br><span class="line"><span class="keyword">from</span> starlette.middleware.base <span class="keyword">import</span> BaseHTTPMiddleware</span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.middleware("http")</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">log_request</span><span class="params">(request, call_next)</span>:</span></span><br><span class="line">    print(<span class="string">'请求开始前我可以处理事情1'</span>)</span><br><span class="line">    response = <span class="keyword">await</span> call_next(request)</span><br><span class="line"></span><br><span class="line">    print(<span class="string">'请求开始后我可以处理的事情3'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> response</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 基于BaseHTTPMiddleware的中间件实例，</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CostimeHeaderMiddleware</span><span class="params">(BaseHTTPMiddleware)</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># dispatch 必须实现</span></span><br><span class="line">    <span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">dispatch</span><span class="params">(self, request, call_next)</span>:</span></span><br><span class="line">        print(<span class="string">'请求开始前我可以处理事情4---CostimeHeaderMiddleware'</span>)</span><br><span class="line">        start_time = time.time()</span><br><span class="line">        responser = <span class="keyword">await</span> call_next(request)</span><br><span class="line">        process_time = round(time.time() - start_time, <span class="number">4</span>)</span><br><span class="line">        <span class="comment"># 返回接口响应时间</span></span><br><span class="line">        responser.headers[<span class="string">"X-Process-Time"</span>] = <span class="string">f"<span class="subst">&#123;process_time&#125;</span> (s)"</span></span><br><span class="line">        print(<span class="string">'请求开始后我可以处理事情5----CostimeHeaderMiddleware'</span>)</span><br><span class="line">        <span class="keyword">return</span> responser</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 基于BaseHTTPMiddleware的中间件实例，</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CostimeHeaderMiddleware2</span><span class="params">(BaseHTTPMiddleware)</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># dispatch 必须实现</span></span><br><span class="line">    <span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">dispatch</span><span class="params">(self, request, call_next)</span>:</span></span><br><span class="line">        print(<span class="string">'请求开始前我可以处理事情6-----CostimeHeaderMiddleware2'</span>)</span><br><span class="line">        start_time = time.time()</span><br><span class="line">        responser = <span class="keyword">await</span> call_next(request)</span><br><span class="line">        process_time = round(time.time() - start_time, <span class="number">4</span>)</span><br><span class="line">        <span class="comment"># 返回接口响应时间</span></span><br><span class="line">        responser.headers[<span class="string">"X-Process-Time"</span>] = <span class="string">f"<span class="subst">&#123;process_time&#125;</span> (s)"</span></span><br><span class="line">        print(<span class="string">'请求开始后我可以处理事情7---CostimeHeaderMiddleware2'</span>)</span><br><span class="line">        <span class="keyword">return</span> responser</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">app.add_middleware(CostimeHeaderMiddleware)</span><br><span class="line">app.add_middleware(CostimeHeaderMiddleware2)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get("/")</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">not_timed</span><span class="params">()</span>:</span></span><br><span class="line">    print(<span class="string">'请求开始后我可以处理的事情2'</span>)</span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">"message"</span>: <span class="string">"你好"</span>&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    uvicorn.run(<span class="string">'eg3:app'</span>, host=<span class="string">"127.0.0.1"</span>, port=<span class="number">8000</span>, debug=<span class="literal">True</span>, reload=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>
<p><strong>运行结果：</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">请求开始前我可以处理事情6-----CostimeHeaderMiddleware2</span><br><span class="line">请求开始前我可以处理事情4---CostimeHeaderMiddleware</span><br><span class="line">请求开始前我可以处理事情1</span><br><span class="line">请求开始后我可以处理的事情2</span><br><span class="line">请求开始后我可以处理的事情3</span><br><span class="line">请求开始后我可以处理事情5----CostimeHeaderMiddleware</span><br><span class="line">请求开始后我可以处理事情7---CostimeHeaderMiddleware2</span><br><span class="line">INFO:     127.0.0.1:50065 - &quot;GET &#x2F; HTTP&#x2F;1.1&quot; 200 OK</span><br></pre></td></tr></table></figure>
<p><strong>结论：</strong></p>
<p>（1）从上面的输出结果可以看得到我们的中间件的注册顺序非常的重要。他们的上面的注册顺序是：</p>
<p><strong>注册显示：</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">app.add_middleware(CostimeHeaderMiddleware)</span><br><span class="line">app.add_middleware(CostimeHeaderMiddleware2)</span><br></pre></td></tr></table></figure>
<p><strong>结果显示：</strong></p>
<p>请求开始前我可以处理事情6——-CostimeHeaderMiddleware2<br>请求开始前我可以处理事情4—-CostimeHeaderMiddleware</p>
<p>——&gt;越是最晚注册的，越最先执行，同时也是最后收尾执行的</p>
<p>（2）假如你有需要使用中间件来处理全局异常的捕获的话，放在最外层去处理！</p>
<h3 id="3：中间件中获取最终responser返回值"><a href="#3：中间件中获取最终responser返回值" class="headerlink" title="3：中间件中获取最终responser返回值"></a>3：中间件中获取最终responser返回值</h3><p>下面这篇文章做出了解释</p>
<p><a href="https://juejin.cn/post/6971451349141553165" target="_blank" rel="noopener">Fastapi框架-冷饭再炒-基础知识补充篇（5)- 自定义中间件，在中间获取响应体报文 - 掘金 (juejin.cn)</a></p>
<p><strong>参考链接：</strong><br>链接1：<a href="https://juejin.cn/post/6971451349141553165" target="_blank" rel="noopener">https://juejin.cn/post/6971451349141553165</a></p>
<p>链接2：<a href="https://fastapi.tiangolo.com/zh/tutorial/middleware/" target="_blank" rel="noopener">中间件 - FastAPI (tiangolo.com)</a></p>
<p><strong>结束语</strong>：</p>
<p>​    今天的分享就到这里了，欢迎大家关注微信公众号”<strong>菜鸟童靴</strong>“</p>
<p><img src="/2022/03/30/FastApi%E5%BC%80%E5%8F%91%E4%B9%8B%E8%87%AA%E5%AE%9A%E4%B9%89%E4%B8%AD%E9%97%B4%E4%BB%B6/微信.png" style="zoom: 50%;"></p>
]]></content>
      <categories>
        <category>后端</category>
      </categories>
      <tags>
        <tag>后端</tag>
        <tag>fastapi</tag>
      </tags>
  </entry>
  <entry>
    <title>FastApi开发之CORS跨域资源共享</title>
    <url>/2022/03/30/FastApi%E5%BC%80%E5%8F%91%E4%B9%8BCORS%E8%B7%A8%E5%9F%9F%E8%B5%84%E6%BA%90%E5%85%B1%E4%BA%AB/</url>
    <content><![CDATA[<p>hello 大家好我是Monday，今天给大家带来一篇FastAPI中CORS跨域资源共享的文章。</p>
<a id="more"></a>
<p><strong>CORS 或者跨域资源共享：</strong> </p>
<p>​    指浏览器中运行的前端拥有与后端通信的 JavaScript 代码，而后端处于与前端不同的「源」的情况。</p>
<h4 id="1、源"><a href="#1、源" class="headerlink" title="1、源"></a>1、源</h4><p>源是协议（<code>http</code>，<code>https</code>）、域（<code>myapp.com</code>，<code>localhost</code>，<code>localhost.tiangolo.com</code>）以及端口（<code>80</code>、<code>443</code>、<code>8080</code>）的组合。</p>
<p>因此，这些都是不同的源：</p>
<ul>
<li><code>http://localhost</code></li>
<li><code>https://localhost</code></li>
<li><code>http://localhost:8080</code></li>
</ul>
<p>即使它们都在 <code>localhost</code> 中，但是它们使用不同的协议或者端口，所以它们都是不同的「源」。</p>
<h4 id="2、步骤"><a href="#2、步骤" class="headerlink" title="2、步骤"></a>2、步骤</h4><p>假设你的浏览器中有一个前端运行在 <code>http://localhost:8080</code>，并且它的 JavaScript 正在尝试与运行在 <code>http://localhost</code> 的后端通信（因为我们没有指定端口，浏览器会采用默认的端口 <code>80</code>）。</p>
<p>然后，浏览器会向后端发送一个 HTTP <code>OPTIONS</code> 请求，如果后端发送适当的 headers 来授权来自这个不同源（<code>http://localhost:8080</code>）的通信，浏览器将允许前端的 JavaScript 向后端发送请求。</p>
<p>为此，后端必须有一个「允许的源」列表。</p>
<p>在这种情况下，它必须包含 <code>http://localhost:8080</code>，前端才能正常工作。</p>
<h4 id="3、通配符"><a href="#3、通配符" class="headerlink" title="3、通配符"></a>3、通配符</h4><p>也可以使用 <code>&quot;*&quot;</code>（一个「通配符」）声明这个列表，表示全部都是允许的。</p>
<p>但这仅允许某些类型的通信，不包括所有涉及凭据的内容：像 Cookies 以及那些使用 Bearer 令牌的授权 headers 等。</p>
<p>因此，为了一切都能正常工作，最好显式地指定允许的源。</p>
<h4 id="4、使用-CORSMiddleware"><a href="#4、使用-CORSMiddleware" class="headerlink" title="4、使用 CORSMiddleware"></a>4、使用 CORSMiddleware</h4><p>你可以在 <strong>FastAPI</strong> 应用中使用 <code>CORSMiddleware</code> 来配置它。</p>
<ul>
<li>导入 <code>CORSMiddleware</code>。</li>
<li>创建一个允许的源列表（由字符串组成）。</li>
<li>将其作为「中间件」添加到你的 <strong>FastAPI</strong> 应用中。</li>
</ul>
<p>你也可以指定后端是否允许：</p>
<ul>
<li>凭证（授权 headers，Cookies 等）。</li>
<li>特定的 HTTP 方法（<code>POST</code>，<code>PUT</code>）或者使用通配符 <code>&quot;*&quot;</code> 允许所有方法。</li>
<li>特定的 HTTP headers 或者使用通配符 <code>&quot;*&quot;</code> 允许所有 headers。</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI</span><br><span class="line"><span class="keyword">from</span> fastapi.middleware.cors <span class="keyword">import</span> CORSMiddleware</span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line">origins = [</span><br><span class="line">    <span class="string">"http://localhost.tiangolo.com"</span>,</span><br><span class="line">    <span class="string">"https://localhost.tiangolo.com"</span>,</span><br><span class="line">    <span class="string">"http://localhost"</span>,</span><br><span class="line">    <span class="string">"http://localhost:8080"</span>,</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">app.add_middleware(</span><br><span class="line">    CORSMiddleware,</span><br><span class="line">    allow_origins=origins,</span><br><span class="line">    allow_credentials=<span class="literal">True</span>,</span><br><span class="line">    allow_methods=[<span class="string">"*"</span>],</span><br><span class="line">    allow_headers=[<span class="string">"*"</span>],</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get("/")</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">"message"</span>: <span class="string">"Hello World"</span>&#125;</span><br></pre></td></tr></table></figure>
<p>默认情况下，这个 <code>CORSMiddleware</code> 实现所使用的默认参数较为保守，所以你需要显式地启用特定的源、方法或者 headers，以便浏览器能够在跨域上下文中使用它们。</p>
<p>支持以下参数：</p>
<ul>
<li><code>allow_origins</code> - 一个允许跨域请求的源列表。例如 <code>[&#39;https://example.org&#39;, &#39;https://www.example.org&#39;]</code>。你可以使用 <code>[&#39;*&#39;]</code> 允许任何源。</li>
<li><code>allow_origin_regex</code> - 一个正则表达式字符串，匹配的源允许跨域请求。例如 <code>&#39;https://.*\.example\.org&#39;</code>。</li>
<li><code>allow_methods</code> - 一个允许跨域请求的 HTTP 方法列表。默认为 <code>[&#39;GET&#39;]</code>。你可以使用 <code>[&#39;*&#39;]</code> 来允许所有标准方法。</li>
<li><code>allow_headers</code> - 一个允许跨域请求的 HTTP 请求头列表。默认为 <code>[]</code>。你可以使用 <code>[&#39;*&#39;]</code> 允许所有的请求头。<code>Accept</code>、<code>Accept-Language</code>、<code>Content-Language</code> 以及 <code>Content-Type</code> 请求头总是允许 CORS 请求。</li>
<li><code>allow_credentials</code> - 指示跨域请求支持 cookies。默认是 <code>False</code>。另外，允许凭证时 <code>allow_origins</code> 不能设定为 <code>[&#39;*&#39;]</code>，必须指定源。</li>
<li><code>expose_headers</code> - 指示可以被浏览器访问的响应头。默认为 <code>[]</code>。</li>
<li><code>max_age</code> - 设定浏览器缓存 CORS 响应的最长时间，单位是秒。默认为 <code>600</code>。</li>
</ul>
<p>中间件响应两种特定类型的 HTTP 请求……</p>
<h4 id="5、CORS-预检请求"><a href="#5、CORS-预检请求" class="headerlink" title="5、CORS 预检请求"></a>5、CORS 预检请求</h4><p>这是些带有 <code>Origin</code> 和 <code>Access-Control-Request-Method</code> 请求头的 <code>OPTIONS</code> 请求。</p>
<p>在这种情况下，中间件将拦截传入的请求并进行响应，出于提供信息的目的返回一个使用了适当的 CORS headers 的 <code>200</code> 或 <code>400</code> 响应。</p>
<h4 id="6、简单请求"><a href="#6、简单请求" class="headerlink" title="6、简单请求"></a>6、简单请求</h4><p>任何带有 <code>Origin</code> 请求头的请求。在这种情况下，中间件将像平常一样传递请求，但是在响应中包含适当的 CORS headers。</p>
<p><strong>更多详见：</strong></p>
<p><a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/CORS" target="_blank" rel="noopener">跨域资源共享 （CORS） - HTTP |断续器 (mozilla.org)</a></p>
<p><strong>结束语</strong>：</p>
<p>​    今天的分享就到这里了，欢迎大家关注微信公众号”<strong>菜鸟童靴</strong>“</p>
<p><img src="/2022/03/30/FastApi%E5%BC%80%E5%8F%91%E4%B9%8BCORS%E8%B7%A8%E5%9F%9F%E8%B5%84%E6%BA%90%E5%85%B1%E4%BA%AB/微信.png" style="zoom: 50%;"></p>
]]></content>
      <categories>
        <category>后端</category>
      </categories>
      <tags>
        <tag>后端</tag>
        <tag>fastapi</tag>
      </tags>
  </entry>
  <entry>
    <title>FastApi学习之限制接口单位时间被访问频次</title>
    <url>/2022/03/28/FastApi%E5%AD%A6%E4%B9%A0%E4%B9%8B%E9%99%90%E5%88%B6%E6%8E%A5%E5%8F%A3%E5%8D%95%E4%BD%8D%E6%97%B6%E9%97%B4%E8%A2%AB%E8%AE%BF%E9%97%AE%E9%A2%91%E6%AC%A1/</url>
    <content><![CDATA[<p>hello 大家好我是Monday，今天给大家带来一篇FastAPI中限制接口访问频次的文章。</p>
<a id="more"></a>
<h2 id="一、前言"><a href="#一、前言" class="headerlink" title="一、前言"></a>一、前言</h2><p>​        对于服务端而言，有时候会碰到这么一个场景：某个接口需要在某个时间段内设置最高的访问次数来降低服务器的压力，比如之前用的某度的一些接口，一分钟内访问次数过高就会返回失败，等上个2分钟就又可以返回了。目的就是为了防止开发人员或者爬虫，甚至是恶意请求对服务器无限制的访问，降低服务器开支，因为一般的用户的请求是不会这么频繁的</p>
<h2 id="二、实现方式"><a href="#二、实现方式" class="headerlink" title="二、实现方式"></a>二、实现方式</h2><h3 id="（1）Ratelimiter"><a href="#（1）Ratelimiter" class="headerlink" title="（1）Ratelimiter"></a><strong>（1）Ratelimiter</strong></h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">pip install ratelimiter</span><br></pre></td></tr></table></figure>
<p><strong>python 中使用 Ratelimiter 来限制某方法的调用次数，用法如下</strong></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">from</span> ratelimiter <span class="keyword">import</span> RateLimiter</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">limited</span><span class="params">(until)</span>:</span></span><br><span class="line">    duration = int(round(until - time.time()))</span><br><span class="line">    print(<span class="string">'Rate limited, sleeping for &#123;:d&#125; seconds'</span>.format(duration))</span><br><span class="line"><span class="comment"># 3秒之内只能访问2次</span></span><br><span class="line">rate_limiter = RateLimiter(max_calls=<span class="number">2</span>, period=<span class="number">3</span>, callback=limited)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">3</span>):</span><br><span class="line">    <span class="keyword">with</span> rate_limiter:</span><br><span class="line">        print(<span class="string">'Iteration'</span>, i)</span><br></pre></td></tr></table></figure>
<p><strong>输出结果如下</strong></p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">Iteration <span class="number">0</span></span><br><span class="line">Iteration <span class="number">1</span></span><br><span class="line">Rate limited, sleeping <span class="keyword">for</span> <span class="number">3</span> seconds</span><br><span class="line">Iteration <span class="number">2</span></span><br></pre></td></tr></table></figure>
<p>看到程序如期打印， callback 指定了超出指定次数是回调方法 </p>
<p>达到了预期的要求</p>
<h3 id="（2）slowapi"><a href="#（2）slowapi" class="headerlink" title="（2）slowapi"></a><strong>（2）slowapi</strong></h3><p>官网链接：<a href="https://slowapi.readthedocs.io/en/latest/" target="_blank" rel="noopener">SlowApi Documentation</a></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">pip install slowapi</span><br></pre></td></tr></table></figure>
<p><strong>fastapi中使用 slowapi 来限制某方法的调用次数，用法如下</strong></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> uvicorn</span><br><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI</span><br><span class="line"><span class="keyword">from</span> slowapi <span class="keyword">import</span> Limiter, _rate_limit_exceeded_handler</span><br><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> Request, Response</span><br><span class="line"><span class="keyword">from</span> slowapi.errors <span class="keyword">import</span> RateLimitExceeded</span><br><span class="line"><span class="keyword">from</span> slowapi.util <span class="keyword">import</span> get_remote_address</span><br><span class="line"><span class="keyword">from</span> fastapi.responses <span class="keyword">import</span> PlainTextResponse</span><br><span class="line"></span><br><span class="line">limiter = Limiter(key_func=get_remote_address)</span><br><span class="line">app = FastAPI()</span><br><span class="line">app.state.limiter = limiter</span><br><span class="line">app.add_exception_handler(RateLimitExceeded, _rate_limit_exceeded_handler)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get("/home")</span></span><br><span class="line"><span class="meta">@limiter.limit("5/minute")</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">homepage</span><span class="params">(request: Request)</span>:</span></span><br><span class="line">    <span class="comment"># return JSONResponse(&#123;"code":1&#125;)</span></span><br><span class="line">    <span class="keyword">return</span> PlainTextResponse(<span class="string">"访问成功"</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    uvicorn.run(app=<span class="string">"ceshi:app"</span>, host=<span class="string">"0.0.0.0"</span>, port=<span class="number">8000</span>)</span><br></pre></td></tr></table></figure>
<p><strong>测试代码如下：</strong></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">headers = &#123;</span><br><span class="line">    <span class="string">"Connection"</span>: <span class="string">"keep-alive"</span>,</span><br><span class="line">    <span class="string">"Cache-Control"</span>: <span class="string">"max-age=0"</span>,</span><br><span class="line">    <span class="string">"sec-ch-ua"</span>: <span class="string">"^\\^"</span>,</span><br><span class="line">    <span class="string">"sec-ch-ua-mobile"</span>: <span class="string">"?0"</span>,</span><br><span class="line">    <span class="string">"sec-ch-ua-platform"</span>: <span class="string">"^\\^Windows^^"</span>,</span><br><span class="line">    <span class="string">"Upgrade-Insecure-Requests"</span>: <span class="string">"1"</span>,</span><br><span class="line">    <span class="string">"User-Agent"</span>: <span class="string">"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/99.0.4844.74 Safari/537.36 Edg/99.0.1150.52"</span>,</span><br><span class="line">    <span class="string">"Accept"</span>: <span class="string">"text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9"</span>,</span><br><span class="line">    <span class="string">"Sec-Fetch-Site"</span>: <span class="string">"none"</span>,</span><br><span class="line">    <span class="string">"Sec-Fetch-Mode"</span>: <span class="string">"navigate"</span>,</span><br><span class="line">    <span class="string">"Sec-Fetch-User"</span>: <span class="string">"?1"</span>,</span><br><span class="line">    <span class="string">"Sec-Fetch-Dest"</span>: <span class="string">"document"</span>,</span><br><span class="line">    <span class="string">"Accept-Language"</span>: <span class="string">"zh-CN,zh;q=0.9,en;q=0.8,en-GB;q=0.7,en-US;q=0.6"</span></span><br><span class="line">&#125;</span><br><span class="line">url = <span class="string">"http://localhost:8000/home"</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">10</span>):</span><br><span class="line">    response = requests.get(url, headers=headers)</span><br><span class="line">    print(response.text)</span><br></pre></td></tr></table></figure>
<p><strong>测试结果：</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">test</span><br><span class="line">&#123;&quot;error&quot;:&quot;Rate limit exceeded: 5 per 1 minute&quot;&#125;</span><br><span class="line">&#123;&quot;error&quot;:&quot;Rate limit exceeded: 5 per 1 minute&quot;&#125;</span><br><span class="line">&#123;&quot;error&quot;:&quot;Rate limit exceeded: 5 per 1 minute&quot;&#125;</span><br><span class="line">&#123;&quot;error&quot;:&quot;Rate limit exceeded: 5 per 1 minute&quot;&#125;</span><br><span class="line">&#123;&quot;error&quot;:&quot;Rate limit exceeded: 5 per 1 minute&quot;&#125;</span><br><span class="line">&#123;&quot;error&quot;:&quot;Rate limit exceeded: 5 per 1 minute&quot;&#125;</span><br><span class="line">&#123;&quot;error&quot;:&quot;Rate limit exceeded: 5 per 1 minute&quot;&#125;</span><br><span class="line">&#123;&quot;error&quot;:&quot;Rate limit exceeded: 5 per 1 minute&quot;&#125;</span><br><span class="line">&#123;&quot;error&quot;:&quot;Rate limit exceeded: 5 per 1 minute&quot;&#125;</span><br></pre></td></tr></table></figure>
<h3 id="（3）walrus"><a href="#（3）walrus" class="headerlink" title="（3）walrus"></a>（3）walrus</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">pip install walrus</span><br></pre></td></tr></table></figure>
<p><strong>fastapi中使用 walrus 来限制某方法的调用次数，用法如下</strong></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> walrus <span class="keyword">import</span> Database, RateLimitException</span><br><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI, Request</span><br><span class="line"><span class="keyword">from</span> fastapi.responses <span class="keyword">import</span> JSONResponse</span><br><span class="line"><span class="keyword">import</span> uvicorn</span><br><span class="line"></span><br><span class="line">db = Database()</span><br><span class="line">rate = db.rate_limit(<span class="string">'xxx'</span>, limit=<span class="number">5</span>, per=<span class="number">60</span>)  <span class="comment"># in 60s just can only click 5 times</span></span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.exception_handler(RateLimitException)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">parse_rate_litmit_exception</span><span class="params">(request: Request, exc: RateLimitException)</span>:</span></span><br><span class="line">    msg = &#123;<span class="string">'success'</span>: <span class="literal">False</span>, <span class="string">'msg'</span>: <span class="string">f'please have a tea for sleep, your ip is: <span class="subst">&#123;request.client.host&#125;</span>.'</span>&#125;</span><br><span class="line">    <span class="keyword">return</span> JSONResponse(status_code=<span class="number">429</span>, content=msg)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get('/')</span></span><br><span class="line"><span class="meta">@rate.rate_limited(lambda request: request.client.host)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span><span class="params">(request: Request)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">'success'</span>: <span class="literal">True</span>&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get('/important_api')</span></span><br><span class="line"><span class="meta">@rate.rate_limited(lambda request: request.client.host)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">query_important_data</span><span class="params">(request: Request)</span>:</span></span><br><span class="line">    data = <span class="string">'important data'</span></span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">'success'</span>: <span class="literal">True</span>, <span class="string">'data'</span>: data&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    uvicorn.run(<span class="string">"ceshi2:app"</span>, debug=<span class="literal">True</span>, reload=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>
<p><strong>项目完整代码：</strong></p>
<p><a href="https://github.com/BoyYongXin/wx_pub_artcole_code" target="_blank" rel="noopener">BoyYongXin/wx_pub_article_code: 博客发文使用的代码 (github.com)</a></p>
<p>参考博客：</p>
<p><a href="https://cloud.tencent.com/developer/article/1769464" target="_blank" rel="noopener">反爬虫策略手把手教你使用FastAPI来限制接口的访问速率 - 云+社区 - 腾讯云 (tencent.com)</a></p>
<p><strong>结束语</strong>：</p>
<p>​    今天的分享就到这里了，欢迎大家关注微信公众号”<strong>菜鸟童靴</strong>“</p>
<p><img src="/2022/03/28/FastApi%E5%AD%A6%E4%B9%A0%E4%B9%8B%E9%99%90%E5%88%B6%E6%8E%A5%E5%8F%A3%E5%8D%95%E4%BD%8D%E6%97%B6%E9%97%B4%E8%A2%AB%E8%AE%BF%E9%97%AE%E9%A2%91%E6%AC%A1/微信.png" style="zoom: 50%;"></p>
]]></content>
      <categories>
        <category>后端</category>
      </categories>
      <tags>
        <tag>后端</tag>
        <tag>fastapi</tag>
      </tags>
  </entry>
  <entry>
    <title>hexo的next主题下添加访客、访问、文章阅读数统计</title>
    <url>/2022/03/25/hexo%E7%9A%84next%E4%B8%BB%E9%A2%98%E4%B8%8B%E6%B7%BB%E5%8A%A0%E8%AE%BF%E5%AE%A2%E3%80%81%E8%AE%BF%E9%97%AE%E3%80%81%E6%96%87%E7%AB%A0%E9%98%85%E8%AF%BB%E6%95%B0%E7%BB%9F%E8%AE%A1/</url>
    <content><![CDATA[<p>小编使用hexo 写博客时，一直想实现访客、访问、文章阅读数统计，今天正好有兴致搞了一搞</p>
<a id="more"></a>
<p><strong>一、前言：</strong></p>
<p><strong>1、由 <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> 强力驱动 v4.1.1</strong>    <strong>2、主题 – <a href="https://pisces.theme-next.org/" target="_blank" rel="noopener">NexT.Pisces</a> v7.6.0</strong></p>
<p><strong>二、具体操作：</strong></p>
<p><strong>1、打开next主题配置文件\themes\next 文件下的_config.yml，</strong></p>
<p>搜索找到 <strong>busuanzi_count</strong>，把enable设置为true</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># Show Views &#x2F; Visitors of the website &#x2F; page with busuanzi.#展示访问数</span><br><span class="line"># Get more information on http:&#x2F;&#x2F;ibruce.info&#x2F;2015&#x2F;04&#x2F;04&#x2F;busuanzi</span><br><span class="line">busuanzi_count:</span><br><span class="line">  enable: true</span><br><span class="line">  total_visitors: true   #统计访客数</span><br><span class="line">  total_visitors_icon: user</span><br><span class="line">  total_views: true    #统计访问数</span><br><span class="line">  total_views_icon: eye</span><br><span class="line">  post_views: true   #统计文章阅读数</span><br><span class="line">  post_views_icon: eye</span><br></pre></td></tr></table></figure>
<p><strong>2、打开next主题配置文件\themes\next 文件下的_config.yml，</strong></p>
<p>搜索<strong>footer</strong>，在它底下添加counter，设值为true</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#统计</span><br><span class="line">counter: true</span><br></pre></td></tr></table></figure>
<p><strong>3、来到\themes\next\layout 文件下的_partials，找到footer.swig文件，</strong></p>
<p>打开编辑，在底下添加代码</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#123;% if theme.footer.counter %&#125;</span><br><span class="line">    &lt;script async src&#x3D;&quot;&#x2F;&#x2F;dn-lbstatics.qbox.me&#x2F;busuanzi&#x2F;2.3&#x2F;busuanzi.pure.mini.js&quot;&gt;&lt;&#x2F;script&gt;</span><br><span class="line">&#123;% endif %&#125;</span><br></pre></td></tr></table></figure>
<p><strong>设置效果一:</strong></p>
<p><img src="/2022/03/25/hexo%E7%9A%84next%E4%B8%BB%E9%A2%98%E4%B8%8B%E6%B7%BB%E5%8A%A0%E8%AE%BF%E5%AE%A2%E3%80%81%E8%AE%BF%E9%97%AE%E3%80%81%E6%96%87%E7%AB%A0%E9%98%85%E8%AF%BB%E6%95%B0%E7%BB%9F%E8%AE%A1/2.jpg" style="zoom: 100%;"></p>
<p><strong>设置效果二：</strong></p>
<p><img src="/2022/03/25/hexo%E7%9A%84next%E4%B8%BB%E9%A2%98%E4%B8%8B%E6%B7%BB%E5%8A%A0%E8%AE%BF%E5%AE%A2%E3%80%81%E8%AE%BF%E9%97%AE%E3%80%81%E6%96%87%E7%AB%A0%E9%98%85%E8%AF%BB%E6%95%B0%E7%BB%9F%E8%AE%A1/1.jpg" style="zoom: 100%;"></p>
<p><strong>结束语</strong>：</p>
<p>​    今天的分享就到这里了，欢迎大家关注微信公众号”<strong>菜鸟童靴</strong>“</p>
<p><img src="/2022/03/25/hexo%E7%9A%84next%E4%B8%BB%E9%A2%98%E4%B8%8B%E6%B7%BB%E5%8A%A0%E8%AE%BF%E5%AE%A2%E3%80%81%E8%AE%BF%E9%97%AE%E3%80%81%E6%96%87%E7%AB%A0%E9%98%85%E8%AF%BB%E6%95%B0%E7%BB%9F%E8%AE%A1/微信.png" style="zoom: 100%;"></p>
]]></content>
      <categories>
        <category>爬虫</category>
      </categories>
      <tags>
        <tag>hexo</tag>
        <tag>博客</tag>
      </tags>
  </entry>
  <entry>
    <title>Charles和Postern如何配合使用抓包</title>
    <url>/2022/03/23/Charles%E5%92%8CPostern%E5%A6%82%E4%BD%95%E9%85%8D%E5%90%88%E4%BD%BF%E7%94%A8%E6%8A%93%E5%8C%85/</url>
    <content><![CDATA[<p>hello 大家好我是Monday，今天给大家带来一篇关于部分阿里系app的成功抓包方案第一篇Charles和Postern配合使用；</p>
<a id="more"></a>
<p><strong>前言：</strong></p>
<p>charles 安装配置参考我以前写的文章 <a href="https://mp.weixin.qq.com/s/Zv42Ji1W38qNpf78ogqZEA" target="_blank" rel="noopener">抓包工具charles安装配置</a></p>
<p>根据操作教程安装配置好以后：</p>
<p>1、我们打开charles软件</p>
<p><img src="/2022/03/23/Charles%E5%92%8CPostern%E5%A6%82%E4%BD%95%E9%85%8D%E5%90%88%E4%BD%BF%E7%94%A8%E6%8A%93%E5%8C%85/0.0.jpg" style="zoom: 50%;"></p>
<p>2、配置socket代理</p>
<p><img src="/2022/03/23/Charles%E5%92%8CPostern%E5%A6%82%E4%BD%95%E9%85%8D%E5%90%88%E4%BD%BF%E7%94%A8%E6%8A%93%E5%8C%85/0.jpg" style="zoom: 50%;"></p>
<h3 id="2、Postern"><a href="#2、Postern" class="headerlink" title="2、Postern"></a>2、Postern</h3><h4 id="Postern简介"><a href="#Postern简介" class="headerlink" title="Postern简介"></a>Postern简介</h4><p>Postern并不是抓包工具,他是一个代理工具</p>
<p>它可以将http请求转为<a href="https://so.csdn.net/so/search?q=socket&amp;spm=1001.2101.3001.7020" target="_blank" rel="noopener">socket</a>,并且包转发到Charles上,这样就可以抓到更多的包</p>
<p>如何下载安装，此处自动过滤</p>
<h5 id="（1）配置代理规则"><a href="#（1）配置代理规则" class="headerlink" title="（1）配置代理规则"></a>（1）配置代理规则</h5><p><img src="/2022/03/23/Charles%E5%92%8CPostern%E5%A6%82%E4%BD%95%E9%85%8D%E5%90%88%E4%BD%BF%E7%94%A8%E6%8A%93%E5%8C%85/1.jpg" style="zoom: 150%;"></p>
<h5 id="（2）添加代理服务器"><a href="#（2）添加代理服务器" class="headerlink" title="（2）添加代理服务器"></a>（2）添加代理服务器</h5><p><img src="/2022/03/23/Charles%E5%92%8CPostern%E5%A6%82%E4%BD%95%E9%85%8D%E5%90%88%E4%BD%BF%E7%94%A8%E6%8A%93%E5%8C%85/2.jpg" style="zoom: 150%;"></p>
<h5 id="（3）配置规则"><a href="#（3）配置规则" class="headerlink" title="（3）配置规则"></a>（3）配置规则</h5><p><img src="/2022/03/23/Charles%E5%92%8CPostern%E5%A6%82%E4%BD%95%E9%85%8D%E5%90%88%E4%BD%BF%E7%94%A8%E6%8A%93%E5%8C%85/3.jpg" style="zoom: 150%;"></p>
<h5 id="（4）添加规则"><a href="#（4）添加规则" class="headerlink" title="（4）添加规则"></a>（4）添加规则</h5><p><img src="/2022/03/23/Charles%E5%92%8CPostern%E5%A6%82%E4%BD%95%E9%85%8D%E5%90%88%E4%BD%BF%E7%94%A8%E6%8A%93%E5%8C%85/4.jpg" style="zoom: 150%;"></p>
<h5 id="（5）打开-关闭Postern"><a href="#（5）打开-关闭Postern" class="headerlink" title="（5）打开/关闭Postern"></a>（5）打开/关闭Postern</h5><p><img src="/2022/03/23/Charles%E5%92%8CPostern%E5%A6%82%E4%BD%95%E9%85%8D%E5%90%88%E4%BD%BF%E7%94%A8%E6%8A%93%E5%8C%85/5.jpg" style="zoom: 150%;"></p>
<p><strong>结果显示：</strong></p>
<p><img src="/2022/03/23/Charles%E5%92%8CPostern%E5%A6%82%E4%BD%95%E9%85%8D%E5%90%88%E4%BD%BF%E7%94%A8%E6%8A%93%E5%8C%85/6.jpg" style="zoom: 150%;"></p>
<p>抓包吧</p>
<p><strong>tips：</strong></p>
<p>​    搭配xposed框架+justMe插件或者+ justMeplush插件更柔顺丝滑</p>
<p><strong>参考文章：</strong></p>
<p><a href="https://blog.csdn.net/tianyi19/article/details/121254560" target="_blank" rel="noopener">(59条消息) Charles+Postern抓包_Tian翊的博客-CSDN博客_charles postern</a></p>
<p><strong>其他相关文章分享：</strong></p>
<p>1、<a href="https://mp.weixin.qq.com/s/2ClY1nV5nZJdBzKzWeclVw" target="_blank" rel="noopener">如何抓取国外网站、app的包</a></p>
<p><strong>结束语</strong>：</p>
<p>​    今天的分享就到这里了，欢迎大家关注微信公众号”<strong>菜鸟童靴</strong>“</p>
<p><img src="/2022/03/23/Charles%E5%92%8CPostern%E5%A6%82%E4%BD%95%E9%85%8D%E5%90%88%E4%BD%BF%E7%94%A8%E6%8A%93%E5%8C%85/微信.png" style="zoom: 150%;"></p>
]]></content>
      <categories>
        <category>抓包</category>
      </categories>
      <tags>
        <tag>抓包</tag>
      </tags>
  </entry>
  <entry>
    <title>FastApi开发学习之Depends依赖项介绍</title>
    <url>/2022/03/23/FastApi%E5%BC%80%E5%8F%91%E5%AD%A6%E4%B9%A0%E4%B9%8BDepends%E4%BE%9D%E8%B5%96%E9%A1%B9%E4%BB%8B%E7%BB%8D/</url>
    <content><![CDATA[<p>hello 大家好我是Monday，今天给大家带来一篇FastAPI开发Depends依赖项介绍。</p>
<a id="more"></a>
<p><strong>前言：</strong></p>
<p>如何去实现。用户在使用我们的接口时，我们想去校验下请求头中的token，请求的key。</p>
<p><strong>1、路径操作装饰器依赖项：</strong></p>
<p>如果有时，我们并不需要在路径操作函数中使用依赖项的返回值。不必在声明路径操作函数的参数时使用 Depends，而是可以在路径操作装饰器中添加一个由 dependencies 组成的 list。具体实现看代码</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> uvicorn</span><br><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI, Header, HTTPException, Depends</span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line">fake_items_db = [&#123;<span class="string">"city"</span>: <span class="string">"beijing"</span>&#125;, &#123;<span class="string">"city"</span>: <span class="string">"shanghai"</span>&#125;,</span><br><span class="line">                 &#123;<span class="string">"city"</span>: <span class="string">"heze"</span>&#125;]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">verify_token</span><span class="params">(token: str = Header<span class="params">(...)</span>)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> token != <span class="string">"zhidingtoken"</span>:</span><br><span class="line">        <span class="keyword">raise</span> HTTPException(status_code=<span class="number">400</span>, detail=<span class="string">"Token header invalid"</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">verify_key</span><span class="params">(key: str = Header<span class="params">(...)</span>)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> key != <span class="string">"key"</span>:</span><br><span class="line">        <span class="keyword">raise</span> HTTPException(status_code=<span class="number">400</span>, detail=<span class="string">"Key header invalid"</span>)</span><br><span class="line">    <span class="keyword">return</span> key</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get("/items/", dependencies=[Depends(verify_token), Depends(verify_key)])</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">read_items</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">return</span> fake_items_db</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    uvicorn.run(app=<span class="string">"demo1:app"</span>, host=<span class="string">"0.0.0.0"</span>, port=<span class="number">8000</span>)</span><br></pre></td></tr></table></figure>
<p><strong>测试用例：</strong></p>
<p><img src="/2022/03/23/FastApi%E5%BC%80%E5%8F%91%E5%AD%A6%E4%B9%A0%E4%B9%8BDepends%E4%BE%9D%E8%B5%96%E9%A1%B9%E4%BB%8B%E7%BB%8D/1.jpg" style="zoom: 100%;"></p>
<p>我们再尝试下不传token或key或传错值，暂时选择token传错值：</p>
<p><img src="/2022/03/23/FastApi%E5%BC%80%E5%8F%91%E5%AD%A6%E4%B9%A0%E4%B9%8BDepends%E4%BE%9D%E8%B5%96%E9%A1%B9%E4%BB%8B%E7%BB%8D/2.jpg" style="zoom: 100%;"></p>
<p>我们可以看到无论路径装饰器依赖项是否返回值，路径操作都不会使用这些值。但是这些值都必须携带。</p>
<p><strong>2、全局依赖项：</strong></p>
<p> 有时，我们要为整个应用添加依赖项，也就是说应用下的所有接口都要添加依赖项。</p>
<p>那么我们看下，如何去实现，比如我们全局都需要校验token 和key。我们去看下，我们应该如何实现代码。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> uvicorn</span><br><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI, Header, HTTPException, Depends</span><br><span class="line"></span><br><span class="line">fake_items_db = [&#123;<span class="string">"city"</span>: <span class="string">"beijing"</span>&#125;, &#123;<span class="string">"city"</span>: <span class="string">"shanghai"</span>&#125;,</span><br><span class="line">                 &#123;<span class="string">"city"</span>: <span class="string">"heze"</span>&#125;]</span><br><span class="line"></span><br><span class="line">fake_items_db2 = &#123;</span><br><span class="line">    <span class="string">"city1"</span>: <span class="string">"beijing"</span>,</span><br><span class="line">    <span class="string">"city2"</span>: <span class="string">"shanghai"</span>,</span><br><span class="line">    <span class="string">"city3"</span>: <span class="string">"heze"</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">verify_token</span><span class="params">(token: str = Header<span class="params">(...)</span>)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> token != <span class="string">"zhidingtoken"</span>:</span><br><span class="line">        <span class="keyword">raise</span> HTTPException(status_code=<span class="number">400</span>, detail=<span class="string">"Token header invalid"</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">verify_key</span><span class="params">(key: str = Header<span class="params">(...)</span>)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> key != <span class="string">"key"</span>:</span><br><span class="line">        <span class="keyword">raise</span> HTTPException(status_code=<span class="number">400</span>, detail=<span class="string">"Key header invalid"</span>)</span><br><span class="line">    <span class="keyword">return</span> key</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">app = FastAPI(dependencies=[Depends(verify_token), Depends(verify_key)])</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get("/items/")</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">read_items</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">return</span> fake_items_db</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get("/items/&#123;city&#125;")</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">read_items</span><span class="params">(city: str)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> fake_items_db2[city]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    uvicorn.run(app=<span class="string">"demo2:app"</span>, host=<span class="string">"0.0.0.0"</span>, port=<span class="number">8000</span>)</span><br></pre></td></tr></table></figure>
<p>我们依次测试访问这两个接口，看看是否都有依赖：</p>
<p>我们先都正常访问：</p>
<p><img src="/2022/03/23/FastApi%E5%BC%80%E5%8F%91%E5%AD%A6%E4%B9%A0%E4%B9%8BDepends%E4%BE%9D%E8%B5%96%E9%A1%B9%E4%BB%8B%E7%BB%8D/3.jpg" style="zoom: 100%;"></p>
<p><img src="/2022/03/23/FastApi%E5%BC%80%E5%8F%91%E5%AD%A6%E4%B9%A0%E4%B9%8BDepends%E4%BE%9D%E8%B5%96%E9%A1%B9%E4%BB%8B%E7%BB%8D/5.jpg" style="zoom: 100%;"></p>
<p>我们咋依次用错误的token和key分别访问这两个端口：</p>
<p><img src="/2022/03/23/FastApi%E5%BC%80%E5%8F%91%E5%AD%A6%E4%B9%A0%E4%B9%8BDepends%E4%BE%9D%E8%B5%96%E9%A1%B9%E4%BB%8B%E7%BB%8D/4.jpg" style="zoom: 100%;"></p>
<p><img src="/2022/03/23/FastApi%E5%BC%80%E5%8F%91%E5%AD%A6%E4%B9%A0%E4%B9%8BDepends%E4%BE%9D%E8%B5%96%E9%A1%B9%E4%BB%8B%E7%BB%8D/6.jpg" style="zoom: 100%;"></p>
<p>ok ，成功设置了全区依赖</p>
<p><strong>3、依赖项成功访问函数需要返回值：</strong></p>
<p>如果有时，我们需要在路径操作函数中使用依赖项的返回值，我们该如何操作：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> uvicorn</span><br><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI, Header, HTTPException, Depends</span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> Optional</span><br><span class="line"><span class="keyword">from</span> pydantic <span class="keyword">import</span> BaseModel</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserReturn</span><span class="params">(BaseModel)</span>:</span></span><br><span class="line">    id: Optional[int] = <span class="literal">None</span></span><br><span class="line">    username: Optional[str] = <span class="literal">None</span></span><br><span class="line">    full_name: Optional[str] = <span class="literal">None</span></span><br><span class="line">    disabled: Optional[bool] = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">verify_token</span><span class="params">(token: str = Header<span class="params">(...)</span>)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> token != <span class="string">"token"</span>:</span><br><span class="line">        <span class="keyword">raise</span> HTTPException(status_code=<span class="number">400</span>, detail=<span class="string">"Token header invalid"</span>)</span><br><span class="line">    <span class="keyword">return</span> UserReturn(**&#123;<span class="string">"id"</span>: <span class="number">1</span>, <span class="string">"username"</span>: <span class="string">"菜鸟童靴"</span>, <span class="string">"full_name"</span>: <span class="string">"Monday最帅"</span>&#125;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get("/items/", )</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">read_items</span><span class="params">(user_info: UserReturn = Depends<span class="params">(verify_token)</span>)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> user_info</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    uvicorn.run(app=<span class="string">"demo3:app"</span>, host=<span class="string">"0.0.0.0"</span>, port=<span class="number">8000</span>)</span><br></pre></td></tr></table></figure>
<p>我们传入正确的token测试下是否有返回值：</p>
<p><img src="/2022/03/23/FastApi%E5%BC%80%E5%8F%91%E5%AD%A6%E4%B9%A0%E4%B9%8BDepends%E4%BE%9D%E8%B5%96%E9%A1%B9%E4%BB%8B%E7%BB%8D/7.jpg" style="zoom: 100%;"></p>
<p>我们传入错误正确的token测试下是否有返回值：</p>
<p><img src="/2022/03/23/FastApi%E5%BC%80%E5%8F%91%E5%AD%A6%E4%B9%A0%E4%B9%8BDepends%E4%BE%9D%E8%B5%96%E9%A1%B9%E4%BB%8B%E7%BB%8D/8.jpg" style="zoom: 100%;"></p>
<p><strong>项目完整代码：</strong></p>
<p><a href="https://github.com/BoyYongXin/wx_pub_artcole_code" target="_blank" rel="noopener">BoyYongXin/wx_pub_article_code: 博客发文使用的代码 (github.com)</a></p>
<p><strong>结束语</strong>：</p>
<p>​    今天的分享就到这里了，欢迎大家关注微信公众号”<strong>菜鸟童靴</strong>“</p>
<p><img src="/2022/03/23/FastApi%E5%BC%80%E5%8F%91%E5%AD%A6%E4%B9%A0%E4%B9%8BDepends%E4%BE%9D%E8%B5%96%E9%A1%B9%E4%BB%8B%E7%BB%8D/微信.png" style="zoom: 100%;"></p>
]]></content>
      <categories>
        <category>后端</category>
      </categories>
      <tags>
        <tag>后端</tag>
        <tag>fastapi</tag>
      </tags>
  </entry>
  <entry>
    <title>FastApi开发三个常用知识分享</title>
    <url>/2022/03/22/FastApi%E5%BC%80%E5%8F%91%E4%B8%89%E4%B8%AA%E5%B8%B8%E7%94%A8%E7%9F%A5%E8%AF%86%E5%88%86%E4%BA%AB/</url>
    <content><![CDATA[<p>hello 大家好我是Monday，今天给大家带来一篇FastAPI开发的三个常用知识分享</p>
<a id="more"></a>
<p><strong>前言：</strong></p>
<p>本文所用原代码，以下所有知识点代码操作都在这个 基础上</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># !/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*-coding=utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI, Depends, HTTPException</span><br><span class="line"><span class="keyword">import</span> crud, schemas</span><br><span class="line"><span class="keyword">from</span> database <span class="keyword">import</span> SessionLocal, engine, Base</span><br><span class="line"><span class="keyword">from</span> sqlalchemy.orm <span class="keyword">import</span> Session</span><br><span class="line"><span class="keyword">import</span> uvicorn</span><br><span class="line"></span><br><span class="line">Base.metadata.create_all(bind=engine)  <span class="comment"># 数据库初始化，如果没有库或者表，会自动创建</span></span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Dependency</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_db</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    每一个请求处理完毕后会关闭当前连接，不同的请求使用不同的连接</span></span><br><span class="line"><span class="string">    :return:</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    db = SessionLocal()</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">yield</span> db</span><br><span class="line">    <span class="keyword">finally</span>:</span><br><span class="line">        db.close()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 新建用户</span></span><br><span class="line"><span class="meta">@app.post("/users/", response_model=schemas.User)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">create_user</span><span class="params">(user: schemas.UserCreate, db: Session = Depends<span class="params">(get_db)</span>)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> crud.db_create_user(db=db, user=user)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 通过id查询用户</span></span><br><span class="line"><span class="meta">@app.get("/user/&#123;user_id&#125;", response_model=schemas.User)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">read_user</span><span class="params">(user_id: int, db: Session = Depends<span class="params">(get_db)</span>)</span>:</span></span><br><span class="line">    db_user = crud.get_user(db, user_id=user_id)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> db_user:</span><br><span class="line">        <span class="keyword">raise</span> HTTPException(status_code=<span class="number">404</span>, detail=<span class="string">"User not found"</span>)</span><br><span class="line">    <span class="keyword">return</span> db_user</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    uvicorn.run(app=<span class="string">"main:app"</span>, host=<span class="string">"0.0.0.0"</span>, port=<span class="number">8000</span>)</span><br></pre></td></tr></table></figure>
<h2 id="1、知识点一（屏蔽不想开放的文档）"><a href="#1、知识点一（屏蔽不想开放的文档）" class="headerlink" title="1、知识点一（屏蔽不想开放的文档）"></a>1、知识点一（屏蔽不想开放的文档）</h2><p> 在实际的开发中呢，我们可能有些接口呢，不能对比进行开放，那么我们肯定想着如何在接口文档中进行屏蔽，那么我们看下应该如何实现呢。</p>
<p>只需要这个参数   就可以了  include_in_schema=False</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"># 通过id查询用户</span></span><br><span class="line"><span class="meta">@app.get("/user/&#123;user_id&#125;", response_model=schemas.User, include_in_schema=False)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">read_user</span><span class="params">(user_id: int, db: Session = Depends<span class="params">(get_db)</span>)</span>:</span></span><br><span class="line">    db_user = crud.get_user(db, user_id=user_id)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> db_user:</span><br><span class="line">        <span class="keyword">raise</span> HTTPException(status_code=<span class="number">404</span>, detail=<span class="string">"User not found"</span>)</span><br><span class="line">    <span class="keyword">return</span> db_user</span><br></pre></td></tr></table></figure>
<p>我们在（通过id查询用户的接口）上加之前效果</p>
<p><img src="/2022/03/22/FastApi%E5%BC%80%E5%8F%91%E4%B8%89%E4%B8%AA%E5%B8%B8%E7%94%A8%E7%9F%A5%E8%AF%86%E5%88%86%E4%BA%AB/1.jpg" style="zoom: 50%;"></p>
<p>加之后效果</p>
<p><img src="/2022/03/22/FastApi%E5%BC%80%E5%8F%91%E4%B8%89%E4%B8%AA%E5%B8%B8%E7%94%A8%E7%9F%A5%E8%AF%86%E5%88%86%E4%BA%AB/2.jpg" style="zoom: 50%;"></p>
<h2 id="2、知识点二（优雅的对外展示我们的接口文档）"><a href="#2、知识点二（优雅的对外展示我们的接口文档）" class="headerlink" title="2、知识点二（优雅的对外展示我们的接口文档）"></a>2、知识点二（优雅的对外展示我们的接口文档）</h2><p>拿新建用户的接口我们做示例：</p>
<p><strong>默认开放文档展示如下</strong></p>
<p><img src="/2022/03/22/FastApi%E5%BC%80%E5%8F%91%E4%B8%89%E4%B8%AA%E5%B8%B8%E7%94%A8%E7%9F%A5%E8%AF%86%E5%88%86%E4%BA%AB/3.jpg" style="zoom: 50%;"></p>
<p><strong>我们改变以下代码如下：</strong></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 新建用户</span></span><br><span class="line"><span class="meta">@app.post("/users/", response_model=schemas.User)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">create_user</span><span class="params">(user: schemas.UserCreate, db: Session = Depends<span class="params">(get_db)</span>)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    - **email**: 用户的邮箱</span></span><br><span class="line"><span class="string">    - **password**: 用户密码</span></span><br><span class="line"><span class="string">    - **user_name**: 用户名称</span></span><br><span class="line"><span class="string">    - **full_name**: 用户全称</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="keyword">return</span> crud.db_create_user(db=db, user=user)</span><br></pre></td></tr></table></figure>
<p>看下效果：</p>
<p><img src="/2022/03/22/FastApi%E5%BC%80%E5%8F%91%E4%B8%89%E4%B8%AA%E5%B8%B8%E7%94%A8%E7%9F%A5%E8%AF%86%E5%88%86%E4%BA%AB/4.jpg" style="zoom: 50%;"></p>
<p>我们可以看到，在接口文档中，我们去描述了我们的参数。文档内正常展示了，那么我们可以用这个，对接口的参数进行一些描述后，就可以展示在我们对外的接口文档中，方便去理解每个字段</p>
<h2 id="3、知识点三（startup-和-shutdown）"><a href="#3、知识点三（startup-和-shutdown）" class="headerlink" title="3、知识点三（startup 和 shutdown）"></a>3、知识点三（startup 和 shutdown）</h2><p> 我们在实际的开发中呢，总会遇到这样的场景（在 写爬虫的时候经常用到），我们想在启动或者终止的时候，做一些事情，fastapi提供了这样的操作，我们看下具体是怎么实现的呢</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line">@app.on_event(&quot;startup&quot;)</span><br><span class="line">def startup_event():</span><br><span class="line">    print(&quot;startup&quot;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">@app.on_event(&quot;shutdown&quot;)</span><br><span class="line">def shutdown_event():</span><br><span class="line">    print(&quot;shutdown&quot;)</span><br></pre></td></tr></table></figure>
<p>只需要加上如上代码，就可以了，一般应用场景</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">1.数据库的连接，断开连接，可以放在开始和结束前。</span><br><span class="line">2.初始化一些前置条件</span><br><span class="line">3.终止程序前需要处理一些后续，清理之类。</span><br></pre></td></tr></table></figure>
<p><strong>我的应用场景：</strong></p>
<p><strong>在写爬虫任务前</strong>，需要对任务状态进行初始化，比如 1做完，2正在做，0未做，在每次做任务前，都需要把状态为2 的任务重置为0</p>
<p><strong>当任务执行结束后</strong>，会发个钉钉消息或者邮件发送给我，</p>
<p><strong>项目完整代码：</strong></p>
<p><a href="https://github.com/BoyYongXin/wx_pub_artcole_code" target="_blank" rel="noopener">BoyYongXin/wx_pub_article_code: 博客发文使用的代码 (github.com)</a></p>
<p><strong>结束语</strong>：</p>
<p>​    今天的分享就到这里了，欢迎大家关注微信公众号”<strong>菜鸟童靴</strong>“</p>
<p><img src="/2022/03/22/FastApi%E5%BC%80%E5%8F%91%E4%B8%89%E4%B8%AA%E5%B8%B8%E7%94%A8%E7%9F%A5%E8%AF%86%E5%88%86%E4%BA%AB/微信.png" style="zoom: 50%;"></p>
]]></content>
      <categories>
        <category>后端</category>
      </categories>
      <tags>
        <tag>后端</tag>
        <tag>fastapi</tag>
      </tags>
  </entry>
  <entry>
    <title>基于web界面的locust对接口进行性能测试</title>
    <url>/2022/03/20/%E5%9F%BA%E4%BA%8Eweb%E7%95%8C%E9%9D%A2%E7%9A%84locust%E5%AF%B9%E6%8E%A5%E5%8F%A3%E8%BF%9B%E8%A1%8C%E6%80%A7%E8%83%BD%E6%B5%8B%E8%AF%95/</url>
    <content><![CDATA[<p>hello 大家好我是Monday，今天在上一篇文章<a href="https://boyyongxin.github.io/2022/03/19/fastapi数据库操作/#more" target="_blank" rel="noopener">fastapi 数据库操作之数据库操作 | 菜鸟童靴 (boyyongxin.github.io)</a>的基础上，给大家带来一篇利用locust对接口进行性能测试的文章。</p>
<a id="more"></a>
<p>首先介绍一下今天主角locust</p>
<h4 id="一、locust介绍"><a href="#一、locust介绍" class="headerlink" title="一、locust介绍"></a>一、locust介绍</h4><p>官方网站：<a href="https://pypi.org/project/locust/" target="_blank" rel="noopener">locust · PyPI</a></p>
<p><img src="/2022/03/20/%E5%9F%BA%E4%BA%8Eweb%E7%95%8C%E9%9D%A2%E7%9A%84locust%E5%AF%B9%E6%8E%A5%E5%8F%A3%E8%BF%9B%E8%A1%8C%E6%80%A7%E8%83%BD%E6%B5%8B%E8%AF%95/1.jpg" style="zoom: 50%;"></p>
<p>  Locust是一个容易使用、分布式的压力测试工具。它是用于网站压力测试(或其它系统)并找出多少用户一个系统可以承载。</p>
<p>在测试过程中，策略就是一个Locust的蠕虫将会攻击你的网站。每一个locust的行为(或你使用的测试用户)是你自己定义的，并且蠕虫进程从一个网页视图中被实时监测。这样会帮助你来实现测试，在真实用户使用前定义系统的瓶颈。</p>
<p>​    Locust是完全基于事件的，因此可以在单台机器中支持数以千计的用户在线。和其它基于事件的程序相比较，它是不需要使用回调的。相反，它通过<a href="https://link.juejin.im?target=http%3A%2F%2Fwww.gevent.org%2F">gevent</a>使用轻量级的进程。每一个locust测试你的网站时，实际上是真实的在内部运行它自己的进程(或greenlet,准确的说)。这样就允许你不使用复杂的回调方法，而是使用Python编写复杂的场景。</p>
<p>​    正如官网【<a href="https://docs.locust.io/en/latest/writing-a-locustfile.html】所说，[Locust](http://locust.io/)是一个" target="_blank" rel="noopener">https://docs.locust.io/en/latest/writing-a-locustfile.html】所说，[Locust](http://locust.io/)是一个</a> open source load testing tool，Define user behaviour with Python code，哈，一看是 Python 就对它有天然的好感。</p>
<p>​    Locust 的使用很简单也很方便，它提供了一个 python lib、一个<a href="https://cloud.tencent.com/product/cli?from=10680" target="_blank" rel="noopener">命令行工具</a>和一个 web UI，用户通过自己写 code 来定义测试用例，通过运行 locust cli 来执行测试，通过 web 界面查看测试结果。</p>
<p>对于程序员（特别是 Python 程序员）来讲，Locust另外一个优势就是，你不用去学不同工具为了定义测试用例而设计的不同的 DSL，直接写 code，通俗易懂。</p>
<p>以上介绍文字来源于官网和网络博客</p>
<h4 id="二、loucst的安装和使用"><a href="#二、loucst的安装和使用" class="headerlink" title="二、loucst的安装和使用"></a>二、loucst的安装和使用</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">pip install locustio</span><br></pre></td></tr></table></figure>
<h4 id="三、编写测试接口代码"><a href="#三、编写测试接口代码" class="headerlink" title="三、编写测试接口代码"></a>三、编写测试接口代码</h4><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> locust <span class="keyword">import</span> HttpUser, task, between</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PressureStart</span><span class="params">(HttpUser)</span>:</span></span><br><span class="line">    min_wait = <span class="number">100</span>  <span class="comment"># 最小等待时间(ms)，模拟用户在执行每个任务之间等待的最小时间</span></span><br><span class="line">    max_wait = <span class="number">500</span>  <span class="comment"># 最大等待时长(ms)，模拟用户在执行每个任务之间等待的最大时长</span></span><br><span class="line">    wait_time = between(min_wait, max_wait)</span><br><span class="line">    host = <span class="string">"http://localhost:8000"</span>  <span class="comment"># 访问的域名和端口</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># def on_start(self):</span></span><br><span class="line">    <span class="comment">#     # login_result = self.client.post("/login", json=&#123;"username": "Tom", "password": "123456"&#125;).text</span></span><br><span class="line">    <span class="comment">#     print(" working start ............")</span></span><br><span class="line">    <span class="comment">#</span></span><br><span class="line">    <span class="comment"># def on_stop(self):</span></span><br><span class="line">    <span class="comment">#     logout_result = self.client.post("/logout", json=&#123;"username": "Jim", "password": "456789"&#125;).text</span></span><br><span class="line">    <span class="comment">#     print(" working stop ............")</span></span><br><span class="line"></span><br><span class="line"><span class="meta">    @task(1)</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">region_get</span><span class="params">(self)</span>:</span></span><br><span class="line">        header = &#123;<span class="string">"Content-Type"</span>: <span class="string">"application/json"</span>&#125;</span><br><span class="line">        self.client.get(<span class="string">'/user/1'</span>, headers=header)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># @task(2)</span></span><br><span class="line">    <span class="comment"># def region_get2(self):</span></span><br><span class="line">    <span class="comment">#     header = &#123;"Content-Type": "application/json"&#125;</span></span><br><span class="line">    <span class="comment">#     self.client.get('/user/1', headers=header)</span></span><br></pre></td></tr></table></figure>
<p><strong>on_start：开始前执行；<br>on_stop：结束后执行。</strong></p>
<p>这两个方法可以帮助我们在进行性能测试时，把一些前置操作和后置处理进行规范化管理。</p>
<p>例如在on_start获取登录的token，在on_stop清理运行产生的冗余数据。</p>
<p><strong>具体用例：</strong></p>
<p><a href="https://blog.csdn.net/hzblucky1314/article/details/120085654" target="_blank" rel="noopener">(59条消息) locust2.0+教程：005 - on<em>start和on_stop</em>三爷带你飞的博客-CSDN博客</a></p>
<h4 id="四，命令行执行"><a href="#四，命令行执行" class="headerlink" title="四，命令行执行"></a>四，命令行执行</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">locust -f ceshi_server.py --host&#x3D;http:&#x2F;&#x2F;localhost:8000</span><br></pre></td></tr></table></figure>
<p><img src="/2022/03/20/%E5%9F%BA%E4%BA%8Eweb%E7%95%8C%E9%9D%A2%E7%9A%84locust%E5%AF%B9%E6%8E%A5%E5%8F%A3%E8%BF%9B%E8%A1%8C%E6%80%A7%E8%83%BD%E6%B5%8B%E8%AF%95/2.jpg" style="zoom: 50%;"></p>
<h4 id="五、开启web界面："><a href="#五、开启web界面：" class="headerlink" title="五、开启web界面："></a>五、开启web界面：</h4><p><img src="/2022/03/20/%E5%9F%BA%E4%BA%8Eweb%E7%95%8C%E9%9D%A2%E7%9A%84locust%E5%AF%B9%E6%8E%A5%E5%8F%A3%E8%BF%9B%E8%A1%8C%E6%80%A7%E8%83%BD%E6%B5%8B%E8%AF%95/3.jpg" style="zoom: 50%;"></p>
<p>locust的web界面</p>
<p>locust的web界面分析：</p>
<p>第一行Number of users to simulate是模拟用户的数量（虚拟用户数）</p>
<p>第二行Hatch rate (users spawned/second）表示产生模拟用户的速度</p>
<p>填写完成后点击“Start swarming”即可开始测试</p>
<p><img src="/2022/03/20/%E5%9F%BA%E4%BA%8Eweb%E7%95%8C%E9%9D%A2%E7%9A%84locust%E5%AF%B9%E6%8E%A5%E5%8F%A3%E8%BF%9B%E8%A1%8C%E6%80%A7%E8%83%BD%E6%B5%8B%E8%AF%95/5.jpg" style="zoom: 50%;"></p>
<p>懒惰的我直接，网页翻一下：</p>
<p><img src="/2022/03/20/%E5%9F%BA%E4%BA%8Eweb%E7%95%8C%E9%9D%A2%E7%9A%84locust%E5%AF%B9%E6%8E%A5%E5%8F%A3%E8%BF%9B%E8%A1%8C%E6%80%A7%E8%83%BD%E6%B5%8B%E8%AF%95/4.jpg" style="zoom: 50%;"></p>
<p><strong>性能测试参数</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Type： 请求的类型，例如GET&#x2F;POST。</span><br><span class="line"></span><br><span class="line">Name：请求的路径</span><br><span class="line"></span><br><span class="line">request：当前请求的数量。</span><br><span class="line"></span><br><span class="line">fails：当前请求失败的数量。</span><br><span class="line"></span><br><span class="line">Median：中间值，单位毫秒，一半的服务器响应时间低于该值，而另一半高于该值。</span><br><span class="line"></span><br><span class="line">Average：平均值，单位毫秒，所有请求的平均响应时间。</span><br><span class="line"></span><br><span class="line">Min：请求的最小服务器响应时间，单位毫秒。</span><br><span class="line"></span><br><span class="line">Max：请求的最大服务器响应时间，单位毫秒。</span><br><span class="line"></span><br><span class="line">Content Size：单个请求的大小，单位字节。</span><br><span class="line"></span><br><span class="line">reqs&#x2F;sec：是每秒钟请求的个数。</span><br><span class="line"></span><br><span class="line">在这个过程中，可以随时停止测试，调整参数</span><br></pre></td></tr></table></figure>
<p>其他功能导航栏显而易见</p>
<p><img src="/2022/03/20/%E5%9F%BA%E4%BA%8Eweb%E7%95%8C%E9%9D%A2%E7%9A%84locust%E5%AF%B9%E6%8E%A5%E5%8F%A3%E8%BF%9B%E8%A1%8C%E6%80%A7%E8%83%BD%E6%B5%8B%E8%AF%95/6.jpg" style="zoom: 50%;"></p>
<h4 id="六，命令行执行（取消web显示界面）"><a href="#六，命令行执行（取消web显示界面）" class="headerlink" title="六，命令行执行（取消web显示界面）"></a>六，命令行执行（取消web显示界面）</h4><p>命令行执行</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">locust -f ceshi_server.py --host&#x3D;http:&#x2F;&#x2F;localhost:8000 --no-web -c 20 -r 20 -t 100s --csv&#x3D;example --loglevel&#x3D;INFO --logfile&#x3D;test.log</span><br></pre></td></tr></table></figure>
<p>启动参数：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">--csv：保存运行结果</span><br><span class="line">--loglevel：日志等级</span><br><span class="line">--logfile：日志文件</span><br><span class="line">--host：域名</span><br><span class="line">–no-web 表示不使用Web界面运行测试。</span><br><span class="line">-c 设置虚拟用户并发数。</span><br><span class="line">-r 设置每秒启动虚拟用户数执行的次数。</span><br><span class="line">-t 设置设置运行时间。</span><br></pre></td></tr></table></figure>
<p>Locust也可以做分布式执行，需要装一个pyzmq（未做测试，记录下来留作以后备用）。</p>
<p>性能测试首先而在于分析性能测试的需求，设计性能测试场景，尽可能的模拟真实环境中的压力（正常和异常情况）。然后结果是考察并发用户数、响应时间、tps这类指标。</p>
<p><strong>项目完整代码：</strong></p>
<p><a href="https://github.com/BoyYongXin/wx_pub_artcole_code" target="_blank" rel="noopener">BoyYongXin/wx_pub_article_code: 博客发文使用的代码 (github.com)</a></p>
<p><strong>参考文献：</strong></p>
<p><a href="https://cloud.tencent.com/developer/article/1516546?from=article.detail.1594240" target="_blank" rel="noopener">基于web界面的locust性能测试 - 云+社区 - 腾讯云 (tencent.com)</a></p>
<p><a href="https://mp.weixin.qq.com/s/_FbeXmGDsBpEpSXUNZrRQA" target="_blank" rel="noopener">如何利用Python对服务器的接口进行压力测试 (qq.com)</a></p>
<p><strong>结束语</strong>：</p>
<p>​    今天的分享就到这里了，欢迎大家关注微信公众号”<strong>菜鸟童靴</strong>“</p>
<p><img src="/2022/03/20/%E5%9F%BA%E4%BA%8Eweb%E7%95%8C%E9%9D%A2%E7%9A%84locust%E5%AF%B9%E6%8E%A5%E5%8F%A3%E8%BF%9B%E8%A1%8C%E6%80%A7%E8%83%BD%E6%B5%8B%E8%AF%95/微信.png" style="zoom: 50%;"></p>
]]></content>
      <categories>
        <category>测试</category>
      </categories>
      <tags>
        <tag>测试</tag>
        <tag>locust</tag>
      </tags>
  </entry>
  <entry>
    <title>fastapi数据库操作之数据库操作</title>
    <url>/2022/03/19/fastapi%E6%95%B0%E6%8D%AE%E5%BA%93%E6%93%8D%E4%BD%9C/</url>
    <content><![CDATA[<p>hello 大家好我是Monday，今天给大家带来一篇FastAPI中通过SQLAlchemy操作mysql数据库的文章</p>
<a id="more"></a>
<h2 id="一、前言"><a href="#一、前言" class="headerlink" title="一、前言"></a>一、前言</h2><p>FastAPI中你可以使用任何关系型数据库，可以通过SQLAlchemy将其轻松的适应于任何的数据库，比如：</p>
<ul>
<li>PostgreSQL</li>
<li>MySQL</li>
<li>SQLite</li>
<li>Oracle</li>
</ul>
<p>　　SQLAlchemy是一个ORM（object-relational mapping）的框架。在ORM中，你创建一个类就会通过SQLAlchemy将其自动转成一张表，在类中的每一个属性就会将其转成表中的字段。</p>
<h2 id="二、项目结构"><a href="#二、项目结构" class="headerlink" title="二、项目结构"></a>二、项目结构</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">.</span><br><span class="line">└── xxxxx_app</span><br><span class="line">    ├── __init__.py</span><br><span class="line">    ├── crud.py</span><br><span class="line">    ├── database.py</span><br><span class="line">    ├── main.py</span><br><span class="line">    ├── models.py</span><br><span class="line">    └── schemas.py</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>init</strong>.py 是一个空文件，但是说明xxxx_app是一个package</li>
<li>database.py 数据库配置相关</li>
<li>models.py 数据库模型表</li>
<li>schemas.py 模型验证</li>
<li>crud.py 数据库操作相关</li>
<li>main.py 主文件</li>
</ul>
<h2 id="三、简单实例"><a href="#三、简单实例" class="headerlink" title="三、简单实例"></a>三、简单实例</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">pip install sqlalchemy</span><br><span class="line">pip install pymysql</span><br></pre></td></tr></table></figure>
<h4 id="1、database-py"><a href="#1、database-py" class="headerlink" title="1、database.py"></a>1、database.py</h4><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> sqlalchemy <span class="keyword">import</span> create_engine</span><br><span class="line"><span class="keyword">from</span> sqlalchemy.ext.declarative <span class="keyword">import</span> declarative_base</span><br><span class="line"><span class="keyword">from</span> sqlalchemy.orm <span class="keyword">import</span> sessionmaker</span><br><span class="line"></span><br><span class="line">SQLALCHEMY_DATABASE_URL = <span class="string">"mysql+pymysql://root:123456@127.0.0.1:3306/test"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># echo=True表示引擎将用repr()函数记录所有语句及其参数列表到日志</span></span><br><span class="line">engine = create_engine(</span><br><span class="line">    SQLALCHEMY_DATABASE_URL, encoding=<span class="string">'utf8'</span>, echo=<span class="literal">True</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment"># SQLAlchemy中，CRUD是通过会话进行管理的，所以需要先创建会话，</span></span><br><span class="line"><span class="comment"># 每一个SessionLocal实例就是一个数据库session</span></span><br><span class="line"><span class="comment"># flush指发送到数据库语句到数据库，但数据库不一定执行写入磁盘</span></span><br><span class="line"><span class="comment"># commit是指提交事务，将变更保存到数据库文件中</span></span><br><span class="line">SessionLocal = sessionmaker(autocommit=<span class="literal">False</span>, autoflush=<span class="literal">False</span>, bind=engine)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建基本映射类</span></span><br><span class="line">Base = declarative_base()</span><br></pre></td></tr></table></figure>
<p>在数据库相关的配置文件中，首先创建一个SQLAlchemy的”engine”，然后创建SessionLocal实例进行会话，最后创建模型类的基类。</p>
<h4 id="2、models-py"><a href="#2、models-py" class="headerlink" title="2、models.py"></a>2、models.py</h4><p>我们开始创建用户表，字段大致如下，后面做用户token认证时也会用到这张表</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;username&quot;: &quot;johndoe&quot;,</span><br><span class="line">    &quot;full_name&quot;: &quot;John Doe&quot;,</span><br><span class="line">    &quot;email&quot;: &quot;johndoe@example.com&quot;,</span><br><span class="line">    &quot;hashed_password&quot;: &quot;$2b$12$EixZaYVK1fsbw1ZfbX3OXePaWxn96p36WQoeG6Lruj3vjPGga31lW&quot;,</span><br><span class="line">    &quot;disabled&quot;: False</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> sqlalchemy <span class="keyword">import</span> Boolean, Column, Integer, String, DateTime</span><br><span class="line"><span class="keyword">from</span> database <span class="keyword">import</span> Base</span><br><span class="line"><span class="keyword">import</span> datetime</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span><span class="params">(Base)</span>:</span></span><br><span class="line">    __tablename__ = <span class="string">"users"</span></span><br><span class="line">    id = Column(Integer, primary_key=<span class="literal">True</span>, index=<span class="literal">True</span>, comment=<span class="string">'自增id'</span>)</span><br><span class="line">    user_name = Column(String(<span class="number">32</span>), unique=<span class="literal">True</span>, index=<span class="literal">True</span>, comment=<span class="string">'用户名'</span>)</span><br><span class="line">    full_name = Column(String(<span class="number">32</span>), unique=<span class="literal">False</span>, index=<span class="literal">False</span>, default=<span class="literal">None</span>, comment=<span class="string">'全称'</span>)</span><br><span class="line">    email = Column(String(<span class="number">32</span>), unique=<span class="literal">True</span>, index=<span class="literal">True</span>, comment=<span class="string">'邮箱地址'</span>)</span><br><span class="line">    hashed_password = Column(String(<span class="number">64</span>), comment=<span class="string">'加密密码'</span>)</span><br><span class="line">    disabled = Column(Boolean, default=<span class="literal">True</span>, comment=<span class="string">'用户状态'</span>)</span><br><span class="line">    createtime = Column(DateTime, default=datetime.datetime.now, comment=<span class="string">'创建时间'</span>)</span><br><span class="line">    updatetime = Column(DateTime, default=datetime.datetime.now, comment=<span class="string">'修改时间'</span>)</span><br></pre></td></tr></table></figure>
<p>通过数据库配置文件中的基类来创建模型类。</p>
<h4 id="3、schemas-py"><a href="#3、schemas-py" class="headerlink" title="3、schemas.py"></a>3、schemas.py</h4><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># !/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*-coding=utf-8 -*-</span></span><br><span class="line"><span class="comment"># @Author: Mr.Yang</span></span><br><span class="line"><span class="comment"># @Date: </span></span><br><span class="line"><span class="comment"># @email: </span></span><br><span class="line"><span class="comment"># @Pagefunction</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pydantic <span class="keyword">import</span> BaseModel</span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> Optional</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserBase</span><span class="params">(BaseModel)</span>:</span></span><br><span class="line">    email: str</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserCreate</span><span class="params">(UserBase)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    请求模型验证：</span></span><br><span class="line"><span class="string">    email:</span></span><br><span class="line"><span class="string">    password:</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    password: str</span><br><span class="line">    user_name: str</span><br><span class="line">    full_name: Optional[str] = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span><span class="params">(UserBase)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    响应模型：</span></span><br><span class="line"><span class="string">    id:</span></span><br><span class="line"><span class="string">    email:</span></span><br><span class="line"><span class="string">    is_active</span></span><br><span class="line"><span class="string">    并且设置orm_mode与之兼容</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    id: int</span><br><span class="line">    disabled: bool</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Config</span>:</span></span><br><span class="line">        orm_mode = <span class="literal">True</span></span><br></pre></td></tr></table></figure>
<p>定义请求参数模型验证与响应模型验证的Pydantic模型，其中响应模型中设置orm_mode=True参数，表示与ORM模型兼容，因为后续中返回的数据库查询是orm模型，通过设置这个参数可以将orm模型通过pydantic模型进行验证。</p>
<h4 id="4、crud-py"><a href="#4、crud-py" class="headerlink" title="4、crud.py"></a>4、crud.py</h4><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">from</span> sqlalchemy.orm <span class="keyword">import</span> Session</span><br><span class="line"><span class="keyword">import</span> models, schemas</span><br><span class="line"><span class="keyword">from</span> passlib.context <span class="keyword">import</span> CryptContext  <span class="comment"># passlib 处理哈希加密的包</span></span><br><span class="line"></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">为了数据安全，我们利用PassLib对入库的用户密码进行加密处理，推荐的加密算法是"Bcrypt"</span></span><br><span class="line"><span class="string">其中，我们主要使用下面方法：</span></span><br><span class="line"><span class="string">pwd_context.hash(password) # 对密码进行加密</span></span><br><span class="line"><span class="string">pwd_context.verify(plain_password, hashed_password) 对密码进行校验</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="comment"># Context是上下文,CryptContext是密码上下文</span></span><br><span class="line">pwd_context = CryptContext(schemes=[<span class="string">"bcrypt"</span>], deprecated=<span class="string">"auto"</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 通过id查询用户</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_user</span><span class="params">(db: Session, user_id: int)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> db.query(models.User).filter(models.User.id == user_id).first()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 新建用户</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">db_create_user</span><span class="params">(db: Session, user: schemas.UserCreate)</span>:</span></span><br><span class="line">    fake_hashed_password = pwd_context.hash(user.password)</span><br><span class="line">    db_user = models.User(email=user.email, hashed_password=fake_hashed_password,</span><br><span class="line">                          user_name=user.user_name, full_name=user.full_name)</span><br><span class="line">    db.add(db_user)</span><br><span class="line">    db.commit()  <span class="comment"># 提交保存到数据库中</span></span><br><span class="line">    db.refresh(db_user)  <span class="comment"># 刷新</span></span><br><span class="line">    <span class="keyword">return</span> db_user</span><br></pre></td></tr></table></figure>
<p>通过传入数据库连接以及参数等进行数据库操作，包括创建用户、查询用户等，返回的是orm模型对象。</p>
<h4 id="5、main-py"><a href="#5、main-py" class="headerlink" title="5、main.py"></a>5、main.py</h4><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> sys</span><br><span class="line">sys.path.append(<span class="string">"../"</span>)</span><br><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI, Depends, HTTPException</span><br><span class="line"><span class="keyword">import</span> crud, schemas</span><br><span class="line"><span class="keyword">from</span> database <span class="keyword">import</span> SessionLocal, engine, Base</span><br><span class="line"><span class="keyword">from</span> sqlalchemy.orm <span class="keyword">import</span> Session</span><br><span class="line"><span class="keyword">import</span> uvicorn</span><br><span class="line"></span><br><span class="line">Base.metadata.create_all(bind=engine) <span class="comment">#数据库初始化，如果没有库或者表，会自动创建</span></span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Dependency</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_db</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    每一个请求处理完毕后会关闭当前连接，不同的请求使用不同的连接</span></span><br><span class="line"><span class="string">    :return:</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    db = SessionLocal()</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">yield</span> db</span><br><span class="line">    <span class="keyword">finally</span>:</span><br><span class="line">        db.close()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 新建用户</span></span><br><span class="line"><span class="meta">@app.post("/users/", response_model=schemas.User)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">create_user</span><span class="params">(user: schemas.UserCreate, db: Session = Depends<span class="params">(get_db)</span>)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> crud.db_create_user(db=db, user=user)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 通过id查询用户</span></span><br><span class="line"><span class="meta">@app.get("/user/&#123;user_id&#125;", response_model=schemas.User)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">read_user</span><span class="params">(user_id: int, db: Session = Depends<span class="params">(get_db)</span>)</span>:</span></span><br><span class="line">    db_user = crud.get_user(db, user_id=user_id)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> db_user:</span><br><span class="line">        <span class="keyword">raise</span> HTTPException(status_code=<span class="number">404</span>, detail=<span class="string">"User not found"</span>)</span><br><span class="line">    <span class="keyword">return</span> db_user</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    uvicorn.run(app=<span class="string">"main:app"</span>, host=<span class="string">"0.0.0.0"</span>, port=<span class="number">8000</span>)</span><br></pre></td></tr></table></figure>
<h4 id="5、测试验证"><a href="#5、测试验证" class="headerlink" title="5、测试验证"></a>5、测试验证</h4><p>现在我们查看下文档<a href="http://localhost:8000/docs#/" target="_blank" rel="noopener">FastAPI - Swagger UI</a>操作一下</p>
<p><img src="/2022/03/19/fastapi%E6%95%B0%E6%8D%AE%E5%BA%93%E6%93%8D%E4%BD%9C/1.jpg" style="zoom: 50%;"></p>
<p><strong>使用postman测试下</strong></p>
<p><img src="/2022/03/19/fastapi%E6%95%B0%E6%8D%AE%E5%BA%93%E6%93%8D%E4%BD%9C/3.jpg" style="zoom: 50%;"></p>
<p><strong>python代码</strong></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line">headers = &#123;</span><br><span class="line">    <span class="string">"accept"</span>: <span class="string">"application/json"</span>,</span><br><span class="line">    <span class="string">"Content-Type"</span>: <span class="string">"application/json"</span></span><br><span class="line">&#125;</span><br><span class="line">url = <span class="string">"http://localhost:8000/users/"</span></span><br><span class="line">data = &#123;</span><br><span class="line">    <span class="string">"user_name"</span>: <span class="string">"monday"</span>,</span><br><span class="line">    <span class="string">"email"</span>: <span class="string">"14268333@qq.com"</span>,</span><br><span class="line">    <span class="string">"password"</span>: <span class="string">"123456"</span>,</span><br><span class="line">    <span class="string">"full_name"</span>: <span class="string">"菜鸟童靴"</span></span><br><span class="line">&#125;</span><br><span class="line">response = requests.post(url, headers=headers, json=data)</span><br><span class="line">print(response.text)</span><br><span class="line">print(response)</span><br></pre></td></tr></table></figure>
<p><strong>结果显示：</strong></p>
<p><img src="/2022/03/19/fastapi%E6%95%B0%E6%8D%AE%E5%BA%93%E6%93%8D%E4%BD%9C/2.jpg" style="zoom: 50%;"></p>
<p><strong>查询用户：</strong></p>
<p><img src="/2022/03/19/fastapi%E6%95%B0%E6%8D%AE%E5%BA%93%E6%93%8D%E4%BD%9C/4.jpg" style="zoom: 50%;"></p>
<p><strong>项目完整代码：</strong></p>
<p><a href="https://github.com/BoyYongXin/wx_pub_artcole_code" target="_blank" rel="noopener">BoyYongXin/wx_pub_article_code: 博客发文使用的代码 (github.com)</a></p>
<p><strong>结束语</strong>：</p>
<p>​    今天的分享就到这里了，欢迎大家关注微信公众号”<strong>菜鸟童靴</strong>“</p>
<p><img src="/2022/03/19/fastapi%E6%95%B0%E6%8D%AE%E5%BA%93%E6%93%8D%E4%BD%9C/微信.png" style="zoom: 50%;"></p>
]]></content>
      <categories>
        <category>后端</category>
      </categories>
      <tags>
        <tag>后端</tag>
        <tag>fastapi</tag>
      </tags>
  </entry>
  <entry>
    <title>解决某阿里系app抓包问题并开发持久化hook抓包插件</title>
    <url>/2022/03/15/%E8%A7%A3%E5%86%B3%E6%9F%90%E9%98%BF%E9%87%8C%E7%B3%BBapp%E6%8A%93%E5%8C%85%E9%97%AE%E9%A2%98%E5%B9%B6%E5%BC%80%E5%8F%91%E6%8C%81%E4%B9%85%E5%8C%96hook%E6%8A%93%E5%8C%85%E6%8F%92%E4%BB%B6/</url>
    <content><![CDATA[]]></content>
  </entry>
  <entry>
    <title>NDK开发之JNI技术</title>
    <url>/2022/03/15/NDK%E5%BC%80%E5%8F%91%E4%B9%8BJNI%E6%8A%80%E6%9C%AF/</url>
    <content><![CDATA[<p>本篇文章，JNI技术</p>
<a id="more"></a>
<p><strong>01</strong>、 <strong>NDK和JNI的关系</strong></p>
<p>在前面安卓NDK开发之Hello JNI中，我们讲解了安卓上的ndk开发的一般流程，初步了解了jni技术。那么ndk和jni到底是什么关系呢？事实上jni和ndk没什么关系，但ndk和jni有关系，准确的说是ndk开发需要用到jni技术。就像水和鱼没关系，但是鱼和水有关系，鱼需要在水中生存。</p>
<ul>
<li>JNI（Java Native Interface）技术是java本身提供的技术，是用来在java层和c/c++层进行通信的接口，和安卓没啥关系。</li>
<li>NDK（Native Development Kit）是谷歌为了更好的支持安卓开发者进行jni开发而提供的一套开发工具包，通过Android.mk和Application.mk文件来管理编译c/c++代码，然后将其so打包到apk中。</li>
</ul>
<p>也就是说ndk开发部分的核心是jni技术，ndk编译c/c++代码的核心部分是mk/cmake脚本的编写。所以我们先了解下ndk开发的用到的jni技术。</p>
<p><strong>02、JNI技术</strong></p>
<p>java的jni开发官方文档地址：<a href="https://docs.oracle.com/javase/8/docs/technotes/guides/jni/spec/jniTOC.html。推荐大家先大概浏览下。" target="_blank" rel="noopener">https://docs.oracle.com/javase/8/docs/technotes/guides/jni/spec/jniTOC.html。推荐大家先大概浏览下。</a></p>
<p>在正式讲解本节内容之前，我们来看一下上一节中利用javah命令自动生成的.h文件中的函数与我们在java层定义的函数之间的关系：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">//java层代码</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">native</span> String <span class="title">getString</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//C/C++层代码</span></span><br><span class="line">jstring JNICALL Java_com_htq_baidu_ndk_NDKTest_getString</span><br><span class="line">    (JNIEnv * env, jobject object)&#123;</span><br><span class="line">   <span class="keyword">return</span> env-&gt;NewStringUTF(<span class="string">"hello.this is from native code"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这两个参数的作用是什么呢？jobject很容易理解就是java层对应的C++层引用类型，即表示java中的Object类型，当我们在java代码中调用某个native函数时，该类即为该native函数对应到.cpp代码函数的jobject参数。这一点和java代码中类编译为class文件时，函数参数中会自动多一个this指针用来表示调用该函数的类的对象一样，这个很容易理解，因此重点来看下JNIEnv*是个什么东东。</p>
<p><strong>JNIEnv*</strong></p>
<p>我们来看下java的jni.h中是如何定义JNIEnv*的，jni.h位于jdk安装目录的include目录下。</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">if</span> defined(__cplusplus)</span></span><br><span class="line"><span class="keyword">typedef</span> _JNIEnv JNIEnv;</span><br><span class="line"><span class="keyword">typedef</span> _JavaVM JavaVM;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">JNINativeInterface</span>* <span class="title">JNIEnv</span>;</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">JNIInvokeInterface</span>* <span class="title">JavaVM</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></figure>
<p>从上面可以看到JNIEnv表示的是JNINativeInterface这个结构体的指针，从上面也可以看到JNIEnv在C和C++下的定义是不同的，这个仅仅影响到我们调用函数的方式而已，对逻辑无影响，主要来说就是在c++中调用JNI提供的API接口函数时不需要JNIEnv参数，而c中通常将该参数作为函数第一个参数，如下所示：</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="comment">//C++调用方式</span></span><br><span class="line">jclass jclazz = env-&gt;FindClass(<span class="string">"com/htq/baidu/ndk/NDKTest"</span>);</span><br><span class="line"><span class="comment">//C调用方式</span></span><br><span class="line">jclass jclazz = (*env)-&gt;FindClass(env, <span class="string">"com/htq/baidu/ndk/NDKTest"</span>);</span><br></pre></td></tr></table></figure>
<p>这两种方式仅仅是调用方式不同而已，对逻辑无影响，这里以C为例进行分析，那么我们来看下JNINativeInterface是如何定义的：</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Table of interface function pointers.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">JNINativeInterface</span> &#123;</span></span><br><span class="line">    <span class="keyword">void</span>*       reserved0;</span><br><span class="line">    <span class="keyword">void</span>*       reserved1;</span><br><span class="line">    <span class="keyword">void</span>*       reserved2;</span><br><span class="line">    <span class="keyword">void</span>*       reserved3;</span><br><span class="line"></span><br><span class="line">    jint        (*GetVersion)(JNIEnv *);</span><br><span class="line"></span><br><span class="line">    jclass      (*DefineClass)(JNIEnv*, <span class="keyword">const</span> <span class="keyword">char</span>*, jobject, <span class="keyword">const</span> jbyte*,</span><br><span class="line">    jsize);</span><br><span class="line">    jclass      (*FindClass)(JNIEnv*, <span class="keyword">const</span> <span class="keyword">char</span>*);</span><br><span class="line"></span><br><span class="line">    jmethodID   (*FromReflectedMethod)(JNIEnv*, jobject);</span><br><span class="line">    jfieldID    (*FromReflectedField)(JNIEnv*, jobject);</span><br><span class="line"><span class="comment">/* spec doesn't show jboolean parameter */</span></span><br><span class="line">    jobject     (*ToReflectedMethod)(JNIEnv*, jclass, jmethodID, jboolean);</span><br><span class="line"></span><br><span class="line">    jclass      (*GetSuperclass)(JNIEnv*, jclass);</span><br><span class="line">    jboolean    (*IsAssignableFrom)(JNIEnv*, jclass, jclass);</span><br><span class="line"></span><br><span class="line"><span class="comment">/* spec doesn't show jboolean parameter */</span></span><br><span class="line">    jobject     (*ToReflectedField)(JNIEnv*, jclass, jfieldID, jboolean);</span><br><span class="line">  </span><br><span class="line">    ......</span><br><span class="line">    </span><br><span class="line">    &#125;;</span><br></pre></td></tr></table></figure>
<p>从注释可以看到JNINativeInterface表示的是接口函数指针表（Table of interface function pointers），也就是说该结构体定义了一系列的接口函数指针，注意是接口函数-&gt;指针，说白了就是该结构体中申明了一系列的功能函数，如FindClass函数，只不过这些函数不是普通形式的函数申明，而是通过函数指针的形式申明的，如：</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="comment">//定义了一个名为FindClass的指针，该指针指向格式为 jclass fun(JNIEnv*, const char*)的函数</span></span><br><span class="line">jclass   (*FindClass)(JNIEnv*, <span class="keyword">const</span> <span class="keyword">char</span>*);</span><br></pre></td></tr></table></figure>
<p>而这些函数指针最终指向的是JVM虚拟机中对应的JNI函数的地址，这样当我们在C/C++代码中通过JNIEnv调用函数的时候才能够被JVM虚拟机正确执行。用图示表示如下：</p>
<p><img src="/2022/03/15/NDK%E5%BC%80%E5%8F%91%E4%B9%8BJNI%E6%8A%80%E6%9C%AF/1.jpg" style="zoom: 100%;"></p>
<p>所以<strong>JNIEnv可以理解为一个存放大量API接口指针的表，调用某个API时会通过该表的指针找到该函数。</strong>注意JNIEnv是和线程相关的，也就是说不能在多个线程中共享使用一个JNIEnv。</p>
<p><strong>03、JNI中核心数据类型</strong></p>
<p>前面提到过javah为我们自动生成的c/c++方法中包含一个jobject类型参数。这个jobject类型就是jni开发中的一种数据结构。就像c/c++中包含基本数据类型int等一样。下面讲解下JNI中的核心数据类型以及java中数据类型在JNI中对应的数据类型的映射关系。</p>
<p><strong>jclass, jobject,jmethodID, jfieldID</strong></p>
<p>JNI中native层与java层通信本质就是在C/C++代码中利用JNI接口去调用本身属于java层的方法。也就是在so层调用java层方法。那么既然是C调java代码，那么最终该方法的执行肯定还是JVM通过加载java字节码来完成java层这些方法的执行。所以如果我们要调用某个java函数，首先得知道该函数属于哪个类，以便得到该类的字节码对象，然后需要知道该函数完整签名，以便得到该方法的方法id，从而能够调用该方法。这就涉及到JNI中的一些重要的数据类型了</p>
<ul>
<li>jclass：JNI中表示类字节码对象的数据结构。对应于java层的类的字节码对象Class</li>
<li>jobject：JNI中表示类字节码对象的实例数据结构。对应于java层的类的字节码对象的实例Object</li>
<li>jmethodID：JNI中表示某方法的id，该id用来唯一确定该类中的某个方法</li>
<li>jfieldID：JNI中表示某域的id，该id用唯一确定该类中的某个域</li>
</ul>
<p>jclass和jobject可以先理解为类似java中对象和实例的区别。即静态方法可直接被对象调用，非静态方法需要被该对象的一个实例调用。这在JNI中也是适用的，后面会讲到JNI中静态方法的调用第一个参数是jclass。而非静态方法的调用第一个参数是jobject。</p>
<p><strong>JNI 数据类型与 Java 数据类型的映射关系</strong></p>
<p>最前面的例子中说到如果java层的方法是无参数的，javah在生成该方法JNI对应的函数时会增加JNIEnv*和jobject/jclass这2个参数。那如果方法本身含有参数呢？那么生成的方法除了上面2个参数之外还会包括java层这些方法本身的参数对应的JNI参数类型。这些参数类型及其对应关系如下：</p>
<p><strong>基本数据类型</strong></p>
<p><img src="/2022/03/15/NDK%E5%BC%80%E5%8F%91%E4%B9%8BJNI%E6%8A%80%E6%9C%AF/2.png" style="zoom: 100%;"></p>
<p><strong>引用数据类型</strong></p>
<p><img src="/2022/03/15/NDK%E5%BC%80%E5%8F%91%E4%B9%8BJNI%E6%8A%80%E6%9C%AF/3.png" style="zoom: 100%;"></p>
<p><strong>可以看到JNI中的基本数据类型和引用类型是在java中对应基本数据类型/引用类型的前面加上j，</strong></p>
<p><strong>如java中int类型对应jint，java中的String对应jstring。</strong></p>
<p><strong>数组类型加上j前缀和Array后缀，如int[]对应jintArray。</strong></p>
<p><strong>注意特殊类型void在JNI中仍然以void类型表示。</strong></p>
<p><strong>04、JNI中数据类型的类型描述符</strong></p>
<p>通过前面介绍大家可能发现了在JNI中对象数据类型只提供了jclass,jobject和jstring这3个数据结构，但是java中的对象数据类型虽然只有Object，但是对应的类实在是太多了，比如java.lang这个包下就有很多类。如何用有限的数据类型表示所有的类呢？这就涉及到JNI中的类型描述符了。</p>
<p><strong>类型描述符可以概括为类描述符，基本类型/数组类型/引用类型描述符2大类。</strong></p>
<p><strong>类描述符</strong></p>
<p>所谓类描述符即在JNI中得到该类的字节码对象时需要传递的描述符。即调用FindClass接口的时候的描述符。类描述符是将java中类的完整名路径（包名+类名）中原来的 . 分隔符换成 / 分隔符后得到的。</p>
<p>例如：java中的java.lang.String类的类描述符就是java/lang/String</p>
<p>这样如果我们要得到某个类的jni层的class对象，则只需要把该类在java层的类对应的类描述符作为参数传递给FindClass接口即可。这样根据不同类描述符来得到不同的jcass对象就能表示所有的java层的类了。</p>
<p>比如：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">jclass jclazz &#x3D; env-&gt;FindClass(“com&#x2F;htq&#x2F;baidu&#x2F;ndk&#x2F;NDKTest”);</span><br><span class="line">jstring jstr&#x3D;(jstring) env-&gt;FindClass(“java&#x2F;lang&#x2F;String”);</span><br></pre></td></tr></table></figure>
<p><strong>基本类型/数组类型/引用类型描述符</strong></p>
<p>基本类型/数组类型/引用类型描述符是用来得到某个域/函数ID的时候作为参数传递的描述符。其中基本类型在JNI层描述符对应关系如下：</p>
<p><img src="/2022/03/15/NDK%E5%BC%80%E5%8F%91%E4%B9%8BJNI%E6%8A%80%E6%9C%AF/4.png" style="zoom: 100%;"></p>
<p><strong>除了long用J表示boolean用Z表示外，其余基本类型对应的JNI层类型描述符都是java层表示的首字母大写</strong>。例如int用I表示，double用D表示，void用V表示。</p>
<p><strong>引用类型用大写的 L + 该类型类描述符 + ;（注意结尾包含一个英文分号;）</strong>，例如：</p>
<blockquote>
<p>String类型用Ljava/lang/String;表示</p>
</blockquote>
<p><strong>数组类型用[加上该数组基本元素类型</strong>，例如</p>
<blockquote>
<p>int[]用[I表示<br>int[][]用[[I表示<br>Stirng[]用[Ljava/lang/String;表示</p>
</blockquote>
<p>注意同为描述类，作为FindClass参数时传递的是类描述符，而作为GetMethodID系类接口参数传递的是引用类型描述符，这2者的区别是后者需要包含前面大写的L和结尾的英文分号;</p>
<p><strong>05 、JNI开发常用API接口</strong></p>
<p>弄清楚了最核心的JNIEnv<em>的概念以及JNI中的数据类型及其描述，接下来就看看如何使用JNIEnv提供的API接口。前面提到过，<em>*首先需要得到该类的字节码对象，然后实例化该对象，接着得到某个方法的方法ID，最终通过该类对象/实例调用该方法（静态方法通过类对象直接调用，非静态方法通过类实例调用）</em></em>。在JNI中是通过JNIEnv对象的FindClass函数来获取字节码对象的。通过GetMethodID/GetStaticMethodID函数来获取某个方法ID。</p>
<p><strong>通过FindClass得到类对象jclass</strong></p>
<p>函数定义如下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">jclass (*FindClass)(JNIEnv*, const char*);</span><br></pre></td></tr></table></figure>
<p>该函数的参数及返回值意义如下：</p>
<ul>
<li>JNIEnv*，该参数为JNIEnv类型的指针，</li>
<li>const char*，字符串常量，类描述符，即将类完整路径的包名分隔符.替换为/之后的结果，具体见前面类描述符相关部分</li>
<li>返回值jclass表示的是java字节码对象。</li>
</ul>
<p><strong>通过GetMethodID/GetStaticMethodID来得到函数ID</strong></p>
<p>获得了类的字节码对象之后就可以通过函数名来调用函数了，而java层函数包括静态函数和非静态函数2部分。对应到JNI层分别对应GetStaticMethodID和GetMethodID。这2个函数定义分别如下所示如下：</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line">jmethodID (JNICALL *GetStaticMethodID)(JNIEnv *env, jclass clazz, <span class="keyword">const</span> <span class="keyword">char</span> *name, <span class="keyword">const</span> <span class="keyword">char</span> *sig);</span><br><span class="line">jmethodID (NICALL *GetMethodID)(JNIEnv *env, jclass clazz, <span class="keyword">const</span> <span class="keyword">char</span> *name, <span class="keyword">const</span> <span class="keyword">char</span> *sig);</span><br></pre></td></tr></table></figure>
<p>可以看到这2个函数的参数和返回值完全一样。其参数及返回值意义如下：</p>
<ul>
<li>JNIEnv*：JNIEnv对象指针</li>
<li>jclass ：java字节码对象，用来表示该方法是在哪个类中定义的。即通过FindClass接口得到的返回值对象</li>
<li>name：函数名字符串，该字符串内容为该函数在java层定义时的函数名</li>
<li>sig：函数签名字符串，也就是函数对应的各个参数及返回值类型的描述符</li>
<li>返回值jmethodID：函数的ID，可以理解为函数的指针</li>
</ul>
<p>其中最后一个参数是函数签名，我们怎么知道函数的签名呢？JNI中函数签名按照如下格式表示：</p>
<blockquote>
<p>（函数每个参数描述符）函数返回值描述符</p>
</blockquote>
<p>例如：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">String test(int i,String str) 对应的函数签名描述符为(ILjava&#x2F;lang&#x2F;String;)Ljava&#x2F;lang&#x2F;String;</span><br><span class="line">void test(int []i,String str) 对应的函数签名描述符为([ILjava&#x2F;lang&#x2F;String;)V</span><br></pre></td></tr></table></figure>
<p>所以只要理解了前面讲解的JNI中数据类型的类型描述符，那么很容易知道函数签名描述符。</p>
<p>另外还可以使用javap命令，命令格式如下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">javap -s 类名（包含包名的全路径类名）</span><br></pre></td></tr></table></figure>
<p>同样的该命令也需要在字节码所在的目录执行，例如在自己的工程的app\build\intermediates\classes\debug目录下执行上述命令，另外当我们执行javah命令自动生成JNI头文件时函数的签名信息在.h文件会以注释的信息告知。</p>
<p><strong>注意虽然GetStaticMethodID和GetMethodID函数的参数以及返回值完全一样，但是决不能乱用，即如果该方法java层是static的就调用GetStaticMethodID，反之调用GetMethodID，需要严格遵守此规定，不然运行时会出现异常。</strong>而前面提到的FindClass使用类描述符可以不严格遵守，也可以使用引用类型描述符。即FindClass(“java/lang/String”)和FindClass(“Ljava/lang/String;”)均可。</p>
<p><strong>通过CallXXXMethod/CallStaticXXXMethod调用函数</strong></p>
<p>得到了MethodID之后就可以调用该函数了，在JNIEnv中定义了一系列的调用对应返回值的函数，都是形如CallXXXMethod/CallStaticXXXMethod的形式，如：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">&#x2F;&#x2F;调用静态方法</span><br><span class="line">jobject (JNICALL *CallStaticObjectMethod)(JNIEnv *env, jclass clazz, jmethodID methodID, ...);</span><br><span class="line">jint (JNICALL *CallStaticIntMethod)(JNIEnv *env, jclass clazz, jmethodID methodID, ...);</span><br><span class="line">void (JNICALL *CallStaticVoidMethod)(JNIEnv *env, jclass cls, jmethodID methodID, ...);</span><br><span class="line">jchar (JNICALL *CallStaticCharMethod)(JNIEnv *env, jclass clazz, jmethodID methodID, ...);</span><br><span class="line">&#x2F;&#x2F;调用非静态方法</span><br><span class="line">jint (JNICALL *CallIntMethod)(JNIEnv *env, jobject obj, jmethodID methodID, ...);</span><br><span class="line">void (JNICALL *CallVoidMethod)(JNIEnv *env, jobject obj, jmethodID methodID, ...);</span><br><span class="line">jchar (JNICALL *CallCharMethod)(JNIEnv *env, jobject obj, jmethodID methodID, ...);</span><br></pre></td></tr></table></figure>
<p>这类函数的第一个参数为JNIEnv对象，第二个参数为jclass（调用静态函数）或jobject（调用非静态函数），第三个参数为函数ID（即调用GetMethodID/GetStaticMethodID接口返回的对象），最后的可变参数就是调用该函数时需要传递的参数。</p>
<p>当我们调用的函数签名返回值属于void则调用CallVoidMethod，返回值为int则调用CallIntMethod，依此类推，如若java层代码为：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">public native void printString();</span><br></pre></td></tr></table></figure>
<p>则对应的C++层调用java代码为：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">&#x2F;&#x2F;首先得到类的字节码对象</span><br><span class="line">jclass jclazz &#x3D; env-&gt;FindClass(&quot;com&#x2F;htq&#x2F;baidu&#x2F;ndk&#x2F;NDKTest&quot;);</span><br><span class="line">&#x2F;&#x2F;得到函数ID</span><br><span class="line">jmethodID methodID &#x3D; env-&gt;GetMethodID(jclazz, &quot;prinString&quot;, &quot;()V&quot;);&#x2F;&#x2F;非静态函数使用GetMethodID</span><br><span class="line">&#x2F;&#x2F;调用函数，第一个参数为JNIEnv对象，第二个参数为类对象，第三个参数为函数ID，最后参数为需要传给原函数的参数，因为为void，所以不需要传参数。C++中调用时无需JNIEnv参数 </span><br><span class="line">env-&gt;CallVoidMethod(object,methodID);</span><br></pre></td></tr></table></figure>
<p>可以看到首先获取字节码对象，然后获取函数ID，最后调用函数，这一点和java中的反射调用某个函数的过程非常类似。</p>
<p><strong>06、native调用java代码实例</strong></p>
<p>那么我们就在前面一节代码的基础上进行改进，此时的主界面包含三个按钮，分别对应c调java中的void函数，c调java中的返回值为int的函数，c调java中函数参数为字符串的函数。此时的MainActivity代码如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> <span class="keyword">extends</span> <span class="title">AppCompatActivity</span> <span class="keyword">implements</span> <span class="title">View</span>.<span class="title">OnClickListener</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> TextView tv;</span><br><span class="line">    <span class="keyword">private</span> Button btnVoid,btnInt,btnString;</span><br><span class="line">    <span class="keyword">private</span> NDKTest ndkTest;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_main);</span><br><span class="line">        ndkTest=<span class="keyword">new</span> NDKTest();</span><br><span class="line"></span><br><span class="line">        tv= (TextView) findViewById(R.id.text);</span><br><span class="line">        btnVoid= (Button) findViewById(R.id.btn_void);</span><br><span class="line">        btnVoid.setOnClickListener(<span class="keyword">this</span>);</span><br><span class="line">        btnInt= (Button) findViewById(R.id.btn_int);</span><br><span class="line">        btnInt.setOnClickListener(<span class="keyword">this</span>);</span><br><span class="line">        btnString= (Button) findViewById(R.id.btn_string);</span><br><span class="line">        btnString.setOnClickListener(<span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View v)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">switch</span> (v.getId()) &#123;</span><br><span class="line">            <span class="keyword">case</span> R.id.btn_void:</span><br><span class="line">                ndkTest.callBackMethod();</span><br><span class="line">                tv.setText(ndkTest.text);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> R.id.btn_int:</span><br><span class="line">                <span class="keyword">int</span> sum=ndkTest.callBackIntMethod(<span class="number">1</span>, <span class="number">2</span>);</span><br><span class="line">                tv.setText(<span class="string">"1加2的和为："</span>+String.valueOf(sum));</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> R.id.btn_string:</span><br><span class="line">                ndkTest.callBackStringArgMethod();</span><br><span class="line">                tv.setText(ndkTest.text);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>代码很简单，大家应该都能够看得懂，就是三个Button用来响应调用三个不同签名格式的native函数。其中的NDKTest类就是用来定义native函数的类，代码如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NDKTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">public</span> String text;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> <span class="keyword">static</span> &#123;</span><br><span class="line"> 	System.loadLibrary(<span class="string">"ndk"</span>);</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> <span class="comment">//java调C函数声明</span></span><br><span class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title">callBackMethod</span><span class="params">()</span></span>;</span><br><span class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">native</span> <span class="keyword">int</span> <span class="title">callBackIntMethod</span><span class="params">(<span class="keyword">int</span> x,<span class="keyword">int</span> y)</span></span>;</span><br><span class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title">callBackStringArgMethod</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> <span class="comment">//c层回调java函数，</span></span><br><span class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">prinString</span><span class="params">()</span></span>&#123;</span><br><span class="line">     String str=<span class="string">"this string is from java code but it called by native code"</span>;</span><br><span class="line">     <span class="keyword">this</span>.text=str;</span><br><span class="line"></span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">addTwoNum</span><span class="params">(<span class="keyword">int</span> x,<span class="keyword">int</span> y)</span></span>&#123;</span><br><span class="line"> 	<span class="keyword">return</span> x+y;</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setString</span><span class="params">(String str)</span></span>&#123;</span><br><span class="line"> 	<span class="keyword">this</span>.text=str;</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>最核心的当然是.cpp代码，在cpp代码中反过来调用java层的代码，调用的原理即是前面讲解的JNI技术，代码如下：</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;jni.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"com_htq_baidu_ndk_NDKTest.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="function">JNIEXPORT <span class="keyword">void</span> JNICALL <span class="title">Java_com_htq_baidu_ndk_NDKTest_callBackMethod</span><span class="params">(JNIEnv * env,jobject object)</span></span>&#123;</span><br><span class="line"></span><br><span class="line"> <span class="comment">//首先得到类的字节码对象</span></span><br><span class="line"> jclass jclazz = env-&gt;FindClass(<span class="string">"com/htq/baidu/ndk/NDKTest"</span>);</span><br><span class="line"> <span class="comment">//得到函数ID</span></span><br><span class="line"> jmethodID methodID = env-&gt;GetMethodID(jclazz, <span class="string">"prinString"</span>, <span class="string">"()V"</span>);</span><br><span class="line"></span><br><span class="line"> <span class="comment">//调用函数，第一个参数为JNIEnv对象，第二个参数为类对象，第三个参数为函数ID，C++中调用时无需JNIEnv参数</span></span><br><span class="line"> env-&gt;CallVoidMethod(object,methodID);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function">JNIEXPORT jint JNICALL <span class="title">Java_com_htq_baidu_ndk_NDKTest_callBackIntMethod</span><span class="params">(JNIEnv *env, jobject object, jint x, jint y)</span></span>&#123;</span><br><span class="line"> <span class="comment">//首先得到类的字节码对象</span></span><br><span class="line"> jclass jclazz = env-&gt;FindClass(<span class="string">"com/htq/baidu/ndk/NDKTest"</span>);</span><br><span class="line"> <span class="comment">//得到函数ID</span></span><br><span class="line"> jmethodID methodID = env-&gt;GetMethodID( jclazz, <span class="string">"addTwoNum"</span>, <span class="string">"(II)I"</span>);</span><br><span class="line"> <span class="comment">//调用函数，第一个参数为JNIEnv对象，第二个参数为类对象，第三个参数为函数ID,C++中调用时无需JNIEnv参数</span></span><br><span class="line"> <span class="keyword">int</span> sum=env-&gt;CallIntMethod(object,methodID,x,y);</span><br><span class="line"> <span class="keyword">return</span> sum;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function">JNIEXPORT <span class="keyword">void</span> JNICALL <span class="title">Java_com_htq_baidu_ndk_NDKTest_callBackStringArgMethod</span><span class="params">(JNIEnv *env, jobject object)</span></span>&#123;</span><br><span class="line"> <span class="comment">//首先得到类的字节码对象</span></span><br><span class="line"> jclass jclazz = env-&gt;FindClass(<span class="string">"com/htq/baidu/ndk/NDKTest"</span>);</span><br><span class="line"> <span class="comment">//得到函数ID</span></span><br><span class="line"> jmethodID methodID = env-&gt;GetMethodID( jclazz, <span class="string">"setString"</span>, <span class="string">"(Ljava/lang/String;)V"</span>);</span><br><span class="line"> <span class="comment">//将cpp文件中的字符串转化为java层的字符串jstring</span></span><br><span class="line"> jstring str=env-&gt;NewStringUTF(<span class="string">"this string is from c call java"</span>);</span><br><span class="line"> <span class="comment">//调用函数，第一个参数为JNIEnv对象，第二个参数为类对象，第三个参数为函数ID，C++中调用时无需JNIEnv参数</span></span><br><span class="line"> env-&gt;CallVoidMethod(object,methodID,str);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>代码注释很详细，大家应该能够看懂。然后运行程序，依次点击void，int，参数为String三种情况对应的按钮，程序输出结果如下：</p>
<p><img src="/2022/03/15/NDK%E5%BC%80%E5%8F%91%E4%B9%8BJNI%E6%8A%80%E6%9C%AF/5.jpg" style="zoom: 100%;"></p>
<p>当点击void按钮时首先在MainActivity的java代码中调用了native函数callBackMethod()，然后在该函数中我们通过JNI中的一系列API接口反过来调用了java层的prinString函数，在该函数中将字符串”this string is from java code but it called by native code”赋值给NDKTest类的text成员变量，最终在MainActivity中通过TextView的setText函数将text显示在控件上。这样就完成了Java层和C++层相互调用的过程。</p>
<p>文章转载于：</p>
<p>​    公众号 [<strong>爱祺科技</strong>]：<a href="https://mp.weixin.qq.com/s/vdPQomwnobRfSuxw0mmWlw" target="_blank" rel="noopener">https://mp.weixin.qq.com/s/vdPQomwnobRfSuxw0mmWlw</a></p>
<p><strong>结束语</strong>：</p>
<p>​    今天的分享就到这里了，欢迎大家关注微信公众号 [<strong>菜鸟童靴</strong>]</p>
]]></content>
      <categories>
        <category>爬虫</category>
      </categories>
      <tags>
        <tag>JNI</tag>
        <tag>逆向知识</tag>
      </tags>
  </entry>
  <entry>
    <title>hexo发生error：spawn failed错误的解决方法</title>
    <url>/2022/03/13/failed%E9%94%99%E8%AF%AF%E7%9A%84%E8%A7%A3%E5%86%B3%E6%96%B9%E6%B3%95/</url>
    <content><![CDATA[<p>小编使用hexo 写博客时，经历了很多次发文失败的问题，在上面浪费了很多时间，踩了很多的坑，很是苦恼，今天小编整理了下</p>
<p>发文不成功遇到的问题和解决办法，分享给大家，希望能让有问题的小伙伴，少走些弯路。</p>
<a id="more"></a>
<p><strong>1.检查本机是否有ssh key设置</strong></p>
<p>如果过没有的话，解决办法将本的id_rsa.pub秘钥复制到github上新建秘钥</p>
<p>（不要迷之自信，小编有一次去github仓库看了一下，发现的ssh key没了，入坑了好半天），</p>
<p>$ cd ~/.ssh 或cd .ssh</p>
<p><img src="/2022/03/13/failed%E9%94%99%E8%AF%AF%E7%9A%84%E8%A7%A3%E5%86%B3%E6%96%B9%E6%B3%95/1.png" style="zoom: 100%;"></p>
<p>如果重新设了一个也连接不上，继续向下看。</p>
<p><strong>2、创建config文件，换443端口</strong></p>
<p>在存放key的目录下新建config文件。</p>
<p>填入以下内容</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Host github.com</span><br><span class="line">User 你GitHub的邮箱</span><br><span class="line">Hostname ssh.github.com</span><br><span class="line">PreferredAuthentications publickey</span><br><span class="line">IdentityFile ~&#x2F;.ssh&#x2F;id_rsa</span><br><span class="line">Port 443</span><br></pre></td></tr></table></figure>
<p>然后用 ssh -T git@github.com命令测试能否连接</p>
<p>如果重新也连接不上，继续向下看。</p>
<p><strong>3、更改hexo文件下的_config.yml配置文件</strong></p>
<p>修改以下内容</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">deploy:</span><br><span class="line">type: git</span><br><span class="line">repo: https:&#x2F;&#x2F;github.com&#x2F;yourname&#x2F;yourname.github.io.git</span><br><span class="line">branch: master</span><br><span class="line">其中的repo修改为</span><br><span class="line">git@github.com:yourname&#x2F;yourname.github.io.git</span><br></pre></td></tr></table></figure>
<p>如果也连接不上，继续向下看（这时候我们就该回头看看本机电脑能否访问github）。</p>
<p>看看是不是网络原因，ping  github.com 查看是否能ping通，果真了访问不了github</p>
<p>到了这里我可以使用科学上网的方式来解决，或者看我之前发的文章，</p>
<p><a href="https://mp.weixin.qq.com/s?__biz=MzI5ODYzMTkxMQ==&amp;mid=2247484031&amp;idx=1&amp;sn=2ef515cc09ebf069c5c769ebf0cc49da&amp;chksm=eca395f7dbd41ce14abd7666120fc65cc98b72858969e0057dadcc28d3c26e759039c3df4638&amp;token=2073142941&amp;lang=zh_CN#rd" target="_blank" rel="noopener">github访问慢，一直不成功，难道非得科学上网吗 (qq.com)</a></p>
<p><a href="https://boyyongxin.github.io/2022/03/06/github访问慢，一直不成功，难道非得科学上网吗/" target="_blank" rel="noopener">github 访问慢，一直不成功，难道非得科学上网吗 | 菜鸟童靴 (boyyongxin.github.io)</a></p>
<p>网页可以访问成功后，我们发现还是无法解决问题，先别急，那就继续向下看吧</p>
<p><strong>4、配置 代理</strong><br>windows 中 git 默认不会使用系统代理，所以即使连接代理或者打开代理软件，浏览器仍然可以访问 GitHub 或 Gitee；但是使用 git 命令行连接 GitHub 或 Gitee 远程仓库可能会出现无法访问的现象。通过为 git 配置代理解决出现的问题。</p>
<p>Windows、Linux、Mac OS 中 git 命令相同：</p>
<p>设置代理命令：</p>
<p><strong>（2）配置socks5代理</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">git config --global http.proxy socks5 192.138.43.112:31181</span><br><span class="line">git config --global https.proxy socks5 192.138.43.112:31181</span><br></pre></td></tr></table></figure>
<p><strong>（3）配置http代理</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">git config --global http.proxy 192.138.43.112:31181</span><br><span class="line">git config --global https.proxy 192.138.43.112:31181</span><br></pre></td></tr></table></figure>
<p><strong>注意事项：</strong></p>
<p>命令中的主机号（192.138.43.112）是使用的代理的主机号，如果代理软件运行在本机则填入127.0.0.1即可，否则填入代理主机 ip<br>命令中的端口号为代理软件或代理主机的监听IP，可以从代理服务器配置中获得<br>socks5和http两种协议由使用的代理软件决定，不同软件对这两种协议的支持有差异，如果不确定可以都尝试一下<br>查看代理命令：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">git config --global --get http.proxy</span><br><span class="line">git config --global --get https.proxy</span><br></pre></td></tr></table></figure>
<p>取消代理命令:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">git config --global --unset http.proxy</span><br><span class="line">git config --global --unset https.proxy</span><br></pre></td></tr></table></figure>
<p>最终发文成功</p>
<p><img src="/2022/03/13/failed%E9%94%99%E8%AF%AF%E7%9A%84%E8%A7%A3%E5%86%B3%E6%96%B9%E6%B3%95/2.jpg" style="zoom: 100%;"></p>
<p>是小编踩过的所有的坑了。</p>
<p><strong>结束语</strong>：</p>
<p>​    今天的分享就到这里了，欢迎大家关注微信公众号”<strong>菜鸟童靴</strong>“</p>
]]></content>
      <categories>
        <category>爬虫</category>
      </categories>
      <tags>
        <tag>hexo</tag>
        <tag>博客</tag>
      </tags>
  </entry>
  <entry>
    <title>内网穿透原来这么容易就能搭建起来</title>
    <url>/2022/03/11/%E5%86%85%E7%BD%91%E7%A9%BF%E9%80%8F%E5%8E%9F%E6%9D%A5%E8%BF%99%E4%B9%88%E5%AE%B9%E6%98%93%E5%B0%B1%E8%83%BD%E6%90%AD%E5%BB%BA%E8%B5%B7%E6%9D%A5/</url>
    <content><![CDATA[<p><strong>前言：</strong></p>
<p>​    在局域网搭建了个服务，外网想访问怎么办呢，别担心今天小编带来个开源免费的工具？</p>
<a id="more"></a>
<h2 id="1、什么是内网穿透"><a href="#1、什么是内网穿透" class="headerlink" title="1、什么是内网穿透?"></a><strong>1、什么是内网穿透?</strong></h2><p><strong>首先解释一下“内网”与“外网”的概念：</strong></p>
<p><strong>内网</strong>：即所说的局域网，比如学校的局域网，局域网内每台计算机的IP地址在本局域网内具有互异性，是不可重复的。但两个局域网内的内网IP可以有相同的。</p>
<p><strong>外网</strong>：即互联网，局域网通过一台服务器或是一个路由器对外连接的网络，这个IP地址是唯一的。也就是说内网里所有的计算机都是连接到这一个外网IP上，通过这一个外网IP对外进行交换数据的。也就是说，一个局域网里所有电脑的内网IP是互不相同的,但共用一个外网IP。（用ipconfig/all查到的IP是你本机的内网IP；在<a href="https://link.zhihu.com/?target=http%3A//www.ip138.com">http://www.ip138.com</a>上看到的是你连接互联网所使用的IP，即外网）。</p>
<p>​    </p>
<h2 id="2、钉钉提供的内网穿透工具"><a href="#2、钉钉提供的内网穿透工具" class="headerlink" title="2、钉钉提供的内网穿透工具"></a>2、钉钉提供的内网穿透工具</h2><p><strong>（1）github网址：</strong></p>
<h3 id="https-github-com-open-dingtalk-pierced"><a href="#https-github-com-open-dingtalk-pierced" class="headerlink" title="https://github.com/open-dingtalk/pierced"></a><a href="https://github.com/open-dingtalk/pierced" target="_blank" rel="noopener">https://github.com/open-dingtalk/pierced</a></h3><p><strong>（2）介绍</strong></p>
<p>本仓库及以下说明来自钉钉官方开发文档。</p>
<blockquote>
<p>注意：鉴于很多开发者在临时体验开发时往往没有公网域名或者公网IP，本工具提供了一个公网代理服务，目的是方便开发测试。</p>
<p>本工具当前不保证多个开发者随意设置相同的子域名导致的冲突以及通道稳定性，因此正式应用、正式环境必须是真实的公网IP或者域名，正式应用上线绝对不能使用本工具。</p>
</blockquote>
<h3 id="内网穿透示意图"><a href="#内网穿透示意图" class="headerlink" title="内网穿透示意图"></a>内网穿透示意图</h3><p><img src="/2022/03/11/%E5%86%85%E7%BD%91%E7%A9%BF%E9%80%8F%E5%8E%9F%E6%9D%A5%E8%BF%99%E4%B9%88%E5%AE%B9%E6%98%93%E5%B0%B1%E8%83%BD%E6%90%AD%E5%BB%BA%E8%B5%B7%E6%9D%A5/tunnel.png" style="zoom: 150%;"></p>
<h2 id="使用方法"><a href="#使用方法" class="headerlink" title="使用方法"></a>使用方法</h2><h3 id="HTTP-穿透"><a href="#HTTP-穿透" class="headerlink" title="HTTP 穿透"></a>HTTP 穿透</h3><ol>
<li><p>下载工具</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">git clone https:&#x2F;&#x2F;github.com&#x2F;open-dingtalk&#x2F;pierced.git</span><br></pre></td></tr></table></figure>
</li>
<li><p>执行命令 <code>./ding -config=./ding.cfg -subdomain=域名前缀 端口</code>。</p>
<p>以 Mac 为例：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">cd mac_64</span><br><span class="line">chmod 777 .&#x2F;ding</span><br><span class="line">.&#x2F;ding -config&#x3D;.&#x2F;ding.cfg -subdomain&#x3D;abcde 8080</span><br></pre></td></tr></table></figure>
<p>Windows：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">cd windows_64</span><br><span class="line">.&#x2F;ding -config ding.cfg -subdomain abcde 8080</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h2 id="3、下面小编以windows为例做个测试："><a href="#3、下面小编以windows为例做个测试：" class="headerlink" title="3、下面小编以windows为例做个测试："></a>3、<strong>下面小编以windows为例做个测试：</strong></h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">注意 -subdomain 后面的参数，最好复杂一些，避免有人已经使用，导致操作不成功</span><br></pre></td></tr></table></figure>
<p>（1）搭建服务端server</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">Created on 2021-12-13 16:29:25</span></span><br><span class="line"><span class="string">---------</span></span><br><span class="line"><span class="string">@summary:</span></span><br><span class="line"><span class="string">---------</span></span><br><span class="line"><span class="string">@author: yangyx01</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="keyword">import</span> uvicorn</span><br><span class="line"><span class="keyword">from</span> starlette.responses <span class="keyword">import</span> JSONResponse  <span class="comment"># 此类型不可少</span></span><br><span class="line"><span class="keyword">from</span> loguru <span class="keyword">import</span> logger</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> Response, Request</span><br><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> APIRouter</span><br><span class="line"><span class="keyword">from</span> fastapi.middleware.cors <span class="keyword">import</span> CORSMiddleware</span><br><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI, Header</span><br><span class="line"><span class="keyword">import</span> redis</span><br><span class="line">REDIS_HOST = <span class="string">'127.0.0.1'</span></span><br><span class="line">REDIS_PORT = <span class="number">6379</span></span><br><span class="line">REDIS_DB = <span class="number">1</span></span><br><span class="line">redis_client = redis.ConnectionPool(host=REDIS_HOST, port=REDIS_PORT, db=REDIS_DB, max_connections=<span class="number">1</span>,</span><br><span class="line">                                    decode_responses=<span class="literal">True</span>)</span><br><span class="line">redis_db = redis.StrictRedis(connection_pool=redis_client)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">startup</span><span class="params">()</span>:</span></span><br><span class="line">    logger.warning(<span class="string">"服务已启动！"</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">shutdown</span><span class="params">()</span>:</span></span><br><span class="line">    logger.warning(<span class="string">"服务已关闭！"</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">app = FastAPI(on_startup=[startup], on_shutdown=[shutdown])</span><br><span class="line"></span><br><span class="line">ALLOWED_HOSTS = [<span class="string">"*"</span>]</span><br><span class="line"></span><br><span class="line">app.add_middleware(</span><br><span class="line">    CORSMiddleware,</span><br><span class="line">    allow_origins=ALLOWED_HOSTS,</span><br><span class="line">    allow_credentials=<span class="literal">True</span>,</span><br><span class="line">    allow_methods=[<span class="string">"*"</span>],</span><br><span class="line">    allow_headers=[<span class="string">"*"</span>],</span><br><span class="line">)</span><br><span class="line">app.debug = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">bp = APIRouter(tags=[<span class="string">'内网穿透测试'</span>], prefix=<span class="string">'/api/v1'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.middleware("http")</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">add_process_time_header</span><span class="params">(request: Request, call_next)</span>:</span></span><br><span class="line">    start_time = time.time()</span><br><span class="line">    response = <span class="keyword">await</span> call_next(request)</span><br><span class="line">    process_time = time.time() - start_time</span><br><span class="line">    response.headers[<span class="string">"X-Process-Time"</span>] = str(process_time)</span><br><span class="line">    <span class="keyword">return</span> response</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@bp.put("/callback_client", summary='callback主动调用接口', description='callback主动调用接口', tags=['callback_client'])</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">callback_client</span><span class="params">(action: str, request: Request, response: Response)</span>:</span></span><br><span class="line">    _body = <span class="keyword">await</span> request.body()</span><br><span class="line">    _header = request.headers</span><br><span class="line">    data_info = json.loads(_body)</span><br><span class="line">    <span class="keyword">if</span> action == <span class="string">'pull_task'</span>:</span><br><span class="line">        logger.debug(<span class="string">"添加任务到redis队列，主动回调接口"</span>)</span><br><span class="line">        <span class="keyword">if</span> data_info.get(<span class="string">"data"</span>, &#123;&#125;) != &#123;&#125;:</span><br><span class="line">            logger.debug(<span class="string">f"callback_client : <span class="subst">&#123;data_info&#125;</span>"</span>)</span><br><span class="line">            redis_db.lpush(<span class="string">"wxtools_callback"</span>, json.dumps(data_info))</span><br><span class="line">            <span class="keyword">return</span> JSONResponse(data_info)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            redis_db.lpush(<span class="string">"wxtools_callback"</span>, json.dumps(data_info))</span><br><span class="line">            <span class="keyword">return</span> JSONResponse(&#123;<span class="string">"code"</span>: <span class="number">-1</span>&#125;)</span><br><span class="line">    <span class="keyword">return</span> JSONResponse(json.dumps(&#123;<span class="string">"code"</span>: <span class="number">1</span>&#125;))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@bp.get("/index", summary='测试主页', description='测试主页', tags=['index'])</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">callback_client</span><span class="params">(request: Request, response: Response)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> JSONResponse(&#123;<span class="string">"code"</span>: <span class="number">1</span>, <span class="string">"res"</span>: <span class="string">"内网穿透成功"</span>&#125;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 添加路由组</span></span><br><span class="line">app.include_router(bp)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    uvicorn.run(app=<span class="string">'callback_server:app'</span>, host=<span class="string">"0.0.0.0"</span>, workers=<span class="number">1</span>, port=<span class="number">7883</span>, reload=<span class="literal">True</span>, debug=<span class="literal">True</span>)</span><br><span class="line">    <span class="comment"># nohup python3 server.py &gt;/dev/null 2&gt;&amp;1 &amp;</span></span><br></pre></td></tr></table></figure>
<p><strong>（2） pull代码进入windows目录下</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">cd windows_64</span><br><span class="line">.&#x2F;ding -config ding.cfg -subdomain dengta123456 7883</span><br></pre></td></tr></table></figure>
<p>运行后结果显示：</p>
<p><img src="/2022/03/11/%E5%86%85%E7%BD%91%E7%A9%BF%E9%80%8F%E5%8E%9F%E6%9D%A5%E8%BF%99%E4%B9%88%E5%AE%B9%E6%98%93%E5%B0%B1%E8%83%BD%E6%90%AD%E5%BB%BA%E8%B5%B7%E6%9D%A5/1.jpg" style="zoom: 150%;"></p>
<p><strong>（4）测试是够成功，我们在外网访问下 index和callback_client 接口</strong></p>
<p><img src="/2022/03/11/%E5%86%85%E7%BD%91%E7%A9%BF%E9%80%8F%E5%8E%9F%E6%9D%A5%E8%BF%99%E4%B9%88%E5%AE%B9%E6%98%93%E5%B0%B1%E8%83%BD%E6%90%AD%E5%BB%BA%E8%B5%B7%E6%9D%A5/3.jpg" style="zoom: 150%;"></p>
<p><img src="/2022/03/11/%E5%86%85%E7%BD%91%E7%A9%BF%E9%80%8F%E5%8E%9F%E6%9D%A5%E8%BF%99%E4%B9%88%E5%AE%B9%E6%98%93%E5%B0%B1%E8%83%BD%E6%90%AD%E5%BB%BA%E8%B5%B7%E6%9D%A5/2.jpg" style="zoom: 150%;"></p>
<p>完美成功，更多的功能，请移步官网，参考教程</p>
<p><strong>（4）tips:</strong></p>
<p>frp也是免费的，而且贼好使。但是 frp前提自己要有公网ip，云服务器之类的。</p>
<p><strong>结束语</strong>：</p>
<p>​    今天的分享就到这里了，欢迎大家关注微信公众号<strong>菜鸟童靴</strong></p>
]]></content>
      <categories>
        <category>技术杂谈</category>
      </categories>
      <tags>
        <tag>内网穿透</tag>
        <tag>测试</tag>
      </tags>
  </entry>
  <entry>
    <title>mitmproxy-ca-cert.pem证书安装不上，终极解决办法手机证书文件安装</title>
    <url>/2022/03/10/mitmproxy-ca-cert-pem%E8%AF%81%E4%B9%A6%E5%AE%89%E8%A3%85%E4%B8%8D%E4%B8%8A%EF%BC%8C%E7%BB%88%E6%9E%81%E8%A7%A3%E5%86%B3%E5%8A%9E%E6%B3%95%E6%89%8B%E6%9C%BA%E8%AF%81%E4%B9%A6%E6%96%87%E4%BB%B6%E5%AE%89%E8%A3%85/</url>
    <content><![CDATA[<p>mitmproxy-ca-cert.pem证书安装不上,终极解决办法手机证书文件安装</p>
<a id="more"></a>
<p><strong>在mitmproxy软件证书配置中，其中手机的证书安装过程一般为：</strong></p>
<p>​    将mitmproxy-ca-cert.pem”文件发送到手机上，点击证书文件，便会出现一个安装窗口。</p>
<p>但是，我的Android手机并不识别pem文件，如华为荣耀10 ，华为Nova青春版。</p>
<p><strong>解决方法为：</strong></p>
<p>（打开手机“设置”；选择“安全和隐私”；点击“更多安全设置”，找到“从SD卡安装”；搜索该证书文件，点击安装.）</p>
<p>1  设置</p>
<p>2 安全与隐私</p>
<p>3 更多安全设置</p>
<p>4 从存储设备安装</p>
<p>5 选中证书文件，点击安装</p>
<p>6 输入锁屏密码</p>
<p>7 给安装文件命名mitmproxy</p>
<p>8 结束了，完成安装！！！</p>
<p><strong>结束语</strong>：</p>
<p>​    今天的分享就到这里了，欢迎大家关注微信公众号”<strong>菜鸟童靴</strong>“</p>
]]></content>
      <categories>
        <category>技术杂谈</category>
      </categories>
      <tags>
        <tag>科学上网</tag>
        <tag>mitmproxy</tag>
      </tags>
  </entry>
  <entry>
    <title>Android10不能使用uiautomatorviewer定位元素的终极解决</title>
    <url>/2022/03/10/Android10%E4%B8%8D%E8%83%BD%E4%BD%BF%E7%94%A8uiautomatorviewer%E5%AE%9A%E4%BD%8D%E5%85%83%E7%B4%A0%E7%9A%84%E7%BB%88%E6%9E%81%E8%A7%A3%E5%86%B3/</url>
    <content><![CDATA[<p>Android app 元素定位除了使用Appium 、Inspector 、Airtest外，还可以使用Android SDK 里tools中的uiautomatorviewer 工具。</p>
<a id="more"></a>
<p>但今天打算使用 uiautomatorviewer 进行元素定位的时候，发现无法截图，并报如下错误：</p>
<figure class="highlight css"><table><tr><td class="code"><pre><span class="line"><span class="selector-tag">Unexpected</span> <span class="selector-tag">error</span> <span class="selector-tag">while</span> <span class="selector-tag">obtaining</span> <span class="selector-tag">UI</span> <span class="selector-tag">hierarchy</span></span><br></pre></td></tr></table></figure>
<p><strong>点击Details</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">java.lang.reflect.InvocationTargetException</span><br></pre></td></tr></table></figure>
<p><img src="/2022/03/10/Android10%E4%B8%8D%E8%83%BD%E4%BD%BF%E7%94%A8uiautomatorviewer%E5%AE%9A%E4%BD%8D%E5%85%83%E7%B4%A0%E7%9A%84%E7%BB%88%E6%9E%81%E8%A7%A3%E5%86%B3/1.jpg" style="zoom: 50%;"></p>
<p><strong>原先使用过啊，没一点问题啊</strong>：</p>
<p>查找资料了解到，从Android 8.0开始，SDK 工具软件包在新版本中已经弃用，所以tools里的uiautomatorviewer工具都不支持了。于是开始查找解决方法。</p>
<p><strong>查找资料找到解决办法</strong>：</p>
<p>1，使用adb命令截图，再导入uiautomatorviewer进行定位。这种方法虽然可行，但太麻烦了。</p>
<p>2，下载修改过的 uiautomatorviewer.bat，将tools里的uiautomatorviewer.bat文件替换掉。</p>
<p><strong>3，终极方法！！！！将SDK目录中tools文件夹下lib中的ddmlib、ddms、ddmuilib 、uiautomatorviewer这四个jar文件替换掉即可。下面是这四个新文件的下载地址：</strong></p>
<p> 链接：<a href="https://pan.baidu.com/s/1NIPNk8ApQIPveVkAfVOpJA" target="_blank" rel="noopener">https://pan.baidu.com/s/1NIPNk8ApQIPveVkAfVOpJA</a><br> 提取码：k5rc<br> <strong>替换完成后，重新打开tools中uiautomatorviewer.bat即可进行元素定位。</strong></p>
<p><img src="/2022/03/10/Android10%E4%B8%8D%E8%83%BD%E4%BD%BF%E7%94%A8uiautomatorviewer%E5%AE%9A%E4%BD%8D%E5%85%83%E7%B4%A0%E7%9A%84%E7%BB%88%E6%9E%81%E8%A7%A3%E5%86%B3/end.jpg" style="zoom: 50%;"></p>
<p><strong>结束语</strong>：</p>
<p>​    今天的分享就到这里了，欢迎大家关注微信公众号<strong>菜鸟童靴</strong></p>
]]></content>
      <categories>
        <category>爬虫</category>
      </categories>
      <tags>
        <tag>自动化</tag>
        <tag>ui</tag>
      </tags>
  </entry>
  <entry>
    <title>Autojs通过VSCode电脑进行调试</title>
    <url>/2022/03/10/Autojs%E9%80%9A%E8%BF%87VSCode%E7%94%B5%E8%84%91%E8%BF%9B%E8%A1%8C%E8%B0%83%E8%AF%95/</url>
    <content><![CDATA[<p>hello 大家好我是Monday，今天给大家带来一篇关于自动化的文章，Auto js如何通过VS Code电脑进行调试？</p>
<a id="more"></a>
<h2 id="前提："><a href="#前提：" class="headerlink" title="前提："></a>前提：</h2><p>首先手机里面安装AutoJs app, 官方代码，</p>
<p>apk 在release 里面下载： <a href="https://links.jianshu.com/go?to=https%3A%2F%2Fgithub.com%2Fhyb1996%2FAuto.js" target="_blank" rel="noopener">https://github.com/hyb1996/Auto.js</a></p>
<p>官方下载VS code:  <a href="https://links.jianshu.com/go?to=https%3A%2F%2Fcode.visualstudio.com%2F" target="_blank" rel="noopener">https://code.visualstudio.com/</a></p>
<h2 id="一、vscode启动Auto-js"><a href="#一、vscode启动Auto-js" class="headerlink" title="一、vscode启动Auto.js"></a>一、vscode启动Auto.js</h2><h3 id="1-vscode里安装auto-js插件"><a href="#1-vscode里安装auto-js插件" class="headerlink" title="1.vscode里安装auto.js插件"></a>1.vscode里安装auto.js插件</h3><p><img src="/2022/03/10/Autojs%E9%80%9A%E8%BF%87VSCode%E7%94%B5%E8%84%91%E8%BF%9B%E8%A1%8C%E8%B0%83%E8%AF%95/1.png" style="zoom: 100%;"></p>
<h3 id="2-ctrl-shift-p调出命令面板"><a href="#2-ctrl-shift-p调出命令面板" class="headerlink" title="2.ctrl + shift + p调出命令面板"></a>2.ctrl + shift + p调出命令面板</h3><p><img src="/2022/03/10/Autojs%E9%80%9A%E8%BF%87VSCode%E7%94%B5%E8%84%91%E8%BF%9B%E8%A1%8C%E8%B0%83%E8%AF%95/2.png" style="zoom: 100%;"></p>
<p> <img src="/2022/03/10/Autojs%E9%80%9A%E8%BF%87VSCode%E7%94%B5%E8%84%91%E8%BF%9B%E8%A1%8C%E8%B0%83%E8%AF%95/3.png" style="zoom: 100%;"></p>
<h2 id="二、连接手机操作"><a href="#二、连接手机操作" class="headerlink" title="二、连接手机操作"></a>二、连接手机操作</h2><h3 id="1、ipconfig查看自己本机ip"><a href="#1、ipconfig查看自己本机ip" class="headerlink" title="1、ipconfig查看自己本机ip"></a>1、ipconfig查看自己本机ip</h3><h3 id="2、手机打开Auto-js侧边选项卡—-gt-连接电脑——-gt-输入ip地址。与电脑同意局域网，或者手机连接电脑无线"><a href="#2、手机打开Auto-js侧边选项卡—-gt-连接电脑——-gt-输入ip地址。与电脑同意局域网，或者手机连接电脑无线" class="headerlink" title="2、手机打开Auto.js侧边选项卡—-&gt;连接电脑——&gt;输入ip地址。与电脑同意局域网，或者手机连接电脑无线"></a>2、手机打开Auto.js侧边选项卡—-&gt;连接电脑——&gt;输入ip地址。与电脑同意局域网，或者手机连接电脑无线</h3><p><img src="/2022/03/10/Autojs%E9%80%9A%E8%BF%87VSCode%E7%94%B5%E8%84%91%E8%BF%9B%E8%A1%8C%E8%B0%83%E8%AF%95/4.png" style="zoom: 100%;"></p>
<h4 id="此时可以看到连接成功"><a href="#此时可以看到连接成功" class="headerlink" title="此时可以看到连接成功"></a>此时可以看到连接成功</h4><p><img src="/2022/03/10/Autojs%E9%80%9A%E8%BF%87VSCode%E7%94%B5%E8%84%91%E8%BF%9B%E8%A1%8C%E8%B0%83%E8%AF%95/5.png" style="zoom: 100%;"></p>
<p> 在vscode里新建js文件，按f5或命令run，就可以在手机上运行</p>
<p><img src="/2022/03/10/Autojs%E9%80%9A%E8%BF%87VSCode%E7%94%B5%E8%84%91%E8%BF%9B%E8%A1%8C%E8%B0%83%E8%AF%95/6.png" style="zoom: 100%;"></p>
<p>手机弹出toast</p>
<p><img src="/2022/03/10/Autojs%E9%80%9A%E8%BF%87VSCode%E7%94%B5%E8%84%91%E8%BF%9B%E8%A1%8C%E8%B0%83%E8%AF%95/7.png" style="zoom: 100%;"></p>
<p>保存文件，ctrl + shift + p</p>
<p><img src="/2022/03/10/Autojs%E9%80%9A%E8%BF%87VSCode%E7%94%B5%E8%84%91%E8%BF%9B%E8%A1%8C%E8%B0%83%E8%AF%95/8.png" style="zoom: 100%;"></p>
<p> 可以看到连接的手机信息，选择就能保存成功</p>
<p><img src="/2022/03/10/Autojs%E9%80%9A%E8%BF%87VSCode%E7%94%B5%E8%84%91%E8%BF%9B%E8%A1%8C%E8%B0%83%E8%AF%95/9.png" style="zoom: 100%;"></p>
<p> <img src="/2022/03/10/Autojs%E9%80%9A%E8%BF%87VSCode%E7%94%B5%E8%84%91%E8%BF%9B%E8%A1%8C%E8%B0%83%E8%AF%95/10.png" style="zoom: 100%;"></p>
<p><img src="/2022/03/10/Autojs%E9%80%9A%E8%BF%87VSCode%E7%94%B5%E8%84%91%E8%BF%9B%E8%A1%8C%E8%B0%83%E8%AF%95/11.png" style="zoom: 100%;"></p>
<h1 id="插件常用命令"><a href="#插件常用命令" class="headerlink" title="插件常用命令"></a>插件常用命令</h1><p>Start Server: 启动插件服务。之后在确保手机和电脑在同一区域网的情况下，在Auto.js的侧拉菜单中使用连接电脑功能连接。<br>Stop Server: 停止插件服务。<br>Run 运行当前编辑器的脚本。如果有多个设备连接，则在所有设备运行。<br>Rerun 停止当前文件对应的脚本并重新运行。如果有多个设备连接，则在所有设备重新运行。<br>Stop 停止当前文件对应的脚本。如果有多个设备连接，则在所有设备停止。<br>StopAll 停止所有正在运行的脚本。如果有多个设备连接，则在所有设备运行所有脚本。<br>Save 保存当前文件到手机的脚本默认目录（文件名会加上前缀remote)。如果有多个设备连接，则在所有设备保存。<br>RunOnDevice: 弹出设备菜单并在指定设备运行脚本。<br>SaveToDevice: 弹出设备菜单并在指定设备保存脚本。<br>New Project（新建项目）：选择一个空文件夹（或者在文件管理器中新建一个空文件夹），将会自动创建一个项目<br>Run Project（运行项目）：运行一个项目，需要Auto.js 4.0.4Alpha5以上支持<br>Save Project（保存项目）：保存一个项目，需要Auto.js 4.0.4Alpha5以上支持</p>
<p><strong>结束语</strong>：</p>
<p>​    今天的分享就到这里了，欢迎大家关注微信公众号”<strong>菜鸟童靴</strong>“</p>
]]></content>
      <categories>
        <category>爬虫</category>
      </categories>
      <tags>
        <tag>自动化</tag>
        <tag>爬虫</tag>
      </tags>
  </entry>
  <entry>
    <title>mitmproxy安装和使用方法总结</title>
    <url>/2022/03/09/mitmproxy%E5%AE%89%E8%A3%85%E5%92%8C%E4%BD%BF%E7%94%A8%E6%96%B9%E6%B3%95%E6%80%BB%E7%BB%93/</url>
    <content><![CDATA[<hr>
<p>笔记_mitmproxy安装和使用方法总结</p>
<a id="more"></a>
<p><strong>MitmProxy 介绍</strong>：</p>
<p>支持 HTTP 和 HTTPS 的抓包程序，类似 Fiddler、Charles 的功能，只不过它是一个控制台的形式操作。<br>同时 MitmProxy 还有两个关联组件，一个是 MitmDump，它是 MitmProxy 的命令行接口，利用它我们可以对接 Python 脚本，用 Python 实现监听后的处理。另一个是 MitmWeb，它是一个 Web 程序，通过它我们可以清楚地观察到 MitmProxy 捕获的请求。</p>
<p><strong>相关链接</strong></p>
<p>mitmproxy不错的中文学习网站 <a href="https://blog.wolfogre.com/posts/usage-of-mitmproxy/" target="_blank" rel="noopener">https://blog.wolfogre.com/posts/usage-of-mitmproxy/</a> </p>
<p>GitHub：<a href="https://github.com/mitmproxy/mitmproxy" target="_blank" rel="noopener">https://github.com/mitmproxy/mitmproxy</a><br>官方网站：<a href="https://mitmproxy.org" target="_blank" rel="noopener">https://mitmproxy.org</a><br>PyPi：<a href="https://pypi.python.org/pypi/mitmproxy" target="_blank" rel="noopener">https://pypi.python.org/pypi/mitmproxy</a><br>官方文档：<a href="http://docs.mitmproxy.org" target="_blank" rel="noopener">http://docs.mitmproxy.org</a><br>MitmDump脚本：<a href="http://docs.mitmproxy.org/en/stable/scripting/overview.html" target="_blank" rel="noopener">http://docs.mitmproxy.org/en/stable/scripting/overview.html</a><br>下载地址：<a href="https://github.com/mitmproxy/mitmproxy/releases" target="_blank" rel="noopener">https://github.com/mitmproxy/mitmproxy/releases</a><br>DockerHub：<a href="https://hub.docker.com/r/mitmproxy/mitmproxy" target="_blank" rel="noopener">https://hub.docker.com/r/mitmproxy/mitmproxy</a></p>
<p>报错可能解决方案： <a href="https://blog.csdn.net/andrew_wf/article/details/84991989" target="_blank" rel="noopener">https://blog.csdn.net/andrew_wf/article/details/84991989</a> </p>
<p><strong>安装：</strong></p>
<p> pip install mitmproxy </p>
<p> 这是最简单和通用的安装方式，执行完毕之后即可完成 MitmProxy的安装，另外还安装了MitmDump、MitmWeb 两个组件 </p>
<p><strong>安装证书</strong></p>
<p>安装好mitmproxy后，到C:\Users\Administrator.mitmproxy目录下</p>
<p><strong>电脑安装证书：</strong><br>mitmproxy-ca.p12</p>
<p>双击下一，直到最后</p>
<p><strong>手机安装证书：</strong><br>mitmproxy-ca.pem</p>
<p><strong>手机模拟器安装证书：</strong></p>
<p>mitmproxy-ca.pem</p>
<p>设置-安全-从SD卡导入证书即可</p>
<p><strong>这样我们就可以愉快的使用mitmproxy去搞一些事情了：</strong></p>
<p><strong>我下面用它抓取一下，皮皮虾app推荐模块抓取：</strong></p>
<p>首先建立两个py文件，一个用于app的视频json信息的抓取</p>
<p><strong>(1)get_request_data.py</strong>  :</p>
<p>用来获取视频列表的url和headers</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> sys</span><br><span class="line">sys.path.append(<span class="string">'../'</span>)</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> mitmproxy</span><br><span class="line"><span class="keyword">from</span> mitmproxy <span class="keyword">import</span> http</span><br><span class="line"><span class="keyword">from</span> mitmproxy <span class="keyword">import</span> flow, proxy, controller, options</span><br><span class="line"><span class="keyword">from</span> mitmproxy.proxy.server <span class="keyword">import</span> ProxyServer</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">程序运行</span></span><br><span class="line"><span class="string"> mitmdump -s xxxx.py</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">response</span><span class="params">(flow)</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="string">'https://it.snssdk.com/bds/feed/stream/'</span> <span class="keyword">in</span> flow.request.url:</span><br><span class="line">        datas = flow.request.headers</span><br><span class="line">        headers = &#123;&#125;</span><br><span class="line">        <span class="keyword">for</span> k,v <span class="keyword">in</span> datas.items():</span><br><span class="line">            headers[k] = v</span><br><span class="line">        print(<span class="string">f'root_url&gt;&gt;&gt;<span class="subst">&#123;flow.request.url&#125;</span>&lt;&lt;&lt;headers&gt;&gt;&gt;<span class="subst">&#123;headers&#125;</span>&lt;&lt;&lt;'</span>)</span><br></pre></td></tr></table></figure>
<p><strong>(2)spider_data.py</strong>  :</p>
<p>对获取到url和headers进行对视频信息的抓取</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#coding=utf-8</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">管道执行命令</span></span><br><span class="line"><span class="string"> mitmdump -s &lt;python1.y&gt; | python &lt;python2.py&gt;</span></span><br><span class="line"><span class="string">  mitmdump -s test.py | python receive.py</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="keyword">from</span> jsonpath <span class="keyword">import</span> jsonpath</span><br><span class="line"><span class="keyword">from</span> glom <span class="keyword">import</span> glom</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">for</span> line <span class="keyword">in</span> sys.stdin:</span><br><span class="line">    root_url = re.search(<span class="string">'root_url&gt;&gt;&gt;(.*?)&lt;&lt;&lt;'</span>, line)</span><br><span class="line">    headers = re.search(<span class="string">'headers&gt;&gt;&gt;(.*?)&lt;&lt;&lt;'</span>, line)</span><br><span class="line">    <span class="keyword">if</span> root_url <span class="keyword">and</span> headers:</span><br><span class="line">        html = requests.get(root_url.group(<span class="number">1</span>),headers=eval(headers.group(<span class="number">1</span>)))</span><br><span class="line">        html.encoding = <span class="string">'utf-8'</span></span><br><span class="line">        data_info = html.json()</span><br><span class="line"></span><br><span class="line">        data_list = glom(data_info, <span class="string">'data.data'</span>)</span><br><span class="line">        <span class="keyword">for</span> datas <span class="keyword">in</span> data_list:</span><br><span class="line">            data = glom(datas, <span class="string">'item.share'</span>)</span><br><span class="line">            title = <span class="string">''</span>.join(jsonpath(data, <span class="string">"$..title"</span>))</span><br><span class="line">            url = <span class="string">''</span>.join(jsonpath(data, <span class="string">"$..compound_page_url"</span>))</span><br><span class="line">            image_url = <span class="string">''</span>.join(jsonpath(data, <span class="string">"$..image_url"</span>))</span><br><span class="line">            video_url = glom(datas, <span class="string">'item.origin_video_download.url_list'</span>)[<span class="number">0</span>].get(<span class="string">'url'</span>)</span><br><span class="line"></span><br><span class="line">            release_time = datas[<span class="string">'item'</span>][<span class="string">'create_time'</span>]</span><br><span class="line">            print(title)</span><br><span class="line">            print(url)</span><br><span class="line">            print(image_url)</span><br><span class="line">            print(video_url)</span><br><span class="line">            print(release_time)</span><br><span class="line">            <span class="keyword">break</span></span><br></pre></td></tr></table></figure>
<p><strong>怎么运行：</strong></p>
<p>进入cmd，窗口</p>
<p>mitmdump -s get_request_data.py | python spider_data.py</p>
<p>在手机端滑动就行了</p>
<p><strong>总结：</strong></p>
<p>中间抓取思路有很多种，get_request_data.py在文件里print()的信息写到文件里或数据库里，mitmdump -s get_request_data.py  在窗口执行这个命令，我们单独在写个程序，扫描数据库或文件，单独进行抓取数据</p>
<p>本文这个，只是小编想用一下，管道命令，</p>
<p><strong>结束语</strong>：</p>
<p> 今天的分享就到这里了，欢迎大家关注微信公众号”<strong>菜鸟童靴</strong>“</p>
]]></content>
      <categories>
        <category>技术杂谈</category>
      </categories>
      <tags>
        <tag>科学上网</tag>
        <tag>mitmproxy</tag>
      </tags>
  </entry>
  <entry>
    <title>安卓7.0以上手机写入安全证书</title>
    <url>/2022/03/09/%E5%AE%89%E5%8D%937-0%E4%BB%A5%E4%B8%8A%E6%89%8B%E6%9C%BA%E5%86%99%E5%85%A5%E5%AE%89%E5%85%A8%E8%AF%81%E4%B9%A6/</url>
    <content><![CDATA[<p>安卓7.0以上手机写入安全证书，具体操作？</p>
<a id="more"></a>
<h3 id="1、背景："><a href="#1、背景：" class="headerlink" title="1、背景："></a><strong>1、背景：</strong></h3><p>谷歌在安卓7.0修改了安全策略，用户添加的CA证书不能再用于安全连接，</p>
<p>对于https传输的数据就抓取不到了，会显示<strong>“<unknown></unknown></strong>“。</p>
<p>既然又知道了原因，那就总还是有办法去解决的。我们只要把代理软件的根证书安装成系统证书就可以了。</p>
<h3 id="2、解决方法及操作方法"><a href="#2、解决方法及操作方法" class="headerlink" title="2、解决方法及操作方法"></a><strong>2、解决方法及操作方法</strong></h3><p>实际上将证书安装到系统区操作还是相对简单的，</p>
<p><strong>（1）将证书用指定的名称放到指定的位置就可以了</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;system&#x2F;etc&#x2F;security&#x2F;cacerts&#x2F;</span><br></pre></td></tr></table></figure>
<p><strong>（2）先将我们的根证书名称改为</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;Certificate_Hash&gt;.&lt;Number&gt;</span><br></pre></td></tr></table></figure>
<p>Certificate_Hash表示证书文件的hash值，Number是为了防止证书文件的hash值一致而增加的后缀（用0就行了）</p>
<p><strong>（3）下载自己的根证书FiddlerRoot.cer，使用</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">openssl x509 -subject_hash_old -in &lt;Certificate_File&gt;</span><br></pre></td></tr></table></figure>
<p><img src="/2022/03/09/%E5%AE%89%E5%8D%937-0%E4%BB%A5%E4%B8%8A%E6%89%8B%E6%9C%BA%E5%86%99%E5%85%A5%E5%AE%89%E5%85%A8%E8%AF%81%E4%B9%A6/1.jpg" style="zoom: 150%;"></p>
<p>计算证书hash ，根据hash将证书重命名为 c8750f0d.0（c8750f0d.0是笔者证书的hash，大家的肯定不一样）</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">cp ***.pem c8750f0d.0</span><br></pre></td></tr></table></figure>
<p>然后将c8750f0d.0文件复制到</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;system&#x2F;etc&#x2F;security&#x2F;cacerts&#x2F;</span><br></pre></td></tr></table></figure>
<p><img src="/2022/03/09/%E5%AE%89%E5%8D%937-0%E4%BB%A5%E4%B8%8A%E6%89%8B%E6%9C%BA%E5%86%99%E5%85%A5%E5%AE%89%E5%85%A8%E8%AF%81%E4%B9%A6/2.jpg" style="zoom: 150%;"></p>
<p>完成后我们就可以看到代理软件的证书出现在系统区了。</p>
<p><strong>这里还有一点需要单独说明，/system/etc/security/cacerts/目录的写权限，需要手机root权限。</strong></p>
<h3 id="3、将证书安装到System中"><a href="#3、将证书安装到System中" class="headerlink" title="3、将证书安装到System中"></a>3、将证书安装到System中</h3><p>不要直接用adb push，安卓5以后有问题，不通用。</p>
<p><strong>（1）重启adb，作为root启动</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">adb root</span><br></pre></td></tr></table></figure>
<p><strong>（2）获取Android设备上访问/system的权限</strong></p>
<p>在早期的Android版本中（API LEVEL &lt; 28），需要使用如下命令获得访问权限：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">adb shell su -c &quot;mount -o rw,remount &#x2F;system&quot;</span><br></pre></td></tr></table></figure>
<p>API LEVEL &gt;= 29，否则，使用如下命令：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">adb shell su -c &quot;mount -o rw,remount &#x2F;system&quot;</span><br></pre></td></tr></table></figure>
<p>（<strong>3）将自己的证书push到系统证书目录</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">adb push c8750f0d.0 &#x2F;system&#x2F;etc&#x2F;security&#x2F;cacerts </span><br><span class="line">adb shell &quot;chmod 664 &#x2F;system&#x2F;etc&#x2F;security&#x2F;cacerts&#x2F;c8750f0d.0&quot;</span><br></pre></td></tr></table></figure>
<p><img src="/2022/03/09/%E5%AE%89%E5%8D%937-0%E4%BB%A5%E4%B8%8A%E6%89%8B%E6%9C%BA%E5%86%99%E5%85%A5%E5%AE%89%E5%85%A8%E8%AF%81%E4%B9%A6/3.jpg" style="zoom: 150%;"></p>
<h4 id="3-1、如果失敗了，解决办法："><a href="#3-1、如果失敗了，解决办法：" class="headerlink" title="3.1、如果失敗了，解决办法："></a><strong>3.1、如果失敗了，解决办法：</strong></h4><p>（<strong>1）通过微信传输文件后，点击保存文件到手机，</strong> </p>
<p>​        文件的目录存放的位置： /sdcard/Download/WeiXin</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mido:&#x2F;sdcard&#x2F;Download&#x2F;WeiXin # pwd</span><br><span class="line">&#x2F;sdcard&#x2F;Download&#x2F;WeiXin</span><br><span class="line">mido:&#x2F;sdcard&#x2F;Download&#x2F;WeiXin # cp c8750f0d.0 &#x2F;system&#x2F;etc&#x2F;security&#x2F;cacerts&#x2F;</span><br><span class="line">mido:&#x2F;sdcard&#x2F;Download&#x2F;WeiXin #</span><br></pre></td></tr></table></figure>
<p><strong>（2）如果修改了之后还是提示Read-only file system，还有方法</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">adb root</span><br><span class="line"></span><br><span class="line">adb disable-verity</span><br><span class="line"></span><br><span class="line">adb reboot #手机会重启，不用关闭cmd窗口，手机可能需要拔掉数据写重新连接</span><br><span class="line"></span><br><span class="line">adb root</span><br><span class="line"></span><br><span class="line">adb shell </span><br><span class="line"></span><br><span class="line">mount -o rw,remount &#x2F;system  #再次进行修改</span><br></pre></td></tr></table></figure>
<p><strong>(3)如果还是错误还是报错’/system’ not in /proc/mounts</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mount -o rw,remount -t auto &#x2F;</span><br></pre></td></tr></table></figure>
<p><img src="/2022/03/09/%E5%AE%89%E5%8D%937-0%E4%BB%A5%E4%B8%8A%E6%89%8B%E6%9C%BA%E5%86%99%E5%85%A5%E5%AE%89%E5%85%A8%E8%AF%81%E4%B9%A6/4.jpg" style="zoom: 150%;"></p>
<p>验证成功</p>
<p><img src="/2022/03/09/%E5%AE%89%E5%8D%937-0%E4%BB%A5%E4%B8%8A%E6%89%8B%E6%9C%BA%E5%86%99%E5%85%A5%E5%AE%89%E5%85%A8%E8%AF%81%E4%B9%A6/5.jpg" style="zoom: 150%;"></p>
<p><strong>结束语</strong>：</p>
<p>​    今天的分享就到这里了，欢迎大家关注微信公众号”<strong>菜鸟童靴</strong>“</p>
]]></content>
      <categories>
        <category>爬虫</category>
      </categories>
      <tags>
        <tag>抓包</tag>
        <tag>证书</tag>
      </tags>
  </entry>
  <entry>
    <title>github访问慢，一直不成功，难道非得科学上网吗</title>
    <url>/2022/03/06/github%E8%AE%BF%E9%97%AE%E6%85%A2%EF%BC%8C%E4%B8%80%E7%9B%B4%E4%B8%8D%E6%88%90%E5%8A%9F%EF%BC%8C%E9%9A%BE%E9%81%93%E9%9D%9E%E5%BE%97%E7%A7%91%E5%AD%A6%E4%B8%8A%E7%BD%91%E5%90%97/</url>
    <content><![CDATA[<p>github访问慢，一直不成功，难道非得科学上网吗，今天小编给你带来终极解决方案，让你不再为此而烦恼</p>
<a id="more"></a>
<h3 id="背景："><a href="#背景：" class="headerlink" title="背景："></a>背景：</h3><p>​        github上有很多优秀的资源和项目，对程序员开发成长的有效平台之一，但是国内访问github的并不是那么友好</p>
<p>经常会出现访问一直转圈圈，访问慢，或者超时失败，小编在今天之前一直都是科学上网的方式，解决现状，今天服务</p>
<p>费软件到期后，忽然访问不了，又不想续费了，所以找了找网上有没有可行性的解决方案，一搜不知道，还真有，</p>
<p>接下来小编给大家案例两种方式的访问，方式一：dev-sidecar、方式二GitHub520 </p>
<h3 id="1、dev-sidecar"><a href="#1、dev-sidecar" class="headerlink" title="1、dev-sidecar"></a>1、dev-sidecar</h3><p>开发者边车，命名取自service-mesh的service-sidecar，意为为开发者打辅助的边车工具<br>通过本地代理的方式将https请求代理到一些国内的加速通道上</p>
<h4 id="1-1开源网址："><a href="#1-1开源网址：" class="headerlink" title="1.1开源网址："></a>1.1开源网址：</h4><p><a href="https://gitee.com/docmirror/dev-sidecar" target="_blank" rel="noopener">https://gitee.com/docmirror/dev-sidecar</a></p>
<h4 id="1-2特性："><a href="#1-2特性：" class="headerlink" title="1.2特性："></a>1.2特性：</h4><p>1、 dns优选</p>
<p>2、 请求拦截</p>
<p>3、 github加速</p>
<p>4、 Stack Overflow 加速</p>
<p>5、 npm加速</p>
<h4 id="1-3安装使用"><a href="#1-3安装使用" class="headerlink" title="1.3安装使用"></a>1.3安装使用</h4><h5 id="1-3-1选择平台下载"><a href="#1-3-1选择平台下载" class="headerlink" title="1.3.1选择平台下载"></a>1.3.1选择平台下载</h5><p><img src="/2022/03/06/github%E8%AE%BF%E9%97%AE%E6%85%A2%EF%BC%8C%E4%B8%80%E7%9B%B4%E4%B8%8D%E6%88%90%E5%8A%9F%EF%BC%8C%E9%9A%BE%E9%81%93%E9%9D%9E%E5%BE%97%E7%A7%91%E5%AD%A6%E4%B8%8A%E7%BD%91%E5%90%97/1646572766.jpg" style="zoom: 50%;"></p>
<p>​    </p>
<p>此项目支持平台有很多，这边以window为例，我直接下载安装，傻瓜式安装，</p>
<h5 id="1-3-2-安装根证书"><a href="#1-3-2-安装根证书" class="headerlink" title="1.3.2 安装根证书"></a>1.3.2 安装根证书</h5><p>第一次打开会提示安装证书，根据提示操作即可</p>
<p>更多有关根证书的说明，请参考 <a href="https://gitee.com/docmirror/dev-sidecar/blob/master/doc/caroot.md" target="_blank" rel="noopener">为什么要安装根证书?</a></p>
<blockquote>
<p>根证书是本地随机生成的，所以不用担心根证书的安全问题（本应用不收集任何用户信息）<br>你也可以在加速服务设置中自定义根证书（PEM格式的证书与私钥）</p>
<p>火狐浏览器需要<a href="https://gitee.com/docmirror/dev-sidecar#3浏览器打开提示证书不受信任" target="_blank" rel="noopener">手动安装证书</a></p>
</blockquote>
<h5 id="1-3-4开始加速吧"><a href="#1-3-4开始加速吧" class="headerlink" title="1.3.4开始加速吧"></a>1.3.4开始加速吧</h5><p><img src="/2022/03/06/github%E8%AE%BF%E9%97%AE%E6%85%A2%EF%BC%8C%E4%B8%80%E7%9B%B4%E4%B8%8D%E6%88%90%E5%8A%9F%EF%BC%8C%E9%9A%BE%E9%81%93%E9%9D%9E%E5%BE%97%E7%A7%91%E5%AD%A6%E4%B8%8A%E7%BD%91%E5%90%97/1646572959.jpg" style="zoom: 50%;"></p>
<p>去试试打开github</p>
<h3 id="2、-GitHub520"><a href="#2、-GitHub520" class="headerlink" title="2、 GitHub520"></a>2、 GitHub520</h3><h4 id="2-1开源网址："><a href="#2-1开源网址：" class="headerlink" title="2.1开源网址："></a>2.1开源网址：</h4><p><a href="https://gitee.com/doshengl/GitHub520" target="_blank" rel="noopener">https://gitee.com/doshengl/GitHub520</a></p>
<h4 id="2-2安装使用"><a href="#2-2安装使用" class="headerlink" title="2.2安装使用"></a>2.2安装使用</h4><h5 id="2-2-1-手动方式（每次得手动更新不推荐）"><a href="#2-2-1-手动方式（每次得手动更新不推荐）" class="headerlink" title="2.2.1 手动方式（每次得手动更新不推荐）"></a>2.2.1 手动方式（每次得手动更新不推荐）</h5><h5 id="2-2-1-1-修改-hosts-文件"><a href="#2-2-1-1-修改-hosts-文件" class="headerlink" title="2.2.1.1 修改 hosts 文件"></a>2.2.1.1 修改 hosts 文件</h5><p>hosts 文件在每个系统的位置不一，详情如下：</p>
<ul>
<li>Windows 系统：<code>C:\Windows\System32\drivers\etc\hosts</code></li>
<li>Linux 系统：<code>/etc/hosts</code></li>
<li>Mac（苹果电脑）系统：<code>/etc/hosts</code></li>
<li>Android（安卓）系统：<code>/system/etc/hosts</code></li>
<li>iPhone（iOS）系统：<code>/etc/hosts</code></li>
</ul>
<p>修改方法，把第一步的内容复制到文本末尾：</p>
<ol>
<li>Windows 使用记事本。</li>
<li>Linux、Mac 使用 Root 权限：<code>sudo vi /etc/hosts</code>。</li>
<li>iPhone、iPad 须越狱、Android 必须要 root。</li>
</ol>
<h6 id="2-2-1-2-激活生效"><a href="#2-2-1-2-激活生效" class="headerlink" title="2.2.1.2 激活生效"></a>2.2.1.2 激活生效</h6><p>大部分情况下是直接生效，如未生效可尝试下面的办法，刷新 DNS：</p>
<ol>
<li>Windows：在 CMD 窗口输入：<code>ipconfig /flushdns</code></li>
<li>Linux 命令：<code>sudo nscd restart</code>，如报错则须安装：<code>sudo apt install nscd</code> 或 <code>sudo /etc/init.d/nscd restart</code></li>
<li>Mac 命令：<code>sudo killall -HUP mDNSResponder</code></li>
</ol>
<p><strong>Tips：</strong> 上述方法无效可以尝试重启机器。</p>
<h4 id="2-2-2-自动方式"><a href="#2-2-2-自动方式" class="headerlink" title="2.2.2 自动方式"></a>2.2.2 自动方式</h4><p><strong>Tip</strong>：推荐 <a href="https://gitee.com/link?target=https%3A%2F%2Fgithub.com%2Foldj%2FSwitchHosts">SwitchHosts</a> 工具管理 hosts</p>
<p>以 SwitchHosts 为例，看一下怎么使用的，配置参考下面：</p>
<ul>
<li>Title: 随意</li>
<li>Type: <code>Remote</code></li>
<li>URL: <code>https://raw.hellogithub.com/hosts</code></li>
<li>Auto Refresh: 最好选 <code>1 hour</code></li>
</ul>
<p>如图：</p>
<p><img src="/2022/03/06/github%E8%AE%BF%E9%97%AE%E6%85%A2%EF%BC%8C%E4%B8%80%E7%9B%B4%E4%B8%8D%E6%88%90%E5%8A%9F%EF%BC%8C%E9%9A%BE%E9%81%93%E9%9D%9E%E5%BE%97%E7%A7%91%E5%AD%A6%E4%B8%8A%E7%BD%91%E5%90%97/switch-hosts.png" style="zoom: 50%;"></p>
<p>这样每次 hosts 有更新都能及时进行更新，免去手动更新。</p>
<p><strong>结束语</strong>：</p>
<p>​    今天的分享就到这里了，欢迎大家关注微信公众号”<strong>菜鸟童靴</strong>“</p>
]]></content>
      <categories>
        <category>技术杂谈</category>
      </categories>
      <tags>
        <tag>github</tag>
        <tag>科学上网</tag>
      </tags>
  </entry>
  <entry>
    <title>pandas案例学习100例（一）</title>
    <url>/2022/02/18/pandas%E6%A1%88%E4%BE%8B%E5%AD%A6%E4%B9%A0100%E4%BE%8B%EF%BC%88%E4%B8%80%EF%BC%89/</url>
    <content><![CDATA[<p>hello 大家好，长时间没有发布新的文章，证明小编在这段日子不是很忙，就是很堕落，显然是后者了</p>
<p>捡起键盘，准备推出pandas 案例100系列，分十次记录学习，多了你也看不进去，我也写不进去：</p>
<a id="more"></a>
<p><strong>案例1：</strong></p>
<p>生成一年中，所有周一的日期：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#生成一年中，所有周一的日期</span></span><br><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line">date_range = pd.date_range(start=<span class="string">'2021-01-01'</span>, end=<span class="string">'2021-12-31'</span>, freq=<span class="string">"W-MON"</span>)</span><br><span class="line">date_range = pd.date_range(start=<span class="string">'2021-01-01'</span>, periods=<span class="number">52</span>, freq=<span class="string">"W-MON"</span>)  <span class="comment"># 一年52个周</span></span><br><span class="line">print(date_range)</span><br></pre></td></tr></table></figure>
<p><strong>案例2：</strong></p>
<p>生成一个月份的所有日期</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 生成一个月份的所有日期</span></span><br><span class="line">date_range = pd.date_range(start=<span class="string">'2021-12-01'</span>, end=<span class="string">'2021-12-31'</span>)</span><br><span class="line">date_range = pd.date_range(start=<span class="string">'2021-12-01'</span>, periods=<span class="number">31</span>)  <span class="comment"># 一個月31天</span></span><br><span class="line">print(date_range)</span><br></pre></td></tr></table></figure>
<p><strong>案例3：</strong></p>
<p>生成一天的所有小時</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#生成一天的所有小時</span></span><br><span class="line">date_range = pd.date_range(start=<span class="string">'2021-12-01'</span>, periods=<span class="number">24</span>, freq=<span class="string">"H"</span>)</span><br><span class="line">date_range = pd.date_range(start=<span class="string">'2021-12-01'</span>, end=<span class="string">'2021-12-02'</span>, closed=<span class="string">"left"</span>, freq=<span class="string">"H"</span>)</span><br><span class="line">print(date_range)</span><br></pre></td></tr></table></figure>
<p><strong>案例4：</strong></p>
<p>使用list构造 Series</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"><span class="comment"># 使用list构造 Series</span></span><br><span class="line">sites = [<span class="string">"Google"</span>, <span class="string">"Runoob"</span>, <span class="string">"Wiki"</span>]</span><br><span class="line">myvar = pd.Series(sites)</span><br><span class="line">print(myvar)</span><br></pre></td></tr></table></figure>
<p><strong>案例5：</strong></p>
<p>使用dict 构造 Series</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 使用dict 构造 Series</span></span><br><span class="line">sites = &#123;<span class="string">'x'</span>: <span class="string">"Google"</span>, <span class="string">'y'</span>: <span class="string">"Runoob"</span>, <span class="string">'z'</span>: <span class="string">"Wiki"</span>&#125;</span><br><span class="line">myvar = pd.Series(sites)</span><br><span class="line">print(myvar)</span><br></pre></td></tr></table></figure>
<p><strong>案例6：</strong></p>
<p>Series转换list</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"><span class="comment"># Series转换list</span></span><br><span class="line">sites = &#123;<span class="string">'x'</span>: <span class="string">"Google"</span>, <span class="string">'y'</span>: <span class="string">"Runoob"</span>, <span class="string">'z'</span>: <span class="string">"Wiki"</span>&#125;</span><br><span class="line">myvar = pd.Series(sites)</span><br><span class="line">data = myvar.tolist()</span><br><span class="line">print(data)python</span><br></pre></td></tr></table></figure>
<p>案例7：</p>
<p>将Series转换DataFrame</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"><span class="comment"># 将Series转换DataFrame</span></span><br><span class="line">grades = &#123;<span class="string">'语文'</span>: <span class="string">"100"</span>, <span class="string">'数学'</span>: <span class="string">"120"</span>, <span class="string">'英语'</span>: <span class="string">"60"</span>&#125;</span><br><span class="line">myvar = pd.Series(grades)</span><br><span class="line">data = pd.DataFrame(myvar, columns=[<span class="string">"grade"</span>])</span><br><span class="line">print(data)</span><br></pre></td></tr></table></figure>
<p><strong>案例8：</strong></p>
<p>用numpy 创建Series</p>
<p>101    10.0<br>102    20.0<br>103    30.0<br>104    40.0<br>105    50.0<br>106    60.0<br>107    70.0<br>108    80.0<br>109    90.0</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="comment"># 用numpy 创建Series</span></span><br><span class="line">s = pd.Series(</span><br><span class="line">    np.arange(<span class="number">10</span>, <span class="number">100</span>, <span class="number">10</span>),  <span class="comment"># 数值：10-90，间隔10</span></span><br><span class="line">    index=np.arange(<span class="number">101</span>, <span class="number">110</span>),  <span class="comment"># 索引：101-109， 间隔7</span></span><br><span class="line">    dtype=<span class="string">"float"</span>  <span class="comment"># 类型：float64</span></span><br><span class="line">)</span><br><span class="line">print(s)</span><br></pre></td></tr></table></figure>
<p><strong>案例9：</strong></p>
<p> 转换Series 的数据类型</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"></span><br><span class="line"><span class="comment"># 转换Series 的数据类型</span></span><br><span class="line">s = pd.Series(</span><br><span class="line">    data=[<span class="string">"001"</span>, <span class="string">"002"</span>, <span class="string">"003"</span>, <span class="string">"004"</span>],</span><br><span class="line">    index=list(<span class="string">"abcd"</span>),</span><br><span class="line">    dtype=<span class="string">"float"</span>  <span class="comment"># 类型：float64</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">s = s.astype(int)  <span class="comment"># 方法一</span></span><br><span class="line"><span class="comment"># s = s.map(int)# 方法二</span></span><br><span class="line">print(s)</span><br></pre></td></tr></table></figure>
<p><strong>案例10：</strong></p>
<p>给Series添加元素</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"></span><br><span class="line"><span class="comment"># 给Series添加元素</span></span><br><span class="line">grades = &#123;<span class="string">'语文'</span>: <span class="string">"100"</span>, <span class="string">'数学'</span>: <span class="string">"120"</span>, <span class="string">'英语'</span>: <span class="string">"60"</span>&#125;</span><br><span class="line">data = pd.Series(grades)</span><br><span class="line">data = data.append(pd.Series(&#123;</span><br><span class="line">    <span class="string">"计算机"</span>: <span class="number">30</span>,</span><br><span class="line">    <span class="string">"化学"</span>: <span class="number">45</span></span><br><span class="line">&#125;))</span><br><span class="line">print(data)</span><br></pre></td></tr></table></figure>
<p><strong>案例11：</strong></p>
<p>用reset index将Series 转换成df</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"><span class="comment"># 用reset index将Series 转换成df</span></span><br><span class="line">grades = &#123;<span class="string">'语文'</span>: <span class="string">"100"</span>, <span class="string">'数学'</span>: <span class="string">"120"</span>, <span class="string">'英语'</span>: <span class="string">"60"</span>&#125;</span><br><span class="line">data = pd.Series(grades)</span><br><span class="line">df = data.reset_index()</span><br><span class="line">df.columns = [<span class="string">"course"</span>, <span class="string">"grade"</span>]</span><br><span class="line">print(data)</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>数据分析</category>
      </categories>
  </entry>
  <entry>
    <title>python如何批量改文件后缀和图片像素大小</title>
    <url>/2021/12/21/python%E5%A6%82%E4%BD%95%E6%89%B9%E9%87%8F%E6%94%B9%E6%96%87%E4%BB%B6%E5%90%8E%E7%BC%80%E5%92%8C%E5%9B%BE%E7%89%87%E5%83%8F%E7%B4%A0%E5%A4%A7%E5%B0%8F/</url>
    <content><![CDATA[<p>hello 大家好，我是Monday，就在我写完pandas学习案例100第一篇的时候，在图片素材里找封面图时，发现已经没有新的封面图了</p>
<p>都是使用过的了，于是乎，我从网上下载了一批新的图片素材，正当我满意的时候，上传时，发现</p>
<a id="more"></a>
<p><img src="/2021/12/21/python%E5%A6%82%E4%BD%95%E6%89%B9%E9%87%8F%E6%94%B9%E6%96%87%E4%BB%B6%E5%90%8E%E7%BC%80%E5%92%8C%E5%9B%BE%E7%89%87%E5%83%8F%E7%B4%A0%E5%A4%A7%E5%B0%8F/2.png" style="zoom: 50%;"></p>
<p>我下载的图片都是webp后缀的，格式不被允许上传，这时候我们改文件的后缀为平台支持的格式就可以了，</p>
<p>重点来了，那么图片难道要一个一个手动改吗，No No No，会Python的你，当然应该是写个小工具批量改了</p>
<p>附带源码：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line"><span class="comment"># 列出当前目录下所有的文件</span></span><br><span class="line">path = <span class="string">r"C:\Users\xx\Desktop\公众号素材"</span></span><br><span class="line">files = os.listdir(path)</span><br><span class="line"><span class="keyword">for</span> index, filename <span class="keyword">in</span> enumerate(files):</span><br><span class="line">    portion = os.path.splitext(filename)</span><br><span class="line">    <span class="comment"># 判断后缀</span></span><br><span class="line">    <span class="keyword">if</span> portion[<span class="number">1</span>] == <span class="string">".webp"</span>:</span><br><span class="line">        <span class="comment"># 重新组合文件名和后缀名</span></span><br><span class="line">        newname = path + <span class="string">"\\"</span> + str(index) + <span class="string">".jpg"</span></span><br><span class="line">        filename = path + <span class="string">"\\"</span> + filename</span><br><span class="line">        os.rename(filename, newname)</span><br></pre></td></tr></table></figure>
<p>看下效果：</p>
<p><img src="/2021/12/21/python%E5%A6%82%E4%BD%95%E6%89%B9%E9%87%8F%E6%94%B9%E6%96%87%E4%BB%B6%E5%90%8E%E7%BC%80%E5%92%8C%E5%9B%BE%E7%89%87%E5%83%8F%E7%B4%A0%E5%A4%A7%E5%B0%8F/3.jpg" style="zoom: 50%;"></p>
<p>本以为完美的落幕，然并卵再次上传，发现如下图的问题</p>
<p><img src="/2021/12/21/python%E5%A6%82%E4%BD%95%E6%89%B9%E9%87%8F%E6%94%B9%E6%96%87%E4%BB%B6%E5%90%8E%E7%BC%80%E5%92%8C%E5%9B%BE%E7%89%87%E5%83%8F%E7%B4%A0%E5%A4%A7%E5%B0%8F/0.jpg" style="zoom: 50%;"></p>
<p>继续盘他，写个脚本批量更改像素:</p>
<p>源码如下：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">from</span> PIL <span class="keyword">import</span> Image</span><br><span class="line"></span><br><span class="line">IPHONE5_WIDTH = <span class="number">530</span> <span class="comment">#改变后的宽</span></span><br><span class="line">IPHONE5_HEIGHT = <span class="number">300</span><span class="comment">#改变后的高</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 改变图片的尺寸大小</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">reset_pic_size</span><span class="params">(file_path, new_path, width=IPHONE5_WIDTH, height=IPHONE5_HEIGHT)</span>:</span></span><br><span class="line">    image = Image.open(file_path)</span><br><span class="line">    image_width, image_height = image.size</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> image_width &gt; width:</span><br><span class="line">        image_height = width * image_height // image_width</span><br><span class="line">        image_width = width</span><br><span class="line">    <span class="keyword">if</span> image_height &gt; height:</span><br><span class="line">        image_width = height * image_width // image_height</span><br><span class="line">        image_height = height</span><br><span class="line"></span><br><span class="line">    new_image = image.resize((image_width, image_height), Image.ANTIALIAS)  <span class="comment"># 滤镜缩放</span></span><br><span class="line">    new_image.save(new_path)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 从文件夹中循环改变每一张图片</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">find_and_resize_pic_from_dir</span><span class="params">(dir_path, new_path)</span>:</span></span><br><span class="line">    <span class="keyword">for</span> root, dirs, files <span class="keyword">in</span> os.walk(dir_path):</span><br><span class="line">        <span class="keyword">for</span> file_name <span class="keyword">in</span> files:</span><br><span class="line">            <span class="keyword">if</span> file_name.lower().endswith(<span class="string">'jpg'</span>) <span class="keyword">or</span> file_name.lower().endswith(<span class="string">'png'</span>):</span><br><span class="line">                file_path = os.path.join(root, file_name)</span><br><span class="line">                new_file_path = new_path + file_name</span><br><span class="line">                reset_pic_size(file_path=file_path, new_path=new_file_path)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    </span><br><span class="line">    file_new_path = <span class="string">r'C:\Users\XX\Desktop\公众号素材\new_'</span></span><br><span class="line">    find_and_resize_pic_from_dir(<span class="string">r'C:\Users\XX\Desktop\公众号素材'</span>, file_new_path)</span><br></pre></td></tr></table></figure>
<p>万事具备，看看能不能如愿上传：</p>
<p><img src="/2021/12/21/python%E5%A6%82%E4%BD%95%E6%89%B9%E9%87%8F%E6%94%B9%E6%96%87%E4%BB%B6%E5%90%8E%E7%BC%80%E5%92%8C%E5%9B%BE%E7%89%87%E5%83%8F%E7%B4%A0%E5%A4%A7%E5%B0%8F/1.png" style="zoom: 50%;"></p>
<p>完美</p>
]]></content>
      <categories>
        <category>python进阶</category>
      </categories>
  </entry>
  <entry>
    <title>深入浅出，JS原型链的工作原理和hook</title>
    <url>/2021/07/06/%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%EF%BC%8CJS%E5%8E%9F%E5%9E%8B%E9%93%BE%E7%9A%84%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86%E5%92%8Chook/</url>
    <content><![CDATA[<p>前言：原型链，即原型链条。它是由原型、原型的原型、原型的原型的原型…这一规则组合成的，经常被应用于继承。</p>
<a id="more"></a>
<p><strong>原型的作用</strong></p>
<p>在JS中，每个对象都有自己的原型。当我们访问对象的属性和方法时，JS会先访问对象本身的属性和方法。如果对象本身不包含这些属性和方法，则访问对象对应的原型。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Person</span>(<span class="params">name,age</span>)</span>&#123;</span><br><span class="line">    <span class="comment">// 对象自身的属性</span></span><br><span class="line">    <span class="keyword">this</span>.name = name;</span><br><span class="line">    <span class="keyword">this</span>.age = age;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 对象自身的方法</span></span><br><span class="line">    <span class="keyword">this</span>.sayName = <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        alert(<span class="keyword">this</span>.name);</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//原型上的方法</span></span><br><span class="line">Person.prototype.sayAge = <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    alert(<span class="keyword">this</span>.age)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> xiaoming = <span class="keyword">new</span> Person(<span class="string">"XiaoMing"</span>,<span class="number">12</span>);</span><br><span class="line"><span class="keyword">var</span> xiaoHong = <span class="keyword">new</span> Person(<span class="string">"XiaoHong"</span>,<span class="number">11</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 调用自身不存在的方法</span></span><br><span class="line">xiaoming.sayAge(); <span class="comment">// 12</span></span><br><span class="line">xiaoHong.sayAge(); <span class="comment">// 11</span></span><br></pre></td></tr></table></figure>
<p>上述例子中，方法“sayAge”是在原型上而非对象中。</p>
<p><a href="https://segmentfault.com/a/1190000016951069?utm_source=sf-similar-article" target="_blank" rel="noopener">浅谈JS中的构造函数、原型对象(prototype)、实例中的属性/方法之间的关系 - SegmentFault 思否</a></p>
<p>原型自身也是一个对象（默认情况下所有对象都是Object的实例)。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">alert(xiaoming instanceof Object); &#x2F;&#x2F; true </span><br><span class="line">alert(Person.prototype instanceof Object); &#x2F;&#x2F; true</span><br></pre></td></tr></table></figure>
<p>每个对象都有自己的原型，所以Person的原型也有它自己的原型，那就是：Object.prototype(部分浏览器允许通过实例的“<strong>proto</strong>”属性访问其原型)</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">alert(Person.prototype.__proto__ &#x3D;&#x3D; Object.prototype); &#x2F;&#x2F; true</span><br></pre></td></tr></table></figure>
<p>既然原型是一个对象，那么，当我们访问的属性和方法在原型不存在，就会继续访问原型的原型，直至Object.prototype。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Person</span>(<span class="params">name,age</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.name = name;</span><br><span class="line">    <span class="keyword">this</span>.age = age;</span><br><span class="line">    <span class="keyword">this</span>.sayName = <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        alert(<span class="keyword">this</span>.name);</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br><span class="line">Person.prototype.sayAge = <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    alert(<span class="keyword">this</span>.age)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 在Object.prototype增加一个“自我介绍”的方法</span></span><br><span class="line"><span class="built_in">Object</span>.prototype.introduce = <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;**</span><br><span class="line">    alert(<span class="string">"My name is "</span> + <span class="keyword">this</span>.name + <span class="string">",I'm "</span> + <span class="keyword">this</span>.age + <span class="string">" years old!"</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> xiaoming = <span class="keyword">new</span> Person(<span class="string">"XiaoMing"</span>,<span class="number">12</span>);</span><br><span class="line"><span class="comment">// 调用对象自身和原型上均不存在的方法</span></span><br><span class="line">xiaoming.introduce(); <span class="comment">// My name is XiaoMing,I'm 12 years old!</span></span><br></pre></td></tr></table></figure>
<p><img src="/2021/07/06/%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%EF%BC%8CJS%E5%8E%9F%E5%9E%8B%E9%93%BE%E7%9A%84%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86%E5%92%8Chook/1.png" alt="img"></p>
<p><strong>原型链hook案例一：</strong></p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="built_in">String</span>.prototype.split_bk = <span class="built_in">String</span>.prototype.split;</span><br><span class="line"><span class="built_in">String</span>.prototype.split = <span class="function"><span class="keyword">function</span> (<span class="params">val</span>) </span>&#123;</span><br><span class="line">    str = <span class="keyword">this</span>.toString()</span><br><span class="line">    <span class="keyword">debugger</span>;</span><br><span class="line">    <span class="keyword">return</span> str.split_bk(val)</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">a = <span class="string">"加密字符串"</span>;</span><br><span class="line">a.split(<span class="string">"加密"</span>)</span><br></pre></td></tr></table></figure>
<p><strong>*原型链hook案例二</strong></p>
<p><img src="/2021/07/06/%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%EF%BC%8CJS%E5%8E%9F%E5%9E%8B%E9%93%BE%E7%9A%84%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86%E5%92%8Chook/2.png" alt="image-20210706231047752"></p>
<p><strong>总结</strong></p>
<p>原型链是JS的一个特性，它实现的核心机制是：</p>
<p>1、访问对象的属性(方法)时，若对象本身不存在该属性(方法)，则会转向访问该对象的原型；</p>
<p>2、对象的原型也是一个对象。访问的属性(方法)依旧不存在于该原型，则会继续访问该原型的原型…</p>
<p>参考链接：<a href="https://segmentfault.com/a/1190000017254949" target="_blank" rel="noopener">https://segmentfault.com/a/1190000017254949</a></p>
]]></content>
      <categories>
        <category>逆向</category>
      </categories>
      <tags>
        <tag>逆向</tag>
        <tag>js</tag>
      </tags>
  </entry>
  <entry>
    <title>android设备指纹</title>
    <url>/2021/06/29/android%E8%AE%BE%E5%A4%87%E6%8C%87%E7%BA%B9/</url>
    <content><![CDATA[<p><strong>1　Android 设备指纹</strong></p>
<p>设备ID 需要兼具稳定性和唯一性，Android 系统的开源和碎片化导致API 函数实现各不相同，所以兼容性是Android 系统中设备指纹面临的最大挑战。表4.1列举了Android 系统中比较稳定的设备参数</p>
<a id="more"></a>
<p><img src="/2021/06/29/android%E8%AE%BE%E5%A4%87%E6%8C%87%E7%BA%B9/1.jpg" alt="img"></p>
<p>目前国内Android 6以上的手机占比已经超过了85%。由于考虑到用户的隐私，高版本Android 系统增加了设备信息采集的限制。</p>
<p><strong>2、Android Q 介绍（百度百科）：</strong></p>
<p>Android Q 是<a href="https://baike.baidu.com/item/谷歌/117920" target="_blank" rel="noopener">谷歌</a>公司在2019年推出的新一代<a href="https://baike.baidu.com/item/操作系统/192" target="_blank" rel="noopener">操作系统</a>。适用于<a href="https://baike.baidu.com/item/手机/6342" target="_blank" rel="noopener">手机</a>、平板电脑等移动终端设备 [1] 。Android Q的首个开发者预览版本（即测试版）在2019年3月14日发行并提供下载。正式版于2019年9月3日发行。此版本Android是各Android版本中，首次不用甜品来命名。该版本借助深色主题和手势导航打造应用体验。为确保用户隐私和安全支持新的保护措施。借助高性能编解码器、更出色的生物识别技术、更快的应用启动速度、Vulkan 1.1、NNAPI 1.2、可折叠设备和 5G 等更多功能扩展。</p>
<p>Android Q 于2019年9月份发布，出于对用户隐私的考虑，Android Q 限制了采集设备标识符，为Android 设备指纹带来了前所未有的挑战。Android Q 禁止非系统应用访问用户不可更改的ID，包括IMEI 号、Serial、USB 序列号等。系统Wi-Fi MAC 地址默认是随机生成的，不是固定的MAC 地址，以防止用户隐私被追踪。我们实际测试发现，IMEI、IMSI、Serial、Bluetooth MAC 都已无法获取参数，Wi-Fi MAC 获取不到真实值，但与BSSID 绑定。因此，Android Q 设备指纹的适配，不仅仅是采集函数的兼容，更重要的是设备ID 恢复逻辑（当用户修改手机某些信息时保持设备ID 不变的计算逻辑）的兼容。</p>
<p>从理论上来说，所有的采集项都是Android 系统公开的API，不可能在采集项被大面积篡改的情况下保持设备ID 不变。因此，设备指纹还需要对APP 运行环境进行监测，以识别异常环境。</p>
<p><strong>3、针对Android 作弊环境的检测方法可以归纳为以下5个方面：</strong></p>
<p>· 通过安装包检测安装的作弊工具。</p>
<p>· 通过特定特征识别root 环境。</p>
<p>· 使用多种方案采集同一字段信息。</p>
<p>· 通过通用性的作弊原理识别运行的作弊框架hook（Java/native）。</p>
<p>· 通过特定特征识别运行的作弊工具和模拟器。Android 黑产工具更新速度很快，样式层出不穷，需要通过黑产情报不断搜集最新的作弊方法。</p>
<p><strong>4、相关文章推荐：</strong></p>
<p><strong>Android唯一识别号（设备指纹）的生成及原理</strong></p>
<p><a href="https://blog.csdn.net/xiechengfa/article/details/70049409?utm_source=itdadao&amp;utm_medium=referral" target="_blank" rel="noopener">https://blog.csdn.net/xiechengfa/article/details/70049409?utm_source=itdadao&amp;utm_medium=referral</a></p>
<p><strong>Android硬件开发系列一指纹识别</strong></p>
<p><a href="https://blog.csdn.net/u010019468/article/details/70332710" target="_blank" rel="noopener">https://blog.csdn.net/u010019468/article/details/70332710</a></p>
<p><strong>Android 设备指纹</strong></p>
<p><a href="https://blog.csdn.net/DeckeDeng/article/details/78481423?locationNum=1&amp;fps=1" target="_blank" rel="noopener">https://blog.csdn.net/DeckeDeng/article/details/78481423?locationNum=1&amp;fps=1</a></p>
]]></content>
      <categories>
        <category>逆向</category>
      </categories>
      <tags>
        <tag>风控、 逆向</tag>
      </tags>
  </entry>
  <entry>
    <title>Python进阶之atexit模块使用</title>
    <url>/2021/06/12/Python%E8%BF%9B%E9%98%B6%E4%B9%8Batexit%E6%A8%A1%E5%9D%97%E4%BD%BF%E7%94%A8/</url>
    <content><![CDATA[<p>如何让程序退出时强行执行一段代码，说起这个需求，我们就不得不说<strong>Python atexit</strong>模块了：</p>
<a id="more"></a>
<p><strong>退出处理器</strong> <code>atexit</code> 模块定义了清理函数的注册和反注册函数. 被注册的函数会在解释器正常终止时执行. <code>atexit</code> 会按照注册顺序的<em>逆序</em>执行; 如果你注册了 <code>A</code>, <code>B</code> 和 <code>C</code>, 那么在解释器终止时会依序执行 <code>C</code>, <code>B</code>, <code>A</code>.</p>
<p>看完这段介绍，有点类似栈的原理，后进先出</p>
<p><strong>1、举个例子说明：</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">def goodbye(name, adjective):</span><br><span class="line">   print(&quot;Goodbye %s, it was %s to meet you.&quot;% (name, adjective))</span><br><span class="line"></span><br><span class="line">def hello():</span><br><span class="line">   print(&#39;hello world!&#39;)</span><br><span class="line"></span><br><span class="line">def a():</span><br><span class="line">   print(&#39;a&#39;)</span><br><span class="line"></span><br><span class="line">import atexit</span><br><span class="line">atexit.register(goodbye, &#39;Mr.Yang&#39;, &#39;nice&#39;)#3</span><br><span class="line">atexit.register(a)#2</span><br><span class="line">hello()#1正常程序首先被执行</span><br><span class="line"></span><br><span class="line">#执行顺序 1 2 3</span><br></pre></td></tr></table></figure>
<p><strong>运行结果</strong></p>
<p><img src="/2021/06/12/Python%E8%BF%9B%E9%98%B6%E4%B9%8Batexit%E6%A8%A1%E5%9D%97%E4%BD%BF%E7%94%A8/Python进阶之atexit模块使用\1.jpg" alt="图片"></p>
<p><strong>2、 作为 [decorator]: 使用，使用场景， 但是只适用于没有参数时调用</strong></p>
<p>举例说明，对上述代码稍作修改：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">import atexit</span><br><span class="line"></span><br><span class="line">def hello():</span><br><span class="line">   print(&#39;hello world!&#39;)</span><br><span class="line">@atexit.register</span><br><span class="line">def a():</span><br><span class="line">   print(&#39;a&#39;)</span><br><span class="line"></span><br><span class="line">hello()</span><br><span class="line"></span><br><span class="line">#运行结果</span><br><span class="line">#hello world!</span><br><span class="line">#a</span><br></pre></td></tr></table></figure>
<p> <strong>3、取消注册， 示例如下。</strong> </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">def goodbye(name, adjective):</span><br><span class="line">   print(&quot;Goodbye %s, it was %s to meet you.&quot;% (name, adjective))</span><br><span class="line"></span><br><span class="line">def hello():</span><br><span class="line">   print(&#39;hello world!&#39;)</span><br><span class="line"></span><br><span class="line">def a():</span><br><span class="line">   print(&#39;a&#39;)</span><br><span class="line"></span><br><span class="line">import atexit</span><br><span class="line">atexit.register(goodbye, &#39;Mr.Yang&#39;, &#39;nice&#39;)#3</span><br><span class="line">atexit.register(a)#2</span><br><span class="line">hello()#1正常程序首先被执行</span><br><span class="line">atexit.unregister(a)</span><br><span class="line">#正常执行顺序 1 2 3</span><br><span class="line"></span><br><span class="line">#由于设置了取消注册atexit.unregister(a)，</span><br><span class="line"></span><br><span class="line">#注销后执行顺序 1 3</span><br></pre></td></tr></table></figure>
<p><strong>运行结果：</strong></p>
<p><img src="/2021/06/12/Python%E8%BF%9B%E9%98%B6%E4%B9%8Batexit%E6%A8%A1%E5%9D%97%E4%BD%BF%E7%94%A8/Python进阶之atexit模块使用\2.jpg" alt="图片"></p>
<p>这个模块一般用来在程序结束时，做资源清理。</p>
<p><strong>应用场景一：</strong></p>
<p> 既能让程序报错，又能在报错已经还能运行<code>clean()</code>呢？</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">import atexit</span><br><span class="line"></span><br><span class="line">@atexit.register</span><br><span class="line">def clean():</span><br><span class="line">   print(&#39;清理环境相关的代码&#39;)</span><br><span class="line"></span><br><span class="line">def test():</span><br><span class="line">   example &#x3D; &#123;&quot;a&quot;: 1, &quot;b&quot;: 2&#125;</span><br><span class="line">   print(example[&quot;c&quot;])#程序报错</span><br><span class="line">test()</span><br></pre></td></tr></table></figure>
<p>运行结果：</p>
<p><img src="/2021/06/12/Python%E8%BF%9B%E9%98%B6%E4%B9%8Batexit%E6%A8%A1%E5%9D%97%E4%BD%BF%E7%94%A8/Python进阶之atexit模块使用\3.jpg" alt="图片"></p>
<p>这样一来，我们不需要显式调用<code>clean</code>函数了。无论程序正常结束，还是程序异常报错，<code>clean</code>函数里面的内容总会执行。</p>
<p><strong>*\</strong>官方文档*<em>：<a href="https://docs.python.org/zh-cn/3.7/library/atexit.html\**" target="_blank" rel="noopener">https://docs.python.org/zh-cn/3.7/library/atexit.html\**</a></em> </p>
<p><strong><em>*参考链接：\</em></strong><a href="https://mp.weixin.qq.com/s/lNwSBhcp9ktwgaGWpXNq-A*" target="_blank" rel="noopener">https://mp.weixin.qq.com/s/lNwSBhcp9ktwgaGWpXNq-A*</a></p>
]]></content>
      <categories>
        <category>python基础</category>
      </categories>
      <tags>
        <tag>python基础</tag>
      </tags>
  </entry>
  <entry>
    <title>使用NanoHTTPD反射调用加密函数（一）</title>
    <url>/2021/06/12/%E4%BD%BF%E7%94%A8NanoHTTPD%E5%8F%8D%E5%B0%84%E8%B0%83%E7%94%A8%E5%8A%A0%E5%AF%86%E5%87%BD%E6%95%B0/</url>
    <content><![CDATA[<p>利用NanoHTTPD反射调用Android APP加密函数，前奏之初识NanoHTTPD</p>
<a id="more"></a>
<h3 id="1-NanoHTTPD介绍"><a href="#1-NanoHTTPD介绍" class="headerlink" title="1.NanoHTTPD介绍"></a>1.NanoHTTPD介绍</h3><p>什么是NanoHTTPD？NanoHTTPD是一个免费、轻量级的(只有一个Java文件) HTTP服务器，可以很好地嵌入到Java程序中。支持 GET, POST, PUT等请求，支持文件上传，占用内存很小。</p>
<p>项目地址：<a href="https://github.com/NanoHttpd/nanohttpd" target="_blank" rel="noopener">https://github.com/NanoHttpd/nanohttpd</a></p>
<h3 id="2-如何嵌入？"><a href="#2-如何嵌入？" class="headerlink" title="2. 如何嵌入？"></a>2. 如何嵌入？</h3><ol>
<li>在build.gradle中增加一个依赖（已经懒到一定境界了，能自动的，绝不手动下载配置）：</li>
</ol>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">compile &#39;org.nanohttpd:nanohttpd:2.2.0&#39;</span><br></pre></td></tr></table></figure>
<ol>
<li>在包里增加一个java文件：AndroidWebServer.java`：</li>
</ol>
<p><strong>3、打开“app/src/main/AndroidManifest.xml”，在manifest标签中加入网络权限的声明，不加会报“java.net.SocketException: socket failed: EACCES ”异常错误</strong></p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">uses-permission</span> <span class="attr">android:name</span>=<span class="string">"android.permission.INTERNET"</span> /&gt;</span></span><br></pre></td></tr></table></figure>
<p><strong>4、编写NanoHTTPD的server服务</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.ceshi;</span><br><span class="line"><span class="keyword">import</span> fi.iki.elonen.NanoHTTPD;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="comment">//自定义一个Server继承NanoHTTPD</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AndroidWebServer</span> <span class="keyword">extends</span> <span class="title">NanoHTTPD</span> </span>&#123;</span><br><span class="line">    <span class="comment">//构造函数 赋值父类</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">AndroidWebServer</span><span class="params">(<span class="keyword">int</span> port)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(port);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Response <span class="title">serve</span><span class="params">(IHTTPSession session)</span> </span>&#123;</span><br><span class="line">        String msg = <span class="string">"&lt;html&gt;&lt;body&gt;&lt;h1&gt;Hello AutoPy&lt;/h1&gt;\n"</span>;</span><br><span class="line">        Map&lt;String, String&gt; parms = session.getParms();</span><br><span class="line">        <span class="keyword">if</span> (parms.get(<span class="string">"code"</span>) == <span class="keyword">null</span>) &#123;</span><br><span class="line">            msg += <span class="string">"&lt;form action='?' method='get'&gt;\n  &lt;p&gt;Your code: &lt;input type='text' name='code'&gt;&lt;/p&gt;\n"</span> + <span class="string">"&lt;/form&gt;\n"</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            msg += <span class="string">"&lt;p&gt;Hello, "</span> + parms.get(<span class="string">"code"</span>) + <span class="string">"!&lt;/p&gt;"</span>;</span><br><span class="line">            <span class="keyword">return</span> newFixedLengthResponse(msg + <span class="string">"&lt;/body&gt;&lt;/html&gt;\n"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> newFixedLengthResponse(msg + <span class="string">"&lt;/body&gt;&lt;/html&gt;\n"</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>5、在MainActivity类中编写如下代码，启用NanoHTTPD服务</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.ceshi;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> androidx.appcompat.app.AppCompatActivity;</span><br><span class="line"><span class="keyword">import</span> android.os.Bundle;</span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> <span class="keyword">extends</span> <span class="title">AppCompatActivity</span> </span>&#123;</span><br><span class="line">    AndroidWebServer http = <span class="keyword">new</span> AndroidWebServer(<span class="number">9988</span>);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MainActivity</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_main);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            http.start();</span><br><span class="line">            System.out.println(<span class="string">"服务启动完成"</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            System.out.println(<span class="string">"服务启动错误"</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//安卓销毁事件</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onDestroy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onDestroy();</span><br><span class="line">        http.stop();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>6、启动app</strong></p>
<p><strong>7、端口转发</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">adb forward tcp:9988 tcp:9988</span><br></pre></td></tr></table></figure>
<p><strong>8、调用接口</strong></p>
<p><img src="/2021/06/12/%E4%BD%BF%E7%94%A8NanoHTTPD%E5%8F%8D%E5%B0%84%E8%B0%83%E7%94%A8%E5%8A%A0%E5%AF%86%E5%87%BD%E6%95%B0/1.png" alt></p>
<p><strong>输入ss回车：</strong></p>
<p><img src="/2021/06/12/%E4%BD%BF%E7%94%A8NanoHTTPD%E5%8F%8D%E5%B0%84%E8%B0%83%E7%94%A8%E5%8A%A0%E5%AF%86%E5%87%BD%E6%95%B0/2.png" alt></p>
<p><strong>参考文章;</strong></p>
<p>安卓NanoHTTPD的快速入门</p>
<p><a href="https://blog.csdn.net/u013738666/article/details/104776840" target="_blank" rel="noopener">https://blog.csdn.net/u013738666/article/details/104776840</a></p>
]]></content>
      <categories>
        <category>逆向</category>
      </categories>
      <tags>
        <tag>逆向，NanoHTTPD</tag>
      </tags>
  </entry>
  <entry>
    <title>androidStudio建立的项目没有libs目录</title>
    <url>/2021/06/11/androidStudio%E5%BB%BA%E7%AB%8B%E7%9A%84%E9%A1%B9%E7%9B%AE%E6%B2%A1%E6%9C%89libs%E7%9B%AE%E5%BD%95/</url>
    <content><![CDATA[<p>ndroid studio建立的项目没有libs目录<br>有时候建立新项目，没有看到lib文件夹，但是文件目录里又有</p>
<a id="more"></a>
<p>android studio建立的项目没有libs目录<br>有时候建立新项目，没有看到lib文件夹，但是文件目录里又有<br><img src="/2021/06/11/androidStudio%E5%BB%BA%E7%AB%8B%E7%9A%84%E9%A1%B9%E7%9B%AE%E6%B2%A1%E6%9C%89libs%E7%9B%AE%E5%BD%95/androidStudio建立的项目没有libs目录\1.jpg" alt><br><img src="/2021/06/11/androidStudio%E5%BB%BA%E7%AB%8B%E7%9A%84%E9%A1%B9%E7%9B%AE%E6%B2%A1%E6%9C%89libs%E7%9B%AE%E5%BD%95/androidStudio建立的项目没有libs目录\2.jpg" alt></p>
<p><strong>原因是显示目录的原因，切换成Project就可以了</strong><br><img src="/2021/06/11/androidStudio%E5%BB%BA%E7%AB%8B%E7%9A%84%E9%A1%B9%E7%9B%AE%E6%B2%A1%E6%9C%89libs%E7%9B%AE%E5%BD%95/androidStudio建立的项目没有libs目录\3.jpg" alt></p>
]]></content>
      <categories>
        <category>逆向</category>
      </categories>
      <tags>
        <tag>逆向，AndroidStudio</tag>
      </tags>
  </entry>
  <entry>
    <title>python进阶之上下文管理器</title>
    <url>/2021/06/10/%E8%BF%9B%E9%98%B6%E4%B9%8B%E4%B8%8A%E4%B8%8B%E6%96%87%E7%AE%A1%E7%90%86%E5%99%A8/</url>
    <content><![CDATA[<p><strong>一、文管理器作用</strong>：</p>
<p>上下⽂管理器允许你在有需要的时候，精确地分配和释放资源。</p>
<a id="more"></a>
<p><strong>二、案例介绍：</strong></p>
<p>对它使⽤最⼴泛的案例就是with语句了。想象下当你有两个相关操作，你想让它们结对执⾏，然后在它们俩中间放置⼀段代码。</p>
<p>上下⽂管理器就是专门让你做这个事情的。举个例⼦：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">with</span> open(<span class="string">'some_file'</span>, <span class="string">'w'</span>) <span class="keyword">as</span> opened_file: </span><br><span class="line">  opened_file.write(<span class="string">'Hola!'</span>)</span><br></pre></td></tr></table></figure>
<p>上⾯这段代码打开了⼀个⽂件，往它⾥⾯写⼊了⼀些数据，然后关闭了它。如果在往⽂件</p>
<p>写数据时发⽣异常，它会尝试去关闭⽂件。上⾯那段代码与这⼀段是等价的：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">file = open(<span class="string">'some_file'</span>, <span class="string">'w'</span>) </span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line"></span><br><span class="line">  file.write(<span class="string">'Hola!'</span>) </span><br><span class="line"><span class="keyword">finally</span>: </span><br><span class="line">  file.close()</span><br></pre></td></tr></table></figure>
<p>对比两个功能一样的代码，相比较之下，with 代码更简洁，去掉了很多样板代码，它确保我们的⽂件会被关闭。</p>
<p><strong>三、使用上下文管理器with的优点：</strong></p>
<p>（1）使用with语句的目的就是把代码块放入with中执行，with结束后，自动完成清理工作，无须手动干预。</p>
<p>（2）在需要管理一些资源比如文件，网络连接和锁的编程环境中，可以在<strong>exit</strong>中定制自动释放资源的机制，你无须再去关系这个问题，这将大有用处。</p>
<p><strong>四、如何上下文管理器</strong>：</p>
<p><strong>1、基于类的实现</strong></p>
<p>⼀个上下⽂管理器的类，最起码要定义<strong>enter</strong>和<strong>exit</strong>⽅法。</p>
<p>让我们来构造我们⾃⼰的⽂件开启的上下⽂管理器，并学习下基础知识。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">File</span><span class="params">(object)</span>:</span> </span><br><span class="line">      <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, file_name, method)</span>:</span></span><br><span class="line">          self.file_obj = open(file_name, method) </span><br><span class="line">      <span class="function"><span class="keyword">def</span> <span class="title">__enter__</span><span class="params">(self)</span>:</span></span><br><span class="line">          <span class="keyword">return</span> self.file_obj </span><br><span class="line">      <span class="function"><span class="keyword">def</span> <span class="title">__exit__</span><span class="params">(self, type, value, traceback)</span>:</span></span><br><span class="line">          self.file_obj.close()</span><br></pre></td></tr></table></figure>
<p>通过定义<strong>enter</strong>和<strong>exit</strong>⽅法，我们可以在with语句⾥使⽤它。我们来试试：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">with</span> File(<span class="string">'demo.txt'</span>, <span class="string">'w'</span>) <span class="keyword">as</span> opened_file: </span><br><span class="line">  opened_file.write(<span class="string">'Hola!'</span>)</span><br></pre></td></tr></table></figure>
<p>我们的<strong>exit</strong>函数接受三个参数。这些参数对于每个上下⽂管理器类中的<strong>exit</strong> </p>
<p>⽅法都是必须的。我们来谈谈在底层都发⽣了什么。</p>
<ol>
<li><p>with语句先暂存了File类的<strong>exit</strong>⽅法</p>
</li>
<li><p>然后它调⽤File类的<strong>enter</strong>⽅法</p>
</li>
<li><p><strong>enter</strong>⽅法打开⽂件并返回给with语句</p>
</li>
<li><p>打开的⽂件句柄被传递给opened_file参数</p>
</li>
<li><p>我们使⽤.write()来写⽂件</p>
</li>
<li><p>with语句调⽤之前暂存的<strong>exit</strong>⽅法</p>
</li>
<li><p><strong>exit</strong>⽅法关闭了⽂件</p>
</li>
</ol>
<p><strong>（**</strong>1） 如何处理异常** </p>
<p>我们还没有谈到<strong>exit</strong>⽅法的这三个参数：type, value和traceback。</p>
<p>在第4步和第6步之间，如果发⽣异常，Python会将异常的type,value和traceback传递</p>
<p>到<strong>exit</strong>⽅法。</p>
<p>它让<strong>exit</strong>⽅法来决定如何关闭⽂件以及是否需要其他步骤。在我们的案例中，我们</p>
<p>并没有注意它们。</p>
<p>那如果我们的⽂件对象抛出⼀个异常呢？万⼀我们尝试访问⽂件对象的⼀个不⽀持的⽅</p>
<p>法。举个例⼦：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">with</span> File(<span class="string">'demo.txt'</span>, <span class="string">'w'</span>) <span class="keyword">as</span> opened_file: </span><br><span class="line">    opened_file.undefined_function(<span class="string">'Hola!'</span>)</span><br></pre></td></tr></table></figure>
<p>我们来列⼀下，当异常发⽣时，with语句会采取哪些步骤。</p>
<ol>
<li><p>它把异常的type,value和traceback传递给<strong>exit</strong>⽅法</p>
</li>
<li><p>它让<strong>exit</strong>⽅法来处理异常</p>
</li>
<li><p>如果<strong>exit</strong>返回的是True，那么这个异常就被优雅地处理了。</p>
</li>
<li><p>如果<strong>exit</strong>返回的是True以外的任何东西，那么这个异常将被with语句抛出</p>
</li>
</ol>
<p>（<strong>2）怎么优雅的去处理异常：</strong></p>
<p>看到处理异常那里，我们仅仅就是在发生异常时，文件能正常被关闭，不需要抛出异常</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">__exit__</span><span class="params">(self, type, value, traceback)</span>:</span> </span><br><span class="line">    print(<span class="string">"Exception has been handled"</span>) </span><br><span class="line">    self.file_obj.close() </span><br><span class="line">    <span class="keyword">return</span> <span class="literal">True</span></span><br></pre></td></tr></table></figure>
<p>我们仅仅return True，这么做就可以了</p>
<p><strong>完整代码：</strong></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Open</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, filepath, mode=<span class="string">'r'</span>, encoding=<span class="string">'utf-8'</span>)</span>:</span></span><br><span class="line">        self.filepath = filepath</span><br><span class="line">        self.mode = mode</span><br><span class="line">        self.encoding = encoding</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__enter__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="comment"># print('enter')</span></span><br><span class="line">        self.f = open(self.filepath, mode=self.mode, encoding=self.encoding)</span><br><span class="line">        <span class="keyword">return</span> self.f</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__exit__</span><span class="params">(self, exc_type, exc_val, exc_tb)</span>:</span></span><br><span class="line">        <span class="comment"># print('exit')</span></span><br><span class="line">        self.f.close()</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__getattr__</span><span class="params">(self, item)</span>:</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> getattr(self.f, item)</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> Open(<span class="string">'a.txt'</span>,<span class="string">'w'</span>) <span class="keyword">as</span> f:</span><br><span class="line">    print(f)</span><br><span class="line">    f.write(<span class="string">'aaaaaa'</span>)</span><br><span class="line">    <span class="comment">#f.wasdf() #抛出异常，交给__exit__处理</span></span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>python基础</category>
      </categories>
      <tags>
        <tag>python基础</tag>
      </tags>
  </entry>
  <entry>
    <title>如何抓取国外网站、app的包</title>
    <url>/2021/06/10/%E5%A6%82%E4%BD%95%E6%8A%93%E5%8F%96%E5%9B%BD%E5%A4%96%E7%BD%91%E7%AB%99%E3%80%81app%E7%9A%84%E5%8C%85/</url>
    <content><![CDATA[<p><strong>前期准备：</strong></p>
<p>  配置好的Charles抓包工具，（可以抓正常国内的APP端和网页端的包）</p>
<p>  设置好的vpn，（可以访问国外的网站）</p>
<a id="more"></a>
<p><strong>操作环境</strong>：以windows为例</p>
<p>打开vpn后，我们访问一下国外的网站，测试一下vpn访问是否正常</p>
<p><img src="/2021/06/10/%E5%A6%82%E4%BD%95%E6%8A%93%E5%8F%96%E5%9B%BD%E5%A4%96%E7%BD%91%E7%AB%99%E3%80%81app%E7%9A%84%E5%8C%85/1.jpg" alt></p>
<p>我习惯直接访问网站测试，大家也可以使用下图所示测试：</p>
<p><img src="/2021/06/10/%E5%A6%82%E4%BD%95%E6%8A%93%E5%8F%96%E5%9B%BD%E5%A4%96%E7%BD%91%E7%AB%99%E3%80%81app%E7%9A%84%E5%8C%85/2.jpg" alt></p>
<p>访问正常，我们打开Chrome游览器的代理设置，显示如下图所示：</p>
<p><img src="/2021/06/10/%E5%A6%82%E4%BD%95%E6%8A%93%E5%8F%96%E5%9B%BD%E5%A4%96%E7%BD%91%E7%AB%99%E3%80%81app%E7%9A%84%E5%8C%85/3.jpg" alt></p>
<p>图一</p>
<p><strong>1、配置抓取网站的数据包</strong></p>
<p>准备工作做好，接下来开始配置Charles抓包工具：</p>
<p><img src="/2021/06/10/%E5%A6%82%E4%BD%95%E6%8A%93%E5%8F%96%E5%9B%BD%E5%A4%96%E7%BD%91%E7%AB%99%E3%80%81app%E7%9A%84%E5%8C%85/4.jpg" alt></p>
<p>依次点击之后我看到如下界面，填入图一的信息并勾选截图选项点击确定：</p>
<p><img src="/2021/06/10/%E5%A6%82%E4%BD%95%E6%8A%93%E5%8F%96%E5%9B%BD%E5%A4%96%E7%BD%91%E7%AB%99%E3%80%81app%E7%9A%84%E5%8C%85/5.jpg" alt></p>
<p>点击ok之后，我们打开我们的国外目标网站，抓包测试一下：</p>
<p><img src="/2021/06/10/%E5%A6%82%E4%BD%95%E6%8A%93%E5%8F%96%E5%9B%BD%E5%A4%96%E7%BD%91%E7%AB%99%E3%80%81app%E7%9A%84%E5%8C%85/如何抓取国外网站、app的包\7.jpg" alt="图片"></p>
<p>如图所示我们已经可以抓到包了</p>
<p><strong>2、接下来我们测试抓取手机端的数据包：</strong></p>
<p>手机设置好代理之后</p>
<p>我们查询一下ip，如图所示</p>
<p><img src="/2021/06/10/%E5%A6%82%E4%BD%95%E6%8A%93%E5%8F%96%E5%9B%BD%E5%A4%96%E7%BD%91%E7%AB%99%E3%80%81app%E7%9A%84%E5%8C%85/6.jpg" alt></p>
<p>ok，接下来我么就可以抓取手机的app了</p>
]]></content>
      <categories>
        <category>抓包</category>
      </categories>
      <tags>
        <tag>抓包，</tag>
      </tags>
  </entry>
  <entry>
    <title>python抽象类原理以及编写</title>
    <url>/2021/06/09/%E6%8A%BD%E8%B1%A1%E7%B1%BB%E5%8E%9F%E7%90%86%E4%BB%A5%E5%8F%8A%E7%BC%96%E5%86%99/</url>
    <content><![CDATA[<p><strong>前言：</strong></p>
<p>好久没写文章了，今天来给大家更新一篇，最近会陆续整理，发出一下以前做的笔记</p>
<a id="more"></a>
<p><strong>1.抽象类概念</strong></p>
<p>抽象类是一个特殊的类，只能被继承，不能实例化</p>
<p><strong>2.为什么要有抽象类</strong></p>
<p>其实在未接触抽象类概念时，我们可以构造香蕉、苹果、梨之类的类，然后让它们继承水果这个的基类，水果的基类包含一个eat函数。</p>
<p>但是你有没有想过，我们可以将香蕉、苹果、梨实例化，去吃香蕉、苹果、梨。但是我们却不能将水果实例化，因为我们无法吃到叫水果的这个东西。</p>
<p>所以抽象类中只能有抽象方法（没有实现功能），该类不能被实例化，只能被继承，且子类必须实现抽象方法。</p>
<p><strong>3.抽象类的作用</strong></p>
<p>在不同的模块中通过抽象基类来调用，可以用最精简的方式展示出代码之间的逻辑关系，让模块之间的依赖清晰简单。</p>
<p>抽象类的编程，让每个人可以关注当前抽象类的方法和描述，而不需要考虑过多的实现细节，这对协同开发有很大意义，也让代码可读性更高。</p>
<p>Python 自带的abc模块用于实现抽象类相关的定义和操作。</p>
<p>我们通过一个简单的例子来说明，如何在 Python 中实现抽象类：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">from</span> abc <span class="keyword">import</span> ABC, abstractmethod</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">People</span><span class="params">(ABC)</span>:</span></span><br><span class="line"><span class="meta">    @abstractmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">walk</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">    </span><br><span class="line"><span class="meta">    @abstractmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">eat</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">dance</span><span class="params">(self)</span>:</span></span><br><span class="line">        print(<span class="string">'我正在跳舞'</span>)</span><br></pre></td></tr></table></figure>
<p>从abc模块导入ABC类，和abstractmethod抽象方法装饰器。基于ABC类可以实现一个抽象类。通过@abstractmethod装饰一个方法，让它成为一个抽象方法。抽象方法在子类中必需被实现。</p>
<p>注意：</p>
<p>抽象类不能被实例化，所以我们实例化一下，可以看到这里报错了</p>
<p><img src="\抽象类原理以及编写\1.jpg" alt></p>
<p>我们再看一下，如果继承抽象类，但是没有实现其中的某个抽象方法，也会导致报错</p>
<p><img src="\抽象类原理以及编写\2.jpg" alt></p>
<p>抽象类People中的dance不是抽象方法，所以子类不需要覆盖。</p>
<p><strong>总结：</strong></p>
<p>抽象类是软件开发中一个非常重要的概念，通过定义抽象类，我们可以约定子类必需实现的方法。当我们一个类有几十上百个方法时，用抽象方法来防止子类漏掉某些方法是非常方便的做法。</p>
<p><strong>完整代码</strong></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">from</span> abc <span class="keyword">import</span> ABC, abstractmethod</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">People</span><span class="params">(ABC)</span>:</span></span><br><span class="line"><span class="meta">    @abstractmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">walk</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="meta">    @abstractmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">eat</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">dance</span><span class="params">(self)</span>:</span></span><br><span class="line">        print(<span class="string">'我正在跳舞'</span>)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">kid1</span><span class="params">(People)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">walk</span><span class="params">(self)</span>:</span></span><br><span class="line">        print(<span class="string">'走路'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">eat</span><span class="params">(self)</span>:</span></span><br><span class="line">        print(<span class="string">'吃饭'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    k = kid1()</span><br><span class="line">    k.dance()</span><br><span class="line">    k.eat()</span><br><span class="line">    k.walk()</span><br></pre></td></tr></table></figure>
<p><img src="\抽象类原理以及编写\3.jpg" alt></p>
<p>如果文章对你有用，记得分享和关注，菜鸟童靴公众号</p>
<p><img src="\抽象类原理以及编写\4.jpg" alt></p>
]]></content>
      <categories>
        <category>python基础</category>
      </categories>
      <tags>
        <tag>python基础</tag>
      </tags>
  </entry>
  <entry>
    <title>Python进阶之闭包和作用域</title>
    <url>/2021/06/09/Python%E8%BF%9B%E9%98%B6%E4%B9%8B%E9%97%AD%E5%8C%85%E5%92%8C%E4%BD%9C%E7%94%A8%E5%9F%9F%E2%80%8B/</url>
    <content><![CDATA[<p><strong>前言：</strong></p>
<p>好久没写文章了，今天来给大家更新一篇，最近会陆续整理，发出一下以前做的笔记</p>
<a id="more"></a>
<p><strong>作用域</strong>：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">g_count = <span class="number">0</span>  <span class="comment"># 全局作用域</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">outer</span><span class="params">()</span>:</span></span><br><span class="line">    o_count = <span class="number">1</span>  <span class="comment"># 闭包函数外的函数中</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">inner</span><span class="params">()</span>:</span></span><br><span class="line">        i_count = <span class="number">2</span>  <span class="comment"># 局部作用域</span></span><br></pre></td></tr></table></figure>
<p>Python 中只有模块（module），类（class）以及函数（def、lambda）才会引入新的作用域，其它的代码块</p>
<p>（如 if/elif/else/、try/except、for/while等）是不会引入新的作用域的，也就是说这些语句内定义的变量，外部也可以访问，</p>
<p>如下代码：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="literal">True</span>:</span><br><span class="line">    msg = <span class="string">'I am from beijing'</span></span><br><span class="line">print(msg)</span><br><span class="line">//运行结果 I am <span class="keyword">from</span> beijing</span><br></pre></td></tr></table></figure>
<p><strong>全局变量和局部变量</strong></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">total = <span class="number">0</span>  <span class="comment"># 全局变量</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">sum</span><span class="params">(arg1, arg2)</span>:</span></span><br><span class="line">    total = arg1 + arg2  <span class="comment"># total在这里是局部变量.</span></span><br><span class="line">    <span class="keyword">return</span> total</span><br><span class="line">print(total)<span class="comment">#函数外是全局变量total</span></span><br><span class="line">total = sum(<span class="number">10</span>, <span class="number">20</span>)</span><br><span class="line">print(total)<span class="comment">#局部变量total</span></span><br></pre></td></tr></table></figure>
<h3 id="global-和-nonlocal关键字"><a href="#global-和-nonlocal关键字" class="headerlink" title="global 和 nonlocal关键字"></a>global 和 nonlocal关键字</h3><p>当内部作用域想修改外部作用域的变量时</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">num = <span class="number">1</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">fun1</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">global</span> num  <span class="comment"># 需要使用 global 关键字声明</span></span><br><span class="line">    print(num) </span><br><span class="line">    num = <span class="number">123</span></span><br><span class="line">    print(num)</span><br><span class="line">fun1()</span><br><span class="line">print(num)</span><br><span class="line"><span class="comment">#结果</span></span><br><span class="line"><span class="comment">#1</span></span><br><span class="line"><span class="comment">#123</span></span><br><span class="line"><span class="comment">#123</span></span><br></pre></td></tr></table></figure>
<p>如果要修改嵌套作用域（非全局作用域）中的变量则需要 nonlocal 关键字了 ，仅读取就无所谓了</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">lazy_sum</span><span class="params">(*args)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">sum</span><span class="params">()</span>:</span></span><br><span class="line">        ax = <span class="number">0</span></span><br><span class="line">        <span class="keyword">for</span> n <span class="keyword">in</span> args:</span><br><span class="line">            ax += n</span><br><span class="line">        <span class="keyword">return</span> ax</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> sum</span><br><span class="line"></span><br><span class="line">s = lazy_sum(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>)</span><br><span class="line">print(s, type(s),s(),sep=<span class="string">'\n'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Output&gt;&gt;&gt;</span></span><br><span class="line">&lt;function lazy_sum.&lt;locals&gt;.sum at <span class="number">0x10768ed90</span>&gt;</span><br><span class="line">&lt;<span class="class"><span class="keyword">class</span> '<span class="title">function</span>'&gt;</span></span><br><span class="line"><span class="class">15</span></span><br></pre></td></tr></table></figure>
<p><strong>进入正题：</strong></p>
<p><strong>闭包</strong></p>
<p> 在函数嵌套的程序结构中，如果内层函数包含对外层函数局部变量的引用，同时外层函数的返回结果又是对内层函数的引用，这就构成了一个闭包。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">lazy_sum</span><span class="params">(*args)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">sum</span><span class="params">()</span>:</span></span><br><span class="line">        ax = <span class="number">0</span></span><br><span class="line">        <span class="keyword">for</span> n <span class="keyword">in</span> args:</span><br><span class="line">            ax += n</span><br><span class="line">        <span class="keyword">return</span> ax</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> sum</span><br><span class="line"></span><br><span class="line">s = lazy_sum(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>)</span><br><span class="line">print(s, type(s),s(),sep=<span class="string">'\n'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Output&gt;&gt;&gt;</span></span><br><span class="line">&lt;function lazy_sum.&lt;locals&gt;.sum at <span class="number">0x10768ed90</span>&gt;</span><br><span class="line">&lt;<span class="class"><span class="keyword">class</span> '<span class="title">function</span>'&gt;</span></span><br><span class="line"><span class="class">15</span></span><br></pre></td></tr></table></figure>
<p>在上面的代码中，我们在外层函数<code>lazy_sum</code>中又嵌套了的内层函数<code>sum</code>，<code>sum</code>引用了<code>lazy_sum</code>的参数，并且<code>lazy_sum</code> 将<code>sum</code> 作为返回结果。如果是按照命令式语言的规则（如C++，C#），在执行<code>sum</code>函数时，会由于在其作用域内找不到<code>args</code>变量而出错，但是在函数式语言中，<strong>当内嵌的函数体内有引用外部作用域的变量时，将会把定义时涉及到的引用环境和函数体打包成一个整体返回</strong>，这中程序结构就是上面说的”闭包(Closure)”。所以说，闭包就是由函数及其相关的引用环境组合而成的实体，即：闭包=函数+引用环境。</p>
<p>从运行结果中可以看到，当调用<code>lazy_sum(*args)</code>时，返回的是内部求和函数的引用地址，当调用函数<code>sum()</code> 时，才真正计算求和的结果。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">s1 = lazy_sum(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>)</span><br><span class="line">s2 = lazy_sum(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>)</span><br><span class="line">print(s1==s2)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Output&gt;&gt;&gt;</span></span><br><span class="line"><span class="literal">False</span></span><br></pre></td></tr></table></figure>
<p>我们使 用<code>nonlocal</code> 关键字 对上面的代码进行更改一下</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">lazy_sum</span><span class="params">(*args)</span>:</span></span><br><span class="line">    ax = <span class="number">0</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">sum</span><span class="params">()</span>:</span></span><br><span class="line">        <span class="keyword">nonlocal</span> ax</span><br><span class="line">        <span class="keyword">for</span> n <span class="keyword">in</span> args:</span><br><span class="line">            ax += n</span><br><span class="line">        <span class="keyword">return</span> ax</span><br><span class="line">    <span class="keyword">return</span> sum</span><br><span class="line"></span><br><span class="line">s = lazy_sum(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>)</span><br><span class="line">print(s, type(s), s(), sep=<span class="string">'\n'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Output&gt;&gt;&gt;</span></span><br><span class="line">&lt;function lazy_sum.&lt;locals&gt;.sum at <span class="number">0x000001B0D80612F0</span>&gt;</span><br><span class="line">&lt;<span class="class"><span class="keyword">class</span> '<span class="title">function</span>'&gt;</span></span><br><span class="line"><span class="class">15</span></span><br></pre></td></tr></table></figure>
<p><strong>闭包的应用场景：</strong></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UrlTemplate</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, template)</span>:</span></span><br><span class="line">        self.template = template</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">openr</span><span class="params">(self, **kwargs)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self.template.format_map(kwargs)</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line"><span class="comment"># 上面的类可以被一个更简单的函数代替</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">url_template</span><span class="params">(template)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">openr</span><span class="params">(**kwargs)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> template.format_map(kwargs)</span><br><span class="line">    <span class="keyword">return</span> openr</span><br><span class="line"></span><br><span class="line">root_url = url_template(<span class="string">'https://www.jianshu.com/search?q=&#123;name&#125;&amp;page=&#123;page&#125;&amp;type=&#123;type&#125;'</span>)</span><br><span class="line"></span><br><span class="line">print(root_url(name=<span class="string">'sss'</span>, page=<span class="string">'1'</span>, type=<span class="string">'note'</span>))</span><br></pre></td></tr></table></figure>
<p><strong>总结</strong></p>
<p>使用一个内部函数或者闭包的方案通常会更优雅一些。简单来讲，一个闭包就是一个函数，只不过在函数内部带上了一个额外的变量环境。闭包关键特点就是它会记住自己被定义时的环境。因此，在我们的解决方案中，opener() 函数记住了template参数的值，并在接下来的调用中使用它。任何时候只要碰到需要给某个函数增加额外的状态信息的问题，都可以考虑使用闭包。相比将函数转换成一个类而言，闭包通常是一种更加简洁和优雅的方案。</p>
<p><strong><em>参考链接：\</em></strong></p>
<p><em><a href="https://www.jianshu.com/p/77d78d84a69c" target="_blank" rel="noopener">https://www.jianshu.com/p/77d78d84a69c</a></em></p>
]]></content>
      <categories>
        <category>python基础</category>
      </categories>
      <tags>
        <tag>python基础</tag>
        <tag>面试集锦</tag>
      </tags>
  </entry>
  <entry>
    <title>Hook框架xposed的简单demo</title>
    <url>/2021/06/07/Hook%E6%A1%86%E6%9E%B6xposed%E7%9A%84%E7%AE%80%E5%8D%95demo/</url>
    <content><![CDATA[<p>简介：Xposed框架是一款可以在不修改APK的情况下影响程序运行的框架服务，通过替换/system/bin/app_process程序控制zygote进程，使得app_process在启动过程中会加载XposedBridge.jar这个jar包，从而完成对Zygote进程及其创建的虚拟机的劫持。<br>Github地址：<a href="https://github.com/rovo89/Xposed" target="_blank" rel="noopener">https://github.com/rovo89/Xposed</a></p>
<a id="more"></a>
<h4 id="1、编写hook的app-例子："><a href="#1、编写hook的app-例子：" class="headerlink" title="1、编写hook的app 例子："></a>1、编写hook的app 例子：</h4><h5 id="（1）-建立一个空工程，编写一个登陆界面，用自定义的一个方法"><a href="#（1）-建立一个空工程，编写一个登陆界面，用自定义的一个方法" class="headerlink" title="（1）.建立一个空工程，编写一个登陆界面，用自定义的一个方法"></a>（1）.建立一个空工程，编写一个登陆界面，用自定义的一个方法</h5><p><img src="/2021/06/07/Hook%E6%A1%86%E6%9E%B6xposed%E7%9A%84%E7%AE%80%E5%8D%95demo/3.png" alt></p>
<p><strong>代码如下</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;EditText</span><br><span class="line">       android:id&#x3D;&quot;@+id&#x2F;et1&quot;</span><br><span class="line">       android:layout_width&#x3D;&quot;wrap_content&quot;</span><br><span class="line">       android:layout_height&#x3D;&quot;wrap_content&quot;</span><br><span class="line">       android:layout_marginStart&#x3D;&quot;24dp&quot;</span><br><span class="line">       android:layout_marginTop&#x3D;&quot;96dp&quot;</span><br><span class="line">       android:layout_marginEnd&#x3D;&quot;24dp&quot;</span><br><span class="line">       android:hint&#x3D;&quot;zhanghao&quot;</span><br><span class="line">       android:inputType&#x3D;&quot;textEmailAddress&quot;</span><br><span class="line">       android:selectAllOnFocus&#x3D;&quot;true&quot;</span><br><span class="line">       app:layout_constraintEnd_toEndOf&#x3D;&quot;parent&quot;</span><br><span class="line">       app:layout_constraintStart_toStartOf&#x3D;&quot;parent&quot;</span><br><span class="line">       app:layout_constraintTop_toTopOf&#x3D;&quot;parent&quot; &#x2F;&gt;</span><br><span class="line">   &lt;EditText</span><br><span class="line">       android:id&#x3D;&quot;@+id&#x2F;et2&quot;</span><br><span class="line">       android:layout_width&#x3D;&quot;wrap_content&quot;</span><br><span class="line">       android:layout_height&#x3D;&quot;wrap_content&quot;</span><br><span class="line">       android:layout_marginStart&#x3D;&quot;24dp&quot;</span><br><span class="line">       android:layout_marginTop&#x3D;&quot;8dp&quot;</span><br><span class="line">       android:layout_marginEnd&#x3D;&quot;24dp&quot;</span><br><span class="line">       android:hint&#x3D;&quot;Password&quot;</span><br><span class="line">       android:imeOptions&#x3D;&quot;actionDone&quot;</span><br><span class="line">       android:inputType&#x3D;&quot;textPassword&quot;</span><br><span class="line">       android:selectAllOnFocus&#x3D;&quot;true&quot;</span><br><span class="line">       app:layout_constraintEnd_toEndOf&#x3D;&quot;parent&quot;</span><br><span class="line">       app:layout_constraintStart_toStartOf&#x3D;&quot;parent&quot;</span><br><span class="line">       app:layout_constraintTop_toBottomOf&#x3D;&quot;@+id&#x2F;et1&quot;</span><br><span class="line">        &#x2F;&gt;</span><br><span class="line"></span><br><span class="line">   &lt;Button</span><br><span class="line">       android:layout_width&#x3D;&quot;wrap_content&quot;</span><br><span class="line">       android:layout_height&#x3D;&quot;wrap_content&quot;</span><br><span class="line">       android:onClick&#x3D;&quot;my_onClick&quot;</span><br><span class="line">       android:text&#x3D;&quot;登陆&quot;</span><br><span class="line">       android:textSize&#x3D;&quot;26dp&quot;&#x2F;&gt;</span><br></pre></td></tr></table></figure>
<h5 id="（2）MainActivity中添加"><a href="#（2）MainActivity中添加" class="headerlink" title="（2）MainActivity中添加"></a>（2）MainActivity中添加</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.hookdemo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> androidx.appcompat.app.AppCompatActivity;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.os.Bundle;</span><br><span class="line"><span class="keyword">import</span> android.view.View;</span><br><span class="line"><span class="keyword">import</span> android.widget.EditText;</span><br><span class="line"><span class="keyword">import</span> android.widget.Toast;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> <span class="keyword">extends</span> <span class="title">AppCompatActivity</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_main);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">my_onClick</span><span class="params">(View view)</span> </span>&#123;</span><br><span class="line">        EditText editText = (EditText) findViewById(R.id.et1);</span><br><span class="line">        EditText editText1 = (EditText) findViewById(R.id.et2);</span><br><span class="line">        String string = editText.getText().toString();</span><br><span class="line">        String string1 = editText1.getText().toString();</span><br><span class="line">        <span class="keyword">if</span>(CheckRegister(string,string1))&#123;</span><br><span class="line">            Toast.makeText(MainActivity.<span class="keyword">this</span>,<span class="string">"登陆成功"</span>,Toast.LENGTH_SHORT).show();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            Toast.makeText(MainActivity.<span class="keyword">this</span>,<span class="string">"登陆失败"</span>,Toast.LENGTH_SHORT).show();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">CheckRegister</span><span class="params">(String string, String string1)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> string.equals(string1);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>效果，两个输入框输入相同时 提示登陆成功，不同时 提示登陆失败</p>
<h4 id="2、hook准备，新建项目，引入xposed-jar包"><a href="#2、hook准备，新建项目，引入xposed-jar包" class="headerlink" title="2、hook准备，新建项目，引入xposed  jar包"></a>2、hook准备，新建项目，引入xposed  jar包</h4><p><img src="/2021/06/07/Hook%E6%A1%86%E6%9E%B6xposed%E7%9A%84%E7%AE%80%E5%8D%95demo/2.png" alt></p>
<h4 id="3、搞定XposedBridgeApi-xx-jar-与-build-gradle，"><a href="#3、搞定XposedBridgeApi-xx-jar-与-build-gradle，" class="headerlink" title="3、搞定XposedBridgeApi-xx.jar 与 build.gradle，"></a><strong>3、搞定XposedBridgeApi-xx.jar 与 build.gradle，</strong></h4><p>在 “项目名称/app/src/main/”目录下找到build.gradle，</p>
<p>在图示位置加上：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">repositories &#123;</span><br><span class="line">	jcenter()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>以及</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">compileOnly &#39;de.robv.android.xposed:api:82&#39;</span><br><span class="line"></span><br><span class="line">compileOnly &#39;de.robv.android.xposed:api:82:sources&#39;</span><br></pre></td></tr></table></figure>
<p>这句代码是告诉AndroidStuido使用jcenter作为代码仓库，从这个仓库里远程寻找 de.robv.android.xposed:api:82 这个API。</p>
<p>写完之后， build.gradle会提示文件已经修改，是否同步。点击 “sync now”，同步即可：</p>
<h4 id="4-声明主入口类路径"><a href="#4-声明主入口类路径" class="headerlink" title="4. 声明主入口类路径"></a>4. 声明主入口类路径</h4><p>需要在 main 文件夹下建立 assets 文件夹中新建一个 xposed_init 的文件，并在其中声明主入口类</p>
<p><img src="/2021/06/07/Hook%E6%A1%86%E6%9E%B6xposed%E7%9A%84%E7%AE%80%E5%8D%95demo/1.png" alt></p>
<h4 id="5、创建hook代码"><a href="#5、创建hook代码" class="headerlink" title="5、创建hook代码"></a>5、创建hook代码</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.ceshi;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.util.Log;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.IXposedHookLoadPackage;</span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.XC_MethodHook;</span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.XposedBridge;</span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.XposedHelpers;</span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.callbacks.XC_LoadPackage;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created by 18459 on 2016/6/27.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Main</span> <span class="keyword">implements</span> <span class="title">IXposedHookLoadPackage</span></span>&#123;</span><br><span class="line">    <span class="comment">//被HOOK的程序的包名和类名</span></span><br><span class="line">    String packName = <span class="string">"com.example.hookdemo"</span>;</span><br><span class="line">    String className = <span class="string">"com.example.hookdemo.MainActivity"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleLoadPackage</span><span class="params">(XC_LoadPackage.LoadPackageParam loadPackageParam)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(!loadPackageParam.packageName.equals(packName))</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        <span class="comment">//打印日志加载的包名</span></span><br><span class="line">        XposedBridge.log(<span class="string">"Loaded app: "</span> + loadPackageParam.packageName);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// replaceHookedMethod 替换方法</span></span><br><span class="line">        <span class="comment">// beforeHookedMethod 方法前执行</span></span><br><span class="line">        <span class="comment">// afterHookedMethod 方法后执行</span></span><br><span class="line">        <span class="comment">// 处理是的情况</span></span><br><span class="line">        <span class="comment">// 找到对应类的方法，进行hook，hook的方式有两种</span></span><br><span class="line">        XposedHelpers.findAndHookMethod(className,     <span class="comment">// 类名</span></span><br><span class="line">                loadPackageParam.classLoader, <span class="comment">// 类加载器</span></span><br><span class="line">                <span class="string">"CheckRegister"</span>, <span class="comment">// 方法名</span></span><br><span class="line">                String<span class="class">.<span class="keyword">class</span>,   // 参数1</span></span><br><span class="line"><span class="class">                <span class="title">String</span>.<span class="title">class</span>,   // 参数2</span></span><br><span class="line"><span class="class">                <span class="title">new</span> <span class="title">XC_MethodHook</span>() </span>&#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">beforeHookedMethod</span><span class="params">(MethodHookParam param)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">                        <span class="keyword">super</span>.beforeHookedMethod(param);</span><br><span class="line">                        XposedBridge.log(<span class="string">"beforeHookedMethod"</span>);</span><br><span class="line">                        Log.d(<span class="string">"xposedplugin"</span>,(String) param.args[<span class="number">0</span>]);</span><br><span class="line">                        Log.d(<span class="string">"xposedplugin"</span>, (String) param.args[<span class="number">1</span>]);</span><br><span class="line"></span><br><span class="line">                        XposedBridge.log(<span class="string">"hook前账号"</span>+(String) param.args[<span class="number">0</span>]);</span><br><span class="line">                        XposedBridge.log(<span class="string">"hook前密码"</span>+(String) param.args[<span class="number">1</span>]);</span><br><span class="line">                        <span class="comment">//将两个参数改为相等</span></span><br><span class="line">                        param.args[<span class="number">0</span>] = <span class="string">"123"</span>;</span><br><span class="line">                        param.args[<span class="number">1</span>] = <span class="string">"123"</span>;</span><br><span class="line"></span><br><span class="line">                        XposedBridge.log(<span class="string">"hook后账号"</span>+(String) param.args[<span class="number">0</span>]);</span><br><span class="line">                        XposedBridge.log(<span class="string">"hook后密码"</span>+(String) param.args[<span class="number">1</span>]);</span><br><span class="line"></span><br><span class="line">                        <span class="comment">//这样设置函数的返回值</span></span><br><span class="line">                        param.setResult(<span class="keyword">true</span>);</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="comment">//这个hook方法之后有啥用还不知道</span></span><br><span class="line">                    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">afterHookedMethod</span><span class="params">(MethodHookParam param)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">                        <span class="keyword">super</span>.afterHookedMethod(param);</span><br><span class="line">                        XposedBridge.log(<span class="string">"afterHookedMethod"</span>);</span><br><span class="line"></span><br><span class="line">                        Log.d(<span class="string">"xposedplugin"</span>, (String) param.args[<span class="number">0</span>]);</span><br><span class="line">                        Log.d(<span class="string">"xposedplugin"</span>, (String) param.args[<span class="number">1</span>]);</span><br><span class="line"></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="6、生成apk-安装"><a href="#6、生成apk-安装" class="headerlink" title="6、生成apk 安装"></a>6、生成apk 安装</h4><h4 id="7、apk导入xpose模块，重启手机"><a href="#7、apk导入xpose模块，重启手机" class="headerlink" title="7、apk导入xpose模块，重启手机"></a>7、apk导入xpose模块，重启手机</h4><p>​    </p>
<h4 id="8、结果演示"><a href="#8、结果演示" class="headerlink" title="8、结果演示"></a>8、结果演示</h4><p><img src="/2021/06/07/Hook%E6%A1%86%E6%9E%B6xposed%E7%9A%84%E7%AE%80%E5%8D%95demo/1.jpg" style="zoom: 25%;"></p>
<p>xpose日志</p>
<p>I/Xposed ( 3570): Found Xposed class ‘de/robv/android/xposed/XposedBridge’, now initializing<br>06-12 18:10:58.280 I/Xposed ( 3570): Loading modules from /data/app/com.example.ceshi-1/base.apk<br>06-12 18:11:02.882 I/Xposed ( 3570):  Loading class com.example.ceshi.Main<br>06-12 18:11:45.428 I/Xposed ( 8549): Loaded app: com.example.hookdemo<br>06-12 18:11:53.710 I/Xposed ( 8549): beforeHookedMethod<br>06-12 18:11:53.723 I/Xposed ( 8549): hook前账号ddddd<br>06-12 18:11:53.723 I/Xposed ( 8549): hook前密码jj<br>06-12 18:11:53.726 I/Xposed ( 8549): hook后账号123<br>06-12 18:11:53.726 I/Xposed ( 8549): hook后密码123</p>
<p><strong>参考链接：</strong></p>
<p>1、###### Hook框架xposed的简单demo</p>
<p><a href="https://blog.csdn.net/coc_k/article/details/52584059" target="_blank" rel="noopener">https://blog.csdn.net/coc_k/article/details/52584059</a></p>
<p>2、###### Using the Xposed Framework API</p>
<p><a href="https://github.com/rovo89/XposedBridge/wiki/Using-the-Xposed-Framework-API" target="_blank" rel="noopener">https://github.com/rovo89/XposedBridge/wiki/Using-the-Xposed-Framework-API</a></p>
<p><a href="https://github.com/rovo89/XposedBridge/wiki/Development-tutorial" target="_blank" rel="noopener">https://github.com/rovo89/XposedBridge/wiki/Development-tutorial</a><br>3、Xposed之Hook方法笔记<br><a href="https://www.jianshu.com/p/c513a2289db0" target="_blank" rel="noopener">https://www.jianshu.com/p/c513a2289db0</a><br>4、关于XposedHook的实践<br><a href="https://www.jianshu.com/p/4e474495865e" target="_blank" rel="noopener">https://www.jianshu.com/p/4e474495865e</a></p>
]]></content>
      <categories>
        <category>逆向</category>
      </categories>
      <tags>
        <tag>逆向，AndroidStudio</tag>
      </tags>
  </entry>
  <entry>
    <title>AndroidStudio使用USB真机调试教程</title>
    <url>/2021/06/07/AndroidStudio%E4%BD%BF%E7%94%A8USB%E7%9C%9F%E6%9C%BA%E8%B0%83%E8%AF%95%E6%95%99%E7%A8%8B/</url>
    <content><![CDATA[<p>Android开发者第一步学习的应该就是真机调试了。但是很多初次接触android studio的同学还是不知道如何用真机调试，今天我就给大家写一个教程，希望可以帮到需要的人。</p>
<a id="more"></a>
<h2 id="一、真机调试"><a href="#一、真机调试" class="headerlink" title="一、真机调试"></a>一、真机调试</h2><p>   1.先用usb线把你的测试手机连接到你的电脑上，并且安装驱动</p>
<p>   2.安装好驱动后就可以在电脑上读取手机的文件。接下来就是设置测试手机（寻找开发者选项）。</p>
<p>​    1）点击测试机“设置“，在设置中，寻找开发者选项，如果没有开发者选项，按接下来的步骤操作：找到关于手机，点击关于手机。然后找到“版本号”（小米手机是MIUI版本），点击几次版本号(最多5次)，系统即提示“您现在处于开发者模式”。注：不同手机提示可能不同。然后返回设置就会找到开发者选项。</p>
<pre><code> 2）然后在设置中找到“安全性（部分手机：系统安全）”，点击进入。找到“未知来源”，点击后会弹出系统提示，点击确认
</code></pre><p>​     3）点击开发者选项，点击启用，会弹出一个系统提示，点击确认。然后再勾选USB调试，系统又会弹出提示，继续点击确认。</p>
<p>​    3.接下来设置android studio。打开android studio，在工具栏中找到，app选项，点击会弹出 Edit Configurations..选项，点击进入，然后在设置页面中找到  Deploymeng target Options下的Target选项，(新版可能找不到，可直接点击运行)，然后选择为USB Device。然后点击OK。至此咱就已经基本设置好了。可以进行真机测试了。</p>
<p> 结果如图所示：</p>
<p><img src="/2021/06/07/AndroidStudio%E4%BD%BF%E7%94%A8USB%E7%9C%9F%E6%9C%BA%E8%B0%83%E8%AF%95%E6%95%99%E7%A8%8B/1.png" style="zoom: 50%;"></p>
<h2 id="二、Android应用各部分说明"><a href="#二、Android应用各部分说明" class="headerlink" title="二、Android应用各部分说明"></a>二、Android应用各部分说明</h2><p><strong>（1）MainActivity.java文件</strong><br>主要活动代码，实际的应用程序文件，将被转化为Dalvik可执行文件并运行。R.layout.activity_main 引用res/layout/activity_main.xml文件。</p>
<p>onCreate()  活动被加载之后众多被调用的方法之一。</p>
<p><strong>（2）AndroidManifest.xml文件</strong></p>
<p>AndroidManifest.xml文件是整个应用程序的信息描述文件，定义了应用程序中包含的Activity,Service,Content provider和BroadcastReceiver组件信息。每个应用程序在根目录下必须包含一个AndroidManifest.xml文件，且文件名不能修改。在AndroidManifest.xml文件中，首先看到是的<manifest>节点，它是整个应用程序的基本属性，涵盖了默认进程名字，应用程序标识，安装位置，对系统的要求以及应用程序的版本等。</manifest></p>
<p>android:icon是普通图标。</p>
<p>android:roundIcon是圆形图标。</p>
<p>android:label属性指定应用的名称。</p>
<p>android:name属性指定一个Activity类子类的全名。</p>
<p>意图过滤器的action被命名为android.intent.action.MAIN，表明这个活动被用做应用程序的入口。</p>
<p>意图过滤器的category被命名为android.intent.category.LAUNCHER，表明应用程序可以通过设备启动器的图标来启动。</p>
<p>@string指的是strings.xml，因此@string/app_name指的是定义在strings.xml中的app_name，这里实际为”demo”。</p>
<p><strong>（3）activity_main.xml文件</strong><br>activity_main.xml 我们将频繁修改这个文件来改变应用程序的布局。</p>
<p>TextView是一个用于构建用户图形界面的Android控件。</p>
<p>它包含有许多不同的属性，诸如android:layout_width, android:layout_height等用来设置它的宽度和高度等。</p>
<p>这里我们给它显示一句话“御风而上，神游天下!”，并且字体颜色为红色，引用自strings.xml文件。</p>
<h2 id="三、建立一个空工程，编写获取序列号的简单例子"><a href="#三、建立一个空工程，编写获取序列号的简单例子" class="headerlink" title="三、建立一个空工程，编写获取序列号的简单例子"></a>三、建立一个空工程，编写获取序列号的简单例子</h2><p><strong>1.获取手机状态需要设置权限</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span>=<span class="string">"com.example.demoimei"</span>&gt;</span><br><span class="line">  &lt;uses-permission android:name="android.permission.READ_PHONE_STATE"&gt;&lt;/uses-permission&gt;</span><br><span class="line">  &lt;application</span><br></pre></td></tr></table></figure>
<p><strong>2.编写布局文件</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">&lt;TextView</span><br><span class="line">    android:id=<span class="string">"@+id/tv1"</span></span><br><span class="line">    android:layout_width=<span class="string">"wrap_content"</span></span><br><span class="line">    android:layout_height=<span class="string">"wrap_content"</span></span><br><span class="line">    android:text=<span class="string">"Hello World!"</span> /&gt;</span><br><span class="line"></span><br><span class="line">&lt;TextView</span><br><span class="line">    android:id=<span class="string">"@+id/tv2"</span></span><br><span class="line">    android:layout_width=<span class="string">"wrap_content"</span></span><br><span class="line">    android:layout_height=<span class="string">"wrap_content"</span></span><br><span class="line">    android:text=<span class="string">"Hello World!"</span> /&gt;</span><br></pre></td></tr></table></figure>
<p><strong>3、编写主 Activity 类中的 onCreate 函数</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.cockroach.hook_object;</span><br><span class="line"><span class="keyword">import</span> android.content.Context;</span><br><span class="line"><span class="keyword">import</span> android.support.v7.app.AppCompatActivity;</span><br><span class="line"><span class="keyword">import</span> android.os.Bundle;</span><br><span class="line"><span class="keyword">import</span> android.telephony.TelephonyManager;</span><br><span class="line"><span class="keyword">import</span> android.widget.TextView;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> <span class="keyword">extends</span> <span class="title">AppCompatActivity</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_main);</span><br><span class="line">    </span><br><span class="line">        TextView tv1 = (TextView) findViewById(R.id.tv1);</span><br><span class="line">        TextView tv2 = (TextView) findViewById(R.id.tv2);</span><br><span class="line">        TelephonyManager tm = (TelephonyManager)getSystemService(Context.TELEPHONY_SERVICE);</span><br><span class="line">        tv1.setText(<span class="string">"imei:"</span> + tm.getDeviceId());</span><br><span class="line">        tv2.setText(<span class="string">"imsi:"</span> + tm.getSubscriberId());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果出现闪退问题，报错</p>
<p> java.lang.SecurityException: getDeviceId: Neither user 10226 nor current process has android.permis</p>
<p>这可能是手机设置的问题，我手机的 应用程序-&gt; 授予权限就OK了</p>
<p><strong>运行结果如下：</strong></p>
<p><img src="/2021/06/07/AndroidStudio%E4%BD%BF%E7%94%A8USB%E7%9C%9F%E6%9C%BA%E8%B0%83%E8%AF%95%E6%95%99%E7%A8%8B/2.jpg" style="zoom: 50%;"></p>
<p>这就是我们的等会要hook的apk程序，下面编写xposed插件</p>
]]></content>
      <categories>
        <category>逆向</category>
      </categories>
      <tags>
        <tag>逆向，AndroidStudio</tag>
      </tags>
  </entry>
  <entry>
    <title>生成器中的return有什么作用</title>
    <url>/2021/06/06/%E7%94%9F%E6%88%90%E5%99%A8%E4%B8%AD%E7%9A%84return%E6%9C%89%E4%BB%80%E4%B9%88%E4%BD%9C%E7%94%A8/</url>
    <content><![CDATA[<p>生成器中的return有什么作用</p>
<a id="more"></a>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">generate_data</span><span class="params">(num)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> num &gt; <span class="number">10</span>:</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(num):</span><br><span class="line">            <span class="keyword">yield</span> i</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> num</span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    res = generate_data(num=<span class="number">12</span>)</span><br><span class="line">    print(res, type(res))</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> res:</span><br><span class="line">        print(i, type(i))</span><br></pre></td></tr></table></figure>
<p><strong>运行结果：</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;generator object generate_data at 0x000002279C741750&gt; &lt;class &#39;generator&#39;&gt;</span><br><span class="line">0 &lt;class &#39;int&#39;&gt;</span><br><span class="line">1 &lt;class &#39;int&#39;&gt;</span><br><span class="line">2 &lt;class &#39;int&#39;&gt;</span><br><span class="line">3 &lt;class &#39;int&#39;&gt;</span><br><span class="line">4 &lt;class &#39;int&#39;&gt;</span><br><span class="line">5 &lt;class &#39;int&#39;&gt;</span><br><span class="line">6 &lt;class &#39;int&#39;&gt;</span><br><span class="line">7 &lt;class &#39;int&#39;&gt;</span><br><span class="line">8 &lt;class &#39;int&#39;&gt;</span><br><span class="line">9 &lt;class &#39;int&#39;&gt;</span><br><span class="line">10 &lt;class &#39;int&#39;&gt;</span><br><span class="line">11 &lt;class &#39;int&#39;&gt;</span><br></pre></td></tr></table></figure>
<p><strong>今天的重点，当num值小于10时：</strong></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">res = generate_data(num=<span class="number">5</span>)</span><br><span class="line">   print(res, type(res))</span><br><span class="line">   <span class="keyword">for</span> i <span class="keyword">in</span> res:</span><br><span class="line">       print(i, type(i))</span><br></pre></td></tr></table></figure>
<p><strong>运行结果：</strong></p>
<p><generator object generate_data at 0x00000282b21e1750> <class 'generator'></class></generator></p>
<p>并没有返回5这个值,但是代码也没有报错，通过印结果，这说明返回的res 也是生成器</p>
<p><strong>带着疑问，我们进行搜索</strong></p>
<p><a href="https://stackoverflow.com/questions/16780002/return-in-generator-together-with-yield-in-python-3-3" target="_blank" rel="noopener">https://stackoverflow.com/questions/16780002/return-in-generator-together-with-yield-in-python-3-3</a></p>
<p><strong>这时候我们明白了：</strong></p>
<p>return 在生成器中，表示生成器运行完成了，可以结束了。然后生成器会抛出一个StopIteration的异常。而for循环能够检测到这个异常，于是结束循环。所以当我们传入的参数为5的时候，生成器直接运行到了return，于是它直接就抛出StopIteration，于是for 循环检测到这个异常就结束了。<br> 在生成器里面的return只是一个结束标志，它不会把后面写的值返回给调用者。这跟函数里面的return语句是不一样的.</p>
<p><strong>我们验证一下：</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">def f():</span><br><span class="line">    return 3</span><br><span class="line">    yield 2</span><br><span class="line">if __name__ &#x3D;&#x3D; &#39;__main__&#39;:</span><br><span class="line">    x &#x3D; f()</span><br><span class="line">    print(x.__next__())</span><br></pre></td></tr></table></figure>
<p><strong>运行结果：</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Traceback (most recent call last):</span><br><span class="line">  File &quot;E:&#x2F;workerspace&#x2F;demo&#x2F;a.py&quot;, line 14, in &lt;module&gt;</span><br><span class="line">    print(x.__next__())</span><br><span class="line">StopIteration: 3</span><br></pre></td></tr></table></figure>
<p>果真如此</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>python基础</category>
      </categories>
      <tags>
        <tag>Python基础</tag>
        <tag>生成器</tag>
      </tags>
  </entry>
  <entry>
    <title>xposed-hook原理</title>
    <url>/2021/06/06/xposed-hook%E5%8E%9F%E7%90%86/</url>
    <content><![CDATA[<p>xposed hook 原理介绍</p>
<a id="more"></a>
<p><strong>1、xposed工作原理：</strong></p>
<p>Android基于Linux，第一个启动的进程自然是<code>init进程</code>，该进程会启动所有Android进程的父进程——<code>Zygote(孵化)进程</code>，该进程的启动配置在<code>/init.rc</code>脚本中，而Zygote进程对应的执行文件是<code>/system/bin/app_process</code>，该文件完成类库的加载以及一些函数的调用工作。在Zygote进程创建后，再fork出SystemServer进程和其他进程。而Xposed Framework呢，就是<strong>用自己实现的app_process替换掉了系统原本提供的app_process</strong>，加载一个额外的jar包，然后入口从原来的<code>com.android.internal.osZygoteInit.main()</code>被替换成了<code>de.robv.android.xposed.XposedBridge.main()</code>，然后<strong>创建的Zygote进程就变成Hook的Zygote进程了</strong>，而后面Fork出来的进程也是被Hook过的。这个Jar包在<code>/data/data/de.rbov.android.xposed.installer/bin/XposedBridge.jar</code>。</p>
<p>「拦截」。Xposed 通过劫持 Android 系统的 zygote 进程来加载自定义功能，这就像是半路截杀，在应用运行之前就已经将我们需要的自定义内容强加在了系统进程当中。</p>
<p><strong>2、Android 系统的Zygote初始化过程</strong></p>
<p><strong>参考链接：</strong><a href="https://www.jianshu.com/p/2303e7efb956" target="_blank" rel="noopener">https://www.jianshu.com/p/2303e7efb956</a></p>
<p><strong>3、xposed拦截流程：</strong></p>
<ul>
<li>startVM() 启动虚拟机并且初始化</li>
<li>startReg() 注册一些JNI的方法</li>
<li>start() 启动Zygote，依次执行 startVM()-&gt;startReg()-&gt;callMain()</li>
<li>callMain() 通过反射调用传入的className对象的main函数，如在init.cpp函数里面传入的ZygoteInit对象和RuntimeInit对象，调用callMain方法就会调用对应的main方法。</li>
</ul>
<p><strong>也就是说在安卓系统启动的时候，在执行callmain()这个函数的时候，我们就把我们的自定义的一些模块注入到，系统进程中了。</strong></p>
]]></content>
      <categories>
        <category>逆向</category>
      </categories>
      <tags>
        <tag>逆向</tag>
        <tag>Hook</tag>
        <tag>frida</tag>
      </tags>
  </entry>
  <entry>
    <title>你应该要了解的https</title>
    <url>/2021/06/06/%E4%BD%A0%E5%BA%94%E8%AF%A5%E8%A6%81%E4%BA%86%E8%A7%A3%E7%9A%84https/</url>
    <content><![CDATA[<p>近几年，互联网发生着翻天覆地的变化，尤其是我们一直习以为常的HTTP协议，在逐渐的被HTTPS协议所取代，在浏览器、搜索引擎、CA机构、大型互联网企业的共同促进下，互联网迎来了“HTTPS加密时代”，HTTPS将在未来的几年内全面取代HTTP成为传输协议的主流。</p>
<a id="more"></a>
<p>读完本文，希望你能明白：</p>
<ul>
<li>HTTP通信存在什么问题</li>
<li>HTTPS如何改进HTTP存在那些问题</li>
<li>HTTPS工作原理是什么</li>
</ul>
<h2 id="一、什么是HTTPS"><a href="#一、什么是HTTPS" class="headerlink" title="一、什么是HTTPS"></a>一、什么是HTTPS</h2><p>HTTPS是在HTTP上建立SSL加密层，并对传输数据进行加密，是HTTP协议的安全版。现在它被广泛用于万维网上安全敏感的通讯，例如交易支付方面。</p>
<p>HTTPS主要作用是：</p>
<p>（1）对数据进行加密，并建立一个信息安全通道，来保证传输过程中的数据安全;</p>
<p>（2）对网站服务器进行真实身份认证。</p>
<p>我们经常会在Web的登录页面和购物结算界面等使用HTTPS通信。使用HTTPS通信时，不再用<code>http://</code>，而是改用<code>https://</code>。另外，当浏览器访问HTTPS通信有效的Web网站时，浏览器的地址栏内会出现一个带锁的标记。对HTTPS的显示方式会因浏览器的不同而有所改变。</p>
<p><img src="./你应该要了解的https/1.jpg" alt></p>
<h2 id="二、为什么需要HTTPS"><a href="#二、为什么需要HTTPS" class="headerlink" title="二、为什么需要HTTPS"></a>二、为什么需要HTTPS</h2><p>在HTTP协议中有可能存在信息窃取或身份伪装等安全问题。使用HTTPS通信机制可以有效地防止这些问题，接下来，我们先来了解下<br>HTTP协议存在的哪些问题：</p>
<ul>
<li>通信使用明文（不加密），内容可能被窃听</li>
</ul>
<p>由于HTTP本身不具备加密的功能，所以也无法做到对通信整体（使用HTTP协议通信的请求和响应的内容）进行加密。即，<strong>HTTP报文使用明文（指未经过加密的报文）方式发送</strong>。</p>
<p>HTTP明文协议的缺陷是导致数据泄露、数据篡改、流量劫持、钓鱼攻击等安全问题的重要原因。HTTP协议无法加密数据，所有通信数据都在网络中明文“裸奔”。通过网络的嗅探设备及一些技术手段，就可还原HTTP报文内容。</p>
<ul>
<li>无法证明报文的完整性，所以可能遭篡改</li>
</ul>
<p>所谓完整性是指信息的准确度。若无法证明其完整性，通常也就意味着无法判断信息是否准确。由于HTTP协议无法证明通信的报文完整性，因此，在请求或响应送出之后直到对方接收之前的这段时间内，即使请求或响应的内容遭到篡改，也没有办法获悉。<br>换句话说，<strong>没有任何办法确认，发出的请求/响应和接收到的请求/响应是前后相同的</strong>。</p>
<ul>
<li>不验证通信方的身份，因此有可能遭遇伪装</li>
</ul>
<p><strong>HTTP协议中的请求和响应不会对通信方进行确认</strong>。在HTTP协议通信时，由于不存在确认通信方的处理步骤，任何人都可以发起请求。另外，服务器只要接收到请求，不管对方是谁都会返回一个响应（但也仅限于发送端的IP地址和端口号没有被Web服务器设定限制访问的前提下）</p>
<p>HTTP协议无法验证通信方身份，任何人都可以伪造虚假服务器欺骗用户，实现“钓鱼欺诈”，用户无法察觉。</p>
<p>反观HTTPS协议，它比HTTP协议相比多了以下优势（下文会详细介绍）:</p>
<ul>
<li>数据隐私性：内容经过对称加密，每个连接生成一个唯一的加密密钥</li>
<li>数据完整性：内容传输经过完整性校验</li>
<li>身份认证：第三方无法伪造服务端（客户端）身份</li>
</ul>
<h2 id="三、HTTPS如何解决HTTP上述问题"><a href="#三、HTTPS如何解决HTTP上述问题" class="headerlink" title="三、HTTPS如何解决HTTP上述问题?"></a>三、HTTPS如何解决HTTP上述问题?</h2><p>HTTPS并非是应用层的一种新协议。只是HTTP通信接口部分用SSL和TLS协议代替而已。</p>
<p>通常，HTTP直接和TCP通信。当使用SSL时，则演变成先和SSL通信，再由SSL和TCP通信了。简言之，<strong>所谓HTTPS，其实就是身披SSL协议这层外壳的HTTP</strong>。</p>
<p><img src="./你应该要了解的https/2.jpg" alt></p>
<p>在采用SSL后，HTTP就拥有了HTTPS的加密、证书和完整性保护这些功能。也就是说<strong>HTTP加上加密处理和认证以及完整性保护后即是HTTPS</strong>。</p>
<p><img src="./你应该要了解的https/3.jpg" alt></p>
<p>HTTPS 协议的主要功能基本都依赖于 TLS/SSL 协议，TLS/SSL 的功能实现主要依赖于三类基本算法：散列函数 、对称加密和非对称加密，<strong>其利用非对称加密实现身份认证和密钥协商，对称加密算法采用协商的密钥对数据加密，基于散列函数验证信息的完整性</strong>。</p>
<p><img src="./你应该要了解的https/4.jpg" alt></p>
<h3 id="1-解决内容可能被窃听的问题——加密"><a href="#1-解决内容可能被窃听的问题——加密" class="headerlink" title="1.解决内容可能被窃听的问题——加密"></a>1.解决内容可能被窃听的问题——加密</h3><h4 id="方法1-对称加密"><a href="#方法1-对称加密" class="headerlink" title="方法1.对称加密"></a>方法1.对称加密</h4><p>这种方式加密和解密同用一个密钥。加密和解密都会用到密钥。<strong>没有密钥就无法对密码解密，反过来说，任何人只要持有密钥就能解密了</strong>。</p>
<p>以对称加密方式加密时必须将密钥也发给对方。可究竟怎样才能安全地转交？在互联网上转发密钥时，如果通信被监听那么密钥就可会落人攻击者之手，同时也就失去了加密的意义。另外还得设法安全地保管接收到的密钥。</p>
<h4 id="方法2-非对称加密"><a href="#方法2-非对称加密" class="headerlink" title="方法2.非对称加密"></a>方法2.非对称加密</h4><p>公开密钥加密使用一对非对称的密钥。一把叫做私有密钥，另一把叫做公开密钥。顾名思义，<strong>私有密钥不能让其他任何人知道，而公开密钥则可以随意发布，任何人都可以获得</strong>。</p>
<p>使用公开密钥加密方式，发送密文的一方使用<strong>对方的公开密钥</strong>进行加密处理，对方收到被加密的信息后，再使用自己的私有密钥进行解密。利用这种方式，不需要发送用来解密的私有密钥，也不必担心密钥被攻击者窃听而盗走。<br><img src="./你应该要了解的https/5.jpg" alt></p>
<p>非对称加密的特点是信息传输一对多，服务器只需要维持一个私钥就能够和多个客户端进行加密通信。</p>
<p>这种方式有以下缺点：</p>
<ul>
<li>公钥是公开的，所以针对私钥加密的信息，黑客截获后可以使用公钥进行解密，获取其中的内容；</li>
<li>公钥并不包含服务器的信息，使用非对称加密算法无法确保服务器身份的合法性，存在中间人攻击的风险，服务器发送给客户端的公钥可能在传送过程中被中间人截获并篡改；</li>
<li>使用非对称加密<strong>在数据加密解密过程需要消耗一定时间</strong>，降低了数据传输效率；</li>
</ul>
<h4 id="方法3-对称加密-非对称加密-HTTPS采用这种方式"><a href="#方法3-对称加密-非对称加密-HTTPS采用这种方式" class="headerlink" title="方法3.对称加密+非对称加密(HTTPS采用这种方式)"></a>方法3.对称加密+非对称加密(HTTPS采用这种方式)</h4><p>使用对称密钥的好处是解密的效率比较快，使用非对称密钥的好处是可以使得传输的内容不能被破解，因为就算你拦截到了数据，但是没有对应的私钥，也是不能破解内容的。就比如说你抢到了一个保险柜，但是没有保险柜的钥匙也不能打开保险柜。那我们就将对称加密与非对称加密结合起来,充分利用两者各自的优势，<strong>在交换密钥环节使用非对称加密方式，之后的建立通信交换报文阶段则使用对称加密方式</strong>。</p>
<p>具体做法是：<strong>发送密文的一方使用对方的公钥进行加密处理“对称的密钥”，然后对方用自己的私钥解密拿到“对称的密钥”，这样可以确保交换的密钥是安全的前提下，使用对称加密方式进行通信</strong>。所以，HTTPS采用对称加密和非对称加密两者并用的混合加密机制。</p>
<h3 id="2-解决报文可能遭篡改问题——数字签名"><a href="#2-解决报文可能遭篡改问题——数字签名" class="headerlink" title="2.解决报文可能遭篡改问题——数字签名"></a>2.解决报文可能遭篡改问题——数字签名</h3><p>网络传输过程中需要经过很多中间节点，虽然数据无法被解密，但可能被篡改，那如何校验数据的完整性呢？——校验数字签名。</p>
<p><strong>数字签名有两种功效</strong>：</p>
<ul>
<li>能确定消息确实是由发送方签名并发出来的，因为别人假冒不了发送方的签名。</li>
<li>数字签名能确定消息的完整性,证明数据是否未被篡改过。</li>
</ul>
<p><strong>数字签名如何生成:</strong><br><img src="./你应该要了解的https/6.jpg" alt></p>
<p>将一段文本先用Hash函数生成消息摘要，然后用发送者的私钥加密生成数字签名，与原文文一起传送给接收者。接下来就是接收者校验数字签名的流程了。</p>
<p><strong>校验数字签名流程</strong>：</p>
<p><img src="./你应该要了解的https/7.jpg" alt="img"></p>
<p>接收者只有用发送者的公钥才能解密被加密的摘要信息，然后用HASH函数对收到的原文产生一个摘要信息，与上一步得到的摘要信息对比。如果相同，则说明收到的信息是完整的，在传输过程中没有被修改，否则说明信息被修改过，因此数字签名能够验证信息的完整性。</p>
<p>假设消息传递在Kobe，James两人之间发生。James将消息连同数字签名一起发送给Kobe，Kobe接收到消息后，通过校验数字签名，就可以验证接收到的消息就是James发送的。当然，这个过程的前提是Kobe知道James的公钥。问题的关键的是，和消息本身一样，公钥不能在不安全的网络中直接发送给Kobe,或者说拿到的公钥如何证明是James的。</p>
<p>此时就需要引入了<strong>证书颁发机构</strong>（Certificate Authority，简称CA），CA数量并不多，Kobe客户端内置了所有受信任CA的证书。CA对James的公钥（和其他信息）数字签名后生成证书。</p>
<h3 id="3-解决通信方身份可能被伪装的问题——数字证书"><a href="#3-解决通信方身份可能被伪装的问题——数字证书" class="headerlink" title="3.解决通信方身份可能被伪装的问题——数字证书"></a>3.解决通信方身份可能被伪装的问题——数字证书</h3><p>数字证书认证机构处于客户端与服务器双方都可信赖的第三方机构的立场上。<br><img src="./你应该要了解的https/8.jpg" alt>们来介绍一下数字证书认证机构的业务流程：</p>
<ul>
<li>服务器的运营人员向第三方机构CA提交公钥、组织信息、个人信息(域名)等信息并申请认证;</li>
<li>CA通过线上、线下等多种手段验证申请者提供信息的真实性，如组织是否存在、企业是否合法，是否拥有域名的所有权等;</li>
<li>如信息审核通过，CA会向申请者签发认证文件-证书。证书包含以下信息：申请者公钥、申请者的组织信息和个人信息、签发机构 CA的信息、有效时间、证书序列号等信息的明文，同时包含一个签名。 其中签名的产生算法：首先，使用散列函数计算公开的明文信息的信息摘要，然后，采用 CA的私钥对信息摘要进行加密，密文即签名;</li>
<li>客户端 Client 向服务器 Server 发出请求时，Server 返回证书文件;</li>
<li>客户端 Client 读取证书中的相关的明文信息，采用相同的散列函数计算得到信息摘要，然后，利用对应 CA的公钥解密签名数据，对比证书的信息摘要，如果一致，则可以确认证书的合法性，即服务器的公开密钥是值得信赖的。</li>
<li>客户端还会验证证书相关的域名信息、有效时间等信息; 客户端会内置信任CA的证书信息(包含公钥)，如果CA不被信任，则找不到对应 CA的证书，证书也会被判定非法。</li>
</ul>
<h2 id="四、-HTTPS工作流程"><a href="#四、-HTTPS工作流程" class="headerlink" title="四、 HTTPS工作流程"></a>四、 HTTPS工作流程</h2><p><img src="./你应该要了解的https/9.jpg" alt></p>
<p>1.Client发起一个HTTPS（比如<code>https://juejin.im/user/5a9a9cdcf265da238b7d771c</code>）的请求，根据RFC2818的规定，Client知道需要连接Server的443（默认）端口。</p>
<p>2.Server把事先配置好的公钥证书（public key certificate）返回给客户端。</p>
<p>3.Client验证公钥证书：比如是否在有效期内，证书的用途是不是匹配Client请求的站点，是不是在CRL吊销列表里面，它的上一级证书是否有效，这是一个递归的过程，直到验证到根证书（操作系统内置的Root证书或者Client内置的Root证书）。如果验证通过则继续，不通过则显示警告信息。</p>
<p>4.Client使用伪随机数生成器生成加密所使用的对称密钥，然后用证书的公钥加密这个对称密钥，发给Server。</p>
<p>5.Server使用自己的私钥（private key）解密这个消息，得到对称密钥。至此，Client和Server双方都持有了相同的对称密钥。</p>
<p>6.Server使用对称密钥加密“明文内容A”，发送给Client。</p>
<p>7.Client使用对称密钥解密响应的密文，得到“明文内容A”。</p>
<p>8.Client再次发起HTTPS的请求，使用对称密钥加密请求的“明文内容B”，然后Server使用对称密钥解密密文，得到“明文内容B”。</p>
<h2 id="五、HTTP-与-HTTPS-的区别"><a href="#五、HTTP-与-HTTPS-的区别" class="headerlink" title="五、HTTP 与 HTTPS 的区别"></a>五、HTTP 与 HTTPS 的区别</h2><ul>
<li>HTTP 是明文传输协议，HTTPS 协议是由 SSL+HTTP 协议构建的可进行加密传输、身份认证的网络协议，比 HTTP 协议安全。</li>
<li></li>
</ul>
<p><img src="你应该要了解的https/10.jpg" alt></p>
<p>关于安全性，用最简单的比喻形容两者的关系就是卡车运货，HTTP下的运货车是敞篷的，货物都是暴露的。而https则是封闭集装箱车，安全性自然提升不少。</p>
<ul>
<li>HTTPS比HTTP更加安全，对搜索引擎更友好，利于SEO,谷歌、百度优先索引HTTPS网页;</li>
<li>HTTPS需要用到SSL证书，而HTTP不用;</li>
<li>HTTPS标准端口443，HTTP标准端口80;</li>
<li>HTTPS基于传输层，HTTP基于应用层;</li>
<li>HTTPS在浏览器显示绿色安全锁，HTTP没有显示;</li>
</ul>
<h2 id="六、为何不所有的网站都使用HTTPS"><a href="#六、为何不所有的网站都使用HTTPS" class="headerlink" title="六、为何不所有的网站都使用HTTPS"></a>六、为何不所有的网站都使用HTTPS</h2><p>既然HTTPS那么安全可靠，那为何不所有的Web网站都使用HTTPS？</p>
<p>首先，很多人还是会觉得HTTPS实施有门槛，这个门槛在于需要权威CA颁发的SSL证书。从证书的选择、购买到部署，传统的模式下都会比较耗时耗力。</p>
<p>其次，HTTPS普遍认为性能消耗要大于HTTP，因为<strong>与纯文本通信相比，加密通信会消耗更多的CPU及内存资源</strong>。如果每次通信都加密，会消耗相当多的资源，平摊到一台计算机上时，能够处理的请求数量必定也会随之减少。但事实并非如此，用户可以通过性能优化、把证书部署在SLB或CDN，来解决此问题。举个实际的例子，“双十一”期间，全站HTTPS的淘宝、天猫依然保证了网站和移动端的访问、浏览、交易等操作的顺畅、平滑。通过测试发现，经过优化后的许多页面性能与HTTP持平甚至还有小幅提升，因此HTTPS经过优化之后其实并不慢。</p>
<p>除此之外，<strong>想要节约购买证书的开销也是原因之一</strong>。要进行HTTPS通信，证书是必不可少的。而使用的证书必须向认证机构（CA）购买。</p>
<p>最后是安全意识。相比国内，国外互联网行业的安全意识和技术应用相对成熟，HTTPS部署趋势是由社会、企业、政府共同去推动的。</p>
]]></content>
      <categories>
        <category>https,面试集锦</category>
      </categories>
      <tags>
        <tag>面试集锦</tag>
        <tag>https</tag>
      </tags>
  </entry>
  <entry>
    <title>bloomfilter</title>
    <url>/2021/06/06/bloomfilter/</url>
    <content><![CDATA[<p>布隆过滤器介绍</p>
<a id="more"></a>
<h2 id="什么是布隆过滤器"><a href="#什么是布隆过滤器" class="headerlink" title="什么是布隆过滤器"></a><strong>什么是布隆过滤器</strong></h2><p>本质上布隆过滤器是一种数据结构，比较巧妙的概率型数据结构（probabilistic data structure），特点是高效地插入和查询，可以用来告诉你 <strong>“某样东西一定不存在或者可能存在”</strong>。</p>
<p>相比于传统的 List、Set、Map 等数据结构，它更高效、占用空间更少，但是缺点是其返回的结果是概率性的，而不是确切的。</p>
<h2 id="实现原理"><a href="#实现原理" class="headerlink" title="实现原理"></a><strong>实现原理</strong></h2><p><strong>HashMap 的问题</strong></p>
<p>讲述布隆过滤器的原理之前，我们先思考一下，通常你判断某个元素是否存在用的是什么？应该蛮多人回答 HashMap 吧，确实可以将值映射到 HashMap 的 Key，然后可以在 O(1) 的时间复杂度内返回结果，效率奇高。但是 HashMap 的实现也有缺点，例如存储容量占比高，考虑到负载因子的存在，通常空间是不能被用满的，而一旦你的值很多例如上亿的时候，那 HashMap 占据的内存大小就变得很可观了。</p>
<p>还比如说你的数据集存储在远程服务器上，本地服务接受输入，而数据集非常大不可能一次性读进内存构建 HashMap 的时候，也会存在问题。</p>
<p><strong>布隆过滤器数据结构</strong></p>
<p>布隆过滤器是一个 bit 向量或者说 bit 数组，长这样：</p>
<p><img src="/2021/06/06/bloomfilter/1.jpg" alt></p>
<p>如果我们要映射一个值到布隆过滤器中，我们需要使用<strong>多个不同的哈希函数</strong>生成<strong>多个哈希值，</strong>并对每个生成的哈希值指向的 bit 位置 1，例如针对值 “baidu” 和三个不同的哈希函数分别生成了哈希值 1、4、7，则上图转变为：</p>
<p><img src="/2021/06/06/bloomfilter/2.jpg" alt></p>
<p>Ok，我们现在再存一个值 “tencent”，如果哈希函数返回 3、4、8 的话，图继续变为：</p>
<p><img src="/2021/06/06/bloomfilter/3.jpg" alt></p>
<p>值得注意的是，4 这个 bit 位由于两个值的哈希函数都返回了这个 bit 位，因此它被覆盖了。现在我们如果想查询 “dianping” 这个值是否存在，哈希函数返回了 1、5、8三个值，结果我们发现 5 这个 bit 位上的值为 0，<strong>说明没有任何一个值映射到这个 bit 位上</strong>，因此我们可以很确定地说 “dianping” 这个值不存在。而当我们需要查询 “baidu” 这个值是否存在的话，那么哈希函数必然会返回 1、4、7，然后我们检查发现这三个 bit 位上的值均为 1，那么我们可以说 “baidu” <strong>存在了么？答案是不可以，只能是 “baidu” 这个值可能存在。</strong></p>
<p>这是为什么呢？答案跟简单，因为随着增加的值越来越多，被置为 1 的 bit 位也会越来越多，这样某个值 “taobao” 即使没有被存储过，但是万一哈希函数返回的三个 bit 位都被其他值置位了 1 ，那么程序还是会判断 “taobao” 这个值存在。</p>
<h2 id="支持删除么"><a href="#支持删除么" class="headerlink" title="支持删除么"></a>支持删除么</h2><p>感谢评论区提醒，传统的布隆过滤器并不支持删除操作。但是名为 Counting Bloom filter 的变种可以用来测试元素计数个数是否绝对小于某个阈值，它支持元素删除。可以参考文章 <a href="https://link.zhihu.com/?target=https%3A//cloud.tencent.com/developer/article/1136056">Counting Bloom Filter 的原理和实现</a></p>
<h2 id="如何选择哈希函数个数和布隆过滤器长度"><a href="#如何选择哈希函数个数和布隆过滤器长度" class="headerlink" title="如何选择哈希函数个数和布隆过滤器长度"></a><strong>如何选择哈希函数个数和布隆过滤器长度</strong></h2><p>很显然，过小的布隆过滤器很快所有的 bit 位均为 1，那么查询任何值都会返回“可能存在”，起不到过滤的目的了。布隆过滤器的长度会直接影响误报率，布隆过滤器越长其误报率越小。</p>
<p>另外，哈希函数的个数也需要权衡，个数越多则布隆过滤器 bit 位置位 1 的速度越快，且布隆过滤器的效率越低；但是如果太少的话，那我们的误报率会变高。</p>
<p><img src="/2021/06/06/bloomfilter/4.jpg" alt>k 为哈希函数个数，m 为布隆过滤器长度，n 为插入的元素个数，p 为误报率</p>
<p>如何选择适合业务的 k 和 m 值呢，这里直接贴一个公式：</p>
<p><img src="/2021/06/06/bloomfilter/5.png" alt></p>
<p>如何推导这个公式这里只是提一句，因为对于使用来说并没有太大的意义，你让一个高中生来推会推得很快。k 次哈希函数某一 bit 位未被置为 1 的概率为：</p>
<p><img src="/2021/06/06/bloomfilter/6.png" alt></p>
<p>插入n个元素后依旧为 0 的概率和为 1 的概率分别是：</p>
<p><img src="/2021/06/06/bloomfilter/7.png" alt></p>
<p>标明某个元素是否在集合中所需的 k 个位置都按照如上的方法设置为 1，但是该方法可能会使算法错误的认为某一原本不在集合中的元素却被检测为在该集合中（False Positives），该概率由以下公式确定</p>
<p><img src="/2021/06/06/bloomfilter/8.png" alt></p>
<h2 id="最佳实践"><a href="#最佳实践" class="headerlink" title="最佳实践"></a><strong>最佳实践</strong></h2><p>常见的适用常见有，利用布隆过滤器减少磁盘 IO 或者网络请求，因为一旦一个值必定不存在的话，我们可以不用进行后续昂贵的查询请求。</p>
<p>另外，既然你使用布隆过滤器来加速查找和判断是否存在，那么性能很低的哈希函数不是个好选择，推荐 MurmurHash、Fnv 这些。</p>
<p><strong>大Value拆分</strong></p>
<p>Redis 因其支持 setbit 和 getbit 操作，且纯内存性能高等特点，因此天然就可以作为布隆过滤器来使用。但是布隆过滤器的不当使用极易产生大 Value，增加 Redis 阻塞风险，因此生成环境中建议对体积庞大的布隆过滤器进行拆分。</p>
<p>拆分的形式方法多种多样，但是本质是不要将 Hash(Key) 之后的请求分散在多个节点的多个小 bitmap 上，而是应该拆分成多个小 bitmap 之后，对一个 Key 的所有哈希函数都落在这一个小 bitmap 上。</p>
<p><strong>参考资料：</strong></p>
<p><a href="https://hackernoon.com/probabilistic-data-structures-bloom-filter-5374112a7832" target="_blank" rel="noopener">https://hackernoon.com/probabilistic-data-structures-bloom-filter-5374112a7832</a></p>
<p><a href="https://www.jasondavies.com/bloomfilter/" target="_blank" rel="noopener">https://www.jasondavies.com/bloomfilter/</a></p>
<p><strong>转载</strong> ：<a href="https://zhuanlan.zhihu.com/p/43263751" target="_blank" rel="noopener">https://zhuanlan.zhihu.com/p/43263751</a></p>
]]></content>
      <categories>
        <category>去重</category>
      </categories>
      <tags>
        <tag>去重， 面试集锦</tag>
      </tags>
  </entry>
  <entry>
    <title>同步和异步，进程，线程和协程之间的区别和联系</title>
    <url>/2021/06/05/%E5%90%8C%E6%AD%A5%E5%92%8C%E5%BC%82%E6%AD%A5%EF%BC%8C%E8%BF%9B%E7%A8%8B%EF%BC%8C%E7%BA%BF%E7%A8%8B%E5%92%8C%E5%8D%8F%E7%A8%8B%E4%B9%8B%E9%97%B4%E7%9A%84%E5%8C%BA%E5%88%AB%E5%92%8C%E8%81%94%E7%B3%BB/</url>
    <content><![CDATA[<p>同步和异步，进程，线程和协程之间的区别和联系</p>
<a id="more"></a>
<h1 id="同步和异步，进程，线程和协程之间的区别和联系"><a href="#同步和异步，进程，线程和协程之间的区别和联系" class="headerlink" title="同步和异步，进程，线程和协程之间的区别和联系"></a>同步和异步，进程，线程和协程之间的区别和联系</h1><p><strong>同步和异步、阻塞和非阻塞</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">异步： 多任务， 多个任务之间执行没有先后顺序，可以同时运行，执行的先后顺序不会有什么影响，存在的多条运行主线</span><br><span class="line">同步： 多任务， 多个任务之间执行的时候要求有先后顺序，必须一个先执行完成之后，另一个才能继续执行， 只有一个主线</span><br><span class="line">阻塞：从调用者的角度出发，如果在调用的时候，被卡住，不能再继续向下运行，需要等待，就说是阻塞</span><br><span class="line">非阻塞： 从调用者的角度出发， 如果在调用的时候，没有被卡住，能够继续向下运行，无需等待，就说是非阻塞</span><br></pre></td></tr></table></figure>
<p><strong>1）同步、异步</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">函数或方法被调用的时候，调用者是否得到最终的结果。</span><br><span class="line"></span><br><span class="line">直接得到最终结果的结果，就是同步调用。（打饭模型，打饭不打好不走开，直到打饭给我后才离开）</span><br><span class="line">不直接得到的最终的结果，就是异步调用。（打饭，不会一直等着，会时不时的过来看看，打完了把饭拿走，异步不保证多长时间打完了饭）</span><br></pre></td></tr></table></figure>
<p><strong>2）阻塞、非阻塞：</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">函数或方法调用的时候，是否立即返回。</span><br><span class="line"></span><br><span class="line">立即返回就是非阻塞调用。</span><br><span class="line">不立即返回就是阻塞调用。</span><br></pre></td></tr></table></figure>
<p><strong>3）区别：</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">同步、异步，与阻塞、非阻塞不相关。</span><br><span class="line">同步、异步强调的是结果。阻塞和非阻塞强调的是时间，是否等待。</span><br><span class="line">同步与异步区别在于：调用者是否得到了想要的最终结果。</span><br><span class="line">同步就是一直要执行到返回最终结果。异步就是直接返回了，但是返回的不是最终的结果，调用者不能通过这种调用得到结果，还要通过被调用者，使用其他方式通知调用者，来取回最终结果。</span><br><span class="line">阻塞与非阻塞的区别在于，调用者是否还能干其他的事情。</span><br><span class="line">阻塞，调用者只能干等。非阻塞，调用者可以先忙一会别的，不用一直等。</span><br></pre></td></tr></table></figure>
<p><strong>4）联系：</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">同步阻塞：调用者阻塞，直到等到拿到最终结果。（打饭模型，什么事情也不敢，就等着打饭，打饭是结果，什么也不干，一直在等着，同步加阻塞）</span><br><span class="line">同步非阻塞：（等着打饭，但是可以玩会手机，看看电视，打饭是结果，但是不用一直在等着）</span><br><span class="line">异步阻塞：（我要打饭，你说等着较好，并没有返回饭给我，我啥事不干，就干等着饭好了叫我）</span><br><span class="line">异步非阻塞：回调的话。（我要打饭，你说等较好，并没有返回饭给我，可以在旁边看看电视，玩玩手机，饭好了叫我）</span><br></pre></td></tr></table></figure>
<h2 id="进程、线程和协程之间的区别和联系"><a href="#进程、线程和协程之间的区别和联系" class="headerlink" title="进程、线程和协程之间的区别和联系"></a><strong>进程、线程和协程之间的区别和联系</strong></h2><h2 id="定义"><a href="#定义" class="headerlink" title="定义"></a><strong>定义</strong></h2><p>进程: 一个运行起来的程序或者软件叫做进程，进程是操作系统分配资源的 基本单位<br>线程：指进程内的一个执行单元,也是进程内的可调度实体。<br>协程：是一种程序组件，是由子例程（过程、函数、例程、方法、子程序）的概念泛化而来的，子例程只有一个入口点且只返回一次，而协程允许多个入口点，可以在指定位置挂起和恢复执行。</p>
<h2 id="区别"><a href="#区别" class="headerlink" title="区别"></a>区别</h2><p>进程是资源分配的最小单位,线程是CPU调度的最小单位.<br>进程是操作系统资源分配的单位<br>线程是CPU调度的单位<br>进程切换需要的资源最大，效率很低<br>线程切换需要的资源一般，效率一般<br>协程切换需要资源很小，效率高</p>
<h2 id="线程与进程的区别"><a href="#线程与进程的区别" class="headerlink" title="线程与进程的区别"></a>线程与进程的区别</h2><p>同一个进程中的线程共享同一内存空间，但是进程之间是独立的。<br>同一个进程中的所有线程的数据是共享的（进程通讯），进程之间的数据是独立的。<br>对主线程的修改可能会影响其他线程的行为，但是父进程的修改（除了删除以外）不会影响其他子进程。<br>一个进程至少有一个线程<br>同一个进程的线程之间可以直接通信，但是进程之间的交流需要借助中间代理(队列)来实现<br>创建新的线程很容易，但是创建新的进程需要对父进程做一次复制。<br>一个线程可以操作同一进程的其他线程，但是进程只能操作其子进程。<br>线程启动速度快，进程启动速度慢（但是两者运行速度没有可比性）。</p>
<h2 id="协程与线程的比较"><a href="#协程与线程的比较" class="headerlink" title="协程与线程的比较"></a>协程与线程的比较</h2><p>一个线程可以多个协程，一个进程也可以单独拥有多个协程，这样python中则能使用多核CPU。<br>线程进程都是同步机制，而协程则是异步<br>协程能保留上一次调用时的状态，每次过程重入时，就相当于进入上一次调用的状态</p>
<p><strong>代码demo：</strong></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> queue</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">consumer</span><span class="params">(name)</span>:</span></span><br><span class="line">    print(<span class="string">"%s准备开始吃包子啦..."</span> % name)</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        new_baozi = <span class="keyword">yield</span></span><br><span class="line">        print(<span class="string">"[%s] 正在吃包子 %s"</span> % (name,new_baozi))</span><br><span class="line">        <span class="comment">#time.sleep(1)</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">producer</span><span class="params">()</span>:</span></span><br><span class="line">    r = con.__next__()</span><br><span class="line">    r = con2.__next__()</span><br><span class="line">    n = <span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span> n &lt; <span class="number">5</span>:    <span class="comment"># 生产者只做5个包子</span></span><br><span class="line">        n += <span class="number">1</span></span><br><span class="line">        print(<span class="string">"\033[32;1m[producer]\033[0m做好了新包子 %s"</span> % n )</span><br><span class="line">        time.sleep(<span class="number">1</span>)</span><br><span class="line">        con.send(n)</span><br><span class="line">        con2.send(n)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    <span class="comment"># 定义2个消费者、1个生产者</span></span><br><span class="line">    con = consumer(<span class="string">"c1"</span>)</span><br><span class="line">    con2 = consumer(<span class="string">"c2"</span>)</span><br><span class="line">    p = producer()</span><br></pre></td></tr></table></figure>
<p>协程介绍： <a href="https://zhuanlan.zhihu.com/p/38528865" target="_blank" rel="noopener">https://zhuanlan.zhihu.com/p/38528865</a> </p>
<p>参考链接 ： <a href="https://blog.csdn.net/DD18203614685/article/details/93226319" target="_blank" rel="noopener">https://blog.csdn.net/DD18203614685/article/details/93226319</a> </p>
]]></content>
      <categories>
        <category>python基础知识</category>
      </categories>
      <tags>
        <tag>面试集锦</tag>
        <tag>python基础知识</tag>
      </tags>
  </entry>
  <entry>
    <title>douyin-signature</title>
    <url>/2021/05/28/douyin-signature/</url>
    <content><![CDATA[<p>声明：本文只作学习研究，禁止用于非法用途，否则后果自负，如有侵权，请告知删除，谢谢！</p>
<p>练习网站平台：</p>
<a id="more"></a>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">JXU1MjREJXU5NzYyJXU2NkI0JXU5NzMyJXU3Njg0JXU4RkQ4JXU0RTBEJXU2NjBFJXU2NjNFJXU0RTQ4</span><br></pre></td></tr></table></figure>
<p><strong>抓取目标：</strong></p>
<p>这次要分析的如何抓取指定用户发布的视频<br>开启分析之旅：</p>
<p>首先在手机上分享出，我们要抓取的用户</p>
<p><img src="/2021/05/28/douyin-signature/1.png" alt></p>
<p>看到这个页面之后，我抓一下包分析一下</p>
<p> <img src="/2021/05/28/douyin-signature/2.png" alt></p>
<p><strong>滑动刷新多抓两个包，进行比较，分析一下参数</strong></p>
<p><img src="/2021/05/28/douyin-signature/17.png" alt></p>
<p>max_cursor ：每次会根据，上一次的抓包结果里面有</p>
<p>_signature:每次是变化的，和今日头条那个差不多（预计）</p>
<p>dytk:这个值呢，插看原网页就有，如图所示</p>
<p> <img src="/2021/05/28/douyin-signature/3.png" alt></p>
<p>让我们瞧一瞧_signature这个参数,全局搜索参数</p>
<p><img src="/2021/05/28/douyin-signature/4.png" alt></p>
<p>进入到第一个js文件，我们发现</p>
<p><img src="/2021/05/28/douyin-signature/5.png" alt></p>
<p>继续向下搜索signature,我们看到生成的函数：</p>
<p><img src="/2021/05/28/douyin-signature/6.png" alt></p>
<p>打上断点分析一下</p>
<p><img src="/2021/05/28/douyin-signature/7.png" alt></p>
<p>我们发现仅仅需要传进去uid，我们就能生成_signature值，我们把js复制下下来进行分析，</p>
<p>这里有两种还原方式：</p>
<p>下面我阐述其中一种：</p>
<p>首先么搜索_bytedAcrawler。结果如图所示：</p>
<p><img src="/2021/05/28/douyin-signature/8.png" alt></p>
<p>我们进入这个函数：</p>
<p>接下来把这个函数复制出来：</p>
<p>!function(t) {<br>    if (t.<strong>M = t.</strong>M || {},<br>        !t.<strong>M.require) {<br>        var e, n, r = document.getElementsByTagName(“head”)[0], i = {}, o = {}, a = {}, u = {}, c = {}, s = {}, l = function(t, n) {<br>            if (!(t in u)) {<br>                u[t] = !0;<br>                var i = document.createElement(“script”);<br>                if (n) {<br>                    var o = setTimeout(n, e.timeout);<br>                    i.onerror = function() {<br>                        clearTimeout(o),<br>                            n()<br>                    }<br>                    ;<br>                    var a = function() {<br>                        clearTimeout(o)<br>                    };<br>                    “onload”in i ? i.onload = a : i.onreadystatechange = function() {<br>                        (“loaded” === this.readyState || “complete” === this.readyState) &amp;&amp; a()<br>                    }<br>                }<br>                return i.type = “text/javascript”,<br>                    i.src = t,<br>                    r.appendChild(i),<br>                    i<br>            }<br>        }, f = function(t, e, n) {<br>            var r = i[t] || (i[t] = []);<br>            r.push(e);<br>            var o, a = c[t] || c[t + “.js”] || {}, u = a.pkg;<br>            o = u ? s[u].url || s[u].uri : a.url || a.uri || t,<br>                l(o, n &amp;&amp; function() {<br>                    n(t)<br>                }<br>                )<br>        };<br>        n = function(t, e) {<br>            “function” != typeof e &amp;&amp; (e = arguments[2]),<br>                t = t.replace(/.js$/i, “”),<br>                o[t] = e;<br>            var n = i[t];<br>            if (n) {<br>                for (var r = 0, a = n.length; a &gt; r; r++)<br>                    n<a href>r</a>;<br>                delete i[t]<br>            }<br>        }<br>            ,<br>            e = function(t) {<br>                if (t &amp;&amp; t.splice)<br>                    return e.async.apply(this, arguments);<br>                t = e.alias(t);<br>                var n = a[t];<br>                if (n)<br>                    return n.exports;<br>                var r = o[t];<br>                if (!r)<br>                    throw “[ModJS] Cannot find module <code>&quot; + t + &quot;</code>“;<br>                n = a[t] = {<br>                    exports: {}<br>                };<br>                var i = “function” == typeof r ? r.apply(n, [e, n.exports, n]) : r;<br>                return i &amp;&amp; (n.exports = i),<br>                n.exports &amp;&amp; !n.exports[“default”] &amp;&amp; Object.defineProperty &amp;&amp; Object.isExtensible(n.exports) &amp;&amp; Object.defineProperty(n.exports, “default”, {<br>                    value: n.exports<br>                }),<br>                    n.exports<br>            }<br>            ,<br>            e.async = function(n, r, i) {<br>                function a(t) {<br>                    for (var n, r = 0, h = t.length; h &gt; r; r++) {<br>                        var p = e.alias(t[r]);<br>                        p in o ? (n = c[p] || c[p + “.js”],<br>                        n &amp;&amp; “deps”in n &amp;&amp; a(n.deps)) : p in s || (s[p] = !0,<br>                            l++,<br>                            f(p, u, i),<br>                            n = c[p] || c[p + “.js”],<br>                        n &amp;&amp; “deps”in n &amp;&amp; a(n.deps))<br>                    }<br>                }<br>                function u() {<br>                    if (0 === l—) {<br>                        for (var i = [], o = 0, a = n.length; a &gt; o; o++)<br>                            i[o] = e(n[o]);<br>                        r &amp;&amp; r.apply(t, i)<br>                    }<br>                }<br>                “string” == typeof n &amp;&amp; (n = [n]);<br>                var s = {}<br>                    , l = 0;<br>                a(n),<br>                    u()<br>            }<br>            ,<br>            e.resourceMap = function(t) {<br>                var e, n;<br>                n = t.res;<br>                for (e in n)<br>                    n.hasOwnProperty(e) &amp;&amp; (c[e] = n[e]);<br>                n = t.pkg;<br>                for (e in n)<br>                    n.hasOwnProperty(e) &amp;&amp; (s[e] = n[e])<br>            }<br>            ,<br>            e.loadJs = function(t) {<br>                l(t)<br>            }<br>            ,<br>            e.loadCss = function(t) {<br>                if (t.content) {<br>                    var e = document.createElement(“style”);<br>                    e.type = “text/css”,<br>                        e.styleSheet ? e.styleSheet.cssText = t.content : e.innerHTML = t.content,<br>                        r.appendChild(e)<br>                } else if (t.url) {<br>                    var n = document.createElement(“link”);<br>                    n.href = t.url,<br>                        n.rel = “stylesheet”,<br>                        n.type = “text/css”,<br>                        r.appendChild(n)<br>                }<br>            }<br>            ,<br>            e.alias = function(t) {<br>                return t.replace(/.js$/i, “”)<br>            }<br>            ,<br>            e.timeout = 5e3,<br>            t.</strong>M.define = n,<br>            t.__M.require = e<br>    }<br>}(this);</p>
<p><strong>M.define(“douyin_falcon:node_modules/byted-acrawler/dist/runtime”, function(l, e) {<br>    Function(function(l) {<br>        return ‘e(e,a,r){(b[e]||(b[e]=t(“x,y”,”x “+e+” y”)(r,a)}a(e,a,r){(k[r]||(k[r]=t(“x,y”,”new x<a href="&quot;+Array(r+1">y</a>.join(“,x[y]”)(1)+”)”)(e,a)}r(e,a,r){n,t,s={},b=s.d=r?r.d+1:0;for(s[“$”+b]=s,t=0;t<b;t)s[n="$"+t]=r[n];for(t=0,b=s=a;t<b;t)s[t]=a[t];c(e,0,s)}c(t,b,k){u(e){v[x]=e}f{g=,ting(bg)}l{try{y=c(t,b,k)}catch(e){h=e,y=l}}for(h,y,d,g,v=[],x=0;;)switch(g=){case 1:u(!)4:f5:u((e){a="0,r=e;{c=a<r;c&&u(e[a]),c}}(6:y=,u((y8:if(g=,lg,g=,y===c)b+=g;else" if(y!="=l)y9:c10:u(s(11:y=,u(+y)12:for(y=f,d=[],g=0;g<y;g)d[g]=y.charCodeAt(g)^g+y;u(String.fromCharCode.apply(null,d13:y=,h=delete" [y]14:59:u((g=")?(y=x,v.slice(x-=g,y:[])61:u([])62:g=,k[0]=65599*k[0]+k[1].charCodeAt(g)">&gt;&gt;065:h=,y=,[y]=h66:u(e(t[b],,67:y=,d=,u((g=).x===c?r(g.y,y,k):g.apply(d,y68:u(e((g=t[b])&lt;”&lt;”?(b—,f):g+g,,70:u(!1)71:n72:+f73:u(parseInt(f,3675:if(){bcase 74:g=&lt;<16>&gt;16g76:u(k[])77:y=,u([y])78:g=,u(a(v,x-=g+1,g79:g=,u(k[“$”+g])81:h=,[f]=h82:u([f])83:h=,k[]=h84:!085:void 086:u(v[x-1])88:h=,y=,h,y89:u({e{r(e.y,arguments,k)}e.y=f,e.x=c,e})90:null91:h93:h=0:;default:u((g&lt;<16>&gt;16)-16)}}n=this,t=n.Function,s=Object.keys||(e){a={},r=0;for(c in e)a[r]=c;a=r,a},b={},k={};r’.replace(/[-]/g, function(e) {<br>            return l[15 &amp; e.charCodeAt(0)]<br>        })<br>    }(“v[x++]=v[—x]t.charCodeAt(b++)-32function return ))++.substrvar .length(),b+=;break;case ;break}”.split(“”)))()(‘gr$Daten Иb/s!l y͒yĹg,(lfi~ah`{mv,-n|jqewVxp{rvmmx,&amp;effkx[!cs”l”.Pq%widthl”@q&amp;heightl”vr<em>getContextx$”2d[!cs#l#,</em>;?|u.|uc{uq$fontl#vr(fillTextx<script type="math/tex">龘ฑภ경2<[#c}l#2q*shadowBlurl#1q-shadowOffsetXl#</script>limeq+shadowColorl#vr#arcx88802[%c}l#vr&amp;strokex[ c}l”v,)}eOmyoZB]mx[ cs!0s$l$Pb<k7l l!r&lengthb%^l$1+s$jl s#i$1ek1s$gr#tack4)zgr#tac$! +0o![#cj?o ]!l$b%s"o ]!l"l$b*b^0d#>&gt;&gt;s!0s%yA0s”l”l!r&amp;lengthb<k+l"^l"1+s"jl s&l&z0l!$ +["cs\'(0l#i\'1ps9wxb&s() &{s) s(gr&stringr,fromcharcodes)0s*ywl ._b&s o!])l l jb<k$.aj;l .tb<k$.gj .^b<k&i"-4j!+& s+ypo!]+s!l!l hd>&l!l Bd>&+l!l <d>&+l!l 6d>&+l!l &+ s,y=o!o!]/q"13o!l q"10o!],l 2d>& s.{s-yMo!o!]0q"13o!]*Ld<l 4d#>&gt;&gt;b|s!o!l q”10o!],l!&amp; s/yIo!o!].q”13o!],o!]*Jd<l 6d#>&gt;&gt;b|&amp;o!]+l &amp;+ s0l-l!&amp;l-l!i\’1z141z4b/@d&lt;l”b|&amp;+l-l(l!b^&amp;+l-l&amp;zl\’g,)gk}ejo{cm,)|yn~Lij~em[“cl$b%@d&lt;l&amp;zl\’l $ +[“cl$b%b|&amp;+l-l%8d&lt;@b|l!b^&amp;+ q$sign ‘, [Object.defineProperty(e, “</l></l></d></k+l"^l"1+s"jl></k7l></16></16></b;t)s[n="$"+t]=r[n];for(t=0,b=s=a;t<b;t)s[t]=a[t];c(e,0,s)}c(t,b,k){u(e){v[x]=e}f{g=,ting(bg)}l{try{y=c(t,b,k)}catch(e){h=e,y=l}}for(h,y,d,g,v=[],x=0;;)switch(g=){case></strong>esModule”, {<br>        value: !0<br>    })])<br>});</p>
<p>var dycs = __M.require(“douyin_falcon:node_modules/byted-acrawler/dist/runtime”);</p>
<p>function sign(uid){<br>    return dycs.sign(uid);<br>}<br>console.log(sign(382237371544059));<br> 初步还原点代码，下面我们继续分析</p>
<p>接下来就是我们本片文章的重点内容：</p>
<p>我进入函数sign里，看看最检测有哪些：</p>
<p><img src="/2021/05/28/douyin-signature/9.png" alt></p>
<p>打上断点，调试，一顿操作猛如虎：</p>
<p><img src="/2021/05/28/douyin-signature/10.png" alt></p>
<p>首先看到的是webdriver的检测，这里是检测selenium等等webdriver的特征，这就是为啥无法用selenium获取数据的原因</p>
<p>我们继续调试;</p>
<p>然后是对location对象进行检测</p>
<p><img src="/2021/05/28/douyin-signature/11.png" alt></p>
<p><strong>环境参数_zid</strong> </p>
<p><img src="/2021/05/28/douyin-signature/12.png" alt></p>
<p>接下来是重要的环节，继续调试可以发现这个js还对canvas做了检测 </p>
<p><img src="/2021/05/28/douyin-signature/13.png" alt></p>
<p> 最后是tac的字符串，这段东西是动态生成的，需要从静态页面源码获取 </p>
<p><img src="/2021/05/28/douyin-signature/14.png" alt></p>
<p>接下来开始逐步还原js加密算法：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">window = <span class="keyword">global</span>;</span><br><span class="line"> </span><br><span class="line">document = &#123;</span><br><span class="line">    _zid :<span class="number">1</span>,</span><br><span class="line">    createElement: function() &#123;</span><br><span class="line">        <span class="keyword">return</span> canvas</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line">canvas = &#123;</span><br><span class="line">    getContext: function getContext() &#123;</span><br><span class="line">        <span class="keyword">return</span> CanvasRenderingContext2D</span><br><span class="line">    &#125;,</span><br><span class="line">    toDataURL: function toDataURL() &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADAAAAAQCAYAAABQrvyxAAACy0lEQVRIS8XWT4hVVRwH8M+bCBt9KWGaGJG5KSEN3LSoINqEbgSjP+S0KaRFELgTohRtkasg7M8ESZAGLSoCXczGTUbowk0uso0WyJDUCE6kI+/Nk9+dc+DM8b5pIBzP5t573r2/9/33+93bMX8Nquu47KS9+C2ft9y25FuP4o02QBloDbgmdzvJrMYxPF/JMo49uIZbCLSpn5+vwd4JN57CcziYQLU60KZ6GaFSkNvpQJ3HUXyIb/EC3kw3jLcpWz88rAdKsrvwWlLnPbyN84j9o4i9rFzUD/W+wRMZSBGNtmaKOhtbatzSAws5EIXb+iCsPVUAOYut+Ayv4mscKkjlfAehn5DV/THlviYQ4J9JBJdXvdHqwGIUnyM6MGKVMTc8gpOum005fRBX8QP+wkcFgZJwdqYEGQ0aKxMNkqV7meCCTRwkstrleR6rAZ2+FcZt8L7DruiZcUDPYezDNryD+ysCOUIlqZrAuwiisf/3kAHdSiCDLY85OvN/G1hmvQ88bK2ffYLfrLTJdAP6U2xJysUflWCjXoALkBlgmwOl0mW/5P2xiFPZxMPGaO3AXIEV6DpuuylHfIlzVnosEbiIr1LGSwJ/pGkSU2RiEQRqohl87ptL/zUK2+d9BGiNvqumHPWFF5vx9qu7bdYTzViCKwkEgO04s0gHwqWTSYg6SVF3/zAHhvdAgO+adR9GnPN7E4+YQhd1mukT5+XYHOZAE4GEaliEwoGP8XIayws6UH9ClOrPnd9loOdeG02bdMVex+zzPX7BlI7+kIb7P9v1OyPXejqcqR3oGDHQt8xyM82d/7rHqOuu6VrjH9950g6nbcBZOxL4Scw0g3WJ1/weGOg4out1XaxKX5+9dBy100smvOVZp5zweZN7LjUfV53mHbDkqyYw4iGvmLHbegNrTZvV96cHXPC4dSaNmbC/eUFdwOU7CT7Uugk6/uUeZMZ6UQAAAABJRU5ErkJggg=="</span></span><br><span class="line">    &#125;,</span><br><span class="line">&#125;;</span><br><span class="line">CanvasRenderingContext2D = &#123;</span><br><span class="line">    arc: function arc() &#123;&#125;,</span><br><span class="line">    stroke: function stroke() &#123;&#125;,</span><br><span class="line">    fillText: function fillText() &#123;&#125;,</span><br><span class="line">&#125;;</span><br><span class="line">window.document=document;</span><br><span class="line"> </span><br><span class="line">navigator = &#123;</span><br><span class="line">    userAgent: <span class="string">'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/80.0.3987.149 Safari/537.36'</span>,</span><br><span class="line">    // userAgent: <span class="string">"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/80.0.3987.149 Safari/537.36"</span>,</span><br><span class="line">&#125;;</span><br><span class="line">window.navigator = navigator;</span><br><span class="line"> </span><br><span class="line">location = &#123;</span><br><span class="line">    <span class="string">"href"</span>: <span class="string">"https://www.iesdouyin.com/share/user/102064772608"</span>,</span><br><span class="line">    <span class="string">"origin"</span>: <span class="string">"https://www.iesdouyin.com"</span>,</span><br><span class="line">    <span class="string">"protocol"</span>: <span class="string">"https:"</span></span><br><span class="line">    ,</span><br><span class="line">&#125;;</span><br><span class="line">window.location = location;</span><br></pre></td></tr></table></figure>
<p> 游览器对象补充完毕：</p>
<p>我们和并完成代码：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"> </span><br><span class="line">window = <span class="keyword">global</span>;</span><br><span class="line"> </span><br><span class="line">document = &#123;</span><br><span class="line">    createElement: function() &#123;</span><br><span class="line">        <span class="keyword">return</span> canvas</span><br><span class="line">    &#125;,</span><br><span class="line">    getElementsByTagName:function () &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">""</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line">canvas = &#123;</span><br><span class="line">    getContext: function getContext() &#123;</span><br><span class="line">        <span class="keyword">return</span> CanvasRenderingContext2D</span><br><span class="line">    &#125;,</span><br><span class="line">    toDataURL: function toDataURL() &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADAAAAAQCAYAAABQrvyxAAACy0lEQVRIS8XWT4hVVRwH8M+bCBt9KWGaGJG5KSEN3LSoINqEbgSjP+S0KaRFELgTohRtkasg7M8ESZAGLSoCXczGTUbowk0uso0WyJDUCE6kI+/Nk9+dc+DM8b5pIBzP5t573r2/9/33+93bMX8Nquu47KS9+C2ft9y25FuP4o02QBloDbgmdzvJrMYxPF/JMo49uIZbCLSpn5+vwd4JN57CcziYQLU60KZ6GaFSkNvpQJ3HUXyIb/EC3kw3jLcpWz88rAdKsrvwWlLnPbyN84j9o4i9rFzUD/W+wRMZSBGNtmaKOhtbatzSAws5EIXb+iCsPVUAOYut+Ayv4mscKkjlfAehn5DV/THlviYQ4J9JBJdXvdHqwGIUnyM6MGKVMTc8gpOum005fRBX8QP+wkcFgZJwdqYEGQ0aKxMNkqV7meCCTRwkstrleR6rAZ2+FcZt8L7DruiZcUDPYezDNryD+ysCOUIlqZrAuwiisf/3kAHdSiCDLY85OvN/G1hmvQ88bK2ffYLfrLTJdAP6U2xJysUflWCjXoALkBlgmwOl0mW/5P2xiFPZxMPGaO3AXIEV6DpuuylHfIlzVnosEbiIr1LGSwJ/pGkSU2RiEQRqohl87ptL/zUK2+d9BGiNvqumHPWFF5vx9qu7bdYTzViCKwkEgO04s0gHwqWTSYg6SVF3/zAHhvdAgO+adR9GnPN7E4+YQhd1mukT5+XYHOZAE4GEaliEwoGP8XIayws6UH9ClOrPnd9loOdeG02bdMVex+zzPX7BlI7+kIb7P9v1OyPXejqcqR3oGDHQt8xyM82d/7rHqOuu6VrjH9950g6nbcBZOxL4Scw0g3WJ1/weGOg4out1XaxKX5+9dBy100smvOVZp5zweZN7LjUfV53mHbDkqyYw4iGvmLHbegNrTZvV96cHXPC4dSaNmbC/eUFdwOU7CT7Uugk6/uUeZMZ6UQAAAABJRU5ErkJggg=="</span></span><br><span class="line">    &#125;,</span><br><span class="line">&#125;;</span><br><span class="line">CanvasRenderingContext2D = &#123;</span><br><span class="line">    arc: function arc() &#123;&#125;,</span><br><span class="line">    stroke: function stroke() &#123;&#125;,</span><br><span class="line">    fillText: function fillText() &#123;&#125;,</span><br><span class="line">&#125;;</span><br><span class="line">window.document=document;</span><br><span class="line"> </span><br><span class="line">navigator = &#123;</span><br><span class="line">    userAgent: <span class="string">'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/80.0.3987.149 Safari/537.36'</span>,</span><br><span class="line">    // userAgent: <span class="string">"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/80.0.3987.149 Safari/537.36"</span>,</span><br><span class="line">&#125;;</span><br><span class="line">window.navigator = navigator;</span><br><span class="line"> </span><br><span class="line">location = &#123;</span><br><span class="line">    <span class="string">"href"</span>: <span class="string">"https://www.iesdouyin.com/share/user/102064772608"</span>,</span><br><span class="line">    <span class="string">"origin"</span>: <span class="string">"https://www.iesdouyin.com"</span>,</span><br><span class="line">    <span class="string">"protocol"</span>: <span class="string">"https:"</span>,</span><br><span class="line">&#125;;</span><br><span class="line">window.location = location;</span><br><span class="line">tac=<span class="string">'i)6a62m09ams!i$141qs"0y\u02a1g,&amp;qnfme|ms g,)gk&#125;ejo&#123;\x7fcms!g,&amp;Iebli\x7fms"l!,)~oih\x7fgyucmk"t (\x80,.jjvx|vDgyg&#125;knbl"d"inkfl"v,.jjvx|vDgyg&#125;knbmxl!,)~oih\x7fgyucgr&amp;Objectn vuq%valuevfq(writable[#c&#125;) %&#123;s#t ,4KJarz&#125;hrjxl@EWCOQDRB,3LKfs&#123;&#125;wsnqB&#123;iAMWBP@,;DCj&#123;&#125;DSKUAWyTK[C[XrHZ^RFZ[[,7HGn\x7fyxowiES&#125;PGWOW\\vL^BN,5JI`&#125;&#123;~iuk&#123;m\x7fRAQMURxNG,3LKsnsjpl~nB&#123;iAMWBP@,2MLpg\x7fa&#125;kEnrjl~PQGG,5JI`&#125;&#123;~iuk&#123;m\x7fTLTVDVWMM,1NMwf|`rjF\x7fm&#125;qk~TD,4KJert|tripAjNVPBTUCC,4KJpo|ksmyoAjNVPBTUCC[+s#,)Vyn`h`fe|,,olbcCt~vz|cz,6ID&#125;u\x7fuuhs@ieg|v@EHZMOY[#s$l$*%s%l%u&amp;k4s&amp;l$l&amp;ms\'l l\'mk"t j\x06l#*%s%l%u&amp;k?s&amp;l#l&amp;ms\'l ,(lfi~ah`&#123;ml\'mk"t j\ufffbl ,(lfi~ah`&#123;m*%s%l%u&amp;kls&amp;l&amp;vr%matchxgr&amp;RegExp$*\\$[a-z]dc_$ n"[!cvk:&#125;l ,(lfi~ah`&#123;ml&amp;m,&amp;efkaoTmk"t j\uffcef z[ cb|1d&lt;,%Dscafgd"in,8[xtm&#125;nLzNEGQMKAdGG^NTY\x1ckgd"inb&lt;b|1d&lt;g,&amp;TboLr&#123;m,(\x02)!jx-2n&amp;vr$testxg,%@tug&#123;mn ,%vrfkbm[!cb|'</span>;</span><br><span class="line"> </span><br><span class="line">// tac=<span class="string">'i)69f3puf9ts!i$1019s"0y\u02a1g,&amp;qnfme|ms g,)gk&#125;ejo&#123;\x7fcms!g,&amp;Iebli\x7fms"l!,)~oih\x7fgyucmk"t (\x80,.jjvx|vDgyg&#125;knbl"d"inkfl"v,.jjvx|vDgyg&#125;knbmxl!,)~oih\x7fgyucgr&amp;Objectn vuq%valuevfq(writable[#c&#125;) %&#123;s#t ,4KJarz&#125;hrjxl@EWCOQDRB,3LKfs&#123;&#125;wsnqB&#123;iAMWBP@,;DCj&#123;&#125;DSKUAWyTK[C[XrHZ^RFZ[[,7HGn\x7fyxowiES&#125;PGWOW\\vL^BN,5JI`&#125;&#123;~iuk&#123;m\x7fRAQMURxNG,3LKsnsjpl~nB&#123;iAMWBP@,2MLpg\x7fa&#125;kEnrjl~PQGG,5JI`&#125;&#123;~iuk&#123;m\x7fTLTVDVWMM,1NMwf|`rjF\x7fm&#125;qk~TD,4KJert|tripAjNVPBTUCC,4KJpo|ksmyoAjNVPBTUCC[+s#,)Vyn`h`fe|,,olbcCt~vz|cz,6ID&#125;u\x7fuuhs@ieg|v@EHZMOY[#s$l$*%s%l%u&amp;k4s&amp;l$l&amp;ms\'l l\'mk"t j\x06l#*%s%l%u&amp;k?s&amp;l#l&amp;ms\'l ,(lfi~ah`&#123;ml\'mk"t j\ufffbl ,(lfi~ah`&#123;m*%s%l%u&amp;kls&amp;l&amp;vr%matchxgr&amp;RegExp$*\\$[a-z]dc_$ n"[!cvk:&#125;l ,(lfi~ah`&#123;ml&amp;m,&amp;efkaoTmk"t j\uffcef z[ cb|1d&lt;,%Dscafgd"in,8[xtm&#125;nLzNEGQMKAdGG^NTY\x1ckgd"inb&lt;b|1d&lt;g,&amp;TboLr&#123;m,(\x02)!jx-2n&amp;vr$testxg,%@tug&#123;mn ,%vrfkbm[!cb|'</span></span><br><span class="line">!function(t) &#123;</span><br><span class="line">    <span class="keyword">if</span> (t.__M = t.__M || &#123;&#125;,</span><br><span class="line">        !t.__M.require) &#123;</span><br><span class="line">        var e, n, r = document.getElementsByTagName(<span class="string">"head"</span>)[<span class="number">0</span>], i = &#123;&#125;, o = &#123;&#125;, a = &#123;&#125;, u = &#123;&#125;, c = &#123;&#125;, s = &#123;&#125;, l = function(t, n) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!(t <span class="keyword">in</span> u)) &#123;</span><br><span class="line">                u[t] = !<span class="number">0</span>;</span><br><span class="line">                var i = document.createElement(<span class="string">"script"</span>);</span><br><span class="line">                <span class="keyword">if</span> (n) &#123;</span><br><span class="line">                    var o = setTimeout(n, e.timeout);</span><br><span class="line">                    i.onerror = function() &#123;</span><br><span class="line">                        clearTimeout(o),</span><br><span class="line">                            n()</span><br><span class="line">                    &#125;</span><br><span class="line">                    ;</span><br><span class="line">                    var a = function() &#123;</span><br><span class="line">                        clearTimeout(o)</span><br><span class="line">                    &#125;;</span><br><span class="line">                    "onload"in i ? i.onload = a : i.onreadystatechange = function() &#123;</span><br><span class="line">                        (<span class="string">"loaded"</span> === this.readyState || <span class="string">"complete"</span> === this.readyState) &amp;&amp; a()</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> i.type = <span class="string">"text/javascript"</span>,</span><br><span class="line">                    i.src = t,</span><br><span class="line">                    r.appendChild(i),</span><br><span class="line">                    i</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, f = function(t, e, n) &#123;</span><br><span class="line">            var r = i[t] || (i[t] = []);</span><br><span class="line">            r.push(e);</span><br><span class="line">            var o, a = c[t] || c[t + <span class="string">".js"</span>] || &#123;&#125;, u = a.pkg;</span><br><span class="line">            o = u ? s[u].url || s[u].uri : a.url || a.uri || t,</span><br><span class="line">                l(o, n &amp;&amp; function() &#123;</span><br><span class="line">                    n(t)</span><br><span class="line">                &#125;</span><br><span class="line">                )</span><br><span class="line">        &#125;;</span><br><span class="line">        n = function(t, e) &#123;</span><br><span class="line">            <span class="string">"function"</span> != typeof e &amp;&amp; (e = arguments[<span class="number">2</span>]),</span><br><span class="line">                t = t.replace(/\.js$/i, <span class="string">""</span>),</span><br><span class="line">                o[t] = e;</span><br><span class="line">            var n = i[t];</span><br><span class="line">            <span class="keyword">if</span> (n) &#123;</span><br><span class="line">                <span class="keyword">for</span> (var r = <span class="number">0</span>, a = n.length; a &gt; r; r++)</span><br><span class="line">                    n[r]();</span><br><span class="line">                delete i[t]</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">            ,</span><br><span class="line">            e = function(t) &#123;</span><br><span class="line">                <span class="keyword">if</span> (t &amp;&amp; t.splice)</span><br><span class="line">                    <span class="keyword">return</span> e.<span class="keyword">async</span>.apply(this, arguments);</span><br><span class="line">                t = e.alias(t);</span><br><span class="line">                var n = a[t];</span><br><span class="line">                <span class="keyword">if</span> (n)</span><br><span class="line">                    <span class="keyword">return</span> n.exports;</span><br><span class="line">                var r = o[t];</span><br><span class="line">                <span class="keyword">if</span> (!r)</span><br><span class="line">                    throw <span class="string">"[ModJS] Cannot find module `"</span> + t + <span class="string">"`"</span>;</span><br><span class="line">                n = a[t] = &#123;</span><br><span class="line">                    exports: &#123;&#125;</span><br><span class="line">                &#125;;</span><br><span class="line">                var i = "function" == typeof r ? r.apply(n, [e, n.exports, n]) : r;</span><br><span class="line">                <span class="keyword">return</span> i &amp;&amp; (n.exports = i),</span><br><span class="line">                n.exports &amp;&amp; !n.exports[<span class="string">"default"</span>] &amp;&amp; Object.defineProperty &amp;&amp; Object.isExtensible(n.exports) &amp;&amp; Object.defineProperty(n.exports, <span class="string">"default"</span>, &#123;</span><br><span class="line">                    value: n.exports</span><br><span class="line">                &#125;),</span><br><span class="line">                    n.exports</span><br><span class="line">            &#125;</span><br><span class="line">            ,</span><br><span class="line">            e.<span class="keyword">async</span> = function(n, r, i) &#123;</span><br><span class="line">                function a(t) &#123;</span><br><span class="line">                    <span class="keyword">for</span> (var n, r = <span class="number">0</span>, h = t.length; h &gt; r; r++) &#123;</span><br><span class="line">                        var p = e.alias(t[r]);</span><br><span class="line">                        p in o ? (n = c[p] || c[p + ".js"],</span><br><span class="line">                        n &amp;&amp; <span class="string">"deps"</span><span class="keyword">in</span> n &amp;&amp; a(n.deps)) : p <span class="keyword">in</span> s || (s[p] = !<span class="number">0</span>,</span><br><span class="line">                            l++,</span><br><span class="line">                            f(p, u, i),</span><br><span class="line">                            n = c[p] || c[p + <span class="string">".js"</span>],</span><br><span class="line">                        n &amp;&amp; <span class="string">"deps"</span><span class="keyword">in</span> n &amp;&amp; a(n.deps))</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                function u() &#123;</span><br><span class="line">                    <span class="keyword">if</span> (<span class="number">0</span> === l--) &#123;</span><br><span class="line">                        <span class="keyword">for</span> (var i = [], o = <span class="number">0</span>, a = n.length; a &gt; o; o++)</span><br><span class="line">                            i[o] = e(n[o]);</span><br><span class="line">                        r &amp;&amp; r.apply(t, i)</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="string">"string"</span> == typeof n &amp;&amp; (n = [n]);</span><br><span class="line">                var s = &#123;&#125;</span><br><span class="line">                    , l = <span class="number">0</span>;</span><br><span class="line">                a(n),</span><br><span class="line">                    u()</span><br><span class="line">            &#125;</span><br><span class="line">            ,</span><br><span class="line">            e.resourceMap = function(t) &#123;</span><br><span class="line">                var e, n;</span><br><span class="line">                n = t.res;</span><br><span class="line">                <span class="keyword">for</span> (e <span class="keyword">in</span> n)</span><br><span class="line">                    n.hasOwnProperty(e) &amp;&amp; (c[e] = n[e]);</span><br><span class="line">                n = t.pkg;</span><br><span class="line">                <span class="keyword">for</span> (e <span class="keyword">in</span> n)</span><br><span class="line">                    n.hasOwnProperty(e) &amp;&amp; (s[e] = n[e])</span><br><span class="line">            &#125;</span><br><span class="line">            ,</span><br><span class="line">            e.loadJs = function(t) &#123;</span><br><span class="line">                l(t)</span><br><span class="line">            &#125;</span><br><span class="line">            ,</span><br><span class="line">            e.loadCss = function(t) &#123;</span><br><span class="line">                <span class="keyword">if</span> (t.content) &#123;</span><br><span class="line">                    var e = document.createElement(<span class="string">"style"</span>);</span><br><span class="line">                    e.type = <span class="string">"text/css"</span>,</span><br><span class="line">                        e.styleSheet ? e.styleSheet.cssText = t.content : e.innerHTML = t.content,</span><br><span class="line">                        r.appendChild(e)</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (t.url) &#123;</span><br><span class="line">                    var n = document.createElement(<span class="string">"link"</span>);</span><br><span class="line">                    n.href = t.url,</span><br><span class="line">                        n.rel = <span class="string">"stylesheet"</span>,</span><br><span class="line">                        n.type = <span class="string">"text/css"</span>,</span><br><span class="line">                        r.appendChild(n)</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            ,</span><br><span class="line">            e.alias = function(t) &#123;</span><br><span class="line">                <span class="keyword">return</span> t.replace(/\.js$/i, <span class="string">""</span>)</span><br><span class="line">            &#125;</span><br><span class="line">            ,</span><br><span class="line">            e.timeout = <span class="number">5e3</span>,</span><br><span class="line">            t.__M.define = n,</span><br><span class="line">            t.__M.require = e</span><br><span class="line">    &#125;</span><br><span class="line">&#125;(window);</span><br><span class="line">__M.define(<span class="string">"douyin_falcon:node_modules/byted-acrawler/dist/runtime"</span>, function(l, e) &#123;</span><br><span class="line">    Function(function(l) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">'e(e,a,r)&#123;(b[e]||(b[e]=t("x,y","x "+e+" y")(r,a)&#125;a(e,a,r)&#123;(k[r]||(k[r]=t("x,y","new x[y]("+Array(r+1).join(",x[y]")(1)+")")(e,a)&#125;r(e,a,r)&#123;n,t,s=&#123;&#125;,b=s.d=r?r.d+1:0;for(s["$"+b]=s,t=0;t&lt;b;t)s[n="$"+t]=r[n];for(t=0,b=s=a;t&lt;b;t)s[t]=a[t];c(e,0,s)&#125;c(t,b,k)&#123;u(e)&#123;v[x]=e&#125;f&#123;g=,ting(bg)&#125;l&#123;try&#123;y=c(t,b,k)&#125;catch(e)&#123;h=e,y=l&#125;&#125;for(h,y,d,g,v=[],x=0;;)switch(g=)&#123;case 1:u(!)4:f5:u((e)&#123;a=0,r=e;&#123;c=a&lt;r;c&amp;&amp;u(e[a]),c&#125;&#125;(6:y=,u((y8:if(g=,lg,g=,y===c)b+=g;else if(y!==l)y9:c10:u(s(11:y=,u(+y)12:for(y=f,d=[],g=0;g&lt;y;g)d[g]=y.charCodeAt(g)^g+y;u(String.fromCharCode.apply(null,d13:y=,h=delete [y]14:59:u((g=)?(y=x,v.slice(x-=g,y:[])61:u([])62:g=,k[0]=65599*k[0]+k[1].charCodeAt(g)&gt;&gt;&gt;065:h=,y=,[y]=h66:u(e(t[b],,67:y=,d=,u((g=).x===c?r(g.y,y,k):g.apply(d,y68:u(e((g=t[b])&lt;"&lt;"?(b--,f):g+g,,70:u(!1)71:n72:+f73:u(parseInt(f,3675:if()&#123;bcase 74:g=&lt;&lt;16&gt;&gt;16g76:u(k[])77:y=,u([y])78:g=,u(a(v,x-=g+1,g79:g=,u(k["$"+g])81:h=,[f]=h82:u([f])83:h=,k[]=h84:!085:void 086:u(v[x-1])88:h=,y=,h,y89:u(&#123;e&#123;r(e.y,arguments,k)&#125;e.y=f,e.x=c,e&#125;)90:null91:h93:h=0:;default:u((g&lt;&lt;16&gt;&gt;16)-16)&#125;&#125;n=this,t=n.Function,s=Object.keys||(e)&#123;a=&#123;&#125;,r=0;for(c in e)a[r]=c;a=r,a&#125;,b=&#123;&#125;,k=&#123;&#125;;r'</span>.replace(/[-]/g, function(e) &#123;</span><br><span class="line">            <span class="keyword">return</span> l[<span class="number">15</span> &amp; e.charCodeAt(<span class="number">0</span>)]</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;(<span class="string">"v[x++]=v[--x]t.charCodeAt(b++)-32function return ))++.substrvar .length(),b+=;break;case ;break&#125;"</span>.split(<span class="string">""</span>)))()(<span class="string">'gr$Daten Иb/s!l y͒yĹg,(lfi~ah`&#123;mv,-n|jqewVxp&#123;rvmmx,&amp;effkx[!cs"l".Pq%widthl"@q&amp;heightl"vr*getContextx$"2d[!cs#l#,*;?|u.|uc&#123;uq$fontl#vr(fillTextx$$龘ฑภ경2&lt;[#c&#125;l#2q*shadowBlurl#1q-shadowOffsetXl#$$limeq+shadowColorl#vr#arcx88802[%c&#125;l#vr&amp;strokex[ c&#125;l"v,)&#125;eOmyoZB]mx[ cs!0s$l$Pb&lt;k7l l!r&amp;lengthb%^l$1+s$jl  s#i$1ek1s$gr#tack4)zgr#tac$! +0o![#cj?o ]!l$b%s"o ]!l"l$b*b^0d#&gt;&gt;&gt;s!0s%yA0s"l"l!r&amp;lengthb&lt;k+l"^l"1+s"jl  s&amp;l&amp;z0l!$ +["cs\'(0l#i\'1ps9wxb&amp;s() &amp;&#123;s)/s(gr&amp;Stringr,fromCharCodes)0s*yWl ._b&amp;s o!])l l Jb&lt;k$.aj;l .Tb&lt;k$.gj/l .^b&lt;k&amp;i"-4j!+&amp; s+yPo!]+s!l!l Hd&gt;&amp;l!l Bd&gt;&amp;+l!l &lt;d&gt;&amp;+l!l 6d&gt;&amp;+l!l &amp;+ s,y=o!o!]/q"13o!l q"10o!],l 2d&gt;&amp; s.&#123;s-yMo!o!]0q"13o!]*Ld&lt;l 4d#&gt;&gt;&gt;b|s!o!l q"10o!],l!&amp; s/yIo!o!].q"13o!],o!]*Jd&lt;l 6d#&gt;&gt;&gt;b|&amp;o!]+l &amp;+ s0l-l!&amp;l-l!i\'1z141z4b/@d&lt;l"b|&amp;+l-l(l!b^&amp;+l-l&amp;zl\'g,)gk&#125;ejo&#123;cm,)|yn~Lij~em["cl$b%@d&lt;l&amp;zl\'l $ +["cl$b%b|&amp;+l-l%8d&lt;@b|l!b^&amp;+ q$sign '</span>, [Object.defineProperty(e, <span class="string">"__esModule"</span>, &#123;</span><br><span class="line">        value: !<span class="number">0</span></span><br><span class="line">    &#125;)])</span><br><span class="line">&#125;);</span><br><span class="line"> </span><br><span class="line">var dycs = __M.require(<span class="string">"douyin_falcon:node_modules/byted-acrawler/dist/runtime"</span>);</span><br><span class="line"> </span><br><span class="line">function sign(uid)&#123;</span><br><span class="line">    <span class="keyword">return</span> dycs.sign(uid);</span><br><span class="line">&#125;</span><br><span class="line">console.log(sign(<span class="number">382237371544059</span>));</span><br></pre></td></tr></table></figure>
<p>到这里我们就还原成功了：</p>
<p><img src="/2021/05/28/douyin-signature/15.png" alt></p>
<p>到此我们分析结束，</p>
<p>请求数据时注意：</p>
<p>保持游览器头和js写的一致，如有疑问，搜索公众号，后台点击联系我。</p>
<p>微信公众号菜鸟童靴，不定期更新，欢迎关注，我们一起进步</p>
<p>​          <img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9tbWJpei5xcGljLmNuL21tYml6X3BuZy9TcElaaWE4OGljZ1RVSzJjaWI5d1U5RUdWaDRrcWVIRVVpYmtFaWE4TVdTbG40MlJEZnpnaWFJTHhiUllJR2ZxdmQzeTVWRlk0aWNkREY3dW4zRUZWSjlSaG1LT1EvNjQw?x-oss-process=image/format,png" alt="img">      </p>
]]></content>
      <categories>
        <category>python爬虫，js逆向</category>
      </categories>
      <tags>
        <tag>爬虫</tag>
        <tag>反编译</tag>
        <tag>js逆向，刷机，root</tag>
      </tags>
  </entry>
  <entry>
    <title>frida-hook原理</title>
    <url>/2021/05/06/frida-hook%E5%8E%9F%E7%90%86/</url>
    <content><![CDATA[<p>frida hook 原理介绍</p>
<a id="more"></a>
<p>frida使用的是<strong>动态二进制插桩技术</strong>（<strong>DBI</strong>），首先来了解一下插桩技术：</p>
<p><strong>一、插桩技术是指将额外的代码注入程序中以收集运行时的信息，可分为两种：</strong></p>
<p><strong>(1)源代码插桩[Source Code Instrumentation(SCI)]</strong>：</p>
<p>顾名思义，在程序源代码的基础上增加（注入）额外的代码，从而达到预期目的或者功能；</p>
<p><img src="/2021/05/06/frida-hook%E5%8E%9F%E7%90%86/1.jpg" alt></p>
<p><strong>(2)二进制插桩（Binary Instrumentation）：</strong></p>
<p>额外代码注入到二进制可执行文件中，通过修改汇编地址，改变程序运行内容，运行后再返回到原来程序运行出处，从而实现程序的额外功能。<br> ●静态二进制插桩[Static Binary Instrumentation(SBI)]：在程序执行前插入额外的代码和数据，生成一个永久改变的可执行文件。<br> ●动态二进制插桩[Dynamic Binary Instrumentation(DBI)]：在程序运行时实时地插入额外代码和数据，对可执行文件没有任何永久改变。</p>
<p><strong>二、DBI能做什么？</strong></p>
<blockquote>
<p>（1）访问进程的内存<br>（2）在应用程序运行时覆盖一些功能<br>（3）从导入的类中调用函数<br>（4）在堆上查找对象实例并使用这些对象实例<br>（5）Hook，跟踪和拦截函数等等</p>
</blockquote>
<h3 id="两种模式"><a href="#两种模式" class="headerlink" title="两种模式"></a>两种模式</h3><ol>
<li><p>attach模式<br>attach到已经存在的进程，核心原理是ptrace修改进程内存，如果进程处于调试状态（traceid不等于0），则attach失败</p>
</li>
<li><p>spawn模式<br>启动一个新的进程并挂起，在启动的同时注入frida代码，适用于在进程启动前的一些hook，如hook RegisterNative等，注入完成后调用resume恢复进程。</p>
</li>
</ol>
<p>参考资料;</p>
<p><a href="https://frida.re/" target="_blank" rel="noopener">https://frida.re/</a></p>
<p><a href="https://mabin004.github.io/2018/07/31/Mac上编译Frida/" target="_blank" rel="noopener">https://mabin004.github.io/2018/07/31/Mac%E4%B8%8A%E7%BC%96%E8%AF%91Frida/</a></p>
]]></content>
      <categories>
        <category>逆向</category>
      </categories>
      <tags>
        <tag>逆向</tag>
        <tag>Hook</tag>
        <tag>frida</tag>
      </tags>
  </entry>
  <entry>
    <title>日常开发中，超级实用的热更新插件</title>
    <url>/2021/02/14/%E6%97%A5%E5%B8%B8%E5%BC%80%E5%8F%91%E4%B8%AD%EF%BC%8C%E8%B6%85%E7%BA%A7%E5%AE%9E%E7%94%A8%E7%9A%84%E7%83%AD%E6%9B%B4%E6%96%B0%E6%8F%92%E4%BB%B6/</url>
    <content><![CDATA[<p><strong>前言：</strong></p>
<p>好久没写文章了，今天来给大家更新一篇，非常实用的文章，希望能在工作中，帮助到你们</p>
<a id="more"></a>
<p><strong>1、背景：</strong></p>
<p>  在程序开发过程中,每次增加新的需求，按照常规做法，你都要改项目代码，然后重新启动程序。</p>
<p><strong>2、痛点：</strong></p>
<p>  这种方式很麻烦，如何改动很小的话，很得不偿失，</p>
<p><strong>3、期望：</strong></p>
<p>  那么有没有一种方式，可以在不需要重新启动程序，就可以完成文件线上实时更新，且能被运行的程序正常读取到。</p>
<p><strong>4、热乎乎的干货来了</strong></p>
<p>  答案有的，接下来，就是今天我们要介绍的”热更新”这一功能，也可以称之为“插件系统”，所谓的“插件系统”，看起来非常高大，实际上远离非常简单，我们的主程序定期扫描特定文件夹，如果发现新增文件或者有文件发生了修改，就热加载这个文件中的代码。</p>
<p>本文依托，python 的 importlib.reload函数来实现此功能。</p>
<p>（1）首先创建一个setting.py文件，文件内容</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">redis&#x3D;&quot;你好&quot;</span><br></pre></td></tr></table></figure>
<p>（2）再创建一个ceshi.py文件，文件内容</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> importlib</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">from</span> reload_conf <span class="keyword">import</span> setting</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">ceshi</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        importlib.reload(setting)</span><br><span class="line">        print(setting.redis)</span><br><span class="line">        time.sleep(<span class="number">1</span>)</span><br><span class="line">ceshi()</span><br></pre></td></tr></table></figure>
<p>我们在控制台运行ceshi.py文件</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">python3 ceshi.py</span><br></pre></td></tr></table></figure>
<p>我们会看到控制台源源不断的 打印出 你好，如图所示：</p>
<p><img src="/2021/02/14/%E6%97%A5%E5%B8%B8%E5%BC%80%E5%8F%91%E4%B8%AD%EF%BC%8C%E8%B6%85%E7%BA%A7%E5%AE%9E%E7%94%A8%E7%9A%84%E7%83%AD%E6%9B%B4%E6%96%B0%E6%8F%92%E4%BB%B6/更新插件3.png" alt></p>
<p>我们保持程序在运行的同时，更改setting中的文件内容</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">redis&#x3D;&quot;你好，精神小伙&quot;</span><br></pre></td></tr></table></figure>
<p>当我更改完之后，你就会发现控制台，输出内容变成了“你好，精神小伙”如图所示</p>
<p><img src="/2021/02/14/%E6%97%A5%E5%B8%B8%E5%BC%80%E5%8F%91%E4%B8%AD%EF%BC%8C%E8%B6%85%E7%BA%A7%E5%AE%9E%E7%94%A8%E7%9A%84%E7%83%AD%E6%9B%B4%E6%96%B0%E6%8F%92%E4%BB%B6/更新插件2.png" alt></p>
<p>这样愉快的就解决了我们问题</p>
<p><strong>注 意 ：</strong></p>
<p>1、代码中的 <strong>importlib.reload(setting)</strong> 中的<strong>setting</strong>，必须是module ，也就是setting这个文件，否则会报错**</p>
<p><img src="/2021/02/14/%E6%97%A5%E5%B8%B8%E5%BC%80%E5%8F%91%E4%B8%AD%EF%BC%8C%E8%B6%85%E7%BA%A7%E5%AE%9E%E7%94%A8%E7%9A%84%E7%83%AD%E6%9B%B4%E6%96%B0%E6%8F%92%E4%BB%B6/更新插件1.png" alt></p>
<p>2、如果你的程序是在，pycharm上运行的话，会出现更新完文件，但是没有被及时打印出，这是因为，pycharm 有个缓存，不是实时写到硬盘上的，最好在更改完文件是，ctrl + s保存下，就可以实时热加载了。</p>
<p>当然如果你是在cmd窗口运行，那就不需要担心了</p>
<p><strong>彩 蛋 </strong>：</p>
<p>为了更好的在实际应用中，发挥作用，我们可以把这个功能，写成装饰器，代码如下：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> importlib</span><br><span class="line"><span class="keyword">from</span> reload_conf <span class="keyword">import</span> setting</span><br><span class="line"><span class="keyword">from</span> loguru <span class="keyword">import</span> logger</span><br><span class="line"><span class="keyword">import</span> traceback</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">module_reload</span><span class="params">(func)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">wrapper</span><span class="params">(*args, **kw)</span>:</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            importlib.reload(setting)</span><br><span class="line">            <span class="keyword">return</span> func(*args, **kw)</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> err:</span><br><span class="line">            logger.error(err)</span><br><span class="line">            traceback.print_exc()</span><br><span class="line">    <span class="keyword">return</span> wrapper</span><br><span class="line"></span><br><span class="line"><span class="meta">@module_reload</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">ceshi</span><span class="params">()</span>:</span></span><br><span class="line">    print(setting.redis)</span><br><span class="line">    time.sleep(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        ceshi()</span><br></pre></td></tr></table></figure>
<p>本文到此结束，这样就可以基于importlib.reload，你可以写一段代码，监控某个特定的文件，一旦发现里面内容被新增、修改你就把这些变动的代码热加载一次。然后正在运行中的 Python 程序就可以不停机使用新增的功能了。</p>
]]></content>
      <categories>
        <category>python爬虫，python技巧</category>
      </categories>
      <tags>
        <tag>python爬虫， 热更新文件， 技术优化</tag>
      </tags>
  </entry>
  <entry>
    <title>oneplus6手机刷机实战教程</title>
    <url>/2021/01/14/oneplus6%E6%89%8B%E6%9C%BA%E5%88%B7%E6%9C%BA%E5%AE%9E%E6%88%98%E6%95%99%E7%A8%8B/</url>
    <content><![CDATA[<p>本篇文章，仅仅讲的是刷机实战和刷机的用处，对刷机的专有名词和原理不做解释，（网站文章教程很多，后期也会整合一篇笔记出来）</p>
<a id="more"></a>
<p><strong>手机刷机有什么好处？</strong><br>　　1）手机root，刷机后的大多数ROM可以自动ROOT，获得最高的管理权限，可以使用更好玩，更丰富的手机软件。<br>　　2）优化手机系统性能，由于可定制的ROM（即刷机ROM）对内存进行了优化处理，删除了一些不常用的软件，以及针对特定人群进行定制优化，因此在性能上更加卓越。<br>　　3）解决手机运行卡、慢等问题，许多朋友可能会遇到手机无缘无故的重启、卡机、无法启动、无法关机等等问题。如果其他方法不奏效，刷机是最直接的方式。<br>　　4）改变官方版本的界面，自定义自己手机界面，官方版本的版本包由于采用优化技术来重点提高了性能，因此对于界面缺乏个性化和多样化的设计，尤其是所提供的主题包有限，从而降低了用户的体验度。因此可以通过刷机来拥有更加丰富的用户界面。</p>
<p>​        5) 对于程序员来说，用处大大的，比如 使用frida 对app进行hook拦截等</p>
<p>当然有利就有弊。许多用户在刷机前也会担心会有什么后遗症，或者刷机不当造成更大的损失。<br><strong>手机刷机有什么坏处？</strong><br>　　有一些朋友可能从手机买来到一直用到抛弃的过程中都没有进行过一次手机刷机，因为可能听说一些手机刷机的坏处。<br>　　首先最重要的一点手机刷机也就是抛弃了手机厂商对手机的调整，自己定义了手机的功能，所以显而易见的大多数厂商的手机在刷机后是不再享受官方联保服务。<br>　　下载了不适合的rom里面可能包含了捆绑病毒等文件，不是任何情况下都适合刷机，比如硬件问题你的手机喇叭损坏了，你想通过刷机来解决这可能吗？<br>　　新手需要学习刷机教学，刚接触刷机不久的用户可能由于某些不规范的操作导致手机刷机后遗留各种问题，轻则手机无信号，重则可能连手机变砖，无信号等等！</p>
<hr>
<p><strong>oneplus6刷机实操教程：</strong></p>
<p><strong>第一步：解锁一加**</strong>6<strong> </strong>bl**</p>
<p> 解锁教程：<a href="https://oneplus.gadgethacks.com/how-to/unlock-bootloader-your-oneplus-6-0185473/" target="_blank" rel="noopener">https:<strong>//</strong>oneplus.gadgethacks.com<strong>/</strong>how<strong>-</strong>to<strong>/</strong>unlock<strong>-</strong>bootloader<strong>-</strong>your<strong>-</strong>oneplus<strong>-</strong>6<strong>-</strong>0185473<strong>/</strong></a></p>
<p>1、启用开发者选项</p>
<p>现在您需要启用手机上的“开发人员选项”菜单来访问一个允许您解锁引导装载程序的设置。点击设置-&gt; 关于手机，然后向下滚动到底部，快速连续点击“版本号”七次。如果操作正确，您将看到一个祝酒词，声明“您现在是一名开发人员”</p>
<p>2、启用 OEM 解锁</p>
<p>从这里，点击后退按钮一次，头回到主设置页面。向下滚动，你会发现新解锁的开发者选项菜单。选择它，然后向下滚动，并启用开关旁边的“ OEM 解锁”在下一页。点击弹出窗口上的“启用” ，如果提示输入你的手机密码。</p>
<p>3、启用高级重启</p>
<p>当你还在“开发者选项”菜单中时，向下滚动并启用“高级重新启动”设置。这将使进入 Fastboot 模式变得更加容易。</p>
<p>4、启动到快速启动模式</p>
<p>启用高级重新启动后，按住电源按钮，打开电源菜单。在第一个提示符上选择“ Reboot” ，然后在第二个提示符上选择“ Bootloader（引导加载器）”并确认您的选择。当您的电话启动进入快速启动模式，继续并连接到您的计算机与 USB 数据线，但留在主要的快速启动菜单。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">或者命令实行： adb reboot bootloader</span><br></pre></td></tr></table></figure>
<p>5、</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">fastboot oem unlock</span><br></pre></td></tr></table></figure>
<p>6、</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">选择 unlock the bootloader</span><br></pre></td></tr></table></figure>
<p>给你的手机长达15分钟的时间来完成擦除程序，然后简单地再次运行初始设置，就像你第一次打开你的手机一样。此时，您的引导加载程序已正式解锁，因此您可以开始刷新自定义固件文件了！</p>
<p><strong>第2步开始刷机：</strong></p>
<p>1、解锁完成，adb reboot bootloader 进入手机开发者模式，打开adb调试，通过以下指令刷入rec</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">fastboot boot twrp**-**3.2.3**-**x_blu_spark_v9.86_op6.img （输入临时twrp）</span><br></pre></td></tr></table></figure>
<p>2、选择语言，中文，向右滑动 允许修改， 自动重启到rec模式后,首先进行清除，直接划</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">adb push twrp-installer-3.3.1-2-enchilada.zip &#x2F;sdcard adb push Magisk-v20.4.zip &#x2F;sdcard</span><br></pre></td></tr></table></figure>
<p>3、点击安装twrp<strong>-</strong>installer，选择多个刷机包Magisk，向右滑动， 返回重启选择系统进行重启 再选择系统，重启机即可，不要直接在刷完包之后重启系统。</p>
<p>4、测试root是否启动成功：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">adb shell su</span><br></pre></td></tr></table></figure>
<p><strong>第3步如果失败了先重新刷入系统，换成官方系统，重复第一二步骤即可</strong></p>
<p> 刷机教程:https:<strong>//</strong>bbs.mokeedev.com<strong>/</strong>t<strong>/</strong>topic<strong>/</strong>14940 直接看最下面的刷回官方系统的教程</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">（1）、电脑安装一加驱动，官方系统的一加6连接电脑，电脑会有一个 CD驱动器Oneplus drivers，双击它安装。</span><br><span class="line">（2）、把准备工作下载的 氧OS_9.0系统_一加6救砖包enchilada_22_O.27_181025.zip 解压 </span><br><span class="line">（3）、双击打开 MsmDownloadTool V4.0_factory.exe，手机完全关机后，按住音量加键 不松，插入数据线，显示已连接后松手，</span><br><span class="line">（4）点击start，等待完成，手机自动重启。</span><br><span class="line">	！！！注意！！！氧os开机一路跳过，不要联网，氢os随便</span><br></pre></td></tr></table></figure>
<p><img src="/2021/01/14/oneplus6%E6%89%8B%E6%9C%BA%E5%88%B7%E6%9C%BA%E5%AE%9E%E6%88%98%E6%95%99%E7%A8%8B/2.png" alt></p>
<p>本片文章结束，文章所用资源，微信公众号后台回复oneplus6刷机，可得到。</p>
<p>文章首发于微信公众号菜鸟童靴，不定期更新，如有需要后台加微信</p>
<p><img src="https://img-blog.csdnimg.cn/20200304210850537.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0JpZ0JveV9Db2Rlcg==,size_16,color_FFFFFF,t_70" alt="img"></p>
]]></content>
      <categories>
        <category>python爬虫，手机刷机</category>
      </categories>
      <tags>
        <tag>爬虫</tag>
        <tag>反编译</tag>
        <tag>js逆向，刷机，root</tag>
      </tags>
  </entry>
  <entry>
    <title>如何用window命令行更改文件创建和修改时间</title>
    <url>/2020/10/17/%E5%A6%82%E4%BD%95%E7%94%A8window%E5%91%BD%E4%BB%A4%E8%A1%8C%E6%9B%B4%E6%94%B9%E6%96%87%E4%BB%B6%E5%88%9B%E5%BB%BA%E5%92%8C%E4%BF%AE%E6%94%B9%E6%97%B6%E9%97%B4/</url>
    <content><![CDATA[<p>昨天朋友突然给我发来消息，说他有个文件，文件的创建时间和修改时间，想修改一下，往前提个几天，刚开始给他推荐了几个软件，但是想想一个程序员怎么能用他人的软件呢，于是乎，安排……..</p>
 <a id="more"></a>
<h3 id="1-步骤："><a href="#1-步骤：" class="headerlink" title="1. 步骤："></a>1. 步骤：</h3><p>　　新建一个bat文件，在其中添加语句：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">@ECHO OFF</span><br><span class="line">powershell.exe -command &quot;ls &#39;folder_path\*.dll&#39; | foreach-object &#123; $_.LastWriteTime &#x3D; Get-Date; $_.CreationTime &#x3D; Get-Date; $_.LastAccessTime &#x3D; Get-Date;&#125;&quot;</span><br><span class="line">PAUSE</span><br></pre></td></tr></table></figure>
<h3 id="2-解释："><a href="#2-解释：" class="headerlink" title="2. 解释："></a>2. 解释：</h3><p>　　代码将folder_path路径下的所有dll文件的创建时间和修改时间改成现在的时间。</p>
<p>　　-command: tells powershell to run the following command and return immediately</p>
<p>　　ls: list all matching files at the path specified</p>
<p>　　foreach-object: run the following block on each file that ls found</p>
<p>　　$_.LastWriteTime = Get-Date: for each file, set the LastWriteTime to the value returned by Get-Date (today’s date and time)</p>
<p>　　$_.CreationTime = Get-Date： for each file, set the CreationTime to the value returned by Get-Date (today’s date and time)</p>
<h3 id="3-修改至指定时间："><a href="#3-修改至指定时间：" class="headerlink" title="3. 修改至指定时间："></a>3. 修改至指定时间：</h3><p>　　将.LastWriteTime=Get−Date:改为.LastWriteTime=Get−Date:改为_.LastWriteTime = ‘01/11/2004 22:13:36’：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">@ECHO OFF</span><br><span class="line">powershell.exe -command &quot;ls &#39;folder_path\*.*&#39; | foreach-object &#123; $_.LastWriteTime &#x3D; &#39;01&#x2F;11&#x2F;2004 22:13:36&#39;; $_.CreationTime &#x3D; &#39;01&#x2F;11&#x2F;2004 22:13:36&#39; &#125;&quot;</span><br><span class="line">PAUSE</span><br></pre></td></tr></table></figure>
<h3 id="4-递归文件夹中所有文件："><a href="#4-递归文件夹中所有文件：" class="headerlink" title="4. 递归文件夹中所有文件："></a>4. 递归文件夹中所有文件：</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">@ECHO OFF</span><br><span class="line">powershell.exe -command &quot;Get-Childitem -path &#39;E:\project_llj\install\test\&#39; -Recurse | foreach-object &#123; $_.LastWriteTime &#x3D; Get-Date; $_.CreationTime &#x3D; Get-Date &#125;&quot; </span><br><span class="line">PAUSE</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>技术杂谈</category>
      </categories>
  </entry>
  <entry>
    <title>JS解析之 某json混淆阅读思路</title>
    <url>/2020/01/04/JS%E8%A7%A3%E6%9E%90%E4%B9%8B%20%E6%9F%90json%E6%B7%B7%E6%B7%86%E9%98%85%E8%AF%BB%E6%80%9D%E8%B7%AF/</url>
    <content><![CDATA[<p> 目标网址：<a href="http://www.python-spider.com/" target="_blank" rel="noopener">http://www.python-spider.com</a></p>
<p>  采集任务：成功获取首页HTML源码</p>
<a id="more"></a>
<hr>
<p><strong>一、代码分析</strong></p>
<p>闲话少叙，让我们开搞</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line">url = <span class="string">'http://www.python-spider.com'</span></span><br><span class="line">response = requests.get(url)</span><br><span class="line">html = response.content.decode()</span><br><span class="line">print(html)</span><br></pre></td></tr></table></figure>
<p>​    直接发请求观察返回代码（目标网站<strong>不限制</strong>请求头、IP等进行，所以无需传入headers），查看返回代码——-&gt;</p>
<p><img src="/2020/01/04/JS%E8%A7%A3%E6%9E%90%E4%B9%8B%20%E6%9F%90json%E6%B7%B7%E6%B7%86%E9%98%85%E8%AF%BB%E6%80%9D%E8%B7%AF/www5\Hexo\BoyYongXin\source\_posts\images\微信图片_20200104211607.png" alt="微信图片_20200104211607"></p>

<p>​    没有错，就是上面一坨。<strong>sojson.v5</strong> 映入眼帘，这么恶心的代码，可以说毫无可读性。自然是要先js美化走一波（如何美化请自行百度 JS美化 第一个网页即可）</p>
<p>美化后，代码就清晰可见了———&gt;</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">;</span><br><span class="line"><span class="keyword">var</span> encode_version = <span class="string">'sojson.v5'</span>,</span><br><span class="line">    arktk = <span class="string">'__0x67e38'</span>,</span><br><span class="line">    __0x67e38 = [<span class="string">'w7dkI2rDmcK0'</span>, <span class="string">'HsK8E8K9wpk7DCEmew=='</span>, <span class="string">'w4kwwr4qwrM='</span>, <span class="string">'w5czYMKJVkEowqg='</span>, <span class="string">'DBtxwq4='</span>, <span class="string">'wphiw6vCisKpcsOMwqTCh8OmLsKewobDg2PCgErCiRwQBwE9d8OVZcKbwpI='</span>, <span class="string">'McOXHUvDmB7ChHDCtQ=='</span>, <span class="string">'JTvCosKMwoc='</span>, <span class="string">'5Lm46IOe5YmJ6ZudO0tlw4nCsMK2ez0f'</span>, <span class="string">'w4LDnFp+Ug=='</span>, <span class="string">'UsKVwq7Co8OZw4w='</span>, <span class="string">'FXrDjsOEAFw='</span>, <span class="string">'wpvDksKeaSt8dg=='</span>, <span class="string">'woB/wrslwqNkXhY='</span>];</span><br><span class="line">(<span class="function"><span class="keyword">function</span> (<span class="params">_0x15e061, _0x24d8c2</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> _0x28d7df = <span class="function"><span class="keyword">function</span> (<span class="params">_0x3a3784</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">while</span> (--_0x3a3784) &#123;</span><br><span class="line">            _0x15e061[<span class="string">'push'</span>](_0x15e061[<span class="string">'shift'</span>]());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    _0x28d7df(++_0x24d8c2);</span><br><span class="line">&#125;(__0x67e38, <span class="number">0x1c9</span>));</span><br><span class="line"><span class="keyword">var</span> _0x421e = <span class="function"><span class="keyword">function</span> (<span class="params">_0x6a3a69, _0x333514</span>) </span>&#123;</span><br><span class="line">    _0x6a3a69 = _0x6a3a69 - <span class="number">0x0</span>;</span><br><span class="line">    <span class="keyword">var</span> _0x39a8d7 = __0x67e38[_0x6a3a69];</span><br><span class="line">    <span class="keyword">if</span> (_0x421e[<span class="string">'initialized'</span>] === <span class="literal">undefined</span>) &#123;</span><br><span class="line">        (<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">            <span class="keyword">var</span> _0x22548a = <span class="keyword">typeof</span> <span class="built_in">window</span> !== <span class="string">'undefined'</span> ? <span class="built_in">window</span> : <span class="keyword">typeof</span> process === <span class="string">'object'</span> &amp;&amp; <span class="keyword">typeof</span> <span class="built_in">require</span> === <span class="string">'function'</span> &amp;&amp; <span class="keyword">typeof</span> global === <span class="string">'object'</span> ? global : <span class="keyword">this</span>;</span><br><span class="line">            <span class="keyword">var</span> _0x582a25 = <span class="string">'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/='</span>;</span><br><span class="line">            _0x22548a[<span class="string">'atob'</span>] || (_0x22548a[<span class="string">'atob'</span>] = <span class="function"><span class="keyword">function</span> (<span class="params">_0x35d241</span>) </span>&#123;</span><br><span class="line">                <span class="keyword">var</span> _0x5e5a32 = <span class="built_in">String</span>(_0x35d241)[<span class="string">'replace'</span>](<span class="regexp">/=+$/</span>, <span class="string">''</span>);</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">var</span> _0x28a5e3 = <span class="number">0x0</span>, _0x2b45a3, _0x343cbf, _0xe0f1d0 = <span class="number">0x0</span>, _0x431162 = <span class="string">''</span>; _0x343cbf = _0x5e5a32[<span class="string">'charAt'</span>](_0xe0f1d0++);~ _0x343cbf &amp;&amp; (_0x2b45a3 = _0x28a5e3 % <span class="number">0x4</span> ? _0x2b45a3 * <span class="number">0x40</span> + _0x343cbf : _0x343cbf, _0x28a5e3++ % <span class="number">0x4</span>) ? _0x431162 += <span class="built_in">String</span>[<span class="string">'fromCharCode'</span>](<span class="number">0xff</span> &amp; _0x2b45a3 &gt;&gt; (<span class="number">-0x2</span> * _0x28a5e3 &amp; <span class="number">0x6</span>)) : <span class="number">0x0</span>) &#123;</span><br><span class="line">                    _0x343cbf = _0x582a25[<span class="string">'indexOf'</span>](_0x343cbf);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> _0x431162;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;());</span><br><span class="line">        <span class="keyword">var</span> _0x5d2a8c = <span class="function"><span class="keyword">function</span> (<span class="params">_0x354c7d, _0xac1c57</span>) </span>&#123;</span><br><span class="line">            <span class="keyword">var</span> _0x3ef3da = [],</span><br><span class="line">                _0x1e7821 = <span class="number">0x0</span>,</span><br><span class="line">                _0x363fd2, _0x3b7037 = <span class="string">''</span>,</span><br><span class="line">                _0x3533d5 = <span class="string">''</span>;</span><br><span class="line">            _0x354c7d = atob(_0x354c7d);</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">var</span> _0x39c851 = <span class="number">0x0</span>, _0x63560e = _0x354c7d[<span class="string">'length'</span>]; _0x39c851 &lt; _0x63560e; _0x39c851++) &#123;</span><br><span class="line">                _0x3533d5 += <span class="string">'%'</span> + (<span class="string">'00'</span> + _0x354c7d[<span class="string">'charCodeAt'</span>](_0x39c851)[<span class="string">'toString'</span>](<span class="number">0x10</span>))[<span class="string">'slice'</span>](<span class="number">-0x2</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            _0x354c7d = <span class="built_in">decodeURIComponent</span>(_0x3533d5);</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">var</span> _0xdb88b7 = <span class="number">0x0</span>; _0xdb88b7 &lt; <span class="number">0x100</span>; _0xdb88b7++) &#123;</span><br><span class="line">                _0x3ef3da[_0xdb88b7] = _0xdb88b7;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">for</span> (_0xdb88b7 = <span class="number">0x0</span>; _0xdb88b7 &lt; <span class="number">0x100</span>; _0xdb88b7++) &#123;</span><br><span class="line">                _0x1e7821 = (_0x1e7821 + _0x3ef3da[_0xdb88b7] + _0xac1c57[<span class="string">'charCodeAt'</span>](_0xdb88b7 % _0xac1c57[<span class="string">'length'</span>])) % <span class="number">0x100</span>;</span><br><span class="line">                _0x363fd2 = _0x3ef3da[_0xdb88b7];</span><br><span class="line">                _0x3ef3da[_0xdb88b7] = _0x3ef3da[_0x1e7821];</span><br><span class="line">                _0x3ef3da[_0x1e7821] = _0x363fd2;</span><br><span class="line">            &#125;</span><br><span class="line">            _0xdb88b7 = <span class="number">0x0</span>;</span><br><span class="line">            _0x1e7821 = <span class="number">0x0</span>;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">var</span> _0x3cdf31 = <span class="number">0x0</span>; _0x3cdf31 &lt; _0x354c7d[<span class="string">'length'</span>]; _0x3cdf31++) &#123;</span><br><span class="line">                _0xdb88b7 = (_0xdb88b7 + <span class="number">0x1</span>) % <span class="number">0x100</span>;</span><br><span class="line">                _0x1e7821 = (_0x1e7821 + _0x3ef3da[_0xdb88b7]) % <span class="number">0x100</span>;</span><br><span class="line">                _0x363fd2 = _0x3ef3da[_0xdb88b7];</span><br><span class="line">                _0x3ef3da[_0xdb88b7] = _0x3ef3da[_0x1e7821];</span><br><span class="line">                _0x3ef3da[_0x1e7821] = _0x363fd2;</span><br><span class="line">                _0x3b7037 += <span class="built_in">String</span>[<span class="string">'fromCharCode'</span>](_0x354c7d[<span class="string">'charCodeAt'</span>](_0x3cdf31) ^ _0x3ef3da[(_0x3ef3da[_0xdb88b7] + _0x3ef3da[_0x1e7821]) % <span class="number">0x100</span>]);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> _0x3b7037;</span><br><span class="line">        &#125;;</span><br><span class="line">        _0x421e[<span class="string">'rc4'</span>] = _0x5d2a8c;</span><br><span class="line">        _0x421e[<span class="string">'data'</span>] = &#123;&#125;;</span><br><span class="line">        _0x421e[<span class="string">'initialized'</span>] = !![];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">var</span> _0x548bc2 = _0x421e[<span class="string">'data'</span>][_0x6a3a69];</span><br><span class="line">    <span class="keyword">if</span> (_0x548bc2 === <span class="literal">undefined</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (_0x421e[<span class="string">'once'</span>] === <span class="literal">undefined</span>) &#123;</span><br><span class="line">            _0x421e[<span class="string">'once'</span>] = !![];</span><br><span class="line">        &#125;</span><br><span class="line">        _0x39a8d7 = _0x421e[<span class="string">'rc4'</span>](_0x39a8d7, _0x333514);</span><br><span class="line">        _0x421e[<span class="string">'data'</span>][_0x6a3a69] = _0x39a8d7;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        _0x39a8d7 = _0x548bc2;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> _0x39a8d7;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">var</span> timestamp = <span class="keyword">new</span> <span class="built_in">Date</span>()[<span class="string">'valueOf'</span>]();</span><br><span class="line"><span class="keyword">var</span> token = <span class="built_in">window</span>[<span class="string">'btoa'</span>](<span class="string">'aiding_win'</span> + <span class="built_in">String</span>(<span class="built_in">Math</span>[_0x421e(<span class="string">'0x0'</span>, <span class="string">'OoTU'</span>)](timestamp / <span class="number">0xf4240</span>)));</span><br><span class="line"><span class="built_in">document</span>[_0x421e(<span class="string">'0x1'</span>, <span class="string">'l[QL'</span>)] = _0x421e(<span class="string">'0x2'</span>, <span class="string">'75NN'</span>) + token[_0x421e(<span class="string">'0x3'</span>, <span class="string">'xR0U'</span>)](<span class="string">'='</span>, <span class="string">''</span>) + <span class="string">'sp'</span> + token + _0x421e(<span class="string">'0x4'</span>, <span class="string">'vC8m'</span>);</span><br><span class="line"><span class="built_in">document</span>[_0x421e(<span class="string">'0x5'</span>, <span class="string">'n%hx'</span>)] = _0x421e(<span class="string">'0x6'</span>, <span class="string">'rDxU'</span>) + <span class="built_in">String</span>(<span class="built_in">Math</span>[_0x421e(<span class="string">'0x7'</span>, <span class="string">'vC8m'</span>)](timestamp / <span class="number">0xf4240</span>)) + _0x421e(<span class="string">'0x8'</span>, <span class="string">'3B5*'</span>);</span><br><span class="line"><span class="keyword">let</span> nh = <span class="built_in">window</span>[<span class="string">'location'</span>][_0x421e(<span class="string">'0x9'</span>, <span class="string">'L64&amp;'</span>)];</span><br><span class="line"><span class="keyword">let</span> href = nh[<span class="string">'split'</span>](<span class="string">'/'</span>);</span><br><span class="line"><span class="keyword">if</span> (href[<span class="string">'length'</span>] &gt;= <span class="number">0x3</span>) &#123;</span><br><span class="line">    setTimeout(<span class="string">'javascript:location.href=nh'</span>, <span class="number">0x1f4</span>);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    setTimeout(_0x421e(<span class="string">'0xa'</span>, <span class="string">'&amp;#k4'</span>), <span class="number">0x1f4</span>);</span><br><span class="line">&#125;; <span class="keyword">if</span> (!(<span class="keyword">typeof</span> encode_version !== <span class="string">'undefined'</span> &amp;&amp; encode_version === _0x421e(<span class="string">'0xb'</span>, <span class="string">'5Khz'</span>))) &#123;</span><br><span class="line">    <span class="built_in">window</span>[_0x421e(<span class="string">'0xc'</span>, <span class="string">'*#To'</span>)](_0x421e(<span class="string">'0xd'</span>, <span class="string">'2e!l'</span>));</span><br><span class="line">&#125;;</span><br><span class="line">encode_version = <span class="string">'sojson.v5'</span>;</span><br></pre></td></tr></table></figure>
<hr>
<p>​    当看到这美化后的一坨代码的时候，我相信大家大家还是一脸懵逼。不过不要紧，让我们逐个分析</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> encode_version = <span class="string">'sojson.v5'</span>,</span><br><span class="line">    arktk = <span class="string">'__0x67e38'</span>,</span><br><span class="line">    __0x67e38 = [<span class="string">'w7dkI2rDmcK0'</span>, <span class="string">'HsK8E8K9wpk7DCEmew=='</span>, <span class="string">'w4kwwr4qwrM='</span>, <span class="string">'w5czYMKJVkEowqg='</span>, <span class="string">'DBtxwq4='</span>, <span class="string">'wphiw6vCisKpcsOMwqTCh8OmLsKewobDg2PCgErCiRwQBwE9d8OVZcKbwpI='</span>, <span class="string">'McOXHUvDmB7ChHDCtQ=='</span>, <span class="string">'JTvCosKMwoc='</span>, <span class="string">'5Lm46IOe5YmJ6ZudO0tlw4nCsMK2ez0f'</span>, <span class="string">'w4LDnFp+Ug=='</span>, <span class="string">'UsKVwq7Co8OZw4w='</span>, <span class="string">'FXrDjsOEAFw='</span>, <span class="string">'wpvDksKeaSt8dg=='</span>, <span class="string">'woB/wrslwqNkXhY='</span>];</span><br></pre></td></tr></table></figure>
<p>​    首先，声明了3个变量。暂时先放这就行了。</p>
<p>​    继续向下看，我们就会看到了一个匿名函数 —-&gt; </p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">(<span class="function"><span class="keyword">function</span> (<span class="params">_0x15e061, _0x24d8c2</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> _0x28d7df = <span class="function"><span class="keyword">function</span> (<span class="params">_0x3a3784</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">while</span> (--_0x3a3784) &#123;</span><br><span class="line">            _0x15e061[<span class="string">'push'</span>](_0x15e061[<span class="string">'shift'</span>]());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    _0x28d7df(++_0x24d8c2);</span><br><span class="line">&#125;(__0x67e38, <span class="number">0x1c9</span>));</span><br></pre></td></tr></table></figure>
<p>​    这个功能不难看出，是一个数组移位函数。我们继续向下看，就会看到一个很长很长的函数</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> _0x421e = <span class="function"><span class="keyword">function</span> (<span class="params">_0x6a3a69, _0x333514</span>) </span>&#123;</span><br><span class="line">    _0x6a3a69 = _0x6a3a69 - <span class="number">0x0</span>;</span><br><span class="line">    <span class="keyword">var</span> _0x39a8d7 = __0x67e38[_0x6a3a69];</span><br><span class="line">    <span class="keyword">if</span> (_0x421e[<span class="string">'initialized'</span>] === <span class="literal">undefined</span>) &#123;</span><br><span class="line">        (<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">            <span class="keyword">var</span> _0x22548a = <span class="keyword">typeof</span> <span class="built_in">window</span> !== <span class="string">'undefined'</span> ? <span class="built_in">window</span> : <span class="keyword">typeof</span> process === <span class="string">'object'</span> &amp;&amp; <span class="keyword">typeof</span> <span class="built_in">require</span> === <span class="string">'function'</span> &amp;&amp; <span class="keyword">typeof</span> global === <span class="string">'object'</span> ? global : <span class="keyword">this</span>;</span><br><span class="line">            <span class="keyword">var</span> _0x582a25 = <span class="string">'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/='</span>;</span><br><span class="line">            _0x22548a[<span class="string">'atob'</span>] || (_0x22548a[<span class="string">'atob'</span>] = <span class="function"><span class="keyword">function</span> (<span class="params">_0x35d241</span>) </span>&#123;</span><br><span class="line">                <span class="keyword">var</span> _0x5e5a32 = <span class="built_in">String</span>(_0x35d241)[<span class="string">'replace'</span>](<span class="regexp">/=+$/</span>, <span class="string">''</span>);</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">var</span> _0x28a5e3 = <span class="number">0x0</span>, _0x2b45a3, _0x343cbf, _0xe0f1d0 = <span class="number">0x0</span>, _0x431162 = <span class="string">''</span>; _0x343cbf = _0x5e5a32[<span class="string">'charAt'</span>](_0xe0f1d0++);~ _0x343cbf &amp;&amp; (_0x2b45a3 = _0x28a5e3 % <span class="number">0x4</span> ? _0x2b45a3 * <span class="number">0x40</span> + _0x343cbf : _0x343cbf, _0x28a5e3++ % <span class="number">0x4</span>) ? _0x431162 += <span class="built_in">String</span>[<span class="string">'fromCharCode'</span>](<span class="number">0xff</span> &amp; _0x2b45a3 &gt;&gt; (<span class="number">-0x2</span> * _0x28a5e3 &amp; <span class="number">0x6</span>)) : <span class="number">0x0</span>) &#123;</span><br><span class="line">                    _0x343cbf = _0x582a25[<span class="string">'indexOf'</span>](_0x343cbf);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> _0x431162;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;());</span><br><span class="line">        <span class="keyword">var</span> _0x5d2a8c = <span class="function"><span class="keyword">function</span> (<span class="params">_0x354c7d, _0xac1c57</span>) </span>&#123;</span><br><span class="line">            <span class="keyword">var</span> _0x3ef3da = [],</span><br><span class="line">                _0x1e7821 = <span class="number">0x0</span>,</span><br><span class="line">                _0x363fd2, _0x3b7037 = <span class="string">''</span>,</span><br><span class="line">                _0x3533d5 = <span class="string">''</span>;</span><br><span class="line">            _0x354c7d = atob(_0x354c7d);</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">var</span> _0x39c851 = <span class="number">0x0</span>, _0x63560e = _0x354c7d[<span class="string">'length'</span>]; _0x39c851 &lt; _0x63560e; _0x39c851++) &#123;</span><br><span class="line">                _0x3533d5 += <span class="string">'%'</span> + (<span class="string">'00'</span> + _0x354c7d[<span class="string">'charCodeAt'</span>](_0x39c851)[<span class="string">'toString'</span>](<span class="number">0x10</span>))[<span class="string">'slice'</span>](<span class="number">-0x2</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            _0x354c7d = <span class="built_in">decodeURIComponent</span>(_0x3533d5);</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">var</span> _0xdb88b7 = <span class="number">0x0</span>; _0xdb88b7 &lt; <span class="number">0x100</span>; _0xdb88b7++) &#123;</span><br><span class="line">                _0x3ef3da[_0xdb88b7] = _0xdb88b7;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">for</span> (_0xdb88b7 = <span class="number">0x0</span>; _0xdb88b7 &lt; <span class="number">0x100</span>; _0xdb88b7++) &#123;</span><br><span class="line">                _0x1e7821 = (_0x1e7821 + _0x3ef3da[_0xdb88b7] + _0xac1c57[<span class="string">'charCodeAt'</span>](_0xdb88b7 % _0xac1c57[<span class="string">'length'</span>])) % <span class="number">0x100</span>;</span><br><span class="line">                _0x363fd2 = _0x3ef3da[_0xdb88b7];</span><br><span class="line">                _0x3ef3da[_0xdb88b7] = _0x3ef3da[_0x1e7821];</span><br><span class="line">                _0x3ef3da[_0x1e7821] = _0x363fd2;</span><br><span class="line">            &#125;</span><br><span class="line">            _0xdb88b7 = <span class="number">0x0</span>;</span><br><span class="line">            _0x1e7821 = <span class="number">0x0</span>;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">var</span> _0x3cdf31 = <span class="number">0x0</span>; _0x3cdf31 &lt; _0x354c7d[<span class="string">'length'</span>]; _0x3cdf31++) &#123;</span><br><span class="line">                _0xdb88b7 = (_0xdb88b7 + <span class="number">0x1</span>) % <span class="number">0x100</span>;</span><br><span class="line">                _0x1e7821 = (_0x1e7821 + _0x3ef3da[_0xdb88b7]) % <span class="number">0x100</span>;</span><br><span class="line">                _0x363fd2 = _0x3ef3da[_0xdb88b7];</span><br><span class="line">                _0x3ef3da[_0xdb88b7] = _0x3ef3da[_0x1e7821];</span><br><span class="line">                _0x3ef3da[_0x1e7821] = _0x363fd2;</span><br><span class="line">                _0x3b7037 += <span class="built_in">String</span>[<span class="string">'fromCharCode'</span>](_0x354c7d[<span class="string">'charCodeAt'</span>](_0x3cdf31) ^ _0x3ef3da[(_0x3ef3da[_0xdb88b7] + _0x3ef3da[_0x1e7821]) % <span class="number">0x100</span>]);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> _0x3b7037;</span><br><span class="line">        &#125;;</span><br><span class="line">        _0x421e[<span class="string">'rc4'</span>] = _0x5d2a8c;</span><br><span class="line">        _0x421e[<span class="string">'data'</span>] = &#123;&#125;;</span><br><span class="line">        _0x421e[<span class="string">'initialized'</span>] = !![];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">var</span> _0x548bc2 = _0x421e[<span class="string">'data'</span>][_0x6a3a69];</span><br><span class="line">    <span class="keyword">if</span> (_0x548bc2 === <span class="literal">undefined</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (_0x421e[<span class="string">'once'</span>] === <span class="literal">undefined</span>) &#123;</span><br><span class="line">            _0x421e[<span class="string">'once'</span>] = !![];</span><br><span class="line">        &#125;</span><br><span class="line">        _0x39a8d7 = _0x421e[<span class="string">'rc4'</span>](_0x39a8d7, _0x333514);</span><br><span class="line">        _0x421e[<span class="string">'data'</span>][_0x6a3a69] = _0x39a8d7;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        _0x39a8d7 = _0x548bc2;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> _0x39a8d7;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>​    这个函数比较复杂，乍一看看不出什么端倪，只能分析出这是一个函数（包含两个形参），并且有一个返回值，我们继续向下阅读剩余代码</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> timestamp = <span class="keyword">new</span> <span class="built_in">Date</span>()[<span class="string">'valueOf'</span>]();</span><br><span class="line"><span class="keyword">var</span> token = <span class="built_in">window</span>[<span class="string">'btoa'</span>](<span class="string">'aiding_win'</span> + <span class="built_in">String</span>(<span class="built_in">Math</span>[_0x421e(<span class="string">'0x0'</span>, <span class="string">'OoTU'</span>)](timestamp / <span class="number">0xf4240</span>)));</span><br><span class="line"><span class="built_in">document</span>[_0x421e(<span class="string">'0x1'</span>, <span class="string">'l[QL'</span>)] = _0x421e(<span class="string">'0x2'</span>, <span class="string">'75NN'</span>) + token[_0x421e(<span class="string">'0x3'</span>, <span class="string">'xR0U'</span>)](<span class="string">'='</span>, <span class="string">''</span>) + <span class="string">'sp'</span> + token + _0x421e(<span class="string">'0x4'</span>, <span class="string">'vC8m'</span>);</span><br><span class="line"><span class="built_in">document</span>[_0x421e(<span class="string">'0x5'</span>, <span class="string">'n%hx'</span>)] = _0x421e(<span class="string">'0x6'</span>, <span class="string">'rDxU'</span>) + <span class="built_in">String</span>(<span class="built_in">Math</span>[_0x421e(<span class="string">'0x7'</span>, <span class="string">'vC8m'</span>)](timestamp / <span class="number">0xf4240</span>)) + _0x421e(<span class="string">'0x8'</span>, <span class="string">'3B5*'</span>);</span><br><span class="line"><span class="keyword">let</span> nh = <span class="built_in">window</span>[<span class="string">'location'</span>][_0x421e(<span class="string">'0x9'</span>, <span class="string">'L64&amp;'</span>)];</span><br><span class="line"><span class="keyword">let</span> href = nh[<span class="string">'split'</span>](<span class="string">'/'</span>);</span><br><span class="line"><span class="keyword">if</span> (href[<span class="string">'length'</span>] &gt;= <span class="number">0x3</span>) &#123;</span><br><span class="line">    setTimeout(<span class="string">'javascript:location.href=nh'</span>, <span class="number">0x1f4</span>);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    setTimeout(_0x421e(<span class="string">'0xa'</span>, <span class="string">'&amp;#k4'</span>), <span class="number">0x1f4</span>);</span><br><span class="line">&#125;; <span class="keyword">if</span> (!(<span class="keyword">typeof</span> encode_version !== <span class="string">'undefined'</span> &amp;&amp; encode_version === _0x421e(<span class="string">'0xb'</span>, <span class="string">'5Khz'</span>))) &#123;</span><br><span class="line">    <span class="built_in">window</span>[_0x421e(<span class="string">'0xc'</span>, <span class="string">'*#To'</span>)](_0x421e(<span class="string">'0xd'</span>, <span class="string">'2e!l'</span>));</span><br><span class="line">&#125;;</span><br><span class="line">encode_version = <span class="string">'sojson.v5'</span>;</span><br></pre></td></tr></table></figure>
<p>可以看出，这最后一部分的代码就很零散，隐隐约约的能看出一些关键字。但是想要理解代码含义还是有一定难度，最初笔者也卡住了很久，直到最后。。。我做了自己的网站，才看出这最后部分的端倪，我先上一段代码——&gt;</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> timestamp = (<span class="keyword">new</span> <span class="built_in">Date</span>()).valueOf();</span><br><span class="line"><span class="keyword">var</span> token=<span class="built_in">window</span>.btoa(<span class="string">'aiding_win'</span> + <span class="built_in">String</span>(<span class="built_in">Math</span>.round(timestamp/<span class="number">1000000</span>)));</span><br><span class="line"><span class="built_in">document</span>.cookie=<span class="string">'token='</span> + token.replace(<span class="string">'='</span>, <span class="string">''</span>) + <span class="string">'sp'</span> + token+ <span class="string">'; path=/'</span> ;</span><br><span class="line"><span class="built_in">document</span>.cookie=<span class="string">'tokentime='</span> + <span class="built_in">String</span>(<span class="built_in">Math</span>.round(timestamp/<span class="number">1000000</span>))+ <span class="string">'; path=/'</span> ;</span><br><span class="line"><span class="keyword">let</span> nh = <span class="built_in">window</span>.location.href;</span><br><span class="line"><span class="keyword">let</span> href = nh.split(<span class="string">'/'</span>);</span><br><span class="line"><span class="keyword">if</span> (href.length &gt;= <span class="number">3</span>) &#123;</span><br><span class="line">    setTimeout(<span class="string">"javascript:location.href=nh"</span>, <span class="number">500</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> &#123;</span><br><span class="line">    setTimeout(<span class="string">"javascript:location.href='/'"</span>, <span class="number">500</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>​    上面的代码其实是我原始的cookie生成js代码。是不是发现了什么端倪？ 没错，最后一部分明显就是原始代码通过混淆得到的。所以我们就有了一个大胆的猜测</p>
<p>之前所有的代码实际上都是为了 _0x421e这个函数服务，最终的目的就是制造了一个真实的解密函数 _0x421e 来解密原始代码。既然有了猜测，我们就开始尝试破解它！</p>
<hr>
<p><strong>二、反混淆</strong></p>
<p>其实反混淆的逻辑非常简单，通过第一部分的分析可知，整个sojson的加密是由四部分组合而成的</p>
<p>\1. 变量声明</p>
<p>\2. 数组移位</p>
<p>\3. 解密函数</p>
<p>\4. 执行函数</p>
<p>​    不说废话了，调试神奇 chrome console登场，新建标签页，F12，console一气呵成（有条件的可以使用 node.js，没有电脑的可以用口算/心算）。之后把前三部分丢进console里，怒敲回车！</p>

<p><img src="/2020/01/04/JS%E8%A7%A3%E6%9E%90%E4%B9%8B%20%E6%9F%90json%E6%B7%B7%E6%B7%86%E9%98%85%E8%AF%BB%E6%80%9D%E8%B7%AF/www5\Hexo\BoyYongXin\source\_posts\images\微信图片_20200104211316.png" alt="微信图片_20200104211316"></p>
<p>可以看到解密函数正常，并没有报错。那么整个反混淆就完成了。下面就是在解密函数的基础上断点调试找cookie实际生成代码，模拟后即可</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line">headers = &#123;</span><br><span class="line"><span class="string">"Accept"</span>:<span class="string">"application/json, text/javascript, */*; q=0.01"</span>,</span><br><span class="line"><span class="string">"Accept-Encoding"</span>:<span class="string">"gzip, deflate"</span>,</span><br><span class="line"><span class="string">"Accept-Language"</span>:<span class="string">"zh-CN,zh;q=0.9"</span>,</span><br><span class="line"><span class="string">"Connection"</span>:<span class="string">"keep-alive"</span>,</span><br><span class="line"><span class="string">"Cookie"</span>:<span class="string">"token=YWlkaW5nX3dpbjE1NzgxNDIspYWlkaW5nX3dpbjE1NzgxNDI=; tokentime=1578142"</span>,</span><br><span class="line"><span class="string">"Host"</span>:<span class="string">"www.python-spider.com"</span>,</span><br><span class="line"><span class="string">"Referer"</span>:<span class="string">"http://www.python-spider.com/content?sku=996"</span>,</span><br><span class="line"><span class="string">"User-Agent"</span>:<span class="string">"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/79.0.3945.88 Safari/537.36"</span>,</span><br><span class="line"><span class="string">"X-Requested-With"</span>:<span class="string">"XMLHttpRequest"</span>,</span><br><span class="line">&#125;</span><br><span class="line">url = <span class="string">'http://www.python-spider.com/detail?skuID=996'</span></span><br><span class="line">response = requests.get(url,headers=headers)</span><br><span class="line">html = response.content.decode()</span><br><span class="line">print(html)</span><br></pre></td></tr></table></figure>
<p>代码里加入cookie生成方式：</p>
<p>补充一下知识点：</p>
<h1 id="Window-btoa-方法"><a href="#Window-btoa-方法" class="headerlink" title="Window btoa() 方法"></a>Window btoa() 方法</h1><hr>
<h2 id="定义和用法"><a href="#定义和用法" class="headerlink" title="定义和用法"></a>定义和用法</h2><p>btoa() 方法用于创建一个 base-64 编码的字符串。</p>
<p>该方法使用 “A-Z”, “a-z”, “0-9”, “+”, “/“ 和 “=” 字符来编码字符串。</p>
<p>base-64 解码使用方法是 <a href="https://www.runoob.com/jsref/met-win-atob.html" target="_blank" rel="noopener">atob()</a> 。</p>
<h2 id="语法"><a href="#语法" class="headerlink" title="语法"></a>语法</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">window.btoa(str)</span><br></pre></td></tr></table></figure>
<p>最后python代码复现：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># coding=utf-8</span></span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line">headers = &#123;</span><br><span class="line">   </span><br><span class="line">    <span class="string">"Cookie"</span>:<span class="string">""</span>,</span><br><span class="line">    <span class="string">"Host"</span>:<span class="string">"www.python-spider.com"</span>,</span><br><span class="line">    <span class="string">"Referer"</span>:<span class="string">"http://www.python-spider.com/content?sku=996"</span>,</span><br><span class="line">    <span class="string">"User-Agent"</span>:<span class="string">"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/79.0.3945.88 Safari/537.36"</span>,</span><br><span class="line">    <span class="string">"X-Requested-With"</span>:<span class="string">"XMLHttpRequest"</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">timestamp = time.time()*<span class="number">1000</span></span><br><span class="line">result_str = <span class="string">'aiding_win'</span> + str(round(timestamp/<span class="number">1000000</span>))</span><br><span class="line">token = base64.encodebytes(result_str.encode(<span class="string">'utf-8'</span>)).decode(<span class="string">'utf-8'</span>)</span><br><span class="line"></span><br><span class="line">cookie = <span class="string">'token=%ssp%s'</span>%(token.replace(<span class="string">'='</span>, <span class="string">''</span>),token)</span><br><span class="line">tokentime =<span class="string">'tokentime='</span> + str(round(timestamp/<span class="number">1000000</span>))</span><br><span class="line">headers[<span class="string">"Cookie"</span>] = cookie + <span class="string">";"</span> + tokentime</span><br><span class="line">headers[<span class="string">"Cookie"</span>] = headers[<span class="string">"Cookie"</span>].replace(<span class="string">"\n"</span>,<span class="string">""</span>)</span><br><span class="line">url = <span class="string">'http://www.python-spider.com/detail?skuID=996'</span></span><br><span class="line">response = requests.get(url,headers=headers)</span><br><span class="line">html = response.content.decode()</span><br><span class="line">print(html)</span><br></pre></td></tr></table></figure>
<p>本文参考链接：<a href="http://www.python-spider.com/content?sku=996" target="_blank" rel="noopener">http://www.python-spider.com/content?sku=996</a></p>
<p><a href="https://blog.csdn.net/Mandyucan/article/details/80421711" target="_blank" rel="noopener">https://blog.csdn.net/Mandyucan/article/details/80421711</a></p>
]]></content>
      <categories>
        <category>python爬虫</category>
      </categories>
      <tags>
        <tag>爬虫</tag>
        <tag>反编译</tag>
        <tag>js逆向</tag>
      </tags>
  </entry>
  <entry>
    <title>某日报搜索参数securitykey加密破解</title>
    <url>/2019/12/31/people-app/</url>
    <content><![CDATA[<p>感觉好久没发文章了，最近小编基本处于放养状态，言归正传，最近遇到一个app，怎么遇到的呢，还用说么，公司来活了，给你的任务</p>
 <a id="more"></a>
<p><strong>任务要求：</strong></p>
<p>给定一批关键词，进行搜索，把搜索结果近期的数据，进行，提取、入库。</p>
<p>接到这个app，首先进行常规操作，配置好手机代理，进行fiddler抓包，于是乎，抓到包了，拿下来，使用postman进行模拟请求</p>
<p>数据返回成功，ok完事了？？</p>
<p>根本不可能，更换一个关键词；不换关键词，请求下一页；都不能用，分析一下请求结构</p>
<p><img src="https://img-blog.csdnimg.cn/20191231151029774.png" alt="img"></p>
<p>我们看到是post请求，一起看看他的form表单</p>
<p><img src="https://img-blog.csdnimg.cn/20191231151224429.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0JpZ0JveV9Db2Rlcg==,size_16,color_FFFFFF,t_70" alt="img"></p>
<p>如何确定那个参数是校验加密，反复抓包几次，对比信息即可，对比发现：</p>
<p>securitykey ：主要校验参数<br>longitude，latitude 经纬度，暂时不重要<br>province_code 时间戳，十位时间戳，后面跟000</p>
<p>开始下一个步骤，反编译APP，看他的源码，找到加密参数的方法</p>
<p>小坑出现了，使用apktool反编译失败，有点猫腻，jadx直接打开apk，如图所示</p>
<p><img src="https://img-blog.csdnimg.cn/20191231152321514.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0JpZ0JveV9Db2Rlcg==,size_16,color_FFFFFF,t_70" alt="img"></p>
<p>不看不知道，一看吓一跳，腾讯和360加固，有加固，需要脱壳</p>
<p>脱壳成功后，把所有脱出来的classs.dex文件，全部拿到，对比一下，先拿文件最大的下手</p>
<p><img src="https://img-blog.csdnimg.cn/20191231152730740.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0JpZ0JveV9Db2Rlcg==,size_16,color_FFFFFF,t_70" alt="img"></p>
<p>全局搜索，加密参数，我们找到了这个文件，瞧一瞧是不是咱所需要的</p>
<p><img src="https://img-blog.csdnimg.cn/20191231152951945.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0JpZ0JveV9Db2Rlcg==,size_16,color_FFFFFF,t_70" alt="img"></p>
<p>如标注位置，发现正是咱们所需要的，加密算法调用，进入getMD5Str方法里面去，看看是如何加密的</p>
<p><img src="https://img-blog.csdnimg.cn/20191231153145614.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0JpZ0JveV9Db2Rlcg==,size_16,color_FFFFFF,t_70" alt="img"></p>
<p>看一看，瞧一瞧，hook这个方法，看看传进来的是什么参数</p>
<p><img src="https://img-blog.csdnimg.cn/20191231153415752.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0JpZ0JveV9Db2Rlcg==,size_16,color_FFFFFF,t_70" alt="img"></p>
<p>跟据多次堆栈和print打印的结果，发现发参数基本就是这个了</p>
<p>有几个参数是变化的，标注一下</p>
<p>经纬度，页码，时间戳</p>
<p>这个app到这里基本就差不多，破解了，</p>
<p>本想着直接python调用这段java代码呢，研究了一下（代码不多），加密代码，使用python还原一下</p>
<p>md5_str = hashlib.md5(security_args.encode(encoding=’UTF-8’)).hexdigest()</p>
<p>其实就是python的md5加密，哈哈</p>
<p>构造请求就可以了，完整代码，就不上传了</p>
]]></content>
      <categories>
        <category>python爬虫</category>
      </categories>
      <tags>
        <tag>爬虫</tag>
        <tag>反编译</tag>
        <tag>Android逆向</tag>
      </tags>
  </entry>
  <entry>
    <title>自动化工具uiautomator2安装和使用教程</title>
    <url>/2019/12/21/%E8%87%AA%E5%8A%A8%E5%8C%96%E5%B7%A5%E5%85%B7uiautomator2%E5%AE%89%E8%A3%85%E5%92%8C%E4%BD%BF%E7%94%A8%E6%95%99%E7%A8%8B/</url>
    <content><![CDATA[<p><strong>1、参考链接</strong></p>
<p> GitHub： <a href="https://github.com/openatx/uiautomator2" target="_blank" rel="noopener">https://github.com/openatx/uiautomator2</a><br> <a id="more"></a></p>
<p><strong>2、工作原理：</strong></p>
<p>三、uiautomator2工作原理：</p>
<p><img src="https://img2018.cnblogs.com/blog/1231206/201903/1231206-20190317123618691-734760575.png" alt="img"></p>
<p>如图所示，python-uiautomator2主要分为两个部分，python客户端，移动设备</p>
<ul>
<li>python端: 运行脚本，并向移动设备发送HTTP请求</li>
<li>移动设备：移动设备上运行了封装了uiautomator2的HTTP服务，解析收到的请求，并转化成uiautomator2的代码。</li>
</ul>
<p>整个过程</p>
<ol>
<li>在移动设备上安装<code>atx-agent</code>(守护进程), 随后<code>atx-agent</code>启动uiautomator2服务(默认7912端口)进行监听</li>
<li>在PC上编写测试脚本并执行（相当于发送HTTP请求到移动设备的server端）</li>
<li>移动设备通过WIFI或USB接收到PC上发来的HTTP请求，执行制定的操作</li>
</ol>
<p><strong>三、安装测试</strong></p>
<p><strong>第一步：</strong></p>
<p>先准备一台（不要两台）开启了<code>开发者选项</code>的安卓手机，连接上电脑，确保执行<code>adb devices</code>可以看到连接上的设备。</p>
<ul>
<li>运行<code>pip3 install -U uiautomator2</code>安装uiautomator2</li>
<li>运行<code>python3 -m uiautomator2 init</code>安装包含httprpc服务的apk到手机+<code>atx-agent, minicap, minitouch</code></li>
</ul>
<p><strong>第二步：</strong></p>
<p>命令行运行<code>python</code>打开python交互窗口。然后将下面的命令输入到窗口中。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">import uiautomator2 as u2</span><br><span class="line"></span><br><span class="line">d &#x3D; u2.connect() # connect to device</span><br><span class="line">print(d.info)</span><br></pre></td></tr></table></figure>
<p>这时看到类似下面的输出，就可以正式开始用我们这个库了。因为这个库功能太多，后面还有很多的内容，需要慢慢去看 ….</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#123;&#39;currentPackageName&#39;: &#39;net.oneplus.launcher&#39;, &#39;displayHeight&#39;: 1920, &#39;displayRotation&#39;: 0, &#39;displaySizeDpX&#39;: 411, &#39;displaySizeDpY&#39;: 731, &#39;displayWidth&#39;: 1080, &#39;productName&#39;: &#39;OnePlus5&#39;, &#39;</span><br><span class="line">screenOn&#39;: True, &#39;sdkInt&#39;: 27, &#39;naturalOrientation&#39;: True&#125;</span><br></pre></td></tr></table></figure>
<p><strong>四、应用及操作</strong></p>
<p><strong>调用uiautomator2的过程</strong></p>
<ol>
<li>配置手机设备参数，设置具体操作的是哪一台手机</li>
<li>抓取手机上应用的控件，制定对应的控件来进行操作</li>
<li>对抓取到的控件进行操作，比如点击、填写参数等。</li>
</ol>
<p><strong>配置手机设备参数</strong></p>
<p>python-uiautomator2连接手机的方式有两种，一种是通过WIFI，另外一种是通过USB。两种方法各有优缺点。<br>WIFI最便利的地方要数可以不用连接数据线，USB则可以用在PC和手机网络不在一个网段用不了的情况。</p>
<ol>
<li><p>使用WIFI连接</p>
<p>手机获取到手机的IP，并确保电脑可以PING通手机。手机的IP可以在设置-WIFI设置里面获取到。<br>比如手机的IP是<code>192.168.0.100</code>，连接设备的代码为</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">import uiautomator2 as u2d &#x3D; u2.connect(&#39;192.168.0.100&#39;)</span><br></pre></td></tr></table></figure>
</li>
<li><p>使用USB连接</p>
<p>手机的序列号可以通过<code>adb devices</code>获取到，假设序列号是<code>123456f</code>，连接代码为</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">import uiautomator2 as u2d &#x3D; u2.connect_usb(&#39;123456f&#39;)</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h4 id="抓取手机上应用的控件"><a href="#抓取手机上应用的控件" class="headerlink" title="抓取手机上应用的控件"></a>抓取手机上应用的控件</h4><p>安装方法: <code>pip install --pre weditor</code></p>
<p>使用方法:<br>首先运行<code>python -m weditor</code>，之后浏览器会自动打开一个网页 <code>http://atx.open.netease.com</code> （注：这个网址仅提供一个前端，而<code>python -mweditor</code>这个命令则本地开放了HTTP的接口，前端去跟本地的服务去通信）</p>
<p>定位方式</p>
<ol>
<li>ResourceId定位: <code>d(resourceId=&quot;com.smartisanos.clock:id/text_stopwatch&quot;).click()</code></li>
<li>Text定位 <code>d(text=&quot;秒表&quot;).click()</code></li>
<li>Description定位 <code>d(description=&quot;..&quot;).click()</code></li>
<li>ClassName定位 <code>d(className=&quot;android.widget.TextView&quot;).click()</code></li>
</ol>
]]></content>
  </entry>
  <entry>
    <title>Hello World</title>
    <url>/2019/12/21/hello-world/</url>
    <content><![CDATA[<p>Welcome to <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a>! This is your very first post. Check <a href="https://hexo.io/docs/" target="_blank" rel="noopener">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="https://hexo.io/docs/troubleshooting.html" target="_blank" rel="noopener">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues" target="_blank" rel="noopener">GitHub</a>.<br><a id="more"></a></p>
<h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ hexo new <span class="string">"My New Post"</span></span><br></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/writing.html" target="_blank" rel="noopener">Writing</a></p>
<h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/server.html" target="_blank" rel="noopener">Server</a></p>
<h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ hexo generate</span><br></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/generating.html" target="_blank" rel="noopener">Generating</a></p>
<h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ hexo deploy</span><br></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/one-command-deployment.html" target="_blank" rel="noopener">Deployment</a></p>
]]></content>
  </entry>
</search>
